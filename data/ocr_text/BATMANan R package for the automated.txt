Vol. 28 no. 15 2012, pages 2088-2090
APPS NO  doi:10.1093/bioinformatics/bts308

 

Systems biology

Advance Access publication May 26, 2012

BATMAN—an R package for the automated quantification of
metabolites from nuclear magnetic resonance spectra using a

Bayesian model

Jie Hao‘, William Astle2, Maria De Iorio3 and Timothy M D Ebbels1’*

1 Section of Biomolecular Medicine, Department of Surgery and Cancer, Faculty of Medicine, Sir Alexander Fleming
Building, Imperial College London, London SW7 2AZ, UK, 2Department of Epidemiology, Biostatistics and
Occupational Health, McGill University, Purvis Hall, 1020 Ave. des Pins Ouest, Montr al, Ou bec, HSA 1A2, Canada
and 8Department of Statistical Science, University College, Gower Street, London WC1 E 6BT, UK

Associate Editor: Olga Troyanskaya

 

ABSTRACT

Motivation: Nuclear Magnetic Resonance (NMR) spectra are widely
used in metabolomics to obtain metabolite profiles in complex
biological mixtures. Common methods used to assign and estimate
concentrations of metabolites involve either an expert manual peak
fitting or extra pre-processing steps, such as peak alignment and
binning. Peak fitting is very time consuming and is subject to human
error. Conversely, alignment and binning can introduce artefacts and
limit immediate biological interpretation of models.

Results: We present the Bayesian automated metabolite analyser
for NMR spectra (BATMAN), an R package that deconvolutes peaks
from one-dimensional NMR spectra, automatically assigns them to
specific metabolites from a target list and obtains concentration
estimates. The Bayesian model incorporates information on
characteristic peak patterns of metabolites and is able to account
for shifts in the position of peaks commonly seen in NMR spectra of
biological samples. It applies a Markov chain Monte Carlo algorithm
to sample from a joint posterior distribution of the model parameters
and obtains concentration estimates with reduced error compared
with conventional numerical integration and comparable to manual
deconvolution by experienced spectroscopists.

Availability and implementation: http://www1.imperial.ac.uk/
medicine/people/t.ebbels/

Contact: t.ebbels@imperial.ac.uk

Received on January 24, 2012; revised on May 15, 2012; accepted
on May 18, 2012

1 INTRODUCTION

Nuclear Magnetic Resonance (NMR) spectroscopy is widely used
in metabolomics to provide information on metabolite proﬁles of
complex biological mixtures, such as bioﬁuids or tissue samples.
These spectra commonly contain around a thousand peaks from
possibly hundreds of metabolites. The concentrations of metabolites
are useful in biomarker discovery, investigating the aetiology of
disease and in understanding fundamental biological processes.
Quantitative measurement of metabolite abundances from NMR
spectra is complicated due to shifting peak positions, peak overlap,
noise and effects of the biological matrix.

 

*To whom correspondence should be addressed.

Excellent solutions to manual peak ﬁtting exist (Weljie et al.,
2006); however, this option is time consuming and is subject to
human error and bias (Tredwell et al., 2011). The R package BQuant
(Zheng et al., 2011) attempts to quantify metabolites from NMR
spectra using Bayesian model selection. However, it is a two—step
procedure that requires spectra to be pre—aligned and partitioned
into bins. Consequently, it is awkward to apply as it is not fully
automated. Peak shifts are not incorporated into the statistical
model, which may lead to suboptimal estimates of metabolite
concentrations, especially in crowded regions.

Herein, we present the R package Bayesian automated metabolite
analyser for NMR spectra (BATMAN) that implements a Bayesian
model for 1H NMR spectra (Astle et al., 2012) and a Markov
chain Monte Carlo (MCMC) algorithm to automate metabolite
quantiﬁcation from NMR spectral data. BATMAN is able to
automatically assign peaks to metabolites given a target metabolite
list and chemical shift region(s) speciﬁed by the user.

2 METHODS

An NMR spectrum, y, can be considered as a linear combination of
metabolite peaks plus noise. Metabolite peaks can be labelled catalogued
0r uncatalogued, according to whether their characteristic peak patterns
are known to the user. We propose a two—component joint model for the
catalogued yc and uncatalogued y” metabolites as follows:

y=yc+yu+8, 8~N(0,I/k), (1)

where I is the identity matrix and A is a scalar precision parameter.
The signal from the catalogued metabolites, yc, can be modelled as a
weighted summation of M metabolite templates

M
yc = Z Ztmu(0'mu)ﬁma (2)

14121 M

where vector tmu is a template spectrum of the uth multiplet belonging to the
mth metabolite, am is the chemical shift parameter for the corresponding
multiplet and pm is proportional to the concentration of the mth metabolite.
The priors for am and ﬁm are truncated normal distributions.

The template spectrum, tmu, in turn is generated as a weighted summation
of Lorentzian peaks. By default, BATMAN Obtains this prior information on
the peak pattern from the Human Metabolome Database (Wishart er 611.,
2009).

We model the Lorentzian peak width 74,, as

1n(ym)=M+Vma 

 

2088 © The Author 2012. Published by Oxford University Press. All rights reserved. For Permissions, please email: journals.permissions@oup.com

112 /B.IO'SIBUJHOprOJXO'SOllBIHJOJUTOTQ/ﬁdnq U101} papeoprmoq

9IOZ ‘091sn8nv uo ::

Automated quantification of metabolites

 

E

Brig-Hal Epncfrum
MEEJDDIH-E-I'. Flt
Waualet FII
FIl Sum

— — Eucrcn-I: and
CIIJ'IIE' dclﬂ
G: G-ﬂlutalhc acl'ﬁl
Hippurpc acid
Durham-flamma-
Dumnthylglycmn
Creatlnln:

— — ﬁrearm-I:

— — Taurlne

— — TrIHIEEhylamlne made

ED

 

Slandardized Intensity
4E]

I: trans-Acan-Iuc ac-u ,-
4“ II
I la
' Ilil
n ,_,. _ - J'IIIIHI' .J.  j
:3 7".“ ‘J " " .- _ ~==r -—-:"_I.'...:'_* — — b1.
: . ..’-..', . . . . . : : .
4.1 4 3.9 3.45 3.35 3.25 3.15-
 3 Hlppurll: acid at 1an ppm
Ln I - I 2 5W. 3. EI'-r 5'5. ﬂuhl‘hlii
9““ I I
c I I
3 g : 
c, _ ._ .. ___..1'_._41 _'._.__.____.  ...
43133 4132 43.01 [1.131] 3.01 CLUE [1.133

ppm shift
Dlmﬂhylaminc at 2.111: ppm

r .
.2 5"“ E. '3'? El". qunnhln:
I

 

43.01 -D_005 mic-n Dona
ppm 5I'llﬂ

3' 'I' 1'.
I' ;_'.'i I. - 5

 

I . . "
: i  - - - f
_'ﬂ't'""M-. J" j""-_--_*-::._-"  " I . ' -'*_—=n-_— _-'_ ..'   . iL-fr' — “"

31:5 ' 2:5 ' 2.35 ' 2.1-5 ' 2.55 2.355 I 2.115 ' 1'35

 

{33
(Gig. a-
,._-,' c:-
 a
g: Eé .
1: Cc: .
m a; .—
ES 3
acq- — c:
3:: L}
1'” mm
2 .2 .
Em 
mg- - tug
E. i E a
:3 1:1"

Hippuric acid DimeEhylamine

Fig. 1. Typical BATMAN result on a 1H NMR spectrum of rat urine. (3) Mean posterior ﬁt (inset: zoom for 3.25—3.29 ppm). (b) Posterior distribution of
chemical shift difference from catalogued position for multiplets of hippuric acid and dimethylamine. (c) Posterior distribution of relative concentration for

the two metabolites

where it represents the spectrum wide average and vm is a random effect,
representing metabolite speciﬁc deviations from M. Our priors for [L and vm
are both Gaussian.

Signal generated by uncatalogued metabolites, y”, is modelled as a linear
combination of wavelet basis functions (W). This alleviates difﬁculties
associated with the incompleteness of the spectral library that can inﬂuence
other methods (Mercier et al., 2011). A probability density model is speciﬁed
in the wavelet domain of the data, i.e. 0 EW y”. We use symlet—6 wavelet
basis functions as they are well suited to modelling Lorentzian peaks (Astle
et 61]., 2012).

The distribution of 0 is modelled by a truncated Gaussian, whose
parameters are speciﬁed by the parameters A, w and r. The hyperparameter
vector it ~ Gamma(c,d/2) allows the prior precision associated with each
wavelet deviate from the global precision X N Gamma(a,b/2). T is a
truncation limit vector where each I,- has a Gaussian distribution left truncated
at a small negative value It.

3 IMPLEMENTATION

A Markov Chain Monte Carlo (MCMC) algorithm is proposed to
sample from the joint posterior distribution of the model parameters.
We temper the likelihood and penalize the wavelet component of the
model stringently to move the chain into a region of good posterior
support in the burn in stage of the MCMC. We introduce block
updates for ,8 jointly with 0, and for omu jointly with 0 to allow
the chain to make global moves. The details are described in Astle
et al. (2012). Adaptation techniques are used to update the peak shift
omu and width parameters ym. The core algorithm is implemented in
C++ language with support for parallel processing between spectra
to improve the processing speed. R version 2.12.1 (or higher),
together with the R packages described in the documentation, is
required. BATMAN runs on Windows, Mac OS X and Linux/U nix
operating systems and supports text ﬁle, R data format and 1D

Bruker spectral data ﬁles as input. Processing 8 spectra on an
Intel 3.0GHz Quad—Core 2 processor machine with 11 catalogued
metabolites region from 2.3 to 4.1 ppm took approximately 22 min.
The MCMC procedure ran for 2000 iterations following a 4000
iteration burn in. The time required scales linearly with the number
both of metabolites and spectra (on a multicore machine, multiple
spectra can be analysed in parallel with the same run time as a single
spectrum analysis).

4 RESULTS

Figure 1 shows an example result of a BATMAN ﬁt of a 1H NMR
spectrum of normal rat urine. The catalogued metabolite peaks are
correctly ﬁt by the algorithm, with uncatalogued peaks absorbed
by the wavelet component. The unimodality of peak position and
concentration distributions indicate no ambiguity in the assignments.
The BATMAN deconvolution has been shown to have reduced mean
estimation error compared with conventional numerical integration
methods and its results on an example dataset ﬁtting 26 metabolites
are comparable with the manual deconvolution by ﬁve experienced
NMR spectroscopists as described by Astle et al. (2012).

Funding: This work was funded by grant BB/E020372/1 from
the UK Biotechnology and Biological Sciences Research Council
(BBSRC).

Conﬂict of Interest: none declared.

REFERENCES

Astle,W. et al. (2012) A Bayesian model of NMR spectra for the deconvolution and
quantiﬁcation of metabolites in complex biological mixtures. J. Am. Stat. Assoc, in
press. The accepted version can be found at http://arxiv.org/abs/1105.2204

 

2089

112 /B.IO'SIBUJROprOJXO'SOllBIIIJOJUlOTQ/ﬁdnq 11101; prBOIUAAOG

9IOZ ‘09 lsnﬁnv uo ::

J.Hao et al.

 

Mercier,P. et al. (2011) Towards automatic metabolomic proﬁling of high-resolution
one-dimensional proton NMR spectra. J. Biomol. NMR, 49, 307—323.

Tredwell,GD. et al. (2011) Between-Person comparison of metabolite ﬁtting for NMR-
based quantitative metabolomics. Anal. Chem, 83, 8683—8687.

Weljie,A.M. et al. (2006) Targeted proﬁling: quantitative analysis of 1H NMR
metabolomics data. Anal. Chem, 78, 443041442.

Wishart,D.S. et al. (2009) HMDB: a knowledgebase for the human metabolome. Nucleic
Acids Res., 37, D603—D610.

Zheng,C. et al. (2011) Identiﬁcation and quantiﬁcation of metabolites in 1H NMR
spectra by Bayesian model selection. Bioinformatics, 27, 1637—1644.

 

2090

112 /B.IO'SIBUJROprOJXO'SOllBIIIJOJUlOTQ/ﬁdnq 11101; prBOIUAAOG

9IOZ ‘09 lsnﬁnv uo ::

