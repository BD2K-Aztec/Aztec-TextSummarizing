Bioinformatics, 31 (20), 2015, 3282—3289

doi: 10.1093/bioinformatics/btv378

Advance Access Publication Date: 20 June 2015
Original Paper

 

 

Phylogenetics

An efficient Bayesian inference framework for
coalescent-based nonparametric phylodynamics

Shiwei Lan"*'*, Julia A. Palaciosz'3'“, Michael Karchers,
Vladimir N. Minin5'6 and Babak Shahbaba7'*

1Department of Statistics, University of Warwick, Coventry CV4 7AL, UK, 2Department of Organismic and
Evolutionary Biology, Harvard University, MA 02138, US, 3Department of Ecology and Evolutionary Biology, Brown
University, RI 02912, US, 4Center for Computational Molecular Biology, Brown University, 5Department of Statistics,
University of Washington, WA 98195, US, 6Department of Biology, University of Washington and 7Department of
Statistics, University of California, Irvine, CA 92697, US

*To whom correspondence should be addressed.
TThe authors wish it to be known that, in their opinion, the first two authors should be regarded as Joint First Authors.
Associate Editor: David Posada

Received on December 1, 2014; revised on May 25, 2015; accepted on June 16, 2015

Abstract

Motivation: The field of phylodynamics focuses on the problem of reconstructing population size
dynamics over time using current genetic samples taken from the population of interest. This tech-
nique has been extensively used in many areas of biology but is particularly useful for studying the
spread of quickly evolving infectious diseases agents, e.g. influenza virus. Phylodynamic inference
uses a coalescent model that defines a probability density for the genealogy of randomly sampled
individuals from the population. When we assume that such a genealogy is known, the coalescent
model, equipped with a Gaussian process prior on population size trajectory, allows for nonpara-
metric Bayesian estimation of population size dynamics. Although this approach is quite powerful,
large datasets collected during infectious disease surveillance challenge the state-of—the-art of
Bayesian phylodynamics and demand inferential methods with relatively low computational cost.
Results: To satisfy this demand, we provide a computationally efficient Bayesian inference frame-
work based on Hamiltonian Monte Carlo for coalescent process models. Moreover, we show that
by splitting the Hamiltonian function, we can further improve the efficiency of this approach. Using
several simulated and real datasets, we show that our method provides accurate estimates of
population size dynamics and is substantially faster than alternative methods based on elliptical
slice sampler and Metropolis-adjusted Langevin algorithm.

Availability and implementation: The R code for all simulation studies and real data analysis con-
ducted in this article are publicly available at http://www.ics.uci.edu/~slan/lanzi/CODES.html and in
the R package phylodyn available at https://github.com/mdkarcher/phylodyn.

Contact: S.Lan@warwick.ac.uk or babaks@uci.edu

Supplementary information: Supplementary data are available at Bioinformatics online.

 

past population size dynamics from current genetic data. In recent
years, phylodynamic inference has become an essential tool in areas like

1 Introduction

POPUIation genetics theory States that Changes in POPUJation Size affeCt ecology and epidemiology. For example, a study of human inﬂuenza A
genetic diversity, leaving a trace of these changes in indiViduals’ gen- Virus from sequences sampled in both hemispheres pointed to a source-
omes. The field of phylodynamics relies on this theory to reconstruct sink dynamics of the inﬂuenza evolution (Rambaut et al., 2008).

©The Author 2015. Published by Oxford University Press. All rights reserved. For Permissions, please e-mail: journals.permissions@oup.com 3282

9mg ‘09 isnﬁnV uo seleﬁuV socl ‘erulomeg JO AirSJeAru [1 112 [3.10811211an[plOJXO'SODBIILIOJIIlOlQ/ﬂ(11111 wort pepeolumoq

Efficient Bayesian phylodynamics

3283

 

Phylodynamic models connect population dynamics and genetic
data using coalescent-based methods (Griffiths and Tavare, 1994;
Kuhner et al., 1998; Strimmer and Pybus, 2001; Drummond et al.,
2002; Drummond et al., 2005; Opgen-Rhein et al., 2005 ; Heled and
Drummond, 2008; Minin et al., 2008; Palacios and Minin, 2013).
Typically, such methods rely on Kingman’s coalescent model, which
is a probability model that describes formation of genealogical rela-
tionships of a random sample of molecular sequences. The coales-
cent model is parameterized in terms of the effective population size,
an indicator of genetic diversity (Kingman, 1982).

While recent studies have shown promising results in alleviating
computational difficulties of phylodynamic inference (Palacios and
Minin, 2012, 2013), existing methods still lack the level of computa-
tional efficiency required to realize the potential of phylodynamics:
developing surveillance programs that can operate similarly to wea-
ther monitoring stations allowing public health workers to predict
disease dynamics to optimally allocate limited resources in time and
space. To achieve this goal, we present an accurate and computa-
tionally efficient inference method for modeling population dy-
namics given a genealogy. More specifically, we concentrate on a
class of Bayesian nonparametric methods based on Gaussian proc-
esses (Minin et al., 2008; Gill et al., 2013; Palacios and Minin,
2013). Following Palacios and Minin (2012) and Gill et al. (2013),
we assume a log-Gaussian process prior on the effective population
size. As a result, the estimation of effective population size trajectory
becomes similar to the estimation of intensity of a log-Gaussian Cox
process (LGCP; Moller et al., 1998), which is extremely challenging
since the likelihood evaluation becomes intractable: it involves inte-
gration over an infinite-dimensional random function. We resolve
the intractability in likelihood evaluation by discretizing the integra-
tion interval with a regular grid to approximate the likelihood and
the corresponding score function.

For phylodynamic inference, we propose a computationally effi-
cient Markov chain Monte Carlo (MCMC) algorithm using
Hamiltonian Monte Carlo (HMC; Duane et al., 1987; Neal, 2010)
and one of its variants, called Split HMC (Leimkuhler and Reich,
2004; Neal, 2010; Shahbaba et al., 2013), which speeds up standard
HMC’s convergence. Our proposed algorithm has several advan-
tages. First, it updates all model parameters jointly to avoid poor
MCMC convergence and slow mixing rates when there are strong
dependencies among model parameters (Knorr-Held and Rue,
2002). Second, unlike a recently proposed Integrated Nested
Laplace Approximation method (INLA, Rue et al., 2009; Palacios
and Minin, 2012), which approximates the posterior distribution
of model parameters given a fixed genealogy, our approach can be
extended to more general settings where we observe genetic data
(as opposed to the genealogy of sampled individuals) that provide
information on genealogical relationships. Third, we show that our
method is up to an order of magnitude more efficient than alterna-
tive MCMC algorithms, such as Metropolis-adjusted Langevin algo-
rithm (MALA; Roberts and Tweedie, 1996), adaptive MALA
(aMALA; Knorr-Held and Rue, 2002) and Elliptical Slice Sampler
(ESZ; Murray et al., 2010) that are commonly used in the field of
phylodynamics. Finally, although in this article we focus on phylo-
dynamic studies, our proposed methodology can be easily applied to
more general point process models.

The remainder of the article is organized as follows. In Section 2,
we provide a brief overview of coalescent models and HMC algo-
rithms. Section 3 presents the details of our proposed sampling
methods. Experimental results based on simulated and real data are
provided in Section 4. Section 5 is devoted to discussion and future
directions.

2 Preliminaries

2.1 Coalescent
Assume that a genealogy with time measured in units of generations is
available. The coalescent model allows us to trace the ancestry of a
random sample of n genomic sequences: two sequences or lineages
merge into a common ancestor as we go back in time until the com-
mon ancestor of all samples is reached. Those ‘merging’ times are
called coalescent times. The coalescent with variable population size
is an inhomogeneous Markov death process that starts with n lineages
at present time, tn 2 0, and decreases by one at each of the consequent
coalescent times, tn_1 < - -- < t1, until reaching their most recent
common ancestor (Kingman, 1982; Griffiths and Tavare, 1994).
Suppose we observe a genealogy of n individuals sampled at time
0. Under the standard (isochronous) coalescent model, given the ef-
fective population size trajectory, Ne (t), the joint density of coales-
cent times tn 2 0 < tn_1 <  < t1 is

P[t1,  ,tn|Ne(t)] = ﬁP[tk_1|tk,Ne(t)]
k=2

2 ﬁ—Ak exp{—J icit},
k=2 Ne(tk—1) 1,, Ne (15)
where Ak =  and Ik = (tk, tk_1]. Note that the larger the popula-
tion size, the longer it takes for two lineages to coalesce. Further, the
larger the number of lineages, the faster two of them meet their com-
mon ancestor.

For rapidly evolving organisms, we may have different sampling
times. When this is the case, the standard coalescent model can be
generalized to account for such heterochronous sampling (Rodrigo
and Felsenstein, 1999). Under the heterochronous coalescent, the
number of lineages changes at both coalescent times and sampling
times. Let {tk}Z=1 denote the coalescent times as before, but now let
sm 2 0 < sm_1 <  < s1 denote sampling times of nm,  ,n1 se-
quences respectively, where  n,- = n. Further, let s and n denote
the vectors of sampling times {53:1 and numbers of sequences
{ni};:1 sampled at these times, respectively. Then we can modify
density (1) as

P[t1, . .. ,tnls7n7Ne(t)] :

Ao k Ai k
A kexp —J ’ dt — J ’ dt (2
n 0, { 101k Ne   Ii’k Ne 

k=2 Ne ’

 

 

V

 

where the coalescent factor Ahk = (1"21") depends on the number of
lineages lbk in the interval IL,e defined by coalescent times and sam-
pling times. For k = 2,  ,n, we denote half-open intervals that
end with a coalescent event by

10,12 = (maxftk,$i},tk—1l, (3)

for s,- < tk_1 and half-open intervals that end with a sampling event
by (i > 0)

Ii,k = (max{tka$i+i}asi+i—1la (4)

for tk < si+,-_1 35,- < tk_1. In density (2), there are n — 1 intervals
{I,,k}i=0 and m — 1 intervals {I,,k}z.>0 for all (i, k). Note that only
those intervals satisfying IL,e C (tk, tk_1] are non-empty. See Figure 1
for more details.

We can think of isochronous coalescence as a special case of het-
erochronous coalescence when m = 1,A0,k = Ak,10,k = Ik,I,-,k = 0
for i > 0. Therefore, in what follows, we refer to density (2) as the
general case.

9mg ‘09 isnﬁnV uo sejeﬁuV socl ‘erulomeg JO AirSJeAru [1 112 [glO'SIBILInO[plOJXO'SODBIILIOJHlOlQ/[Zdllq mon pepeolumoq

3284

S.Lan et al.

 

Time (Present to Past)
(—

 

 

 

 

 

 

 

 

 

Numberoflineages  2  3  4  4  5  3 5453 5
Observed data       
Grid of Points x5         

Fig. 1. A genealogy with coalescent times and sampling times. Blue dashed
lines indicate the observed times: coalescent times {t1,---,t6} and sampling
times {31,32,33}. The intervals where the number of lineages change are
denoted by I,-,k. The superimposed grid {x1,---,x5} is marked by gray dashed
lines. We count the number of lineages in each interval defined by grid
points, coalescent times and sampling times

We assume the following log-Gaussian Process prior on the ef-
fective population size, Ne (t):

Ne(t) = eXPlf(t)l, f(t) N 973(0, C(19)), (5)

where 973(0, C(0)) denotes a Gaussian process with mean function 0
and covariance function C(0). A priori, Ne(t) is a log-Gaussian
process.

For computational convenience, we use a Gaussian process with
inverse covariance function Ci;1(ic) = KCQI, where Gill corres-
ponds to a modified inverse covariance matrix of Brownian motion
(C134) that starts with an initial Gaussian distribution with mean 0
and large variance. This corresponds to an intrinsic autoregression
model (Besag and Kooperberg, 1995; Knorr-Held and Rue, 2002).
The computational complexity of computing the density of this
prior is (9(D) since the inverse covariance matrix is tri-diagonal
(Kalman, 1960; Rue and Held, 2005; Palacios and Minin, 2013).
The precision parameter K is assumed to have a Gamma(oc, ﬂ) prior.

2.2 HMC

Bayesian inference typically involves intractable models that rely on
MCMC algorithms for sampling from the corresponding posterior
distribution, 7t(0). HMC (Duane et al., 1987; Neal, 2010) is a state-
of-the-art MCMC algorithm that suppresses the random walk
behavior of standard Metropolis-based sampling methods by pro-
posing states that are distant from the current state but nevertheless
have a high probability of being accepted. These distant proposals
are found by numerically simulating Hamilton dynamics, whose
state space consists of position, denoted by the vector 0, and mo-
mentum, denoted by the vector p. It is common to assume
p ~N(0,M), where M is a symmetric, positive-definite matrix
known as the mass matrix, often set to the identity matrix I for
convenience.

For Hamiltonian dynamics, the potential energy, U(0), is defined
as the negative log density of 0 (plus any constant); the kinetic energy,
K (p) for momentum variable p, is set to be the negative log density of
p (plus any constant). Then the total energy of the system, the
Hamiltonian function, is defined as their sum: H (0, p) = U(0) + K

The system of (0,p) evolves according to the following set of
Hamilton’s equations:

9: VpH(0,p) = M‘lp,
P = —V9H(0,P) = —V9U(0)-

(6)

In practice, we use a numerical method called leapfrog to approxi-
mate the Hamilton’s equations (Neal, 2010) when the analytical so-
lution is not available. We numerically solve the system for L steps,
with some step size, a, to propose a new state in the Metropolis algo-
rithm and accept or reject it according to the Metropolis acceptance
probability (see Neal, 2010, for more discussions).

3 Method

3.1 Discretization

As discussed above, the likelihood function (2) is intractable in general.
We can, however, approximate it using discretization. To this end, we
use a fine regular grid, x = {xd}dD=1, over the observation window and
approximate N e(t) by a piecewise constant function as follows:

D—l
* * xd + xd 1
NCO) % Z exp[f(xd)]1t€(xdaxd+ll’ xd = 2 + ' (7)
d=1

Note that the regular grid x does not coincide with the sampling
coalescent times, except for the first sampling time sm 2 x1 and the
last coalescent time t1 2 x13. To rewrite (2) using the approximation
(7), we sort all the time points {t, s,x} to create new D + m + n — 4
half-open intervals  with either coalescent time points, sampling
time points or grid time points as the end points (Fig. 1).

For each a E {1, - - - ,D + m + n — 4}, there exists some i, k and
d such that I; = Lk ﬂ (xd,xd+1]. Each integral in density (2) can be
approximated as a sum:

 

Ai,k ~ . _ *
Ne<t>dt~ Z A,,kexpi ram...

1; C113}:

where A0, is the length of the interval 1;. This way, the joint density
of coalescent times (2) can be rewritten as a product of the following

where y, is an auxiliary variable set to 1 if I; ends with a coalescent

terms:

time and to 0 otherwise. Then, density (2) can be approximated as
follows:

D+m+n—4
P[t1,  ,tn|s,n,Ne(t)] m H P[y,,,|s,n,Ne(t)]

oc=1

where the coalescent factor ALk on each interval I; is determined by
the number of lineages l,-,k in I We denote the expression on the right-
hand side of Equation (9) by Coalescent(f), where f :=  2:11.

3.2 Sampling methods

Our model can be summarized as

D m n—4
{ya} + +

;=1 |s, n, f N Coalescent(f),

f|ic ~N(0,%Cm), (10)

K N Gamma(oc, ﬂ).

9mg ‘09 isnﬁnV uo sejeﬁuV sorl ‘erulomeg JO AirSJeAru [1 112 ﬁrosleumo[pJOJXO'sopeuuogurorq/ﬁdnq wort pepeolumoq

Efficient Bayesian phylodynamics

3285

 

After transforming the coalescent times, sampling times and
grid points into {you ALk, A0,}, we condition on these data to generate
posterior samples for f = logNe(x*) and K, where x* =  is the
set of the middle points in (7). We use these posterior samples to
make inference about Ne 

For sampling f using HMC, we first compute the discretized log-
likelihood

D—1

l=—Z Z {Yaf(x:1)+Ai,kAoceXpl_f(x:1)l}

d=1 I; C(xd ,xd+1]

and the corresponding gradient (score function)

5d = — 2 {ya — Ai,kAoceXpl_f(x:1)l}-
I;C(xd,xd+1]
based on (9).
Because the prior on K is conditionally conjugate, we could dir-
ectly sample from its full conditional posterior distribution,

x |y, s,n,f ~ Gamma(oc + (D — 1)/2,/3 + ch;,1£/2). (11)

However, updating f and K separately is not recommended in gen-
eral because of their strong interdependency (Knorr-Held and Rue,
2002): large value of precision K strictly confines the variation of f,
rendering slow movement in the space occupied by f. Therefore, we
update (f, K) jointly in our sampling method. In practice, of course,
it is better to sample 0 := (f, t), where ‘C = log(K) is in the same scale
as f = logNe(x*). Note that the log-likelihood of 0 is the same as
that of f because density (2) does not involve ‘C. The log-density prior
on 0 is defined as follows:

logP(0) oc ((D — 1) /2 + a): —(ch;11f/2 + met (12)

3.3 Speed up by splitting Hamiltonian
The speed of HMC could be increased by splitting the Hamiltonian
into several terms such that the dynamics associated with some of
these terms can be solved analytically (Leimkuhler and Reich, 2004;
Neal, 2010; Shahbaba et al., 2013). For these analytically solvable
parts (typically in quadratic forms), simulation of the dynamics does
not introduce a discretization error, allowing for faster movements
in the parameter space.

For our model, we split the Hamiltonian H (0,p) = U(0) + K(p)
as follows:
—l — [(D — 1)/2 + och + ﬁeI

2 +
chijfer + pr —l — [(D — 1) /2 + och + per
2 + 2 '

H(0’P) =

 

(13)

 

We further split the middle part into two dynamics involving f It and
‘le, respectively,

f =
{ It p—D7 
p_D = —Ci:11fer.
 2 pp,
_ T _1 (14b)
pD = —f Cin fer/2,

where the subindex ‘— D’ means all but the Dth element. Using the
spectral decomposition Ci;1 = UAU‘1 and denoting f* :2 x/Xer/2
U_1f and piD :2 U_1p_D, we can analytically solve the dynamics
(14a) as follows (Lan, 2013) (more details are provided in the
Supplementary Material):

[ f*(t) ] _ [cosh/XeT/Zt) sin(\/XeT/2t)] [ f*(0) ] (15)
piD(t) — —sin(\/XeT/2t) cos(\/XeT/2t) piD(0)

 

Algorithm 1. splitHMC for the coalescent model

 

Initialize 0(1) at current 0 = (f, 1')

Sample a new momentum value pa) ~ N(0, I)

Calculate H(0(1),p(1)) = U(0(1)) —|— K(p(1)) according to (13)
for 6 = 1 to L do

13%) 2pm +8/2

 

S(e)
((D— 1)/2+a) —ﬁexp(r(‘))i

1

“((0%) = 1(5) + g/Zngé)

1 1+1 1 [+1
f*(€+1) COS («X6211 2) 8) Sin («X6211 2) 8) 

(—

1:1?) ( 1(a)) ( 1(4)) :99
_ —sin x/Xez 8 cos x/Xez a _

T(t+1) = 10%) + 8 /2 p199

1
pgm :pg 2) _8/2f*(e+1)Tf*(e+1)/2

p(e+1>=p(‘+i) +g/2

 

S(t+1)
((D — 1)/2 +oc) —ﬁexp(t(f+1)):|

end for

Calculate H (0(+1),p(L+1)) = U(0(L+1)) —|— K(p(L+1)) according to (13)

Calculate the acceptance probability (X : min{1, exp[—H (0(+1) , p(L+1))—|—
H(0<1>,p<1>)i}

Accept or reject the proposal according to (X for the next state 0'

 

where diagonal matrix \/X scales different dimensions. We then use
the standard leapfrog method to solve the dynamics (14b) and the
residual dynamics in (13). Note that we only need to diagonalize
Ci? once prior to sampling and then calculate fTCz-jzlfer = f*Tf*;
therefore, the overall computational complexity of the integrator is
0(D2). Algorithm 1 shows the steps for this approach, which we

refer to as splitHMC.

4 Experiments

We illustrate the advantages of our HMC-based methods using four
simulation studies. We also apply our methods to analysis of a real
dataset. We evaluate our methods by comparing them to INLA in
terms of accuracy and to several sampling algorithms, MALA,
aMALA and ESZ, in terms of sampling efficiency. We measure sam-
pling efficiency with time-normalized effective sample size (ESS).
Given B MCMC samples for each parameter, we define the corres-
ponding ESS = B[1 + 225:1 y(le)]_1 and calculate it using the
‘effectiveSize’ function in R Coda. Here, 25:1 y(k) is the sum of K
monotone sample autocorrelations (Geyer, 1992). We use the min-
imum ESS over all parameters normalized by the CPU time, s (in se-
conds), as the overall measure of efficiency: min(ESS) /s.

We tune the stepsize and number of leapfrog steps for our HMC-
based algorithm, such that their overall acceptance probabilities are
in a reasonable range (close to 0.70). In all experiments, we use
Gamma hyper prior parameters a = [i = 0.1.

9mg ‘09 isnﬁnV uo sejeﬁuV sorl ‘erulomeg JO AirSJeAru [1 112 ﬁrosleumo[pJOJXO'sopeuuogurorq/ﬁdnq wort pepeolumoq

3286

S.Lan et al.

 

Since MALA (Roberts and Tweedie, 1996) and aMALA (Knorr-
Held and Rue, 2002) can be viewed as variants of HMC with one
leapfrog step for numerically solving Hamiltonian dynamics, we im-
plement MALA and aMALA proposals using our HMC framework.
MALA, aMALA and HMC-based methods update f and ‘C jointly.
aMALA uses a joint block-update method designed for Gaussian
Markov Random Field (GMRF) models: it first generates a proposal
K* |K from some symmetric distribution independently of f and then
updates f*|f, K* based on a local Laplace approximation. Then,
(f*, K*) is either accepted or rejected. It can be shown that aMALA
is equivalent to Riemannian MALA (Roberts and Stramer, 2002;
Girolami and Calderhead, 2011, also see Supplementary Material).
In addition, aMALA closely resembles the most frequently used
MCMC algorithm in Gaussian process-based phylodynamics
(Minin et al., 2008; Gill et al., 2013).

ES2 (Murray et al., 2010) is another commonly used sampling al-
gorithm designed for models with Gaussian process priors. Palacios
and Minin (2013) used ES2 for phylodynamic inference. ES2 imple-
mentation relies on the assumption that the target distribution is ap-
proximately normal. This, of course, is not a suitable assumption
for the joint distribution of (f, 1). Therefore, we alternate the up-
dates f |K and K |f when using ESZ. Note that we are sampling K in
ES2 to take advantage of its conjugacy.

4.1 Simulations
We simulate four genealogies for n = 50 individuals with the follow-
ing true trajectories:

1. logistic trajectory:

90
1 12<
0 + 1 + exp(2(3 — (t mod 12)))’ t mOd — 6’

90
1 + exp(2(—9 + (t mod 12)))’

 

Ne(t) 2

10+ t mod 12 > 6;

 

2. exponential growth: Ne (t) = 1000 exp(—t);
3. boombust:

N ) 1000 exp(t—2), 1:32,
C _ 1000 exp(—t+2), t>2;

4. bottleneck:

1, 2:305,
Ne(t)= 0.1, t€(0.5,1.0),
1, 1.21.0.

To simulate data under heterochronous sampling, we selected 10 of
our samples to have sampling time 0. The sampling times for the re-
maining 40 individuals were selected uniformly at random. Our four
simulated genealogies were generated using the thinning algorithm
detailed in Palacios and Minin (2013) and implemented in R.
Simulated genealogies are displayed in the Supplementary File.

We use D = 100 equally spaced grid points in the approximation
of likelihood when applying INLA and MCMC algorithms (HMC,
splitHMC, MALA, aMALA and E52). Figure 2 compares the esti-
mates of Ne(t) using INLA and MCMC algorithms for the four
simulations. In general, the results of MCMC algorithms match
closely with those of INLA. It is worth noting that MALA and ES2
are occasionally slow to converge. Also, INLA fails when the num-
ber of grid points is large, e.g. 10 000, while MCMC algorithms can
still perform reliably.

For each experiment, we run 15 000 MCMC iterations with the
first 5000 samples discarded. We repeat each experiment 10 times.

 

 

 

 

 

 

 

 

 

 

 

 

 

 

 

 

 

 

 

logistic
0.
O _
O
N
0
d _
9 l0
‘6 0.
z 3 -
'O
9 _
8
0
co m. _
o. _ I) l I
N _ _ I '
,r ~ \ ,— Truth — MALA
- I' I— INLA — aMALA
in i — HMC — 532
o' T l — splitHMC
I l l l l I
20 15 10 5
Time (past to present)
exponential growth
N _
O
+ _
(D
ID
a: \— '
26?. -
_° l0
9
8 _
co 8
+ —
(D
ID
a _
. _
(D
ID
| l l | |
8 6 4 2 0
Time (past to present)
boombust
N _
O
+ —
(D
l0
4,: S
‘6 5 ‘
2 l0
'0
2
8 o '
co <3 _
(D
l0
8
I _
(D
ID
| l I l l
8 6 4 2 0
Time (past to present)
bottleneck
_ I I a - ~ ‘ ‘
\
8. _ I' ‘1
8 I, \
_ I \
I \
8. — ' ‘
9 ID
V
{D
Z _
E 8. —
(5 \—
O
U) _
O
(\! _
0
l0
Q _
O
l | | | | |

 

 

 

3.0 2.5 2.0 1.5 1.0 0.5 0.0
Time (past to present)

Fig. 2. INLA versus MCMC: simulated data under logistic (top 1), exponential
growth (top 2), boombust (top 3) and bottleneck (bottom) population size tra-
jectories. Dotted blue lines show 95% credible intervals given by INLA and
shaded regions show 95% credible interval estimated with MCMC samples
given by splitHMC

9mg ‘09 1sn8nV uo sejeﬁuV sorl ‘121u10111123 10 AnsleAru [1 112 /810'SI12umo[p101x0'831112u1101u101q/ﬁd11q 111011 pepeolumoq

Efficient Bayesian phylodynamics

3287

 

The results provided in Table 1 are averaged over 10 repetitions. As
we can see, our methods substantially improve over MALA,
aMALA and E52. Note that due to high computational cost of
Fisher information, aMALA is much worse than MALA in terms of
time-normalized ESS.

Figure 3 compares different sampling methods in terms of their
convergence to the stationary distribution when we increase the size
of grid points to D = 1000. As we can see in this more challenging
setting, Split HMC has the fastest convergence rate. HMC, ES2 and
MALA take longer time (around 500 s, 1000 s and 2000 s, respect-
ively) to converge, while aMALA does not reach the stationary dis-
tribution within the given time-frame.

In Figure 4, we show the estimated population size trajectory for
the four simulations using our splitHMC, Bayesian Skyline Plot

Table 1. Sampling efficiency in modeling simulated population
trajectories

 

Method AP s/iter minESS spdup ESS spdup
(f)/s (f) (1)/s (t)

 

ES2 1.00 1.62E-03 0.19 1.00 0.27 1.00
MALA 0.77 1.06E-03 0.70 3.76 2.13 7.86
I aMALA 0.64 7.73E-03 0.14 0.73 0.10 0.37

HMC 0.75 9.39E-03 1.88 10.08 1.77 6.52
splitHMC 0.72 6.71E-03 2.64 14.17 2.71 10.02
ES2 1.00 1.68E-03 0.22 1.00 0.28 1.00

MALA 0.76 1.05E-03 0.55 2.53 2.11 7.40
11 aMALA 0.66 8.00E-03 0.06 0.29 0.12 0.41

HMC 0.73 1.23E-02 2.94 13.47 1.34 4.69
splitHMC 0.75 7.12E-03 5.22 23.93 2.73 9.58
ES2 1.00 1.67E-03 0.21 1.00 0.33 1.00

MALA 0.75 1.12E-03 0.55 2.66 1.91 5.81
111 aMALA 0.65 8.11E-03 0.07 0.34 0.10 0.31

HMC 0.75 1.27E-02 2.23 10.68 1.05 3.20
splitHMC 0.75 7.66E-03 3.78 18.09 2.04 6.23
ES2 1.00 1.66E-03 0.25 1.00 0.14 1.00

MALA 0.83 1.11E-03 0.51 2.05 1.69 12.18
IV aMALA 0.65 8.18E-03 0.07 0.30 0.08 0.60

HMC 0.81 1.17E-02 0.58 2.30 0.87 6.25

splitHMC 0.76 7.78E-03 0.80 3.21 1.38 9.96

 

The true population trajectories are (I) logistic, (II) exponential growth,
(III) boombust and (IV) bottleneck. AP, acceptance probability; s/iter, seconds
per sampling iteration; ‘spdup’, speedup of efﬁciency measurement minESS/s
using ES2 as baseline.

Convergence rate

 

 

 

 

 

 

O
o _
(\l
I
O
o _
(‘0
I
8
o O
5 $—
_§_g ' -- HMC
E) — splitHMC
2 8 _  MALA
"1’ '-' aMALA
—- ES2
:3 . a . a '~ " " " "
O _ _ - ‘
(El) _ o —
O ..,.I - _ . ~ ' ' ' T T
c: - -*'
h _
' I l I I I
0 500 1000 1 500 2000

time (seconds)

Fig. 3. Trace plots of log-likelihoods for different sampling algorithms based
on a simulated coalescent model with logistic population trajectory. splitHMC
converges the fastest

(Drummond et al., 2005) and Bayesian Skyride (Minin et al., 2008).
Comparison of recovered estimates from these three methods
show that our Gaussian-process-based method (using splitHMC
algorithm) performs better than the other two: our point estimates
are closer to the truth and our credible intervals cover the truth al-
most everywhere. Bayesian Skyride and splitHMC perform very
similar; however, the BCIs recovered with splitHMC cover entirely
the two peaks in the logistic simulation, the peak in the boombust
simulation and the entire bottleneck phase in the bootleneck simula-
tion. A direct comparison of efficiency of these three methods is not
possible since Bayesian Skyline Plot and Bayesian Skyride assume
different prior distributions over Ne Additionally, Bayesian
Skyline Plot and Bayesian Skyride are implemented in BEAST
(Drummond et al., 2012) using a different language (Java).
Supplementary Figure 52 in the Supplementary File shows the
trace plots of the posterior distributions of the results displayed in
Figure 4 to assess convergence of the posterior estimates.

4.2 Human influenza A in New York

Next, we analyze a real dataset previously used to estimate influenza
seasonal dynamics (Palacios and Minin, 2012, 2013). The data con-
sist of a genealogy estimated from 288 human inﬂuenza H3N2 se-
quences sampled in New York state from January 2001 to March
2005. The key feature of the inﬂuenza A virus epidemic in temperate
regions like New York is the epidemic peaks during winters fol-
lowed by strong bottlenecks at the end of the winter season. We use

Logistic

splitHMC Bayesian Skyline Bayesian Skyride

 

 

 

Scaled Ne(t)
50 500 5000
III I II III I
5.0 50.0 5000
III I II III I
5.0 50.0 500.0
III I II III I

 

 

 

 

 

 

 

 

 

m. m. in.
O O O
I I I I I I I I I I I I I I I
20 15 1o 5 o 20 15 1o 5 o 20 15 1o 5 o
Exponential Growth
splitHMC Bayesian Skyline Bayesian Skyride

 

 

 

 

 

 

 

 

 

ScaledNe(t)
5e+01

II II II II
5e+01

II II II II
5e+01

II II II II

 

 

 

 

 

 

 

 

 

 

 

 

 

 

 

 

 

 

 

 

 

 

 

 

 

 

 

 

S S S
8 8 8
I I I I l l l l I I I I
8 6 4 2 o 8 6 4 2 o 8 6 4 2 o
Boombust
splitHMC Bayesian Skyline Bayesian Skyride
C I I I
\g ‘— _ ‘— _ ‘— _
z 9 - 9 — 9 -
-o 8 8 8
2 _ _ _
m _ _ _
O
"’ 5 ' § : § :
I» ' ID “’
L“ I I I I I L“ I I I I I L“ I I I I I
8 6 4 2 o 8 6 4 2 o 8 6 4 2 o
Bottleneck
splitHMC Bayesian Skyline Bayesian Skyride
C _ _ _
v O _ O _ O _
(D O _ O _ O _
z m' _ Ln' _ m _
E a : a : a :
8 o- _ o' _ O _
w I!) _ I!) _ I!) _
O. — O. — o —
o I I I I I I o l l l l l l o I I I I I I
3.0 2.0 1.0 0.0 3.0 2.0 1.0 0.0 3.0 2.0 1.0 0.0

Time (past to present) Time (past to present) Time (past to present)

Fig. 4. Comparison of recovered population size trajectories for the four simu-
lations using our splitHMC, Bayesian Skyline and Bayesian Skyride. Posterior
medians are displayed as bold black curves and shaded areas represent 95%
BCls. The truth is displayed as black thin line

9mg ‘09 1sn8nV uo sejeﬁuV SO’I ‘121u10111123 10 A1tSJeAtuf1 112 /810'S{12umo[p101x0'sot112u1101utotq/ﬁd11q 111011 pepeolumoq

3288

S.Lan et al.

 

Table 2. Sampling efficiency of MCMC algorithms in influenza data

 

 

 

 

 

 

 

 

 

 

 

 

 

 

 

 

 

 

 

 

 

 

 

 

 

 

 

 

 

 

 

 

 

 

 

 

 

 

 

 

 

 

 

 

Method AP s/Iter minESS spdup ESS spdup
(f)/s (f) (1)/s (1)
ES2 1.00 1.88E-03 0.15 1.00 0.57 1.00
MALA 0.79 1.28E-03 0.60 3.89 2.20 3.85
aMALA 0.79 8.61E-03 0.09 0.60 0.14 0.25
HMC 0.72 1.31E-02 2.06 13.34 1.72 3.03
splitHMC 0.79 1.05E-02 2.88 18.69 3.01 5.29
inﬂuenza
E ‘_ _
gm ‘
8 - _ _ _ _ r — INM   aMALA
, ‘ — HM:  ----5 Es2
,’ — splitHMC-in ----§ oput: HAL-3V1;
e - x —   
+1 I + I":- 'I' ++HIIHIIIIIITII-- ++  1.3.11.1..." .l S ‘H-H-I'HII'IIIIIII: 5
2000 2001 2002 2003 2004 2005

Time (past to present)

Fig. 5. Population dynamics of influenza A in New York (2001—2005): shaded
region is the 95% credible interval calculated with samples given by splitHMC
with CW. SplitHMC with CE: (red) is more conservative than splitHMC with
Can (dark green) in estimating the variation of population size trajectory

120 grid points in the likelihood approximation. The results de-
—1

picted in Figure 5 based on intrinsic precision matrix, C1n ,

are quite
comparable to that of INLA. However, estimates using splitHMC
with different covariances show that using Ci;1 is more conservative
than C134 in estimating the variation of population size trajectory.
In Table 2, we can see that the speedup by HMC and splitHMC

over other MCMC methods is substantial.

5 Discussion

Phylodynamic inference has become crucial in conservation biology,
epidemiology and other areas. Bayesian nonparametric methods
coupled with coalescent models provide a powerful framework to
infer changes in effective population sizes with many advantages.
One of the main advantages of Bayesian nonparametric methods
over traditional parametric methods that assume fixed functional
form of Ne(t), such as exponential growth (Kuhner et al., 1998), is
the ability of Bayesian nonparametric methods to recover any func-
tional form without any prior knowledge about Ne(t). With the
technological advance of powerful tools for genotyping individuals,
it is crucial to develop efficient methodologies that can be applied to
large number of samples and multiple genes.

In this article, we have proposed new HMC-based sampling al-
gorithms for phylodynamic inference. We have compared our meth-
ods to several alternative MCMC algorithms and showed that
they substantially improve computational efficiency of GP-based
Bayesian phylodynamics. (More results are provided in the
Supplementary Document.) Further, our analysis shows that our re-
sults are not sensitive to the prior specification for the precision par-
ameter K. This is inline with previously published results for similar
models (see Supplementary Material of Palacios and Minin, 2013).

To obtain the analytical solution of (14a) in splitHMC, we
—1
can, however, use the Cholesky decomposition instead Ci? 2 RTR

Eigen-decompose the precision matrix C sacrificing sparsity. One
and transform f* = Rf. This way, the dynamics (14a) would be
much simpler with the solution as a rotation (Pakman and Paninski,

—1
in 9

2014). Because R is also tridiagonal similar to C in theory the
computational cost of splitHMC could be reduced to (9(D). In prac-
tice, however, we found that this approach would work well when
the Hamiltonian (13) is mainly dominated by the middle term. This
condition does not hold for the examples discussed in this article.
Nevertheless, we have provided the corresponding splitHMC
method with Cholesky decomposition in the Supplementary File,
since it can still be used for situations where the middle term does in
fact dominate the overall Hamiltonian.

There are several possible future directions. One possibility is to
use ES2 as a proposal generating mechanism in updating f as
opposed to using it for sampling from the posterior distribution.
Finding a good proposal for K (or I), however, remains challenging.
Another possible direction it to allow K to be time dependent. When
there is rapid fluctuation in the population, one single precision par-
ameter K may not well capture the corresponding change in the la-
tent vector f. Our future work will include time-varying precision
K (t) or more informative covariance structure in modeling Gaussian
prior. Also, we can extend our existing work by allowing irregular
grids, which may be more suitable for rapidly changing population
dynamics.

Another important extension of the methods presented here is to
allow for multiple genes and genealogical uncertainty. The MCMC
methods proposed here can be incorporated into a hierarchical
framework to infer population size trajectories from sequence data
directly. In contrast, INLA cannot be adapted easily to perform in-
ference from sequence data. This greatly limits its generality.

Acknowledgements

We thank Jim Faulkner for his careful reading of the manuscript and useful
feedback. We also thank three anonymous referees for suggestions that im-
proved the exposition of this article.

Funding

J.A.P. acknowledges scholarship from CONACyT Mexico to pursue her re-
search work. This work was supported by NIH grant R01 A1107034 (to S.L.,
M.K., V.N.M. and BS), the NSF grant IIS-1216045 (to BS.) and the NIH
grant U54 GM111274 (to V.N.M.).

Conﬂict of Interest: none declared.

References

Besag,J. and Kooperberg,C. (1995) On conditional and intrinsic autoregres-
sions. Biometrika, 82, 733—746.

Drummond,A. et al. (2012) Bayesian phylogenetics with BEAUti and the
BEAST 1.7. Mol. Biol. Evol, 29, 1969—1973.

Drummond,A.]. et al. (2002) Estimating mutation parameters, population his-
tory and genealogy simultaneously from temporally spaced sequence data.
Genetics, 161, 1307—1320.

Drummond,A.]. et al. (2005) Bayesian coalescent inference of past population
dynamics from molecular sequences. Mol. Biol. Evol, 22, 1185—1192.

Duane,S. et al. (1987) Hybrid Monte Carlo. Phys. Lett. B, 195, 216—222.

Geyer,C.J. (1992) Practical Markov chain Monte Carlo. Stat. Sci., 7,
473—483.

Gill,M.S. et al. (2013) Improving Bayesian population dynamics inference: a
coalescent-based model for multiple loci. Mol. Biol. Evol, 30, 713—724.

9mg ‘09 1sn8nV uo sejeﬁuV SO’I ‘121u10111123 10 A1tSJeAtuf1 112 /810'S{12umo[p101x0'sot112u1101utotq/ﬁd11q 111011 pepeolumoq

Efficient Bayesian phylodynamics

3289

 

Girolami,M. and Calderhead,B. (2011) Riemann manifold Langevin and
Hamiltonian Monte Carlo methods. ]. R. Stat. Soc. B 73, 123—214.

Grifﬁths,R.C. and Tavare,S. (1994) Sampling theory for neutral alleles in a
varying environment. Philos. Trans. R. Soc. Lond. B Biol. Sci., 344,
403—410.

Heled,J. and Drummond,A. (2008) Bayesian inference of population size his-
tory from multiple loci. BMC Evol. Biol., 8, 289.

Kalman,R.E. (1960) A new approach to linear ﬁltering and prediction prob-
lems. Trans. ASME ]. Basic Eng, 82(Series D), 35—45.

Kingman,J. (1982) The coalescent. Stochastic Processes Appl., 13, 235—248.

Knorr-Held,L. and Rue,H. (2002) On block updating in Markov random ﬁeld
models for disease mapping. Scand. ]. Stat., 29, 597—614.

Kuhner,M.K. et al. (1998) Maximum likelihood estimation of population
growth rates based on the coalescent. Genetics, 149, 429—434.

Lan,S. (2013) Advanced Bayesian computational methods through geometric
techniques. Ph.D. dissertation, Copyright ProQuest, UMI Dissertations
Publishing 2013, M3.

Leimkuhler,B. and Reich,S. (2004) Simulating Hamiltonian Dynamics.
Cambridge University Press, New York.

Minin,V.N. et al. (2008) Smooth Skyride through a rough skyline: Bayesian
coalescent-based inference of population dynamics. Mol. Biol. Evol., 25,
1459—1471.

Mullen]. et al. (1998) Log Gaussian Cox processes. Scand. ]. Stat., 25:
451—482.

Murray,I. et al. (2010) Elliptical slice sampling. ]. Machine Learn. Res.
Workshop Conf. Proc., 9, 541—548.

Neal,R.M. (2010) MCMC using Hamiltonian dynamics. In: Brooks, S. et al.
(eds.) Handbook of Markov Chain Monte Carlo. Chapman and Hall/CRC,
Boca Raton, pp. 113—162.

Opgen-Rhein,R. et al. (2005) Inference of demographic history from genealogical
trees using reversible jump Markov chain Monte Carlo. BMC Evol. Biol. 5, 6.
Pakman,A. and Paninski,L. (2014) Exact Hamiltonian Monte Carlo for trun-

cated multivariate Gaussians. ]. Comput. Graphical Stat., 23, 518—542.

Palacios,J.A. and Minin,V.N. (2012) Integrated nested Laplace approximation
for Bayesian nonparametric phylodynamics. In: de Freitas,N. and
Murphy,K.P. (eds.) UAI. Catalina Island AUAI Press, pp. 726—735.

Palacios,J.A. and Minin,V.N. (2013) Gaussian process-based Bayesian non-
parametric inference of population size trajectories from gene genealogies.
Biometrics, 69, 8—18.

Rambaut,A. et al. (2008) The genomic and epidemiological dynamics of
human inﬂuenza A virus. Nature, 453, 615—619.

Roberts,G.O. and Stramer,O. (2002) Langevin diffusions and Metropolis-
Hastings algorithms. Methodol. Comput. Appl. Probability 4, 337—35 7.

Roberts,G.O. and Tweedie,R.L. (1996) Exponential convergence of Langevin
distributions and their discrete approximations. Bernoulli, 2: 341—363.

Rodrigo,A.G. and Felsenstein,]. (1999) Coalescent approaches to HIV popula-
tion genetics In: Crandall,K. (ed.) The Evolution of HIV, Johns Hopkins
Univ. Press, Baltimore, pp. 233—272.

Rue,H. and Held,L. (2005) Gaussian Markov Random Fields: Theory and
Applications, volume 104 of Monographs on Statistics and Applied
Probability. Chapman 86 Hall, London.

Rue,H. et al. (2009) Approximate Bayesian inference for latent Gaussian mod-
els by using integrated nested Laplace approximations. ]. R. Stat. Soc. B 71,
319—392.

Shahbaba,B. et al. (2013) Split Hamiltonian Monte Carlo. In: Statistics and
Computing, 24, 339—349.

Strimmer,K. and Pybus,O.G. (2001) Exploring the demographic history of DNA
sequences using the generalized skyline plot. Mol. Biol. Evol, 18, 2298—2305.

9mg ‘09 1sn8nV uo sejeﬁuV SO’I ‘121u10111123 10 A1tSJeAtuf1 112 /810'S{12umo[p101x0'sot112u1101utotq/ﬁd11q 111011 pepeolumoq

