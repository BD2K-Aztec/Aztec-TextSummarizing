Motivation: Random sampling of the solution space has emerged as a popular tool to explore and infer properties of large metabolic networks. However, conventional sampling approaches commonly used do not eliminate thermodynamically unfeasible loops. Results: In order to overcome this limitation, we developed an efficient sampling algorithm called loop less Artificially Centered hit and run on a Box ll achr b. This algorithm is inspired by the hit and run on a Box algorithm for uniform sampling from general regions, but employs the directions of choice approach of Artificially Centered hit and run. A novel strategy for generating feasible warm up points improved both sampling efficiency and mixing. ll achr b shows overall better performance than current strategies to generate feasible flux samples across several models. Furthermore, we demonstrate that a failure to eliminate unfeasible loops greatly affects sample statistics, in particular the correlation structure. Finally, we discuss recommendations for the interpretation of sampling results and possible algorithmic improvements. Availability and implementation: Source code for MATLAB and OCTAVE including examples are freely available for download at

introduction a diversity of computational methods referred to as constrained based methods has been developed to study the characteristics and capabilities of genome scale Models (GEMs). Uniform random sampling of the flux solution space is a popular choice for interrogation of GEMs without introducing optimality criteria. From evaluation of the impact of physiological constraints on the sampled flux distributions () to identification of transcriptional regulation (), definition of a flux backbone () and correlated reaction sets (), uniform sampling has been applied to explore achievable states and emergent properties of networks. More importantly, uniform sampling has emerged as an unbiased tool to assess the capabilities of metabolic reconstructions (). For this type of analysis to be valid, a key and often overlooked assumption is that the flux samples are thermodynamically feasible. GEMs are mathematically described by the stoichiometry matrix S m  n , which encodes the mass balances for m metabolites reacting in n biochemical reactions. The capacities of these reactions are phenomenologically limited by thermodynamic and kinetic constraints in the form of lower lb and upper ub bounds. Assuming steady state for metabolites accumulation, the vector of reaction fluxes v consistent with mass conservation is defined by the following set of constraints (Eqs. 1 and 2 the resulting flux space X defines a convex polytope describing the achievable states of the network. Sampling from this multi-dimensional body can be efficiently achieved using Markov Chain Monte Carlo (MCMC) methods such as the hit and run (HR) () and the 'Artificially Centered hit and run (ACHR) () algorithms. The latter method has been particularly preferred for sampling the irregularly shaped solution space of metabolic networks, as it explores elongated directions of X enabling in principle faster mixing. There are, however, additional constraints on v that ensure its thermodynamic feasibility. Let us denote N int the matrix storing the null space vectors of the internal reactions described by S int , and Dl int the vector of chemical potentials for these reactions. According to the first and second law of thermodynamics, v is thermodynamically feasible if for v int v (),Equations (3) and 4 guarantee respectively that the global potential energy of the network is balanced (first law), and that reactions proceed in the opposite direction of chemical potential change (second law). These two equations can be satisfied simultaneously only if the net flux around all closed loops is equal to zero, and hence it is commonly referred as the loop less condition'. Imposition of this condition generally causes the solution space X loop less to be non-convex, which is much harder to sample and so far no algorithm has been developed to do so. Instead, ad hoc methods using conventional samplers have been used to sample from X and then either remove samples with 'loopy' patterns (), or find the nearest feasible flux distribution (). Both approaches have disadvantages. The first approach may yield few feasible samples making it inefficient in high dimensional models, whereas the second approach is impractical in large models as it requires the solution of a non polynomial time MILP problem for each flux distribution. Here we present a scalable, direct sampling algorithm called loop less Artificially Centered hit and run on a Box ll achr b. This algorithm is motivated by a recent variation of the hit and run algorithm for uniform sampling from general regions (convex and non-convex) termed hit and run on a Box' (HRB) (), and employs directions of choice as in ACHR. The algorithm shows overall better performance than current strategies to generate thermodynamically feasible flux samples in several metabolic models ranging from small size models to GEMs. Finally, we report significant discrepancies in feasible and unfeasible sample statistics, highlighting the consequences of employing thermodynamically unfeasible samples for statistical inference.

discussion exact calculation of the volume of a large polytope is an p hard problem (), which leads to polynomial time approximate algorithms for convex bodies (). These algorithms typically rely on Monte Carlo sampling methods, and have proven to be particularly useful in the analysis of metabolic networks (). However, rigorous enforcement of thermodynamic feasibility of flux samples has so far been overlooked, as it greatly complicates sampling due to the imposition of non-convex constraints np hard problem). The significant differences in sample statistics when excluding unfeasible samples () highlights that thermodynamic feasibility can not be ignored without introducing significant errors. Here, we developed a scalable algorithm inspired by mature Monte Carlo samplers to incorporate this condition and generate only feasible samples. ll achr b outperforms the conventional ACHR where unfeasible loop laws are present, and even for models without potential unfeasible loop laws, ll achr b was as fast as ACHR (). Mixing is a concern when sampling in complicated spaces. Reimers (2015) reported a high frequency of reactions with only zero flux samples despite a non-zero flux range using ACHR to sample iJO1366. Using ll achr b we only found one blocked reaction in the iJO1366 model involved in an unfeasible loop. Apart from collecting a bigger sample, the main difference in our approach is the pre-processing of iJO1366, which first (a) compacted linear pathways and (b) removed trace elements from the biomass equation. The former reduces the dimension of the problem, while the latter should make the problem better conditioned. The inaccessible reaction in the core E.coli model (fumarate reductase) highlights that caution still is required when analysing sampling results. The loop less condition dictates that fumarate reductase can only be active under anaerobic conditions and this is indeed consistent with experimental data (). In this instance, fumarate reductase activity under anaerobic conditions can only be accurately captured, if the model is deliberately constrained for anaerobic growth, i.e. zero oxygen uptake supplementary panel A). Another illustrative example of the caution needed when analysing sampling results from ll achr b are. Comparison of sample statistics for the iRBC283 (A) and iJO1366r (B) models estimated respectively from 5  10 5 flux samples generated ignoring (ACHR) and enforcing ll achr b the loop less condition. left hand side panels compare the normalized flux means for reaction i, i.e. mean divided by flux range range (l i /R i ), whereas the right hand side panels compare non-redundant pairwise correlation coefficients between reactions i and j (q ij ) the two blocked reactions from iIT341 (reversible o succinyl homoserine lyaseshsl4r and l threonine deaminase thr dl supplementary panel B). Samples from ll achr b show these two perfectly coupled reactions to be blocked. By constraining these two reactions to zero, the unfeasible loop is avoided. notably have also studied this loop and have proposed to manually fix the directional ities of another two perfectly coupled reactions involved in it, namely, phospho trans acetyl ase p tar and acetate kines e ack r. This measure unblocks thr dl and SHSL4r and allows all reactions to carry flux avoiding the loop, however it massively constrains the flux range of p tar and ack r from 65.926 to 0.0169 mmol gdc wh. In this particular case, more experimental evidence is needed to decide between the alternatives. More importantly, these cases underscore the need for careful analysis of sampling results from ll achr b. We finish by mentioning possible improvements to the algorithm. de have recently reported efficient procedures for improving the performance of HR by finding an ellipsoid that closely matches the sampling space. By extracting directions from the surface of the matching ellipsoid, the performance of the traditional HR can be greatly improved. This strategy is convenient as HR guarantees convergence to the uniform distribution on the target space () as opposed to the non markovian ACHR directions choice. A combination of this strategy with the present algorithm would confer this desired guarantee; however, it is unclear how well it would scale in the case of a nonconvex space. This will be subject for future research.
