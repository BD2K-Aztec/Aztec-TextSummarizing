Motivation: Correlation between life history or ecological traits and genomic features such as nucleotide or amino acid composition can be used for reconstructing the evolutionary history of the traits of interest along phylogenies. Thus far, however, such ancestral reconstructions have been done using simple linear regression approaches that do not account for phylogenetic inertia. These reconstructions could instead be seen as a genuine comparative regression problem, such as formalized by classical generalized least square comparative methods , in which the trait of interest and the molecular predictor are represented as correlated Brownian characters co evolving along the phylogeny. Results: Here, a Bayesian sampler is introduced, representing an alternative and more efficient algorithmic solution to this comparative regression problem, compared with currently existing generalized least square approaches. Technically, ancestral trait reconstruction based on a molecular predictor is shown to be formally equivalent to a phylogenetic Kalman filter problem, for which backward and forward recursions are developed and implemented in the context of a Markov chain Monte Carlo sampler. The comparative regression method results in more accurate reconstructions and a more faithful representation of uncertainty, compared with simple linear regression. Application to the reconstruction of the evolution of optimal growth temperature in Archaea, using GC composition in ribosomal RNA stems and amino acid composition of a sample of protein coding genes, confirms previous findings, in particular, pointing to a hyperthermophilic ancestor for the kingdom. Availability and implementation: The program is freely available at www phylo bayes org
introduction there is a growing interest in reconstructing the evolutionary history of quantitative traits along phylogenies using information coming from genetic sequences. In those cases where the evolution of genes or genomes is influenced by ecological or life history traits, the ancestral sequences, which can be reconstructed over the tree using phylogenetic methods, will contain useful information about ancestral values of the trait. One of the first applications of this idea was to the reconstruction of ancestral optimal growth temperatures based on ribosomal RNA (rRNA) nucleotide composition (), or amino acid composition of the proteome (), although in principle, the same idea could be applied to other cellular, ecological or morphological traits that would correlate with genetic sequences. In its original formulation, the sequence trait correlation approach proceeds in several steps. First, the correlation between the trait and the molecular predictor (in the aforementioned example, the trait being temperature and the predictor rRNA or protein composition) is characterized in extant species. Typically, a regression analysis is conducted, yielding an estimate of the slope and the intercept of the linear regression of the trait against the predictor. Second, ancestral sequences, and thus ancestral values of the molecular predictor, are inferred using molecular phylogenetic methods. Finally, the values of the predictor inferred in the ancestors along the phylogeny are translated into estimates of ancestral traits, based on the regression. This approach is simple and straightforward to implement. One potential problem, however, is that it does not take into account phylogenetic inertia. In the present context, the phylogenetic structure underlying both the trait and the molecular predictor has at least two important consequences. First, the correlation measured in extant tax a between the trait and the molecular predictor should be corrected for the non independence between data points (). Second, ancestral reconstructions could possibly benefit from the fact that inertia effectively induces an intertemporal smoothing of the reconstruction across neighboring nodes along the phylogeny. An alternative to the stepwise regression method would be to use a fully integrated comparative and phylogenetic approach, modeling the joint correlated evolution of the trait and the sequences and conditioning the resulting hierarchical model simultaneously on genetic sequences and quantitative data (). This would account not only for phylogenetic inertia but also for all sources of uncertainty associated with the unknown parameters of the model. However, in some cases, proceeding in a stepwise manner, dividing the problem into smaller and computationally more manageable tasks, can be more practical. Also, some interesting situations, in particular involving trait dependent stabilizing selection on sequence composition, are not so easily modeled directly at the level of the substitution process, as they induce interdependence among sites of the alignment. A middle ground solution, explored here, still relies on a preliminary estimation of ancestral sequence compositions along the tree using a phylogenetic program. Thus, ancestral composition is here treated as known and inferred separately from the model to be presented later in the text. On the other hand, the estimation of the correlation between composition and trait and the ancestral reconstruction of the trait are merged into one single step, explicitly formalized as a comparative regression problem. Similar models have been developed in the context of generalized least square methods () and used for reconstructing, among other things, ancestral genome sizes of extinct lineages (). Once reconsidered in the context of the comparative method, the question is typically formulated in terms of a multivariate process jointly encompassing the trait of interest and the molecular predictor. Mathematically, a process Z(t) is defined, running along the branches of the phylogeny and combining the trait of interest X(t) and the molecular predictor Y(t). In the case of rRNA stems, X(t) would be the temperature, Y(t) some function of the GC content of RNA stems, so that Z(t) would be a bivariate process. In more general settings, both X(t) and Y(t) could themselves be multivariate. Under the Brownian assumption, the joint posterior distribution over the values of the trait X and the predictor Y over the phylogeny is multivariate normal and can be compactly represented using the Kronecker product formalism (e.g. as in). Conditioning this distribution on observed values for the trait and or the predictor at the relevant nodes of the phylogeny can be done by maximum likelihood, using multivariate normal theory and matrix calculus () or in a Bayesian Markov chain Monte Carlo (MCMC) context, using standard metropolis hastings algorithms (). Equivalently, standard multivariate normal theory allows for a reformulation of this model, such that the joint variation of the trait X and the predictor Y over the time interval t represented by a branch of the phylogenetic tree is written as follows where t and t are normally distributed residual errors and B is a linear operator. This reformulation suggests a hierarchical structure in which a (partially) hidden state, the trait X, evolves along the phylogeny according to its own Brownian generator, effectively undergoing discrete time transitions from one node of the tree (at time t) to the next (at time t  t) according to a multivariate normal kernel (the distribution of t ). Before each such transition, the process emits, along the branch just visited, an observable quantity, the predictor Yt  Yt  t  Yt, whose distribution linearly depends on the hidden states at both ends of the branch (through Xt  Xt  t  Xt). Based on the observed history of the predictor Y along the phylogeny and the observed values of X at the tips, the aim is to reconstruct the hidden evolutionary history of X. This reformulation suggests an analogy with hidden Markov models or, more specifically, as all distributions are normal, with what is known in particle filtering and tracking as the Kalman filter (). There are several differences between the classical Kalman filter and its phylogenetic counterpart introduced here. In particular, in the classical Kalman filter, the emitted state only depends on the current state, whereas in the phylogenetic model, the emitted state Yt depends on both the current and the previous hidden states. Also, the classical Kalman filter unfolds along a linear time frame, whereas the phylogenetic model is branched in time. However, these differences are minor and do not compromise the most important property of the Kalman filter, namely, its convenient analytical tractability, leading to simple and computationally efficient recursions for integrating and resampling hidden states along the phylogeny using dynamic programming methods and elementary matrix algebra. Importantly, such reconstructions will automatically integrate both the across time smoothing effect between neighboring nodes for the trait X(t) and the additional information provided by the local behavior of the predictor Yt about the local evolution of the trait X(t). The Kalman approach introduced here and the generalized least square approaches mentioned earlier in the text () are similar. The main difference is algorithmic, the Kalman filter having a globally lower algorithmic complexity than the algebraic and the metropolis hastings approaches, as will be detailed later in the text. In this article, the phylogenetic Kalman filter is introduced and formalized. Backward and forward recursions are established and are used in the context of a Bayesian MCMC sampler, as a Gibbs sampling method for updating the X component of the model. This Gibbs sampling approach is then combined with another previously described conjugate Gibbs sampling algorithm for updating the correlation matrix (). The combination of the two algorithms results in an efficient alternating Gibbs strategy for sampling from the joint posterior distribution over the unknown parameters. Finally, the phylogenetic Kalman filter is applied to the reconstruction of ancestral growth temperatures in Archaea.
