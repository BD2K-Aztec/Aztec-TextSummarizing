Motivation: The detection of positive selection is widely used to study gene and genome evolution, but its application remains limited by the high computational cost of existing implementations. We present a series of computational optimizations for more efficient estimation of the likelihood function on large scale phylogenetic problems. We illustrate our approach using the branch site model of codon evolution. Results: We introduce novel optimization techniques that substantially outperform both code ml from the PAML package and our previously optimized sequential version slim code ml. These techniques can also be applied to other likelihood based phylogeny software. Our implementation scales well for large numbers of codons and or species. It can therefore analyse substantially larger datasets than code ml. We evaluated fast code ml on different platforms and measured average sequential speedups of fast code ml single threaded versus code ml of up to 5.8, average speedups of fast code ml (multi-threaded) versus code ml on a single node (shared memory) of up to 36.9 for 12 CPU cores, and average speedups of the distributed fast code ml versus code ml of up to 170.9 on eight nodes (96 CPU cores in total).

introduction the development of evolutionary models has a long tradition in phylogenetics, and recent advances have enhanced our understanding of the molecular mechanisms involved. At the heart of these advances is the democratization of the use of the likelihood framework, which was made possible by algorithmic developments () and the wide availability of powerful computing platforms. The surge of genomic data is, however, pushing the limits of current implementations [e.g. ()] and demands for the developments of better and more efficient ways to compute the phylogenetic likelihood function (PLF). The development of codon models is a good example to illustrate these current challenges and the benefits that can be reached by improving the efficiency of current likelihood calculations (). There are clear advantages to use codon models in phylogenetics (), but these are currently not widely used because of the large computational burdens involved (). Further, the detection of positive selection has been facilitated by the development of new codon models. However, their application to genome scale data comprising a large number of species, or individuals in the case of population genomic studies, remains challenging. Thus, there exists an urgent need for improved implementations and novel optimization techniques to analyse emerging genomic datasets (). The prevalent approach for detecting positive selection in protein coding genes is to use Markov models of codon substitution to estimate the ratio of non-synonymous to synonymous changes along the branches of a phylogenetic tree (). The branch site model bsm section 84 allows to detect positive selection that affects a subset of codon sites for a subset of branches in a phylogenetic tree. This model is particularly useful to perform interspecific comparisons and is probably the most widely used approach for this specific purpose. The test compares a model that assumes positive selection on one branch or on a set of a priori specified branches (hypothesis H 1 ) with a null model that does not incorporate positive selection (hypothesis H 0 ). If the test is significant, the Bayes Empirical Bayes be b method is used to compute the posterior probability of each particular codon to evolve under positive selection along the specified branches (). In code ml the test is usually applied iteratively and independently to each branch of a given phylogenetic tree (). This approach is compute bound, and although alternatives have recently been proposed, the limiting factor of such analyses *To whom correspondence should be addressed.
