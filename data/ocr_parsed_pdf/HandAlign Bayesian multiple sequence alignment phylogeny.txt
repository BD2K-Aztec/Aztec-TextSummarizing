Vol. 28 no. 8 2012, pages 1170-1171
APP N doi:10.1093/bioinformatics/btsO58

 

Phylogenetics

Advance Access publication January 28, 2012

HandAlign: Bayesian multiple sequence alignment,
phylogeny and ancestral reconstruction

Oscar Westesson, Lars BarquistT and Ian Holmes*
Department of Bioengineering, University of California Berkeley, CA 94720, USA

Associate Editor: David Posada

 

ABSTRACT

Summary: We describe handalign, a software package for
Bayesian reconstruction of phylogenetic history. The underlying
model of sequence evolution describes indels and substitutions.
Alignments, trees and model parameters are all treated as jointly
dependent random variables and sampled via Metropolis—Hastings
Markov chain Monte Carlo (MCMC), enabling systematic statistical
parameter inference and hypothesis testing. handalign implements
several different MCMC proposal kernels, allows sampling from
arbitrary target distributions via Hastings ratios, and uses standard
file formats for trees, alignments and models.

Availability and Implementation: Installation and usage instructions
are at http : //biowiki . org/HandAlign

Contact: ihh@berkeley.edu

Supplementary information: Supplementary material is available at
Bioinformatics online.

Received on November 3, 2011; revised on January 18, 2012;
accepted on January 20, 2012

1 BACKGROUND

Multiple sequence alignments constitute a central part of many
bioinformatics workﬂows. Commonly, an alignment is built from
primary sequences, a tree is reconstructed from this alignment, and
various analyses are run using the alignment and/or tree.

This can be problematic for several reasons. First, inference of the
tree and alignment is likely to be uncertain: many alternative trees
or alignments may explain the data comparably well. Downstream
analyses that assume the tree and alignment to be true ignore this
uncertainty, and potentially inherit embedded bias and error.

Second, this ﬂow of information is circular: alignment algorithms
often (implicitly or explicitly) make use of a guide tree, while tree-
and model-ﬁtting algorithms typically use an alignment as input.
This leads to a Chicken-and-egg situation.

In attempted resolution of these problems, the ﬁeld of statistical
alignment methods uniﬁes alignment and tree-building as related
inference tasks under a phylogenetic likelihood function. The
handalign software is one such tool, building on a range of prior
work in this area (Bouchard-Cote et (11., 2009; Holmes and Bruno,
2001; Redelings and Suchard, 2005).

 

*To whom correspondence should be addressed.
lPresent address: Wellcome Trust Sanger Institute, Cambridge, UK.

2 SAMPLING ALIGNMENTS, TREES AND
PARAMETERS

handal ign implements a Bayesian model of sequence phylogeny
with separate substitution and indel components. To perform
inference of unknown variables (i.e. trees, ancestral sequences or
parameters) under this model, handalign makes use of Markov
chain Monte Carlo sampling (MCMC). We cannot directly observe
the indel history (H), tree (T) or evolutionary model parameters (9).
However, we can estimate their a posteriori probability distribution,
conditional on what we do observe: the extant sequences (S). That
is, we aim to sample (H, T, 9|S). Explicitly marginalizing H, T and
9 is infeasibly expensive: there are combinatorially many trees T
and histories H, and continuously varying parameters 9. MCMC
provides a powerful alternative way to sample from (H, T, 9|S) that is
often not much more expensive than computing the joint likelihood
of (H,T,9,S).

Informally, MCMC randomly walks the space of (H, T,9) tuples,
the number of steps spent at a particular tuple converging to the
posterior probability P(H , T, 9| S). The result is a series {(Hn , Tn , 9,,)}
of samples from the posterior.

Depending on the investigator’s goals, various analyses can then
be performed using the collection of tuples {(Hn, Tn,9,,)}. The
ensemble can be summarized with a single ‘consensus’ alignment
or tree, including conﬁdence levels (e.g. the probability that a given
subset of species form a monophyletic Clade, or that a given column
is correct). Alternatively, downstream computations can be averaged
over the ensemble: the sampled parameters can be used to estimate
modes and moments (e.g. the most likely indel rate), or detect
signatures of interest (e.g. positive selection).

As well as MCMC, handalign can perform a stochastic search
using the same underlying model, but returning a single best-guess
(H, T,9) rather than a collection of such tuples.

3 CAPABILITIES

Given unaligned PASTA-format sequences, or (optionally) an ‘initial guess”
in the form of a Stockholm-format alignment with an embedded Newick-
format tree. handalign performs N X |S| sampling steps (where |S| is
the number of input sequences). Each step uses one of the MCMC kernel
moves (described below) to update one of H ,T or 9. If requested (Via a
command-line option), the new tuple (H, T, 9) is logged to a ﬁle. If operated
in ‘Stochastic search” mode, a greedy local search is performed every K
samples to ﬁnd the most likely nearby alignment. After N X |S | samples, the
ﬁnal (H, T, 9) tuple is output in Stockholm+Newick format.

Indel models: the insertionideletion model is an afﬁne-gap transducer
approximation to a Long Indel birth-death process (Miklos at al., 2004)
with insertion rate A, deletion rate it, deletion extension probability r.

 

1170 © The Author 2012. Published by Oxford University Press. All rights reserved. For Permissions, please email: journals.permissions@oup.com

112 /3.Io's[Bumo[pJOJXO'sotwuiJOJutotqﬂ:duq 11101} popeolumoq

91oz ‘Og anﬁnv uo ::

HandAIign

 

The approximation is that indel events never overlap on the same branch.
Other indel length distributions, such as TKF91 or mixture-geometric, can
be used.

Substitution models: any parametric continuous-time Markov chain can be
used to model character evolution, Via the ﬁle format of the companion
program xrate. For instance, 2ON-state amino acid models (with N -Valued
hidden states) and 64-state codon models have been used. Parameters
of these substitution models can be sampled, allowing alignment-free
estimation of statistics such as Ka/KS. Ancestral characters are summed
out(Holmes and Bruno, 2001); they can be imputed using xrate.

Tree prior: the prior over tree topologies is uniform, with a weak exponential
prior over total branch length. Alternate priors can be implemented using
the ‘Arbitrary target distribution” mechanism.

Arbitrary target distribution: handalign allows any tree/alignment
probability model to be implemented over a Unix pipe and used in a
MetropolisiHastings accept/reject step.

MCMC kernel moves: the relative proportions of the various sampling
moves can be set on the command line. All are variants of Gibbs-sampling
moves. Some are full Gibbs (perfectly mixing the sampled variables at every
step); others utilize Metropolis-within-Gibbs or a variant of importance
sampling that includes the current point in the list of accessible points.
The individual moves vary in the dependence of their complexities on the
input sequence length, L. The worst-case complexity with default settings
is (9(L2), comparable to BaliPhy (Redelings and Suchard, 2005).

Stochastic search: handalign can be used to do a partially randomized
greedy search, yielding a relatively quick, approximate maximum likelihood
estimate for the alignment and/0r tree, in addition to a full MCMC trace.
The iterative reﬁnement command-line option interrupts the MCMC run
periodically to perform a greedy (Viterbi) search for the locally maximal
alignment close to the current sample.

Alignment banding: as the DP matrix may be costly to ﬁll, both in time and
memory, users may specify an alignment ‘band’ as a heuristic constraint.
Command-line options can be used to prevent Visiting cells more than M
positions away from the current alignment path. This has the effect of
causing indels longer than M to be excluded, but is otherwise ergodic, and
generally converts an (9(L") step into an O(LM"‘1) step (for a Z 2).

HMMoC adapter: handalign can optionally make use of the Hidden
Markov Model Compiler hrnmoc to craft optimized C++ code for DP-based
sampling steps. This typically speeds things up by a large constant factor.

MCMC trace analysis: the DART package includes several scripts for
summarizing MCMC traces. cons tock.pl ﬁnds a consensus alignment
and uses ANSI terminal color to render posterior probabilities of
individual columns (Fig. 1). Alternatively, trees can be extracted using
stocktree.pl and a separate program, such as CONSENSE in
the PHYLIP package, used to estimate consensus trees. handalign
sampling traces use Stockholm alignment format to embed trees and
parameters. A trace can be rendered as an ANSI terminal color
animation using stockfilm.pl, converted into other common formats
(see http://biowiki.org/StockholmTools) or the parameters
extracted and their distribution analyzed (Fig. 2).

Current limitations and performance: the (9(L2) complexity may
be limiting for longer sequences (e.g. genomes); alignment banding
should ameliorate this (but its effect on mixing performance is
untested). Underﬂow/precision issues may potentially be an issue with
larger trees. A ongoing compilation of comparison tests is here:
http: / /biowiki . org/HandAlignBenchmark

 

Fig. 1. A summary alignment of SIV/HIV gp120 proteins produced by
constock.pl. Posterior probabilities of alignment columns are shown
on the ‘PP’ line (most signiﬁcant decimal digit) and by ANSI terminal color
(white-on-cyan is most reliable, blue-on-black is least). Hypervariable (hV)
region 5 [Leonard et al. (1990)] corresponds with a low-conﬁdence region.

LIBDSEU'Zi'b '.Ime Nil
30 45 ED 75 90

 

Ila

Posterior

 ill I I r ‘ﬁnsiw
 Mu Hnil" ll lW  lllll Ill H ll /.,,....,:>

Indel rate
one

004

 

5m :50 muo woo !50[I H50 rum
Sample ind ex

Fig. 2. The indel rate of the SIV/HIV gp120 protein has most of its
probability mass concentrated between 0.04 and 0.06 indels per substitution.
handalign was run for 90 min on a 3.4 GHz CPU, generating 2000
samples (500 discarded as burn-in). Every ﬁfth sample is plotted; the entire
trace was used to estimate the density.

ACKNOWLEDGEMENTS

The authors thank Benjamin Redelings, Marc Suchard, Jotun Hein,
Joe Herman, Alexandre Bouchard-Cote and many others working in
statistical alignment for their illuminating discussions.

Funding: National Institutes of Health/National Human Genome
Research Institute grant (R01-GM076705).

Conﬂict of Interest: none declared.

REFERENCES

Bouchard-Coté,A. et al. (2009) Efﬁcient inference in phylogenetic InDel trees. In
Advances in Neural Information Processing Systems 21 (NIPS), Vancouver, Canada.

Holmes,I. and Bruno,W.J. (2001) Evolutionary HMMs: a Bayesian approach to multiple
alignment. Bioinformatics, 17, 8037820.

Leonard,C. et al. (1990) Assignment of intrachain disulﬂde bonds and characterization
of potential glycosylation sites of the type 1 recombinant human immunodeﬁciency
virus envelope glycoprotein (gp120) expressed in Chinese hamster ovary cells. J.
ofBiol. Chem, 265, 10373.

Miklos,I. et al. (2004) A long indel model for evolutionary sequence alignment. Mol.
Biol. Evol., 21, 5294540.

Redelings,B.D. and Suchard,M.A. (2005) Joint Bayesian estimation of alignment and
phylogeny. Systematic Biol, 54, 401418.

Note: References truncated to comply with page limit. See
Supplementary Material for complete bibliography.

 

1171

112 /3.Io's[BumoIpJOJXO'sorwurJOJurorq”:duq urori popeolumoq

9103 ‘Og isnﬁnv uo ::

