Vol. 28 no. 15 2012, pages 2088-2090
APP N doi:10.1093/bioinformatics/bt3308

 

Systems biology

Advance Access publication May 26, 2012

BATMAN—an R package for the automated quantification of
metabolites from nuclear magnetic resonance spectra using a

Bayesian model

Jie Haol, William Astle2, Maria De Iorio3 and Timothy M D Ebbelsla*

1 Section of Biomolecular Medicine, Department of Surgery and Cancer, Faculty of Medicine, Sir Alexander Fleming
Building, Imperial College London, London SW7 2AZ, UK, 2Department of Epidemiology, Biostatistios and
Occupational Health, McGill University, Purvis Hall, 1020 Ave. des Pins Ouest, Montr al, Ou bec, HSA 1A2, Canada
and 3Department of Statistical Science, University College, Gower Street, London WC1 E 6BT, UK

Associate Editor: Olga Troyanskaya

 

ABSTRACT

Motivation: Nuclear Magnetic Resonance (NMR) spectra are widely
used in metabolomics to obtain metabolite profiles in complex
biological mixtures. Common methods used to assign and estimate
concentrations of metabolites involve either an expert manual peak
fitting or extra pre-processing steps, such as peak alignment and
binning. Peak fitting is very time consuming and is subject to human
error. Conversely, alignment and binning can introduce artefacts and
limit immediate biological interpretation of models.

Results: We present the Bayesian automated metabolite analyser
for NMR spectra (BATMAN), an R package that deconvolutes peaks
from one-dimensional NMR spectra, automatically assigns them to
specific metabolites from a target list and obtains concentration
estimates. The Bayesian model incorporates information on
characteristic peak patterns of metabolites and is able to account
for shifts in the position of peaks commonly seen in NMR spectra of
biological samples. It applies a Markov chain Monte Carlo algorithm
to sample from a joint posterior distribution of the model parameters
and obtains concentration estimates with reduced error compared
with conventional numerical integration and comparable to manual
deconvolution by experienced spectroscopists.

Availability and implementation: http://www1.imperial.ac.uk/
medicine/people/t.ebbels/

Contact: t.ebbels@imperial.ac.uk

Received on January 24, 2012; revised on May 15, 2012; accepted
on May 18,2012

1 INTRODUCTION

Nuclear Magnetic Resonance (NMR) spectroscopy is widely used
in metabolomics to provide information on metabolite proﬁles of
complex biological mixtures, such as bioﬂuids or tissue samples.
These spectra commonly contain around a thousand peaks from
possibly hundreds of metabolites. The concentrations of metabolites
are useful in biomarker discovery, investigating the aetiology of
disease and in understanding fundamental biological processes.
Quantitative measurement of metabolite abundances from NMR
spectra is complicated due to shifting peak positions, peak overlap,
noise and effects of the biological matrix.

 

*To whom correspondence should be addressed.

Excellent solutions to manual peak ﬁtting exist (Weljie et (11.,
2006); however, this option is time consuming and is subject to
human error and bias (Tredwell et (11., 2011). The R package BQuant
(Zheng et (11., 2011) attempts to quantify metabolites from NMR
spectra using Bayesian model selection. However, it is a two-step
procedure that requires spectra to be pre-aligned and partitioned
into bins. Consequently, it is awkward to apply as it is not fully
automated. Peak shifts are not incorporated into the statistical
model, which may lead to suboptimal estimates of metabolite
concentrations, especially in crowded regions.

Herein, we present the R package Bayesian automated metabolite
analyser for NMR spectra (BATMAN) that implements a Bayesian
model for 1H NMR spectra (Astle et (11., 2012) and a Markov
Chain Monte Carlo (MCMC) algorithm to automate metabolite
quantiﬁcation from NMR spectral data. BATMAN is able to
automatically assign peaks to metabolites given a target metabolite
list and Chemical shift region(s) speciﬁed by the user.

2 METHODS

An NMR spectrum. y. can be considered as a linear combination of
metabolite peaks plus noise. Metabolite peaks can be labelled catalogued
or uncatalogued. according to whether their characteristic peak patterns
are known to the user. We propose a two-component joint model for the
catalogued yo and uncatalogued y“ metabolites as follows:

y=yc+y“+8. 8~N(0.I/A). (1)

where I is the identity matrix and A is a scalar precision parameter.
The signal from the catalogued metabolites. y‘. can be modelled as a
weighted summation of M metabolite templates

M
yo = Z Ztmu(gmu )ﬁm v (2)

111:] M

where vector tmu is a template spectrum of the nth multiplet belonging to the
mth metabolite. emu is the chemical shift parameter for the corresponding
multiplet and ﬁn, is proportional to the concentration of the mth metabolite.
The priors for emu and 5», are truncated normal distributions.

The template spectrum. tmu . in turn is generated as a weighted summation
of Lorentzian peaks. By default. BATMAN obtains this prior information on
the peak pattern from the Human Metabolome Database (Wishart et al..
2009).

We model the Lorentzian peak width y,,, as

1110411) = M + Vm v (3)

 

2088 © The Author 2012. Published by Oxford University Press. All rights reserved. For Permissions, please email: journals.permissions@oup.com

112 /3.Io's[Bruno[pJOJXO'sotwurJOJutotqﬂ:duq wort papBOIII/lAOG

9103 ‘Og anﬁnv uo ::

Automated quantification of metabolites

 

E

Dngmal Spat-mum
— Malabohles Fl!
Wavﬂel Fl!
Fl‘ Sum
— — Suntan-n acid
— — cane and
— - Ono-nlutanc acid
Hlpounc acid
— - Dumunyiamme
' Dmnyvgrynnc
' Creatmirl:
— — Cream-u:
— — Taurlrl:
— — Trmerhwamme cuer
— — vans-Ac crime sand

60

 

Slandardized Intensity
4U

20

(b)

_ _ _..1 _._

4103 4102 —D.D1

 

ppm shiﬂ

Dlmﬂhylamlnc a! 2.730 ppm
2 5m. a 9? 51's. quanhlol I

 

0.505

Fig. 1. Typical BATMAN result on a 1H NMR spectrum of rat urine. (3) Mean posterior ﬁt (inset: zoom for 3.257329 ppm). (b) Posterior distribution of

K

I

l l

r, l 
2' V] .x. j‘m. _f-F'Pkm. 1' -.‘

3.65 ' 2.55 ' 2.55 ' 2'75

ll "

 

' 2.55 ' 2.55 2.l15 ' 2.35 '

ppm

(oleﬁ- a.
D 0

:8  I:

Ea  Ea. .
i=1 5 $6 1—
83. | I a l
83 [—1 8

EN  321%-

E : ﬂ'

a?  e°_ 3
§- i e e
r: ' ci'

Hippuric acid Dimethylamine

chemical shift difference from catalogued position for multiplets of hippuric acid and dimethylamine. (c) Posterior distribution of relative concentration for

the two metabolites

where it represents the spectrum wide average and v,” is a random effect,
representing metabolite speciﬁc deviations from it. Our priors for p. and v,”
are both Gaussian.

Signal generated by uncatalogued metabolites, y“, is modelled as a linear
combination of wavelet basis functions (W). This alleviates difﬁculties
associated with the incompleteness of the spectral library that can inﬂuence
other methods (Mercier et al., 2011). A probability density model is speciﬁed
in the wavelet domain of the data, i.e. 9 EW y“. We use symlet-6 wavelet
basis functions as they are well suited to modelling Lorentzian peaks (Astle
et al., 2012).

The distribution of 9 is modelled by a truncated Gaussian, whose
parameters are speciﬁed by the parameters A, III and r. The hyperparameter
vector 1]! ~ Garnma(c,d/2) allows the prior precision associated with each
wavelet deviate from the global precision 1 ~ Garnma(a,b/2). I is a
truncation limit vector where each If has a Gaussian distribution left truncated
at a small negative value it.

3 IMPLEMENTATION

A Markov Chain Monte Carlo (MCMC) algorithm is proposed to
sample from the joint posterior distribution of the model parameters.
We temper the likelihood and penalize the wavelet component of the
model stringently to move the chain into a region of good posterior
support in the burn in stage of the MCMC. We introduce block
updates for ﬂ jointly with 0, and for emu jointly with 0 to allow
the chain to make global moves. The details are described in Astle
et al. (2012). Adaptation techniques are used to update the peak shift
emu and width parameters ym. The core algorithm is implemented in
C++ language with support for parallel processing between spectra
to improve the processing speed. R version 2.12.1 (or higher),
together with the R packages described in the documentation, is
required. BATMAN runs on Windows, Mac OS X and Linux/Unix
operating systems and supports text ﬁle, R data format and 1D

Bruker spectral data ﬁles as input. Processing 8 spectra on an
Intel 3.0GHz Quad-Core 2 processor machine with 11 catalogued
metabolites region from 2.3 to 4.1 ppm took approximately 22 min.
The MCMC procedure ran for 2000 iterations following a 4000
iteration burn in. The time required scales linearly with the number
both of metabolites and spectra (on a multicore machine, multiple
spectra can be analysed in parallel with the same run time as a single
spectrum analysis).

4 RESULTS

Figure 1 shows an example result of a BATMAN ﬁt of a 1H NMR
spectrum of normal rat urine. The catalogued metabolite peaks are
correctly ﬁt by the algorithm, with uncatalogued peaks absorbed
by the wavelet component. The unimodality of peak position and
concentration distributions indicate no ambiguity in the assignments.
The BATMAN deconvolution has been shown to have reduced mean
estimation error compared with conventional numerical integration
methods and its results on an example dataset ﬁtting 26 metabolites
are comparable with the manual deconvolution by ﬁve experienced
NMR spectroscopists as described by Astle et al. (2012).

Funding: This work was ﬁinded by grant BB/E020372/1 from
the UK Biotechnology and Biological Sciences Research Council
(BBSRC).

Conﬂict of Interest: none declared.

REFERENCES

Astle,W. et at. (2012) A Bayesian model of NMR spectra for the deconvolution and
quantiﬁcation of metabolites in complex biological mixtures. J. Am. Stat. Assoc, in
press. The accepted version can be found at http://arxiv.org/abs/1105.2204

 

2089

112 /3.IO'S[1211anprOJXO'SOTJBLUJOJIItOTq”Idllq wort papeolumoq

9103 ‘Og isnﬁnv uo ::

J.Hao et al.

 

Mercier,P. et al. (2011) Towards automatic metabolomic proﬁling of high-resolution
one-dimensional proton NMR spectra. J. Biomol. NMR, 49, 3077323.

Tredwe11,G.D. et al. (2011) Between-Person comparison of metabolite ﬁtting for NMR-
based quantitative metabolomics. Anal. Chem, 83, 868378687.

Weljie,A.M. et al. (2006) Targeted proﬁling: quantitative analysis of 1H NMR
metabolomics data. Anal. Chem, 78, 44304442.

Wishart,D.S. et al. (2009) HMDB: a knowledgebase for the human metabolome. Nucleic
Acids Res, 37, D6037D610.

Zheng,C. et al. (2011) Identiﬁcation and quantiﬁcation of metabolites in 11-1 NMR
spectra by Bayesian model selection. Biolnformatics, 27, 163771644.

 

2090

112 /3.Io's[Bumo[pJOJXO'soneurJOJHtotqﬂ:duq uror} papeo1umoq

9103 ‘0g isnﬁnv uo ::

