BIOINFORMA TICS

0'so;112u110}u101q//2duq

SIBumoprOJX

£10"

55,2kgowsmoddmmowoio~&o:~=£¢o~m\

 

T.G. Vaughan et al.

 

The inference framework centres around the following
expansion:

P(E, ty, M, H, m,  t], 

(1)
0( PF(S|E, t, u)P(E, ty, MltI, L, m, 9)P(u, m, 9).

The ﬁrst term PF(S|E, t, u) is the probability of the sequence
alignment and can be efﬁciently evaluated using Felsenstein’s
pruning algorithm (Felsenstein, 1981). The second term
captures the joint probability of the genealogy and the type
mapping, conditional on the number of samples, their types
and the times at which they were recorded, and the demographic
model parameters. This is given by the structured coalescent, as
discussed below. The ﬁnal term is the joint prior for all model
parameters and can be factorized into P(u)P(m)P(0).

Our goal here is to use MCMC to draw samples from
Equation (1), thus allowing us to uncover what the data have
to say about the structured tree and the demographic and evo—
lutionary model parameters.

2.3 The structured coalescent probability density

The structured coalescent, allowing for serially sampled se—
quences as detailed by Ewing et a]. (2004), assumes the following
demographic model. A discrete set of connected subpopulations
D with sizes Nd for d e D are evolving under a WrightiFisher
model in which each generation of length g is divided into two
stages. In the first stage, each haploid individual in the model
migrates from its current location/type d to a new location a”
with probability (Md/g, or remains in the same subpopulation
with probability 1 — Z d, e D\ d qdd/ g. In the second stage, Nd indi—
viduals are sampled with replacement from the occupants of each
subpopulation following stage 1, with the sampled individuals
forming the next generation.

To express the probability density of a structured tree under
this model, we require the following additional definitions. First,
we divide the period spanned by the tree into B adjacent intervals
of lengths 1:1, 1:2, . . .,1:B such that 25:1 Ta = t,. where t, is the age
of the root. Each interval is bracketed by a pair of consecutive
‘events’, each of which may be a ‘coalescent’, ‘migration’ or
‘sampling’ event. Coalescent events correspond to internal
nodes i 6 Y, migrations correspond to discontinuities in the
type functions (pm/>0) and sampling events correspond to leaf
nodes x e I. The total number of migration events from the a“
type to the (I type in M is given by viz,” while the total number of
coalescent events (i.e. internal tree nodes) occurring in type d is
vfi. Finally, the number of tree edges (1', j) for which (pm/>0) = d
for t in interval 0: is given by kmd. All of this information is
readily available from T as defined previously.

The probability density of the components of the structured
tree before conditioning on the sequence data is then given by

P(E7tY7M|tI7L7m7e) =

B kg“; 1
exp —Zmz 6—d+koc,d Z mdd’ (2)

on:l deD 2 d’eD\d

( )W 1 Vii
x m / cm’ —
dd 0,,

where 0,, 2 Mg are population sizes scaled by the generation
length and mdd’ E (Gd/0d,)qd/d are the immigration rates into (I
from a“ (per individual in a“). (This is essentially Equation (3)
from Beerli and Felsenstein (2001) but allowing for heterochro—
nous leaves.)

The structured coalescent, as well as other models including
the reversible Markov model used by Lemey et a]. (2009), im—
poses the following additional constraint on the structured
tree beyond those laid out in section 2.1: that the type functions
for all edges meeting at node i possess the same value at ti.
Formally,

<ﬂ<i,i,,>(ti) = (p(i(.],i)(ti) = (p(i(.,,i)(ti) (3)

where ip, i6, and it, are the parent, left child and right child of 1',
respectively.

3 MCMC SAMPLING ALGORITHM

As outlined above, our goal here is to use MCMC to efﬁciently
draw samples from the joint posterior Equation (1) over the state
space spanned by x = (E, ty, M, u, m, 0). To perform efﬁciently,
MCMC sampling algorithms need to be able to (i) rapidly cal—
culate the value of a target distribution for a particular state x
and (ii) propose new states x’ that are far enough from the cur—
rent state for state space to be explored relatively quickly but not
so far that the proposal acceptance rate becomes low.

Much of this problem is solved by existing methods. For re—
versible substitution processes, the probability of the sequence
alignment given the tree can be efﬁciently evaluated using the
pruning algorithm (Felsenstein, 1981). For inference under the
structured coalescent, the density of the structured genealogy can
be evaluated very simply by directly applying Equation (2),
which scales according to the number of ‘events’ (coalescent,
migration and sampling) making up the tree. The prior densities
for the parameters (u,m,0) are usually chosen to be standard
functions for which numerical evaluation is straightforward. In
terms of state proposal, standard proposal distributions for sam—
pling distributions over real numbers can be used to propose new
parameter combinations.

The remaining component is a set of proposal operators that
allow exploration of those regions of T space that have ﬁnite
support under the structured coalescent. As noted above, this has
been addressed in two distinct ways by Beerli and Felsenstein
(1999) and Ewing et a]. (2004). Here we introduce a novel set of
operators that directly builds on an existing set of unstructured
phylogenetic tree operators (Drummond et al., 2002) that form
the basis for the phylogenetics package BEAST (Bouckaert et al.,
2014; Drummond and Rambaut, 2007; Drummond et al., 2012)
and as such have been shown capable of eff1ciently traversing the
space of (E, ty).

3.1 Structured tree operator design strategy
Our general operator construction strategy involves the
following:

(1) the application of an existing unstructured tree operator,
mapping (E. tY)—>(E‘, t‘Y), followed by

 

2274

ﬁm'spzumofpmjxo'sopnuuopnorq/ﬁdnq

Efficient Bayesian inference under the structured coalescent

 

(2) the application of an edge type function proposal, which
produces type functions (pat/4) e M ’ for a subset of the
edges (1', j) e E‘ to ensure Equation (3) is satisﬁed at all
nodes.

New type functions are proposed by using a backward—in—time
continuous—time Markov chain (CTMC) to describe the type—
change process along an edge, with the type transition rate
matrix ﬁxed to the jointly estimated structured coalescent immi—
gration rate matrix m. We deﬁne the CTMC in terms of the
probability of the edge taking a particular type given the type
at the most recent node, p(d, t) E P(<p<,~,j>(t) = dl<p<,~,j>(t,~) = (1,), by
way of the following master equation:

0' /
E14077 t) =  mdd’p(d 7 t) (4)
d eD
where we deﬁne mm = —Zd,eD\d mddu

Drawing type—space paths from Equation (4) is straightfor—
ward (Gillespie, 1976, 1977). However, to ensure Equation (3)
is satisﬁed, we need to be able to draw paths from the CTMC
conditioned on the type d,- and d,- at ‘both’ ends of an edge (1', j).
To do this, we use the uniformization—based scheme of
Fearnhead and Sherlock (2006). (A useful summary is provided
by Rodrigue et a]. (2008).)

This method involves deﬁning a ‘uniformized’ version of the
process that has a uniform intensity A = max d[—mdd] over the
length of an edge. This is accomplished by allowing for ‘do noth—
ing’ transitions that are not associated with a type change. This
means that the number of transition events and the time at which
the events occur do not depend on exactly which transitions occur.
We can therefore sample these aspects of the type function ﬁrst.

The number of ‘virtual’ events 11,, which includes the ‘do noth—
ing’ transitions, is distributed according to

P("v)[R""ld,-,dj

[€MAldhdj

P(nv|d:v dz) = (5)
where A = If — t,~, P(nv) is a Poissonian with rate parameter AA,
R is the stochastic matrix m/A + I and eMA is a matrix exponen—
tial. We sample from this distribution using the technique
described in Section 2 of the Supplementary Material, then
sample the event times by uniformly selecting 11, times from the
interval [ti,t_,-] and sorting the result.

The remaining problem of sampling the transition types them—
selves is equivalent to sampling paths of a discrete time Markov
chain conditional on the end states, and is addressed using the
standard forwardibackward algorithm (Baum et al., 1970).

One difﬁculty with this approach is its reliance on the matrix
exponential 6’”. Identifying general numerical approaches to
matrix exponentiation is known to be problematic (Moler and
Van Loan, 2003). We use the scaled Pade approximation method
as implemented in the Java library jblas (http://mikiobraun.
github.io/jblas), which generally performs well. However, in our
experience it can become unreliable when very large and
very small (yet non—zero) migration rates exist in the same
matrix. For some data and prior combinations, it may therefore
be necessary to temporarily switch to an alternative proposal
mechanism when the MCMC chain strays into problematic
regions.

3.2 Proposal acceptance probabilities

Non—unitary proposal acceptance probabilities are integral to the
MetropolisiHastings MCMC algorithm. For a given proposal
operator op, a proposed state x‘ is accepted with the probability

f (x ‘)
ﬂx)

where f(x) is the target density and pop(x’|x) is what we refer to
as the HastingsiGreen factor (HGF%a generalization of the
usual Hastings ratio to reversible jump MCMC operators
(Green, 1995).

To calculate the HGF for each of our new operators, we need
to be able to determine the probability density with which a
particular type—change path is proposed. This density is given by

P(<ﬂ<i,/> Idi)
P911101)

 

pope/m) (6)

ocop(x‘, x) = min(1,

P(‘P<r./> ldrv 4/) = (7)

Here P(<p<,~,j> |d,~) is the probability of the CTMC path conditional
only on the most recent type, which can be derived directly from
Equation (4) and is a simple product of exponential waiting time
factors and transition rates. The denominator P(a",«|d,~) is the total
transition probability over the length of the edge and may be
computed using the same matrix exponential eMA used in the
previous section.

3.3 Structured tree operators

As described above, the tree—speciﬁc operators present in our
sampler are straightforward extensions of the unstructured tree
operators described by Drummond et a]. (2002). They include
the following:

o The ‘WilsoniBalding’ move (Wilson and Balding, 1998),
which disconnects a subtree and reattaches it at a randomly
chosen location on the rest of the tree. Our extension re—
quires generating a type function for the new connecting
edge.

0 The ‘subtree exchange’ move, which chooses two subtrees
and switches the points at which they connect to the rest of
tree. Again, our extension requires generating a type func—
tion for each of the two new edges.

0 A ‘node height shifting’ move, which repositions a randomly
selected internal node by drawing from a uniform distribu—
tion between its oldest child and its parent. Our implemen—
tation randomly selects a new type for the selected node and
then generates three new type functionsione for each of the
connecting edges.

0 A ‘tree height scaling’ move, which does not alter the top—
ology but instead scales the age of each node by a randomly
chosen factor. Our extension does not generate new type
functions but merely scales the times of the type changes
in the same way. This move is also used by Ewing et a].
(2004).

In addition, we include a ‘node retype’ operator, which selects
a new type for an internal node and generates new type functions

 

2275

ﬁm'spzumofpmjxo'sopnuuopnorq/ﬁdnq

 

:39\Ewowsmoaﬁmowoxmoagoﬁsambwﬁ

53x\Ewogmoizmnnw.oxmoagoﬁsiwbwﬁ

T.G. Vaughan et aI.

 

is particularly striking in the case of the 1,. parameter, for which
our method produced at least an order of magnitude as many
effective samples per unit time as our implementation of the
previously published method.

We therefore ﬁnd that the new operators presented here gen-
erally outperform our implementation of the Ewing at a]. (2004)
operators, in spite of the additional computational complexity of
our proposals.

4.4 Comparison with Migrate-n

Migrate-n (Beerli and Felsenstein, 1999, 2001; Beerli, 2006) has
long been a popular tool for performing both Bayesian and max-
imum-likelihood analysis under the structured coalescent. There
are numerous differences between the MCMC sampler presented
here and Migrate-n: we focus on providing the capability to per-
form joint estimation of heterochronous structured trees, demo-
graphic model parameters and substitution model parameters,
while Migrate-n excels at demographic model parameter infer-
ence for trees with ﬁxed clock rates or times expressed relative to
an unknown substitution rate.

Despite this, it is possible to analyse some datasets under
exactly equivalent assumptions in both packages. In Section 6
of the Supplementary Material, we directly compare sampled
posteriors obtained for model parameters from heterochronous
sequence datasets simulated under 2 and 3 deme models, assum-
ing a known clock rate Ito, and ﬁnd perfect agreement. Given
the complete independence of these implementations, this is ex-
tremely strong evidence that both samplers are implemented
correctly.

4.5 Application to global inﬂuenza epidemics

To assess the usefulness of our sampling strategy and its imple-
mentation in the context of real genetic data, we address the
problem of inferring global dynamics of inﬂuenza epidemics
from genetic data. To do this, we assembled 980 H3N2 1.6kb
HA sequences from NCBI GenBank, which were isolated from
humans in Hong Kong (11 = 220), New York (11 = 320) and New
Zealand (11 2440) between the years 2000 and 2006. (Accession
numbers, sampling times and locations are tabulated in the
Supplementary Material.) These locations were chosen to be rep-
resentative of northern, southern and equatorial regions having
human population sizes of comparable order ofmagnitude, while
the sampling time boundaries were chosen to ensure a roughly
even temporal and spatial distribution of samples. Additionally,
these locations and times allow comparison with the study of
global H3N2 dynamics conducted by Bedford 61 a]. (2010).

The data were analysed under a 3 deme structured coalescent
model with a GTR+F nucleotide substitution model and a strict
molecular clock. As for the simulated data, the heterochronous
sampling times and rapid evolution of influenza allowed for joint
estimation of the clock rate, Ito. Broad log-normal priors log N
(0, 4) were used for all population size and rate parameters. Due
to the large size of the data set, the MCMC algorithm was run
for 3.7 x 108 iterations to ensure adequate mixing, giving a “min-
imum’ ESS across the sampled parameters of ~150. Two add-
itional chains of 3.3 ><108 iterations each were run to assess
convergence. (See Section 7 of the Supplementary Material for
details, the full set of results and E55 estimates.)

  
 
 
   
  

Location

I Hong Kong
I NewZeaIand
I NewYork

 

 

 

 

 

 

(b)
E I
§ -
E —
I—I—I—I—I
Root location probability
(C) (d)
E §' _
g 2
0) d)
D Q _
I I I _ I
0 1 2 3 4 0.005
6 P4)
I I I I I I I I I
1998 1999 2000 2001 2002 2003 2004 2005 2006
Year

Fig. 5. Summary of results from spatial H3N 2 influenza analysis, includ—
ing (a) the 980 taxon maximum sampled posterior structured tree, the
sampled posterior probability distributions for (b) the root location,
(c) the subpopulation sizes and (d) the base substitution rate (substitu—
tionsisiteiyear). The grey lines in (c) and (d) show the visible portions of
the log AI’(0, 4) prior used for all of these parameters, scaled vertically for
clarity

Figure 5 summarizes some of the results of this analysis,
including the maximum sampled posterior tree, and posterior
distributions for the root location, the subpopulation sizes 0
and the molecular clock rate Ito. Assuming a constant generation
time, the differences between elements of 0 reflect differences in
effective population sizes of the virus populations. It is therefore
interesting that the order of these sizes corresponds to the order-
ing of the human population sizes: New Zealand (smallest),
Hong Kong, New York (largest). Furthermore, the estimated
base mutation rate no 2 5 x 10’3 substitutions/site/year [95%
HPD interval (4.5 X 104, 5.5 X 104)] is in line with previous
estimates for the HA gene (Rambaut el 61]., 2008). The placement
of the root of the maximum sampled posterior tree in New York
is in agreement with the posterior probability distribution of the
root location (Fig. 5b). This may seem contrary to conventional
wisdom that Asia provides the source for seasonal inﬂuenza epi-
demics (Russell 61 61]., 2008). However, the location of the root is
very much a function of the particular dataset used.
Furthermore, our result is in line with the results of Bedford
61 a]. (2010) who applied a hierarchical approach to a much
larger dataset and found that the ‘trunk’ location of their
sampled H3N2 transmission tree was likely also within the
USA at the time of the root of our tree (mid 1998).

5 DISCUSSION

Taken together, the results above are strong evidence that our
new algorithm and its implementation are correct, computation-
ally efficient and capable of analysing large datasets. However,
the algorithm presented here does not address problems that are
fundamental to the structured coalescent. As discussed in detail
by Ewing at a]. (2004), the structured coalescent tree density

 

2278

/310‘Sp:um0[p10;x0‘soneuHOJIIrorq/ﬁdnq

Efficient Bayesian inference under the structured coalescent

 

[Equation (2)] can yield improper posterior densities for elements
of the migration rate and population size parameters when un—
informative priors are used. In our experience, this can still lead
to slow mixing with proper but broad priors. In such cases, we
suggest following the advice of Ewing et a]. (2004) by imposing
sensible upper and lower bounds on the demographic parameters
whenever known.

There are many possible extensions to this work. Firstly, as we
discuss in Section 1 of the Supplementary Material, other models
involving structured trees exist beyond the structured coalescent.
Some of these are likely to be particularly important in the ﬁeld
of viral phylodynamics, where the overlapping epidemiological
and evolutionary time scales mean that birth4ieath sampling
models (Stadler, 2008) or generalized coalescent processes
(Volz, 2012) are needed to explain the sequence data.
Developing, implementing and testing the performance of our
proposal operators on spatial extensions to these models will
therefore be an important area of future research.

Secondly, the problem of summarizing large numbers of struc—
tured trees sampled from posterior distributions requires special
attention. While existing techniques for summarizing phylogen—
etic tree distributions [Felsenstein (2003) provides a good review]
allow for the un—typed component of the trees in the sampled set
to be summarized, this discards useful information. In our inﬂu—
enza analysis we chose to use the sampled structured tree with
the HPD. While retaining type information, this approach is also
suboptimal because it gives no indication of the uncertainty asso—
ciated with the type—change paths depicted.

The BEAST 2 package implementing the algorithms discussed
in this article and used in the analyses may be found at http://
compevol.github.io/MultiTypeTree, together with an example
analysis and a tutorial. The software source code is available
under the GNU General Public License and is highly extensible,
making third—party implementation of further structured tree
models practical.

ACKNOWLEDGEMENTS

The authors also wish to acknowledge the contribution of the
NeSI high—performance computing facilities and the staff at the
Centre for eResearch at the University of Auckland. The authors
thank Peter Beerli for helpful comments and suggestions.

Funding: The work was supported by the Allan Wilson Centre
for Molecular Ecology and Evolution (to T.G.V. and AP);
Royal Society of New Zealand Marsden grant [UOA0809 to
D.K. and A.J.D.]; Rutherford Discovery Fellowship from the
Royal Society of New Zealand (to A.J.D.).

Conﬂict of Interest: none declared.

REFERENCES

Baum,L.E. et a]. (1970) A maximization technique occurring in the smtistical ana—
lysis of probabilistic functions of Markov chains. Ann. Math. Stat., 41, 164.
Bedford,T. et a]. (2010) Global migration dynamics underlie evolution and persist—

ence of human inﬂuenza A (H3N2). PLoS Pathog., 6, e1000918.
Beerli,P. (2006) Comparison of Bayesian and maximum—likelihood inference of
population genetic parameters. Bioinformatics, 22, 3417345.

Beerli,P. and Felsenstein,J. (1999) Maximum—likelihood estimation of migration
rates and effective population numbers in two populations using a coalescent
approach. Genetics, 152, 7637773.

Beerli,P. and Felsenstein,J. (2001) Maximum likelihood estimation of a migration
matrix and effective population sizes in n subpopulations by using a coalescent
approach. Proc. Natl Acad. Sci. USA, 98, 456341568.

Bouckaert,R. et a]. (2014) BEAST 2: a software platform for Bayesian evolutionary
analysis. PLoS Comp. Biol, 10, e1003537.

Drummond,A.J. and Rambaut,A. (2007) BEAST: Bayesian evolutionary analysis
by sampling trees. BMC Evol Biol, 7, 214.

Drummond,A.J. et a]. (2006) Relaxed phylogenetics and dating with conﬁdence.
PLoS Biol, 4, e88.

Drummond,A.J. et a]. (2002) Estimating mutation parameters, population history
and genealogy simultaneously from temporally spaced sequence data. Genetics,
161, 1307.

Drummond,A.J. et a]. (2012) Bayesian phylogenetics with BEAUti and the BEAST
1.7. Mol Biol. Evol, 29, 196%1973.

Ewing,G. et a]. (2004) Using temporally spaced sequences to simultaneously esti—
mate migration rates, mutation rate and population sizes in measurably evolving
populations. Genetics, 168, 240772420.

Fearnhead,P. and Sherlock,C. (2006) An exact Gibbs sampler for the Markov—
modulated Poisson process. J. R. Stat. Soc. Ser. B, 68, 767.

Felsenstein,J. (1981) Evolutionary trees from DNA sequences: a maximum likeli—
hood approach. J. Mol. Evol, 17, 3687376.

Felsenstein,J. (2003) Inferring Phylogenies. Sinauer Associates, Massachusetts.

Gillespie,D.T. (1976) A general method for numerically simulating the stochastic
time evolution of coupled chemical reactions. J. Comp. Phys., 22, 403.

Gillespie,D.T. (1977) Stochastic simulation of coupled chemical reactions. J. Phys.
Chem., 81, 2340.

Green,P. (1995) Reversible jump Markov chain Monte Carlo computation and
Bayesian model determination. Biometrika, 82, 7117732.

Grenfell,B.T. et a]. (2004) Unifying the epidemiological and evolutionary dynamics
of pathogens. Science, 303, 3277332.

Hasegawa,M. et a]. (1985) Dating of the human—ape splitting by a molecular clock
of mitochondrial DNA. J. Mol Evol, 22, 1607174.

Hein,J. et al. (2005) Gene Genealogies, Variation and Evolution: a Primer in
Coalescent Theory. Oxford University Press, New York.

Hudson,R.R. (1990) Gene genealogies and the coalescent process. Oxf. Surv. Evol
Biol, 7, 1.

Kingman,J.F.C. (1982) On the genealogy of large populations. J. Appl Prol7a17., 19,
27.

Kuhnert,D. et a]. (2011) Phylogenetic and epidemic modeling of rapidly evolving
infectious diseases. Infect. Genet. Evol, 11, 182571841.

Lemey,P. et a]. (2009) Bayesian phylogeography ﬁnds its roots. PLoS Comput. Biol,
5, e1000520.

Moler,C. and Van Loan,C. (2003) Nineteen dubious ways to compute the exponen—
tial of a matrix, twenty—ﬁve years later. SIAM Rev., 45, 3419.

Notohara,M. (1990) The coalescent and the genealogical process in geographically
structured population. J. Math. Biol, 29, 59775.

Pannell,J.R. (2003) Coalescence in a metapopulation with recurrent local extinction
and recolonization. Evolution, 57, 9497961.

Rambaut,A. et a]. (2008) The genomic and epidemiological dynamics of human
influenza A virus. Nature, 453, 615%19.

Rodrigue,N. et a]. (2008) Uniformization for sampling realizations of Markov pro—
cesses: applications to Bayesian implementations of codon substitution models.
Bioinformatics, 24, 56—62.

Russell,C.A. et a]. (2008) The global circulation of seasonal influenza a (H3N2)
viruses. Science, 320, 34(%346.

Sanderson,M.J. (2002) Estimating absolute rates of molecular evolution and diver—
gence times: a penalized likelihood approach. Mol Biol. Evol, 19, 1017109.
Stadler,T. (2008) Lineages—through—time plots of neutral models for speciation.

Math. Biosci., 216, 1637171.

Thorne,J.L. et a]. (1998) Estimating the rate of evolution of the rate of molecular
evolution. Mol Biol. Evol, 15, 164771657.

Vaughan,T.G. and Drummond,A.J. (2013) A stochastic simulator of birth—death
master equations with application to phylodynamics. Mol Biol. Evol, 30,
148(F1493.

Volz,E.M. (2012) Complex population dynamics and the coalescent under neutral—
ity. Genetics, 190, 1877201.

Volz,E.M. et a]. (2013) Viral phylodynamics. PLoS Comput. Biol, 9, e1002947.

Wilson,I.J. and Balding,D.J. (1998) Genealogical inference from microsatellite data.
Genetics, 150, 4997510.

 

2279

ﬁm'spzumot‘pmjxo'sopnuuopnotq/ﬁdnq

