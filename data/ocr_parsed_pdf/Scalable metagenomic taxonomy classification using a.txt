BIOINFORMA TICS

0'so;112u110}u101q//2duq

SIBumoprOJX

£10"

Lz-n'lcrl

k'n’IEF3

k-mer 3

k-mar to anume main
k-mer 1: 61.53.6456
k-mer 2: 61.52.63.617
krmer 3: 51,52,53,64,GG

k-mer to tamnom tree main
k-mer 1:61.63,64,66.nl.n2.n3
kimer 2: Gl,GZ,G3,n 1.67.n5

K~mer 3: Gl,Gz_.GS,n1,Gﬂ,GE,n2,n3

k-l'lhrl' ._'-‘

 

/3.10'S[Bum0[p10}x0'SOpBLUJOJuyqu”:duq

Or :1 list of candidate taxonorm: labe\5
1 2 3 tl S 6 7 S 9
(G 1.1.0];E63,1‘0),(nl,1.0),{ns,l.0},(GE.G.B7),[Gd.0.6?],(|13,0.6?3, [112,067], :67,0.33]

I15 n5

-
n3 I13

I,

\n 1 / \f': 2
I“ \ \
J "\ .v‘i \.
G 1 G 2 G 64 G 5 G 6

Refe rence taxonomy

6164 9] Score too low terminate

 

/3.10'S[Bum0[p10}x0'SOpBLUJOJuyqu”:duq

S.K.Ames et al.

 

rank assignments in the Direct Match category imply that the read label
score for lower rank assignments were below the comparable score
threshold and suggest sequence novelty in the classiﬁed sequence.
‘Novel Match’ is reported when multiple child nodes from competing
lineages have comparable read label scores above the threshold but the
LCA has a higher read label score. This indicates novelty in the query
read and could occur when a substantial subset of the read’s k-mers are
found in competing lineages, but the combination of k-mers observed at
the LCA node is more signiﬁcant.

2.4 Database ingest

A key feature of our approach is to store the k-mer/taxonomy database in
a ﬁle rather than build it anew for each query run; this permits shifting
computational costs to the off-line taxonomy/genome ingest phase. The
database is created once, and then is used repeatedly during classiﬁcation.
To enable database search during classiﬁcation, the ﬁle is mapped into
the memory address space of the classiﬁcation program, allowing k-mers
and associated taxonomy IDs to be accessed directly. Previous work at
Lawrence Livermore National Laboratory (LLNL) has modiﬁed the
Jemalloc memory management library (Evans, 2006) to enable memory
allocation from an address range memory-mapped to a ﬁle residing on a
storage device. Jemalloc is a drop-in replacement for regular malloc rou-
tines for allocating memory. Our modiﬁcation to Jemalloc allows for an
additional step to specify the database ﬁlename (Jemalloc memory-maps
to temporary ﬁles). We have chosen to use the memory-map ﬁle ap-
proach rather than implementing an out-of-core indexing algorithm be-
cause of the ease of programming using the memory-map abstraction for
the persistent storage of data structures. We place the memory-mapped
ﬁles onto a ramdisk for in-memory performance. An ingest utility creates
the database, which includes a hash table whose keys are k-mers and
values are sets of taxonomy identiﬁers.

Supplementary Table S2 shows numbers of k-mers present and the
total storage required for several of the databases. The current default
settings use 619 GB (kFull) and 39 GB (kML). The databases use 6 bytes
per taxon, including genome counts information. We found that these
counts are extraneous information and only 2 bytes per taxon identiﬁer
are required. Using 2 bytes per taxon allows for 65 566 distinct taxa
(the current database has 18498 distinct taxa). Future work is expected
to reduce the database size to 413 GB (kFull) and 26 GB (kML). The
ingest pipeline for the full database took ~17 h using up to 256 2.3 GHz
Advanced Micro Devices (AMD) compute nodes each with 32 GB run-
ning single-threaded tasks that dumped intermediate results to ﬁles in the
parallel ﬁle system.

2.5 Test data

To compare performance with existing state-of-the-art published tools,
accuracy was compared with PhymmBL (Brady and Salzberg, 2011),
MetaPhlAn (Segata et al., 2012) and Genometa (Davenport et al.,
2012). PhymmBL balances classifying known species with classifying
novel organisms but uses BLAST, which does not scale well with sequen-
cer output (Angiuoli et al., 2011). MetaPhlAn uses a small marker library
making it scalable but it does not attempt to label every read. It is also
optimized to do relative abundance estimation, which LMAT currently
does not do. Genometa replaces BLAST with a potentially faster search
algorithm (Bowtie2 or BWA) and attempts to assign a taxonomic label to
every read. Ideally, the same reference database would be used for all
programs. However, adapting our database to work with Genometa and
PhymmBL required signiﬁcant customization and was not technically
feasible with MetaPhlAn. Therefore, the existing reference database of
each tool was used. The Genometa database is the oldest database
created in 2010, our reference database was created in fall 2011, and
PhymmBL and MetaPhlAn use databases created in mid 2012. The pub-
lished PhymmBL dataset that uses a read length of 100 was chosen as the

test query dataset. As the test data were created before each reference
database was created, the query species should be present in each refer-
ence database.

Three additional simulated test query sets were used to evaluate the
accuracy of our method in the presence of query sequences absent from
the reference database for viruses, prokaryotes and eukaryotes (fungi and
protists). MetaSim was used with a 100 bp (Barthelson et al., 2011) and
80 bp (Richter et al., 2008) Illumina error model to generate the novel
bacterial and viral dataset, respectively. Eukaryotes were taken from
single species sequencing data deposited in the Short Read Archive
(SRA) and include Trypanosoma evansi, Candida albicans, Coccidiaides
immitis, Aspergillus fumigatus and Entamaeba histalytica (read lengths
ranged from 36 to 200). For the bacterial dataset, 100 sequences not
found in the reference database (determined by GenBank Identifier and
header comparison) were selected at random to serve as the candidate test
set with 1000 000 simulated reads and equal concentrations of the 100
bacteria. The 100 strains were made up of 75 distinct species, 14 of which
were species not found in our reference database. For the viral case, 6921
reads were generated, assuming equal concentrations of 25 viral genomes,
which made up 25 distinct species, 10 of which were not found in the
reference database. Not every test sequence in the ‘novel’ datasets proved
to be divergent from the reference database. A detailed description of the
test data is given in the Supplementary Material. To measure run time,
three non-synthetic metagenomic samples representing a viral metagen-
ome (SRX022172), a human microbiome metagenome (ERR01 1121) and
a single species raw read ‘metagenome’ (DRR000184) were taken from
the SRA.

3 RESULTS

3.1 Classiﬁcation accuracy

Read accuracy is reported by counting the number of reads cor—
rectly assigned to a taxonomic label consistent with its true
origin. For example, a read originating from Bacillus anthracis,
but assigned to Bacillus would be counted as correct at the genus
rank. Read accuracy is tracked for each taxonomy rank to com—
pare accuracy with rank speciﬁcity. Sample accuracy is reported
for true—positive and false—positive counts on species calls. This
introduces one free parameter, which is not automatically
selectediminimum number of reads needed to make a species
call (or minimum species abundance for MetaPhlAn). Results
for all programs are reported as performance curves to iden—
tify the trade—offs of reducing the false—positive count with
increased thresholds while potentially reducing the true—positive
count.

Figure 4 shows the true—p0sitive/false—positive performance
curve for different minimum read thresholds compared with
the other contemporary methods and our own reduced size
marker library (kML) and full—sized library (kFull). Values for
k=20 (kFull) and k: 18 (kML) were used as default values
(accuracy comparisons for different values for k are shown in
Supplementary Figure S1). LMAT—kFull and LMAT—kML
showed near identical accuracy, with the full—sized database cor—
rectly detecting a small number of additional species.
Genometa’s advantage over PhymmBL could be explained by
its stricter read mapping criteria, which favors detection of
known genomes. Although we were able to recreate higher per—
formance runs for MetaPhlAn on their previously published test
sets, MetaPhlAn’s lower performance on the PhymmBL test sug—
gests that it may be more difﬁcult to do both taxonomic

 

2256

ﬁm'spzumol‘pmﬂo'sopeuuopuorq/ﬁdnq

Scalable metagenomic taxonomy search

 

identification and relative abundance estimation when microbial
content consists exclusively of exceptionally low per genome
coverage. (The PhymmBL test set contains just 50 reads per
genome and includes multiple closely related strains.)

Table 1 shows the percentage of PhymmBL input set reads
correctly labeled for select ranks and reads that were incorrectly
labeled or failed to be assigned a label. The table shows that the
majority of reads labeled by LMAT using the kFull database are
identified by species (74.2% for the full database) with high ac—
curacy (> 99%). When LMAT used our marker library (LMAT—
kML), fewer reads (40%) were classiﬁed but the assignments
were highly accurate (>99 %). Although PhymmBL can poten—
tially make rank ﬂexible selections using the confidence scores
assigned to different rank levels, we were not able to implement
an automated threshold that demonstrated good results.
Therefore, we report observed species accuracy calls as well as
PhymmBL’s published results, which are slightly higher.
Genometa’s accuracy was lower than other methods with fewer

LMAT-kFull: 531 _
/__
LMAT-kML: 527
500

 

 G'e‘riéirié‘t'a""'
,,.,-——-”'Fiii§7r?.?nBL
J

I , ’ ’MeiaPhiAn

400

w
o
9

True Positives

N
o
o

100

 

 

 

0

 

—5 45 95 145 195 245
False Positives

Fig. 4. Species-level accuracy comparing reference databases/algorithms’
performance on PhymmBL query set. Classiﬁer performance is shown
using the full database (LMAT-kFull), and a marker database (LMAT-
kML), and is compared with other software, Genometa, PhymmBL and
MetaPhlAn. LMAT-kFULL performance is underneath the LMAT-
kML plot, highlighting similar performance

Table 1. Per read accuracy for known bacteria shown in percentages

reads assigned species labels. This is likely because of its use of a
best hit approach instead of rank—ﬂexible selection. (MetaPhlAn
does not report read—speciﬁc labels, thus it is excluded from the
table.) Our method using the full database could not assign spe—
cies—specific labels to 25.8% of the reads; 8.5% of the reads were
assigned labels with ranks at the genus, family and order levels;
6.9% and 3.1% of the reads not listed in Table 1 were correctly
assigned labels at other ranks (e.g. kingdom, sub—species, class
etc.) for the kFull and kML databases, respectively. The high
overall LMAT accuracy is explained by the rank—ﬂexible selec—
tion, where low rank assignments are only made in the absence of
conﬂicting evidence, with the read label score ﬁltering out an
additional 10% of the reads, thus leaving just 0.3% of the
reads with an incorrect assignment.

One key challenge is to maintain accuracy in the presence of
novel genomes by preventing overly speciﬁc rank calls. Because it
proved to be challenging to manipulate the other publicly avail—
able software tools to use our reference database particularly in
the case of the viral and eukaryote test sets, it was not possible to
directly compare results. Instead, we evaluate our two data—
bases7kFull and kML. Figure 5 shows the species sample
accuracy curve for our method on the three datasets (virus, bac—
teria and eukaryotes), which include novel organisms. The
number of test species that are also represented in our reference
database were 15, 61 and 4 for the viruses, prokaryotes and eu—
karyotes, respectively, and indicate the practical upper bound on
the number of correctly identiﬁable species. For the novel viral
case, approximately 1>< coverage was used for each viral genome.
With this relatively good coverage level, although only 14 of the
15 known viral species were correctly called, no false species calls
were made. For the bacteria case, 0.35>< coverage was used, and
the eukaryote case used 470 779 reads chosen at random to simu—
late low coverage.

In eukaryote and prokaryote cases, the false—positive count
was extremely low but not perfect. In the eukaryote case, the
T .evansi not in our reference database was classiﬁed
T rypanosoma brucei and it appears that signiﬁcant portions of
these two genomes are highly similar, making the distinction
difﬁcult. The kML eukaryotic results are expected to improve
as more microbial eukaryotic genomes are sequenced to allow for
better targeting of markers that discriminate between near neigh—
bors. For bacteria, there were two false—positive species calls,
M ycobacterium abscessus and Rahnella Sp. Y9602, which share
signiﬁcant portions of their genomes with the novel species

 

 

Application Database Species Genus Family Order Wrong No label No hits
LMAT kFull 74.2 (99.7) 6.7 (99.9) 1.4 (100) 0.4 (100) 0.3 10.1 0
LMAT kML 40.4 (99.8) 4.1 (99.9) 0.8 (100) 0.1 (100) 0.2 51.3 17.7
PhymmBL Published 7 (95.4) 7 7 7 4.6 7 7
PhymmBL GenBank 88.3 (92.5) 7 7 7 7.5 11.7 7
Genometa Published 66.7 (92.2) 7 7 7 7.8 33.3 7

 

Note: Per rank accuracy shows two values7percentage of all reads correctly labeled by rank (species, genus, family or order) or incorrectly labeled (Wrong) or failed to be
assigned a label (No label and No hits). In parentheses shows percenmge of reads assigned a label at the speciﬁed rank that were correct. No label=reads with no
taxonomically informative label assigned and includes No hits, No hits = reads with no k—mer matches to the database. 7: entry not applicable.

 

2257

ﬁm'spzumoi‘pmjxo'sopeuuowtotq/ﬁdnq

ref. database

’ z ' LMAT7KFuii
i LMAT7KML

 

 

 

 

ref. database

’ z ' LMAT7KFuii
i LMAT7KML

 

 

 

 

ref. database

’ z ' LMAT7KFuii
i LMAT7KML

 

/3.10's112um0fp10}x0"sotJBuiJOJutotqﬂ:duq

 

26.6

290

0.656

Application—Ref. Database

LMAT—kFuII

LMAT—kML
MetaPhlAn(Using-Bowtie2)
BLAST-Ful|Rebe(Map-on|y)
BowtieZ-Fu||Rebe(Map-on|y)

 

/3.IO'S[BIIm0[p.IOJXO'SOIJBIIIJOJIIIOIq/ﬂdnq

S.K.Ames et al.

 

where awareness of these parameter settings is needed. The final
user—deﬁned parameter setting limits the number of candidate
taxonomy identiﬁer considered and was set to 50 early on to
ensure efﬁcient run times with the understanding that accuracy
costs are incurred for genetic fragments associated with a com—
plex taxonomic hierarchy. LMAT’s fast run times allow the soft—
ware to be run initially with default settings and quickly rerun on
targeted subsets of reads as needed.

The reported LMAT tests focus on identifying known
organisms in complex samples, which the results show still
presents a major challenge. The use of relatively short reads
(2}100 bases) indicate that even known sequences can be difﬁ—
cult to taxonomically classify when they represent short genetic
elements conserved among multiple taxa. LMAT analysis on
human clinical samples exhibits a high read label rate allowing
the much smaller pool of unlabeled reads to be interrogated for
more distant evolutionary relationships with other tools. For
some environmental samples, more of the microbial contents
are expected to be highly divergent from the reference database
and populated with greater amounts of non—microbial eukaryotic
DNA. In these cases lower, rates of read labeling are obtained.
The Supplementary Material shows the high scoring read label
rates (score 31) for four different environmental samples range
from 10 to 60%, but relaxing the default minimum read label
score threshold increases the read label rate to >50% in all cases.
We find that the species identiﬁed by reads with low scores are
frequently the same as those identiﬁed by high conﬁdence, high
scoring reads. One can pull out additional lower scoring reads for
taxa that are likely present as indicated by the higher scoring
reads, thus diminishing the fraction of unclassiﬁed reads. The
ﬂexibility of adjusting the score threshold without rerunning
the whole analysis enables LMAT to rapidly screen large
environmental datasets and obtain a large fraction of labeled
reads.

Although the full library should be fast enough to run on large
metagenomes, marker libraries still have a speed advantage.
Recently published marker library approaches like MetaPhlAn
rely on bacterial marker genes, which cannot be applied directly
to other microbial contents. Other marker libraries like Sequedex
(Berendzen et al., 2012) rely on an individual marker sequence to
contain the taxonomic signal in a single contiguous genetic elem—
ent. By contrast, our method resolves the taxonomic signal
across the entire read with a scoring procedure. Individual
k—mers may contain part of the signal with the intersection of
taxonomic labels from multiple k—mers yielding a stronger signal,
and thus accuracy should improve with sequencer read length.
The reference database size is a function of genetic and taxo—
nomic diversity allowing near neighbors to be added with only
a limited increase in the database size. As the number of neighbor
strains increase, strain level discrimination run time costs grow.
Although our method reports strain level discrimination, accur—
acy was measured at the species level because minimum genome
coverage affects accuracy and the available synthetic test sets
focus on species discrimination. Future work will include design—
ing better strain discrimination tests and expand the database to
include functional annotation.

ACKNOWLEDGEMENTS

This work was performed under the auspices of the US
Department of Energy by Lawrence Livermore National
Laboratory under Contract DE—AC52—07NA27344.

Funding: Laboratory Directed Research and Development
(33—ER—2012 and 08—ER—2011); DOE Ofﬁce of Science
(KJ0402000—SCW1076).

Conﬂict of Interest: none declared.

REFERENCES

Angiuoli,S.V. et a]. (2011) Resources and costs for microbial sequence analysis
evaluated using virtual machines and cloud computing. PLoS One, 6, e26624.

Barthelson,R. et a]. (2011) Plantagora: modeling whole genome sequencing and
assembly of plant genomes. PLoS One, 6, e28436.

Berendzen,J. et a]. (2012) Rapid phylogenetic and functional classiﬁcation of short
genomic fragments with signature peptides. BMC Rex. Notes, 5, 460.

Brady,A. and Salzberg,S. (2011) PhymmBL expanded: conﬁdence soores, custom
databases, parallelization and more. Nat. Methods“, 8, 367.

Davenport,C.F. et a]. (2012) Genometa7a fast and accurate classiﬁer for short
metagenomic shotgun reads. PLoS One, 7, e41224.

Drge,J. and McHardy,A.C. (2012) Taxonomic binning of metagenome samples
generated by next—generation sequencing technologies. Brief. Bioinform., l3,
64(r655.

Evans,J. (2006) A scalable concurrent malloc(3) implementation for freebsd. In:
BSDCan — The Technical BSD Conference. Ottawa, Canada.

Huson,D.H. et a]. (2007) MEGAN analysis of metagenomic data. Genome Rec, 17,
3777386.

Keller,A. et a]. (2012) New insights into the tyrolean iceman’s origin and phenotype
as inferred by whole—genome sequencing. Nat. Commun., 3, 698.

Knight,R. et a]. (2012) Unlocking the potential of metagenomics through replicated
experimental design. Nat. Biotechnol, 30, 5137520.

Langmead,B. et a]. (2009) Ultrafast and memory—efﬁcient alignment of short dna
sequences to the human genome. Genome Biol., 10, R25.

Leung,H.C. et a]. (2011) A robust and accurate binning algorithm for metagenomic
sequences with arbitrary species abundance ratio. Bioinformaticx, 27, 148971495.

Liu,B. et a]. (2011) Accurate and fast estimation of taxonomic proﬁles from meta—
genomic shotgun sequences. BMC Genomics, 12 (Suppl. 2), S4.

Loh,P.—R. et a]. (2012) Compressive genomics. Nat. Biotechnol, 30, 627%30.

Mande,S.S. et a]. (2012) Classiﬁcation of metagenomic sequences: methods and
challenges. Brief. Bioinform., l3, 669%81.

Martin,J. et a]. (2012) Optimizing read mapping to reference genomes to determine
composition and species prevalence in microbial communities. PLoS One, 7,
e36427.

Mende,D.R. et a]. (2012) Assessment of metagenomic assembly using simulated
next generation sequencing data. PLoS One, 7, e31386.

Mohammed,M.H. et a]. (2011) SPHINX7an algorithm for taxonomic binning of
metagenomic sequences. Bioinformaticx, 27, 22730.

Pell,J. et a]. (2012) Scaling metagenome sequence assembly with probabilistic de
bruijn graphs. Proc. Natl. Acad. Sci. USA, 109, 13272713277.

Richter,D.C. et a]. (2008) MetaSim: sequencing simulator for genomics and meta—
genomics. PLoS One, 3, e3373.

Schatz,M.C. et a]. (2010) Cloud computing and the DNA data race. Nat.
Biotechnol, 28, 691$93.

Segata,N. et a]. (2012) Metagenomic microbial community proﬁling using unique
clade—speciﬁc marker genes. Nat. Met/iodx‘, 9, 8117814.

Sharma,V.K. et a]. (2012) Fast and accurate taxonomic assignments of metage—
nomic sequences using metabin. PLoS One, 7, e34030.

Teeling,H. and Glockner,F.O. (2012) Current opportunities and challenges in mi—
crobial metagenome analysis7a bioinformatic perspective. Brief Bioinform., 13,
7287742.

Venter,J.C. et a]. (2004) Environmental genome shotgun sequencing of the sargasso
sea. Science, 304, 6&74.

 

2260

ﬁm'spzumoi‘pmjxo'sopeuuowrorq/ﬁdnq

