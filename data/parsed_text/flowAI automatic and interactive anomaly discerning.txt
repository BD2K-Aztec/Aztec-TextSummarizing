Motivation: Flow cytometry (FCM) is widely used in both clinical and basic research to characterize cell phenotypes and functions. The latest FCM instruments analyze up to 20 markers of individual cells, producing high-dimensional data. This requires the use of the latest clustering and dimen-sionality reduction techniques to automatically segregate cell sub-populations in an unbiased manner. However, automated analyses may lead to false discoveries due to inter-sample differences in quality and properties. Results: We present an R package, flowAI, containing two methods to clean FCM files from un-wanted events: (i) an automatic method that adopts algorithms for the detection of anomalies and (ii) an interactive method with a graphical user interface implemented into an R shiny application. The general approach behind the two methods consists of three key steps to check and remove suspected anomalies that derive from (i) abrupt changes in the flow rate, (ii) instability of signal acquisition and (iii) outliers in the lower limit and margin events in the upper limit of the dynamic range. For each file analyzed our software generates a summary of the quality assessment from the aforementioned steps. The software presented is an intuitive solution seeking to improve the results not only of manual but also and in particular of automatic analysis on FCM data. Availability and implementation: R source code available through Bioconductor: http://bioconduc tor.org/packages/flowAI/ Contacts:
IntroductionFlow cytometry (FCM) is a laser-based methodology designed to capture the physical and biochemical characteristics of a cell or a particle in a stream of fluid. Fluorescence-conjugated antibodies are used to target antigens expressed inside or at the surface of the cells of interest. As cells pass through the laser (excitation), the fluorochrome will change its state of energy and emit a light (emission) that is captured by a series of detectors. FCM applications have been developed mainly for both research and clinical settings in medicine but also for other non-biomedical domains such as marine and plant biology. The most common application is the immune-phenotyping of blood samples and thus the quantification of the number and frequency of various immune cell populations. In hematology, FCM is the technology of choice, as, for example, it requires only few drops of blood to diagnose leukemia through the detection of the perturbation of normal cell frequencies (). Moreover, FCM helped increase our understanding of cellular functions of the immune system and is widely used in cell cycle analysis, pre-transplant crossmatching, cell sorting, apoptosis, vaccine development and other applications that scrutinize cellular properties(). The data are stored in Flow Cytometry Standard (FCS) files that include the fluorescence and scattered light levels for each cell that passed through the laser beams. Nowadays it is possible to analyze up to 20 markers at a time in a single staining panel by using an equal number of different fluorochromes detected in separate channels. The common approach used to analyze the data produced by FCM is to visually select cells of interest through 1 or 2 markers known to be highly specific. However, to delineate the high heterogeneity of immune cell populations, it is necessary to look simultaneously at the whole staining panel. Principal component analysis has been used to detect the complexity in CD8 T cell populations characterized by intermediate phenotypes that show a continuum of expression of different combinations of cytokines and surface markers (). Another dimensionality reduction technique called t-Distributed Stochastic Neighbor Embedding (t-SNE) () was successfully applied to identify ambiguous cell populations, including monocytemacrophage intermediates and granulocyte variants in a mass cytometry experiment based on a 38-antibody panel (). Several computational tools that aim to automatically characterize cell populations without losing multi-dimensional information are constantly developed and periodically benchmarked by the FlowCAP consortium (). Undoubtedly, the widest range of tools has been distributed by the BioConductor platform based on the R programming language. The root package for FCM data is flowCore, since it defines the container class and it enables to perform essential manipulations such as compensation and transformation (). In addition, a series of complementary packages has been developed for further operations, such as visualization, quality assessment, statistical analysis and automated gating (). To accompany and support the large development of automatic methods to define populations, it is crucial to use high quality FCM data as input in order to optimize the robustness of the results. This is especially true since research is looking deeper into the complexity of cell distribution. For instance, target cell sub-populations may represent as low as 0.05% of the total cell population suggesting that minute variation in the quality of the data may lead to false positive results or loss of signal. Standardization, calibration and quality control guidelines using beads have been defined to ensure that the signal acquired is the most accurate and with the least variation (). Nonetheless, these procedures are not always carefully monitored and even having the FCM instrument at optimal conditions before sample processing does not exclude electronic drifts or fluidic instability issues at the time of data recording. An R package, flowQ (), creates concise reports of quality checks on single and multi-panel experiments to highlight issues that can be encountered in data acquisition. The reports indicate the number of cells, percentage of boundary events and anomalies on the fluidics and signal acquisition over time. Another package, flowClean (), determines and marks low quality cells using compositional data analysis. In brief, it splits the time in equally sized bins and flags the events that are within time frames containing unusual ratios of cell populations. However, flowQ does not actively detect and remove the anomalies and flowClean is poorly intuitive and thus it does not allow to infer the source of the anomalies. We present our package called flowAI that provides two solutions, one automatic and one interactive, to discard cells from FCM data that do not reach appropriate quality standards. Our workflow adapts and expands previous ideas with methods never implemented before to provide a more objective, efficient and intuitive solution for the quality control of FCM data.
Implementation and methods
The softwareBoth the automatic and interactive methods have been implemented in the R package flowAI and distributed by the Bioconductor platform (http://bioconductor.org/packages/flowAI/). Our tools incorporate functionalities from several other R packages. For example, the automatic method integrates functions from the mFilter () and changepoint () packages in the algorithms aiming to automatically detect the anomalies while the interactive method leverages on the R shiny package () to build the web graphical interface.
WorkflowThe entire quality control analysis of flowAI contains three main steps to detect and remove anomalies from FCM data complementary for both the automatic and the manual methods ().
Flow rate checkThe first step evaluates the steadiness of the flow rate of the analysis. The flow rate is reconstructed by reporting the number of cells acquired per unit of time. This is only possible for FCS files of version equal or greater than 3.0 which implement the keyword $TIMESTEP to allow for kinetic analysis ().. Workflow of the quality control of FCM data using the flowAI package. Data can be processed manually with a Shiny application or automatically with the call of an R function. The steps are complementary in both cases. On the one hand, the manual method allows the user to interactively choose appropriate thresholds on plots portraying flow rate and signal acquisition through visual inspection. On the other hand, the automatic method performs this selection through anomaly detection algorithms. Both the interactive and automatic methods eliminate events recorded outside an acceptable dynamic range using standard thresholds
FlowThe keyword stores a value corresponding to the resolution of the 'Time' channel in terms of seconds or fractions of a second. Ideally, the detection of anomalies in the flow rate check should be performed at the maximum time resolution allowed by the FCM instrument. However, the setting of a larger time step for the analysis greatly decreases the running time and memory usage. A stable flow rate of FCM instruments can be pictured by a line with non-periodic fluctuations but with a constant variation. The anomalies in the flow rate that mostly affect the quality of signal acquisition are abrupt surges and significant changes in the speed of the fluid, generally caused by factors such as debris and air intrusion in the fluidic system. To discard anomalies through the interactive method, users can adjust two horizontal sliding bars to eliminate flow rate surges and two vertical sliding bars to discard regions at the beginning and the end of the flow rate where the instabilities mostly occur. Instead, for the automatic version we designed an anomaly detection algorithm built upon the generalized extreme studentized deviate (ESD) test () and optimized to work on time series data. As stated in a review of outlier detection methods, the anomalies are contextual to the nature of the data () and hence it is preferable to develop techniques customized for the domain of interest. The patterns depicted by the flow rate of FCM data are generally similar to the ones treated by economists, engineers and social scientists in time series analyses, whose basic idea is to extract additional information from time series data by splitting into its components. As a first step for our automatic method, we implemented the ChristianoFitzgerald band pass filter () to split the value (y t ), corresponding to the number of events recorded at the time point t, into the trend (s t ) and cyclical (c t ) components:The trend component will be a smooth line that indicates longterm increase or decrease in the flow rate, while the cyclical component will contain the non-periodic fluctuations and abrupt surges from the trend line. Second, the flow rate values are penalized by adding or subtracting the corresponding absolute values of the cyclical component according to their direction from their median:Lastly, the generalized ESD test is applied on the penalized flow rate to detect the anomalies. This method, with an iterative process, searches for a number outliers not exceeding a predefined threshold k, r 1:k  {r 1 , r 2 ,. . ., r i ,. . ., r k }, in a dataset of sample size n. At each iteration, an observation r i is tested as a potential outlier and it is removed from the data before the next iteration. Practically, an exemplary iteration has the following steps: 1. Extraction of the observation that largely deviates from the central tendency indicator (mean or median) scaled by the measure of dispersion (standard deviation or median absolute deviation):2. Computation of the critical value lambda k i from the t distribution using a defined level of significance a. The observation is flagged as an outlier if its value is higher than lambda: r i > k i .3. The observation r i is removed from the data that is now reduced to the sample size n  i.Our procedure uses the median and the median absolute deviation (MAD) because, particularly in presence of outliers, they are a more robust alternative to the mean and standard deviation (). changepoints has been detected. In flowAI we used a variant of this method provided by the changepoint package that not only searches for shifts in the mean but also in the variance. The binary segmentation algorithm is performed independently on each fluorescence channel and lastly the longest region that does not contain changepoints in any of the channels is chosen as high quality signal.
Dynamic range checkA third quality step is performed on the lower and upper limit of the dynamic range. Signals recorded by FCM instruments can only fall within a determined dynamic range. The last generation of FCM has reached a dynamic range of 2 24 channels (), but most of the instruments nowadays used in laboratories and clinics have a range of 2 18. Due to this limitation, all measurements with a real value higher than the upper limit will be recorded in the last channel of the dynamic range causing an accumulation of signals that is not directly comparable with the rest of the data. These values are commonly called margin events. Our package allows the removal of events where at least one of the parameters has an intensity value on the upper limit of the dynamic range. The values of the lower limit are treated in a different way. For the signal of the light scatter channels (reflecting the morphology of the cells) any value less than zero is removed. Instead, for the immunofluorescence channel, small fluctuations in the range of negative values are usually acceptable since they are the byproduct of standard operations such as correction of background noise, auto fluorescence and spectral overlap. Nonetheless, technical issues, such as flow rate surges or voltage instability, can exacerbate the magnitude of a negative value to an unacceptable range that would also interfere with the downstream signal processing, such as logicle transformation or automatic gating. The flowAI package uses an outlier detection method to remove the outliers among the negative values. Every value that is inferior to a certain threshold is labelled as outlier and consequently removed. For each channel, a threshold referred to as Z-score is computed with a method recommended by. The formula is given in (6), where the threshold is obtained for a set of n negative values x 1:n  (x 1 ,. . ., x n ):Alternatively to the removal of negative outliers, the lower limit of the dynamic range can be truncated to the cut-off suggested by the FCS file. This method was previously adopted as preprocessing step for the cleaning of FCM data from erroneous measurement ().
Results evaluationAt the completion of the analysis with the automatic method, a report is generated indicating the percentage of cells that did not pass the quality checks and a series of graphs showing where the anomalies in terms of time and parameters were detected. Our suggestion is first to run the automatic method with default settings on a small sample of FCM data, second to customize the settings if necessary, third to perform the quality control automatically on the entire dataset and lastly to intervene manually only for those files whose automatic control is not able to meet the accuracy required.
Results and discussionHere, we provide analysis results obtained using the automatic method in flowAI on several FCM data. We studied the nature of the abnormalities detected in each quality control step and then we evaluated the overall improvement of computational analysis with the cleaned data.
Overview of the datasetsA total of 4469 FCM files from 11 different datasets, precisely 2 inhouse and 9 from the online database FlowRepository (), were used for our evaluation. The two in-house datasets contain 84 samples each, and are part of a larger project called the Singapore Longitudinal Aging Study (SLAS). Ethical approval was obtained from the National University of Singapore Institutional Review Board for SLAS blood collection and experiments. A different panel was used for the two datasets. Panel 1 consisted of 16 antibodies targeting markers for the overall white blood cell populations: CD16, CD4, CD38, CD62L, CD19, CD66b, CD45, CD27, CD56, CD3, CD8, CD14, CD123, HLA-DR. Panel 2 consisted of 14 antibodies targeting the B lymphocyte populations: CD19, CD20, CD21, CD23, CD24, CD27, CD38, IgG, IgM, IgD, HLA-DR. Regarding the 9 datasets retrieved online, we selected the ones used for the flowCAP contests. Data and details are available on flowrepository.org under the IDs with the prefix FR-FCM-and followed by: ZZYA, ZZZU, ZZY2, ZZY3, ZZYY, ZZY6, ZZYZ, ZZZV, ZZ99.
Examination of anomalies in FCM data from different perspectivesIn this section, the anomalies detected in each quality control step is analyzed separately. The main consideration is that even though our workflow schematizes the quality control in three different steps, they are usually strictly related. For example, a surge in the flow rate often corresponds to an unstable signal acquisition that in turn would potentially result in a value in the upper margin or in the negative outlier space of the dynamic range. Nonetheless, given the high variability of anomalies that can occur in a FCM experiment, the division of the quality control in the three steps defined in our work is necessary to assure the detection of those anomalies that are not visible from a single perspective. In this manuscript, we focus on the file 220662.fcs from the ZZZV dataset to show how a complete quality control with flowAI works on an FCS file. In addition, numerous other examples are reported in the supplementary material.
Surges and trend shifts in the flow rateThe flow rate was recreated dividing the time channel of an FCS file in equal intervals with a time step of 1/10 of a second. Fluidics' stability in the sample is a good indicator for the absence of anomalies such as clogging and air bubbles in the flow cell and other disturbances in the flow stream. Our algorithm has been designed to acknowledge cyclical patterns to detect local anomalies, i.e. surges, as well as to remove global anomalies, i.e. large deviations of the trend from the median flow rate (). From all the FCS files analyzed, we verified that the beginning and the end of the flow rate are the regions where irregularities occur the most. FCM experts recognize these patterns as being frequent and mainly due to air bubbles, debris or clogged cells (Supplementary, e, f). In, the flow rate takes about 10 s to stabilize but usually strong fluctuations vanish more quickly (Supplementary Figs S1a, S2a and S3a). Nevertheless, there are cases of flow rate surges interspersed over the entire course of the experiment (Supplementary Figs S4a and S5a) possibly caused by clusters of debris suddenly aspirated by the FCM tube (Supplementaryc). However, even though it was not always possible to associate flow rate surges with debris or clogged cells, surges removal is still necessary because of their association with signal intensity variation. Lastly, in an FCS file we observed a steady change of the flow rate, and hence the signal, in the last part of the analysis. The resulting low quality cells have a distribution uniformly shifted compared to the one of the high quality cells. This is probably due to the manipulation of the speed settings by the instrument operator during the running of the experiment (Supplementary).
Mean and variance deviation from stable acquisition regionsFor each channel, the signal acquisition over time is reconstructed first dividing the total number of cells in equally sized bins and second calculating the median value of each bin. The output is graphically shown with line plots (). Mean and variance shifts in the signal acquisition are detected using the binary segmentation method from the changepoint package (see Section 2.2.2). In most of the analyzed cases, signal instability is strongly related to flow rate fluctuations (, Supplementary Figs S1S3 and S6). However, anomalies caused by laser-detection systems can eventually occur independently of the speed variations of the flow rate. In Supplementary, for example, the numerous flow rate surges are hardly detectable in the signal plots and the channels storing the signal elicited by the green laser (G780-A, G710-A, G660-A and G610-A) show a delay in the reaching of stability that warrants a careful monitoring of the functionality of that specific laser-detection system. In Supplementary, even though the flow rate surges are associated clearly with the signal plots, the signal acquisition gradually weakens at different rates in different channels after a first region of steadiness (FSC-A, FSC-H and APC-A), while in other channels it remains constant for a longer period. In this rare case, other technical issues should be investigated. Some of the factors that might cause less common anomalies, but have to be kept in mind, are laser power instability, detection system irregularities, poor quality of the sheath fluid and accumulation of dirt in the flow cell.
Refiningthe dynamic range: removal of negative outliers and margin events Because of the quantum nature of light, both the scatter and fluorescence channel values cannot theoretically fall in the negative range of values. However, because of the background and noise correction of the optical detection system of FCM instruments, negative values are recorded for both light scatter and immunofluorescence channels. This problem is also exacerbated by instable signal acquisition, for instance during flow rate surges (Supplementary Figs S2ac and S4ac), or by compensation, where a value proportionate to the spectra overlap of other channels is subtracted from each channel. Negative estimates are considered part of a negative population of cells with a low mean and a large coefficient of variation. Therefore, with the logarithmic transformation not being able to handle negative values, new transformation methods have been developed. Probably the most popular one is the logicle transformation, also called 'bi-exponential' (). With this method, values with an absolute small magnitude are scaled linearly, while large values are scaled in a log-like fashion. The transition from the linear to the logarithmic scaling is defined by the x parameter of the formula. It determines the width of the linearized data and its value is directly estimated from the fifth percentile of the values below zero. We noticed that this estimation method lacks accuracy when the outliers in the negative range are more than 5% of negative values and precision when the negative values acquired are low and with sparse values. To overcome the arbitrary estimation of the x parameter, a cut-off at the value-111 has been suggested (). Nevertheless, this procedure does not have any theoretical explanation either and, as the authors of the logicle transformation method also implied, the truncation of the values would deform the distribution of the negative population and result in an improper estimation of its statistics (). Our idea is to use an outlier detection method to remove only the negative values that stray from the ones that compactly aggregate around zero. In, we depicted the differences among the distributions of the logicle transformed data for a channel of the 220662.fcs file where the x parameter was estimated on the raw data, after removing the(b) were extracted from the report generated by the automatic method of the flowAI package using default settings. (a) Strong fluctuations are detected in the flow rate at the beginning of the experiment. The anomalies detected are indicated with green circles. (b) Changepoint detection in signal intensity over time, represented as median of equally sized bins. The region discarded is complementary to the one detected as instable in the flow rate check. The yellow region is selected as being steady and therefore categorized as high quality. (c) ECDF curves of raw intensity values of the low (in red) and high (shades of blue) quality events of the PE Tx RD-A channel. The sample size of the three high quality samplings equals the number of low quality events detected. (d) Density plots of the logicle transformed data of the PE Tx RD-A channel using the logicle parameters estimated from raw data (green line), from data with negative values truncated at-111 (blue line), and from data without negative outliers (red line). The density curves vary among the three sets of data, indicating the repercussions on the estimation of the logicle parameters according to the dynamic range used for the data flowAInegative outliers and after truncating the data at 111. Generally speaking, a better estimation of the parameters of a negative cell population is expected, since the data are neither affected by outliers nor by a truncation to an arbitrary threshold. Overall, although this procedure might not give any substantial advantage for downstream manual analysis, it should improve the quality of the results for any kind of automatic analysis, from simple statistics calculations to gating. A last issue to consider when analyzing FCM data is the signal which value exceeds the limitations of the machine, thus generating the so called margin events. In fact, the signal can only be recorded up to the upper value of a dynamic range pre-set by the manufacturer of a FCM instrument. Therefore, it is impractical to discern subpopulations of cells whose values are stored in the upper margin of the dynamic range. This is already a common practice especially among computational biologists that require clean data to improve the quality of the analysis which is why we implemented it in our pipeline.
Overall improvement using computational methodsIn the previous sections, we described each step of our pipeline separately in order to examine the anomalies from different perspectives. Instead, in this section, we look at the final results using approaches to analyze the multi-dimensionality data in its entire complexity.
Disappearance of undefined populations in high quality dataWe used SPADE to identify and visualize populations from high dimensional FCM data (). In brief, SPADE first prunes high density regions, second identifies clusters and third links them together with a minimum spanning tree. The SPADE results before and after quality control of the file 220662.fcs are reported in. The FCS file was part of an experiment where the functionality of CD4 and CD8 T cells in response to an HIV vaccination was assessed through intracellular cytokine staining. Looking at the SPADE results through the markers CD3, CD4 and CD8 it is possible to identify CD4 T cells at the bottom-right branch and CD8 T cells at the top-right branch (). The analysis was made with default settings and, from the 200 populations identified by SPADE in the original file (), 43 disappeared in the high quality data (and Supplementary). To explain the nature of the faulty populations, we examined the graphs reporting the coefficient of variation and a high variability was found for the markers CD3 and CD8 in the discarded populations. One may also suspect that those are new undefined populations that solicit further investigation. However, plotting the CD3 channel against FSC-A with the flowJo software, it was possible to identify the faulty populations only in the files with high instability in the flow rate (Supplementary). signals are included in downstream analyses, it becomes hard to detect them and they would eventually lead to false discoveries.
Benchmarking and performanceThe automatic method in flowAI was compared both with a manual quality control using flowJo and the method in R package flowClean. The flowQ package was excluded from the comparison because it does not actively detect anomalies.
Agreement assessment with other approachesA fundamental element for the quality control of an FCS file to is the time channel. The datasets ZZYA, ZZY2, ZZY3, ZZYY, ZZY6 and ZZYZ seemed to be already pre-processed and did not have a proper time channel. Although flowAI is still able to check the signal and dynamic range of a FCS file without the time channel, in this case it is impossible for flowClean and impractical for flowJo to do the quality control. Therefore, only the remaining datasets with a proper time channel were used for the benchmarking. The flowJo analysis was executed by removing the margin events from the FSC-A and SSC-A scatterplot and unstable acquisition regions from the channel with more visible anomalies plotted against time. Regarding flowClean and the automatic method in flowAI, they were both run with default settings. The Cohen's kappa test was used to measure the agreement of two quality control methods on each FCS file. For the kappa statistic, a minimum value of anomalies was required to reach the significance level. For each dataset, the median of the significant kappa coefficients has been reported in. Overall, flowAI showed a stronger agreement with the manual quality control than with flowClean. Also, flowAI was the most stringent towards anomalies while flowClean was the most tolerant (and Supplementary). Nonetheless, both flowAI and flowClean still require a fine tuning of the settings for certain datasets to perform optimally. For example, better agreements would have been reached for the SLAS panel I dataset if less stringent settings were used for flowAI. In this respect, a decisive advantage of flowAI is its intuitiveness. In fact, based on the flow rate and signal plots, it is relatively easy to establish if the settings have to be more or less stringent. On the contrary, we found the diagnostic plot produced by flowClean harder to interpret.
Running timeThe running time of the automatic method in flowAI was measured on a laptop with a 2.7 GHz CPU and 16 GB of RAM. We used four batches of datasets to evaluate the time performance. Each batch consists of five datasets of increasing size (100, 500, 1000, 1500 and 2000 MB) formed using an increasing number of FCS files with same size, number of events and parameters (). The speed of flowAI is mostly influenced by the size of the FCS file rather than the number of parameters or events and the creation of the graphics for the full report takes the greatest amount of time. The possibility of creating a mini report containing only the percentages of anomalies is provided but it is discouraged for now, unless the user is sure of the nature of the anomalies in the entire dataset. On the contrary, the running time for flowClean increases considerably with the number of parameters because of its way of defining cell populations through combinations of positive signals from the different parameters (Supplementary). Overall, flowAI performance was faster for all the datasets used and, in particular, at least 3 times faster when using FCS files with 22 parameters (and Supplementary).
ConclusionOver the last few years, we have seen increasing efforts in automatizing pipelines of biomedical data analysis through computational algorithms. FCM is still one technique that hardly abandons the concept of manual analysis since usually the data produced has high variability that requires human interpretation. Often, the analysis demands high expertise and the results are still conditioned by a subjective evaluation. Our idea was born from the intention of removing the technical variability of FCM data in an objective way, thus reducing subjectiveness in interpretations and improving the performance of downstream computational analyses. This is especially the case when a high number of files is analyzed and when anomalies are generated by multiple sources. We defined an approach and created an R package, flowAI, to automatically or interactively detect anomalies in FCM data. First, anomalous patterns and peaks are removed from the flow rate automatically by a method built upon time series decomposition and the1 0 5 0 1 0 0 1 5 0 2 0 0 3 1 5 3 0 4 5 6 0. Running time of a quality control analysis with the automatic method of flowAI. The graphics' creation for the full report, that is fundamental for an accurate examination, takes a considerable amount of time. Alternatively, a mini-report containing only the percentages of anomalies is produced without significant running time increase flowAIGeneralized ESD test. Second, the tool checks the stability of the signal over time for each channel; here the automatic method uses a changepoint algorithm to detect durable shifts in the mean or variance of the acquisition values. Lastly, the dynamic range of the values acquired for each channel is refined. The upper limit is cleared of the margin events and the lower limit is cleared of the negative outliers. From the use of the flowAI package, we expect a general improvement in the quality of research that employs FCM instruments. Removing events with erratic intensity values will facilitate different aspects of FCM analysis such as: (i) more effective compensation since the overlap signal is subtracted only from real values; (ii) more accurate detection of rare cells due to the removal of background noise; (iii) easier characterization of the nature of an ambiguous cell population (either as undefined cell type or as technical issue). When using the automatic method for the quality control of a dataset of FCS files, it is preferable to infer the optimal settings for a dataset using a sample of few FCS files. In fact, because of the intuitiveness of the flowAI report, it is easy to infer the source of recurrent anomalies in a FCM experiment. Subsequently, the automatic method of flowAI can be run on the entire dataset with customized settings. Lastly, because the automatic quality control might still not meet the expectations for certain FCS files, the checking of the full reports reveals where it is necessary to intervene manually with the interactive method of flowAI or with another method. This last point is a limitation of flowAI that could be overcome by the dynamic adjustment of the settings of the automatic method, but for now it remains an open question that warrants further investigation. An additional consideration is that flowAI is designed to detect anomalies within a single FCS file, hence, other tools are necessary to check for anomalies between batches of FCS files. Also, another challenging task is the designing of a complete automatic pre-processing pipeline. In conclusion, our quality control approach produces a comprehensive check of the FCM data implementing algorithms never employed before. We recommend the usage of flowAI as a first preprocessing step of the data right after they are obtained from the FCM instrument so that all the downstream analyses, from compensation to detection or rare cells, will benefit from it.
at University of California, Los Angeles on August 30, 2016 http://bioinformatics.oxfordjournals.org/ Downloaded from
.2.2 Signal acquisition check The second step verifies the stability of the signal acquired over time. A common practice to verify the quality of signal acquisition is to use LevyJennings-type graphs, where fluorescence is plotted against time (Barnett and Reilly, 2007). A stable signal acquisition should produce intensity values whose distribution is consistent throughout the course of the entire experiment. This is the expected behavior if we assume that cells from a heterogeneous sample are randomly aspirated by the FCM tube over time. Therefore, changes in the signal intensities are not due to biological variation but rather to technical issues such as defective laser-detection system, voltage instability or poor quality of sample preparation, for example, inadequate vortexing. For each channel, flowAI creates LevyJennings-type graphs by splitting the intensity values of a marker in equally sized bins and plotting their median against time. This method is already implemented by the flowQ package, where the user can infer the quality of an FCS file from the visualization of time line plots. However, in addition to that, flowAI allows the removal of the regions with an unstable signal. As for the flow rate, this operation can be performed manually through visual inspection or automatically. The latter method implements a step detection algorithm to identify shifts in the mean and variance of the intensity values. The algorithm used, binary segmentation, is implemented in the changepoint package (Killick and Eckley, 2014). Its basic concept has been firstly described by the genetists Edwards and Cavalli-Sforza as a new clustering method based on the analysis of variance (Edwards and Cavalli-Sforza, 1965). This method is computationally fast and most frequently used among the changepoint detection methods. This approach iteratively splits the data in two groups at a time simply applying the method of least squares. In our case, given an ordered set of n fluorescence values m 1:n  (m 1 , m 2 ,. . ., m i ,. . ., m n ) corresponding to the medians of all bins, the total sum of squares (SST) from their mean is calculated as a measure of dispersion: SST  X n i1 m i  m 2 (4) A changepoint m i that splits the data in two segments, s 1 (m 1 ,. . ., m i ) and s 2 (m i  1 ,. . ., m n ), is detected when the cost function, represented by the within-groups sum of squares (SSW), is minimized: arg min i X i s11 m s1  m s1  2  X n s2i1 m s2  m s2  2 (5) The minimization of the cost function (5) is equivalent to the maximization of the between-group sum of squares (SSB), and the sum between SSW and SSB results in the SST. Each new segment created is in turn split in two segments by the repetition of the same procedure. The search of new changepoints terminates if either the minimized cost function is higher than a defined threshold or if a pre-established maximum number of flowAI
.3.2 Erratic populations revealed using dimensionality reduction Another approach consisted in applying a dimensionality reduction method, t-SNE (Maaten and Hinton, 2008), to capture non-linear relationships in the high dimensional space with the intensity values of high and low quality events. For the analysis we used the R package cytofkit that includes also an algorithm based on support vector machine to identify the clusters from the new components defined by t-SNE (Supplementary Fig. S8a and b). Using 2D plots of the first two components, we noticed that in most of the files a fraction of low quality cells was still superimposing to the populations of high quality cells while a remaining fraction formed separate sub-populations of events. In an FCS file from the SLAS dataset (Panel 1), we ascertained that the new populations in the low quality data mainly derived from dead cells and margin events; the borders are jagged and the shape is irregular reflecting the erratic nature of the acquired signal (Supplementary Fig. S8b). In contrast, the populations of high quality cells have smooth borders and a regular round shape. T-SNE was then computed on a B cell population preprocessed with flowJo, where debris, doublets and dead cells were removed (Supplementary Fig. S8c and d). In Supplementary Figure S8c, an irregular CD19 population is revealed that was not found in the analysis of the raw data (Supplementary Fig. S8b). Further analysis revealed that the expression values of the CD19 channel were recorded at the upper margin of the dynamic range. This demonstrates that anomalies in only one channel can be easily camouflaged as valid cell populations in a multi-dimensional analysis if a careful quality control has not been applied beforehand. Lastly, in Supplementary Figure S8d, a significant shift in the average acquisition signal is visible in the t-SNE analysis by the formation of adjacent complementary population. In summary, we advocate the importance of making a comprehensive cleaning on the data from different perspectives. Once faulty (a) (b) Fig. 3. SPADE analysis of the file 220662.fcs from the ZZZV dataset (a) before and (b) after quality control. The raw intensity median values and the coefficient of variation of the CD3, CD4 and CD8 channels are used as color-code for the population identified by SPADE. In (a) it is possible to localize the populations of CD4 and CD8 T cells and nodes with high coefficient of variation. In (b) the grey nodes are the population removed by the quality control
G.Monaco et al. at University of California, Los Angeles on August 30, 2016 http://bioinformatics.oxfordjournals.org/ Downloaded from
