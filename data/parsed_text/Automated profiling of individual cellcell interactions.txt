Motivation: There is a need for effective automated methods for profiling dynamic cellâ€“cell interactions with single-cell resolution from high-throughput time-lapse imaging data, especially, the interactions between immune effector cells and tumor cells in adoptive immunotherapy. Results: Fluorescently labeled human T cells, natural killer cells (NK), and various target cells (NALM6, K562, EL4) were co-incubated on polydimethylsiloxane arrays of sub-nanoliter wells (nanowells), and imaged using multi-channel time-lapse microscopy. The proposed cell segmenta-tion and tracking algorithms account for cell variability and exploit the nanowell confinement property to increase the yield of correctly analyzed nanowells from 45% (existing algorithms) to 98% for wells containing one effector and a single target, enabling automated quantification of cell locations , morphologies, movements, interactions, and deaths without the need for manual proofreading. Automated analysis of recordings from 12 different experiments demonstrated automated nanowell delineation accuracy >99%, automated cell segmentation accuracy >95%, and automated cell tracking accuracy of 90%, with default parameters, despite variations in illumination, staining, imaging noise, cell morphology, and cell clustering. An example analysis revealed that NK cells efficiently discriminate between live and dead targets by altering the duration of conjugation. The data also demonstrated that cytotoxic cells display higher motility than non-killers, both
IntroductionDynamic cell behaviors, especially cellcell interactions, are of vital interest in immunology (), cancer biology () and stem cell engineering (). Automated time-lapse microscopy of live cells in vitro is a well-established method for spatiotemporal recording of cells and biomolecules, and tracking multi-cellular interactions. Unfortunately, most conventional methods assess limited numbers (10100) of manuallysampled 'representative' cell pairs, leading to subjective bias and therefore lack the ability to quantify the behaviors of statistically under-represented cells reliably. This is significant since many biologically significant cellular subpopulations like tumor stem cells, multi-killer immune cells and biotechnologically relevant protein secreting cells, are rare. There is a need for methods to sample cellcell interaction events on a larger scale to investigate such cellular phenomena. Recent advances have enabled the fabrication of large arrays of sub-nanoliter wells (nanowells) cast onto transparent biocompatible polydimethylsiloxane substrates (;). Small groups of living cells from clinical samples, and laboratory-engineered cells can be confined to nanowells, and imaged over extended durations by multi-channel time-lapse microscopy, allowing thousands of controlled cellular events to be recorded as an array of multi-channel movies (). We refer to this method as Time-lapse Imaging Microscopy In Nanowell Grids (TIMING). The spatial confinement can enable a rich sampling of localized cellular phenomena, including cell movements, cellular alterations, and cellcell interaction patterns, along with the relevant intra-cellular event markers (). TIMING is thus ideally suited for tracking cell migration and interactions at short distances but if cell migratory patterns over larger distances are of interest, arrays with larger wells can be fabricated. Similarly, if unconfined migratory behavior of cells is desired, other methods have been described (). The promise and challenge of nanowell arrays, is high throughput, eliminating the need for user selection of events of interest, and the ability to repeatedly follow the same cell(s) over time.illustrates a TIMING dataset consisting of >11 000 nanowells containing fluorescently tagged human CAR  T-cells (red) and NALM-6 tumor cells (green) that were imaged by time-lapse microscopy over 80 time points at 5-min intervals to yield an array of 4-channel movies, one per nanowell. The border nanowells from each block are discarded, yielding 25 usable nanowells/block. TIMING datasets vary in size between 200 GB and 1.5 TB depending upon the array size, and the number of time points. A sample TIMING dataset corresponding to one block is provided as Supplementary Material A. Production datasets are often of lower quality than the example in, for example, see (4) and exhibit natural cellular variability, variations in signal to noise ratio (SNR), staining variations, focus drift, spectral overlap between fluorochromes and photobleaching. Our goal is to develop highly automated pipeline of algorithms that can reliably segment and track the cells in TIMING datasets with minimal parameter tuning, and yield a sufficiently rich set of cellularscale measurements for statistical profiling, without the need for manual proofreading (Supplementary Material B). A direct application of general-purpose segmentation and tracking algorithms is not a viable strategy since their yield (the number of correctly analyzed nanowells) is surprisingly low, and their parameter tuning needs are high. For example, a direct application of Alsegmentation algorithm with a reported accuracy >95% that is the core of the opensource FARSIGHT toolkit (farsight-toolkit.org) to the dataset inproduces an error-free yield of only 43% of the nanowells for the basic case when a nanowell contains one effector and one target (). The situation with tracking algorithms is similar. For example, in analyzing one sample block containing 36 nanowells, out of which 21 contained at least one cell, a state-of-the art algorithm () accurately tracked only six nanowells withAn array of 168  70 nanowells arranged in blocks of 7  7 (with 5  5 usable inner nanowells/block). (B) Enlarged views of five blocks highlighted by the red box in Panel A. (C) Timeseries data at 5-min intervals for the nanowell highlighted by the red box in Panel B. (D) Enlargement of a single frame of the time-lapse series for the nanowell shown in Panel C, showing 3 NALM-6 target cells (green), one CD19-specific CAR  T-cell (red, lower right) in contact with a target cell (contact region appears yellow) and a red fluorescent debris particle that is rejected in the analysis (left edge) (Color version of this figure is available at Bioinformatics online.). Illustrating automated image analysis challenges. (AH) Sample image frames. The red arrows indicate unclear boundaries between adjacent cells. The yellow arrows highlight low-intensity cells that are difficult to detect. The green arrows highlight cells that are difficult to segment due to non-uniform fluorescence. Panels A, B, D, E and F exemplify frames with low contrast and SNR. (I) Mean and standard deviation (error bars) of the background intensity (dark gray) and the foreground intensity (light gray) for the panels AH. (J) Variation in fluorescence distribution both across the pixels associated with one cell, and across cells. The red and blue histograms correspond to the cell indicated by the red and blue dots, respectively, in Panel H (Color version of this figure is available at Bioinformatics online.) zero errors (yield of 28%) (Supplementary Material C). When the yield falls below 90%, manual proofreading is essential to identify the nanowells that were tracked accurately. If on the other hand, when the automated accuracy exceeds 90%, the user can simply accept the automated results, and the modest error that they entail. General-purpose segmentation and tracking algorithms are inadequate because they do not exploit the powerful constraints that are germane to TIMING datasets, specifically, the spatial confinement of cells and rarity of cell divisions. They also lack mechanisms to cope with the higher morphological variability and non-uniform fluorescence of cell bodies compared with cell nuclei that were heavily studied in the prior literature (). In this article, we present algorithms that exploit the confinement and cell-cycle constraints, and utilize novel segmentation approaches to increase the yield to 98% for the basic case noted above (Results section, compareversus), and deliver high tracking accuracies (). At this level of performance, the quantitative measurements derived from automated segmentation and tracking can be directly utilized for statistical studies without the need for manual proofreading. The following sections describe our methodology.
Methods
Specimen preparation and imagingThe TIMING datasets were derived from ongoing studies in which human T cells (genetically engineered to express chimeric antigen receptor CAR) and natural killer (NK) cells were used as effectors. Antibodies for phenotyping of T cells were purchased from Biolegend (CA, USA). Human leukemic lines NALM6, K562 or mouse EL4 cells expressing the appropriate ligands were used as targets (T). Both cell types were washed once in serum-free medium, suspended to $2 million/mL and labeled with PKH67 Green and PKH26 Red dyes respectively, as directed by the manufacturer (SigmaAldrich). Approximately 100 000 effector (E) cells were loaded onto the nanowell array, followed by $200 000 target cells. Cells were allowed to settle into the nanowells for 5 min, and excess cells were washed away. Next, 50 mL of Annexin V-Alexa Fluor 647 (AnnVAF647, Life Technologies) was mixed in 3 mL of complete culture medium (RPMI-1640  10% FBS, containing no phenol red, Cellgro) and pipetted onto the nanowell array plate, thus immersing the array in the medium throughout the image acquisition while allowing for nutrition and gas exchange (37 C, 5% CO 2 ). The nanowell array is much wider than the field of view of the microscope, so a computercontrolled microscope stage (AxioObserver Z1, Carl Zeiss) was used to scan the array spatially. Images were collected over 12-13 hr periods at 5-10 min intervals. This temporal sampling rate is in the range of times described between first contact and killing in previous in vitro observations (). The stage movements from one block to the next require $100 ms, negligible compared with the sampling interval. We used an LD Plan Neofluar 20/0.4 NA Korr Ph1 Ph2 M27 (Carl Zeiss) objective lens combined with an optovar of 1 Tubulens, yielding a total magnification of 200, and a resolution of 0.325 mm/pixel (pixel size). A Peltier-cooled (10 C) digital scientific CMOS camera (ORCA-Flash 4.0 V2 C11440-22CU), or Hamamatsu EM-CCD camera were used for recording the images.The first entry indicates the number of nanowells containing the corresponding cell distribution (manually verified), and the second entry indicates the corresponding yield.
Automatic nanowell localizationAutomatic localization of nanowells is necessary for delineating the cell confinement regions, correcting for stage re-positioning errors, and breaking up the overall TIMING dataset into a large number of motion-corrected video sequences, one per nanowell. This operation must be reliable since a single well-detection error can render the nanowell unusable for analysis, reducing the experimental yield. It must be robust to focus drift (accounting for shrinkage/swelling/irregularity of the polymer substrate), wells with compromised geometry, illumination variations, ringing artifacts and debris or air bubbles that may move, and abruptly appear/disappear from the camera view over time (). Content-independent image registration methods like SIFT matching () were neither sufficiently reliable nor practical for TIMING data. They required multiple parameter adjustments, and failed in the presence of artifacts. Therefore, we adopted a normalized cross-correlation (NCC) based template fitting method that is robust to illumination variations and artifacts (). We exploited the fact that the geometry of nanowells is known from the fabrication process, and they are always visible in the phase-contrast channel. Note inthat some of the nanowells are intentionally rotated by 45 for implementing a coding strategy designed to uniquely locate individual wells in an array. Therefore, we select two empty wells (regular and rotated by 45 ) from the dataset being analyzed and use them as templates that are fitted to the image data. The NCC responses are in the range of (1, 1), with 1 indicating a poor match, and 1 a perfect match. To speed up NCC, we used a Fourier implementation, and performed the normalization in the spatial domain.shows the NCC responses of the example wells into the best-fitting (of the two) templates in. We used the local maximum clustering algorithm () on the best-fitting NCC response to detect well centers, and used the known spacing between nanowells to filter out invalid responses, yielding a robust localization of wells with >99% accuracy (Section 3). To cope with artifacts, we discard the nanowell videos whose maximum NCC response falls below a predefined threshold (typ. 0.75). The resulting rigid spatial transformation estimates () are used to generate cropped motion-corrected nanowell video recordings.
Image pre-processingEach image frame of every video sequence is leveled to correct illumination variations by subtracting the local background estimated at each pixel using a Gaussian kernel with r  15 (). Next, we correct for spectral overlap between the emission spectra of the PKH67 and PKH26 dyes used to label the effector and target cells. The columns of the mixing matrix are estimated offline using principal component analysis for a 7  7 block of nanowell videos, and then re-used across the rest of the array. The unmixing was performed by the linear inverse method ().Note that the NMTDM computation is only performed for the foreground pixels, and can be carried out efficiently in parallel for different connected components. This map exhibits much clearer peaks compared with the multi-scale LoG (versus C), and allows reliable cell detection. Individual cells are detected using local maxima clustering over the NMTDM (). This step requires only two parameter settings: the number of levels M, and the clustering radius r for selecting the peaks. Using this, we estimate the number of cells independently for each frame, and compute a histogram over the time series (). Knowing that the number of cells in a nanowell staysconstant (cell divisions are rare within the observation period), the presence of more than one non-zero entry in this histogram implies that conventional segmentation and tracking results would be error prone for this nanowell, and require proofreading. However, the histogram exhibits a peak at the correct cell count (4). We found that the histogram peak is a reliable indicator of cell counts over a time-lapse sequence despite errors in individual frames, and the height of the peak of the normalized histogram is a reliable measure of our confidence in the cell count. For this illustration, the peak reaches 82%. We discard nanowells for which the peak falls below 75%.
Confinement constrained cell re-segmentationAlthough the above-described method is effective for estimating the correct number of cell bodies, it does not yield precise cell location estimates and cell segmentations, because it assumes that the cells are brighter closer to their centers. Our strategy to overcome this limitation is to use the histogram-based cell count estimate to re-segment the cells de novo by a normalized spectral clustering of image pixels (). This method can detect cells of diverse shapes, and tends to estimate clusters (cells) with similar sizesa reasonable assumption when handling ambiguous images. Given N foreground pixel coordinates fx i g i1; ... ;N , we compute a similarity matrix W 2 R NN as follows:where e is a user-defined constant representing the maximum distance between a pixel and its neighbors, jj:jj is the Euclidean norm, and r controls the neighborhood width. Next, we compute the degree matrix D and the un-normalized graph Laplacian matrix L  D  W where D is a diagonal matrix defined as:Wi; j:From this, we form the matrix U  u 1 ;. .. ; u K  2 R NK by computing the first K eigenvectors u 1 ;. .. ; u K of the generalized eigenvalue problem Lu  kDu. Finally, we cluster the points fy i g i1; ... ;N corresponding to the rows of U into clusters C i ; i  1;. .. ; K, and re-label the foreground pixels fx i g i1; ... ;N accordingly. This method (G) enables cells in video sequences to be re-segmented accurately despite errors on individual frames. We are guaranteed to obtain a fixed number of cells across each movie, and this simplifies cell tracking. Interestingly, the confinement constrained cell re-segmentation algorithm also enables efficient editing of incorrect segmentation and tracking results. If needed, a user can re-run the spectral clustering based re-segmentation with the corrected cell count, and this yields the correct results in most cases.
Confinement-constrained cell trackingReliable cell tracking is needed to quantify the complex motile behaviors of cells at high throughput. The low temporal sampling rate (510 min/frame) implies that cells can undergo significant displacements and shape changes between frames. In addition, the effect of the nanowell walls makes it difficult to predict cell movements. Importantly, we wish to avoid the need for manual proofreading. With these considerations in mind, we propose a confinement-constrained tracking method that is fast, fully automated, and reliable. It is formulated globally over the entire movie, rather than on a successive frame-by-frame basis. It does not require any initialization, and requires only three parameters. Note that our algorithm is not proposed for general-purpose cell tracking problems. It is designed specifically for confinement-constrained TIMING data with no cell divisions and sparse temporal sampling. For general problems, sophisticated cell-tracking methods have been described and compared in the literature (). The approaches include particle filtering (), Kalman filtering () that require a motion model and an observation model, but do not need prior segmentations. Contour based (), mean-shift () and level-set methods (), are preferable when high-temporal resolution data are available, and some can handle merging and splitting of cells implicitly (). Optimization-based approaches () require objects to be detected/segmented a priori and are preferred for low temporal resolution data. When objects can enter/exit the field, cells divide or die, or when the segmentation is unreliable, elaborate methods are described to handle appearance, disappearance, merge and split and automatic correction of segmentation errors (). For TIMING data, we are unconcerned with such complications because of the nanowell confinement property, so our formulation is a streamlined one. We formulate the tracking of K cells over T frames as a globally optimal edge selection problem on a directed graph. A node n t j in the graph represents cell j at frame t, and is described by an attribute vector d t j  fc t j ; a t j ; r t j g, where c t j  x t j ; y t j  is the centroid; a t j is the area of the cell; and r t j denotes the pixels defining cell j. An edgeAutomated profiling of individual cellcell interactionse t i;j  fn t1 i ; n t j g associates cell i at frame t  1 to cell j at frame t, and we compute an association cost u t ij that measures the dissimilarity between cell regions i and j. An edge selection variable c t ij 2 f0; 1g indicates if a given edge is selected in the final solution. Using integer programming, we seek the solution c 2 f0; 1g N , where N  T  1  K  K that minimizes the following sum of association costs over each nanowell:s:t:t  2;. .. ; T:The cell confinement constraint is implicit in this formulation. The inequality constraints ensure that each node n t j is associated with a maximum of one node in the previous frame, and the next frame, respectively. In computing u t i;j , we ignore shape and texture features since cell morphologies and intensity profiles vary over time. We compute a weighted sum of the Euclidean distance between cell centroids gc i ; c j , the area difference between cells ga i ; a j   ja i  a j j, and the following set-theoretic distance between the pixels r i ; r j  for the two cells:where a overlap is the overlapping area, and min distr i ; r j  is the shortest distance between the cells' pixels. The overall cost is written as u ij  w 1  gc i ; c j   w 2  ga i ; a j   w 3  gr i ; r j , where the weights w 1 , w 2 and w 3 can be adjusted if needed. We used the default values w 1  1, w 2  10, and w 3  100. One can increase w 3 when high temporal resolution data and good segmentation results are available. We solve the integer program in Equation (4) using the branch-and-bound algorithm (). Although the theoretical worst-case running time can grow exponentially, this is not a concern since we are processing small cohorts of cells in each nanowell.illustrates the results of automated tracking for a nanowell containing only effector cells, showing our ability to cope with large inter-frame movements. Panels BE depict sample cell trajectories for effector and target cells with diverse motion patterns. Additional examples are presented in.
Detection and quantification of cellcell contactsDetecting contacts between effectors and targets, and measuring the contact parameters (e.g. onset time, duration, frequency, extent) is needed for understanding how cell behaviors predict subsequent events of interest, especially the killing of targets by effectors. Approaches using the spatial proximity of cell segmentations () can be unreliable for TIMING data since they require much higher resolution imaging, and are sensitive to segmentation errors. With this in mind, we define a soft cell interaction measure CI for quantifying the interaction of a cell with its surrounding cells, as follows. First, we compute the normalized effector fluorescence signal I j N x; y in each nanowell j. Next, we define a series of ring-like compartments using a Euclidean distance map Dx; y with respect to the segmented target cells as illustrated in. Pixels with distances between k and k  1 pixels form compartments b k with inner radii k  f1; 2;. .. ; ng, where n is the maximum distance needed to cover the complete nanowell. We sum the fluorescence intensities over each compartment, and normalize them by their radii k that are proportional to the compartment areas. With this, the cell interaction measure CIt is the following weighted intensity summation:shows how CI (t) captures contacts between NK cells and K562 cells in a graded manner over an image sequence. This measure can be thresholded to detect contact events with a desired sensitivity. The threshold is set and verified manually by an immunologist based on visual verification of at least 30 nanowells for each TIMING dataset, starting with a default value (typ. 0.01). We consider this visual verification to be valuable due diligence. A full manual annotation of the contacts by five independent observers over 156 nanowell videos showed a 90.4% concordance with the default threshold. In order to definitely assign contact, it is defined to occur when the threshold criterion is met for two successive frames. The CIt measure is defined above for a single cell and its neighbors. It can be extended to handle multiple cells by using the segmentation masks.
Feature computationFor each cell, the automated segmentation and tracking operations produce multiple time series of primary features including cell location x; y, area at, instantaneous speed vt, cell shape as measured by the eccentricity of the best-fitting ellipse et, and the contact measure CIt. In addition, target cell death events (apoptosis) are detected using Annexin V whose summed fluorescence intensity i d t, is measured as another primary feature. Next, we compute cellular features at the scale of each nanowell, specifically, the number of effector cells n e , target cells n t , dead effectors n ed , contacted targets n tc , and killed targets n tk. These measurements can be used to profile the nanowells. The primary cellular features capture essential aspects of the cellular activities within each nanowell, but they have two disadvantages. First, they have a variable dimensionality, since the number of time points varies across TIMING experiments. Second, a longexperiment can result in unnecessarily high-dimensional feature data. With the intent of deriving meaningful lower-dimensional representations of cellular events independent of the number of time points, we derive a set of eight secondary features for each cell. For each cell, we compute the average speed prior to first contact v free , average speed during the contact phase v contact , average cell eccentricity prior to first contact e free , average eccentricity during the contact phase e contact , time elapsed between first contact and death Dt d , total contact duration between first contact and death Dt cd , time duration before first contact Dt free , the number of conjugations prior to target cell death n cd .
Experimental resultsThe proposed method was evaluated on 12 TIMING experiments involving combinations of target cells (NALM6, K562 and EL4) and effector cells (NK cells or CAR  T cells), to evaluate its ability to cope with biological and imaging variability, different cell types, and varying experimental conditions. All the datasets were analyzed using the parameter settings summarized in. Given the sheer volume of the data, we start by presenting a visual summary of sample segmentation and tracking results in. Overall, the algorithms and parameter settings proved reliable for automated analysis. As a detailed example, we present results of manually validating the segmentation and tracking on a small dataset with 2000 nanowells containing CAR  T cells and NALM6 cells imaged over 7080 time points. Of these, 157 nanowells had more than four effectors or targets. These larger cohorts are irrelevant for the current biological study of interest, so they were omitted from further analysis. An additional 33 wells (1.7%) were discarded because the confidence in cell counts (histogram peak) was below 75%. Of the remaining 1803 nanowells, only 7 were not detected accurately due to air bubbles, so our overall nanowell detection accuracy exceeds 99%.
1 Improvement in yieldIn order to assess the fraction of wells with zero cell detection errors, we manually validated the results over the 1803 remaining nanowells using the proposed method and the () algorithm was used as a benchmark. The results are summarized in. For the table entries with >90 wells, we manually validated 40% of wells, and the full set of wells for the remaining entries. Comparing the corresponding entries in Tables 1 and 2 show that the proposed method dramatically increased the number of usable wells. The few errors were due to persistently dim fluorescent cells that were missed, or because a cell was persistently occluded by another cell for >80% of the recording duration. For perspective, yield rates <90% render the automated image analysis results unusable, since the user has to manually analyze an excessive number of nanowells. With a yield close to 98%, the user can simply accept the automated results, and the modest error that they entail.
Cell segmentation and tracking performanceA total of 5061 cells were segmented and tracked in this dataset. The automated segmentation and tracking results were overlaid on the movies and presented to an immunologist, and the errors were scored as: under-segmentation, over-segmentation and incorrect association. Over-segmentation errors appear when a cell is identified as two or more objects. Under-segmentation occurs when the same label is assigned to multiple cells. Both of these errors can occur if the cell count is incorrect. Incorrect correspondence occurs when the tracking fails, usually due to segmentation errors. We consider a single association error sufficient to render the tracking results for a nanowell movie unusable. Despite this stringent requirement and the high volume of data, the algorithm is extremely accurate (). We next compared automatic segmentations of 30 randomly selected target and effector cells against manual segmentations. The Jaccard similarity index for target cells was 0.86 6 0.12 (mean 6 SD.) and 0.78 6 0.17 for effector cells, indicating good segmentation accuracy.
Data analysisWe analyzed a TIMING dataset containing 11 520 nanowells (320 blocks of 6  6 wells) in which we imaged the dynamics of killing of K562 cells by in-vitro expanded NK cells for 8 h at 6-min intervals. From the automatically extracted features, we selected only the nanowells containing exactly one effector and one target cell, showing a stable effector-target contact of at least 6 min (two successive frames), and in the case of target death, contact by effector prior to death. This resulted in a cohort of 552 nanowells that is ideal for analyzing the dynamic behaviors of effectors, without the confounds associated with multi-effector cooperation or serial killing. Comparisons of the out-of-contact motility and the velocity during tumor cell conjugation demonstrated that NK cells that participated in killing displayed higher motility during both phases (), consistent with our recent report that demonstrated that motility might be a biomarker for activated immune cells (). Furthermore, for NK cells the change in speed and arrest upon target cell ligation is well documented (). Second, we were also interested in quantifying differences in NK cell behavior in interacting with live or dead cells. Of all the NK cells that participated in killing, only 18% re-conjugated to target cells subsequent to apoptosis, and when they did, their duration of conjugation 18 6 14 min was significantly shorter than conjugations mediated by the same NK cells to live tumor cells (52 6 72 min) (). These results suggest that NK cells largely avoided conjugating to dead target cells, and even when they did, made an early decision to terminate the conjugation.Automated profiling of individual cellcell interactions
ImplementationFor a block with 36 wells and 60 cells, the processing time is 910 s/ block per time point on a Dell 910 PowerEdge server with 40 CPU cores, 1 TB of RAM, and a RAID 5 storage system. The cell tracking took 1.1 s/block; segmentation took 3.1 s/block; well detection took 1.5 s/block; and feature computation took 3.5 s/block. Various portions of the software were implemented in Python and C, and MATLAB (Supplementary Material D).
ConclusionsThe combined TIMING system consisting of the nanowell arrays and the proposed confinement-constrained image analysis methods enables a far more comprehensive sampling of cellular events than is possible manually. The proposed algorithms dramatically improved the yield and accuracy of the automated analysis to a level at which the automatically generated cellular measurements can be utilized for biological studies directly, with little/no editing. Most segmentation and/or tracking errors (mostly due to persistently low fluorescence (dim cells), or persistent cell occlusion over extended durations) can be detected based on the histogram threshold method, and the corresponding nanowells can either be ignored or edited. Our pipeline is now in active use in several biological studies being reported separately (e.g.). It is scalable to multi-terabyte datasets, and does not require elaborate initialization or careful parameter tuning. Supplementary Material D includes the software for the computational pipeline that enables routine, accurate, comprehensive, high-throughput, and high-yield analysis of TIMING datasets on multi-core computers.. Visual summary of segmentation and tracking results involving various target cells (NALM6, K562 and EL4) and effector cells (NK cell or CAR  T cell) from 12 TIMING experiments, all run with identical parameter settings (). The upper rows show sample frames. The middle rows show segmentations. The bottom rows show the cell tracks (Color version of this figure is available at Bioinformatics online.)
at University of California, Los Angeles on August 30, 2016 http://bioinformatics.oxfordjournals.org/ Downloaded from
A.Merouane et al. at University of California, Los Angeles on August 30, 2016 http://bioinformatics.oxfordjournals.org/ Downloaded from
Fig. 3. Illustrating automated localization of nanowells. (A) Examples of nanowells showing artifacts. (B) NCC for the best-fitting template. (C) Estimated nanowell cropping regions (Color version of this figure is available at Bioinformatics online.) Fig. 4. Illustrating the pre-processing (leveling, smoothing, unmixing, illumination correction) for a sample 5  5 nanowell block. (A) Shows the presence of well outlines in the target (NALM-6 cells) channel. Panels A1 and A2 show close-up views of two selected nanowells. (B) The corresponding effector (CAR  T cells) channel. Panels B1 and B2 correspond to the same nanowells highlighted in A1 and A2, respectively. Panels C and D show the target and effector channels after pre-processing. The histograms of pixel intensities in the green boxes on top of the images show the uneven illumination in the raw image that is corrected by the pre-processing (Color version of this figure is available at Bioinformatics online.)
Finally, we smooth the images using a median filter with radius r m  3 while preserving cell boundaries. As noted by other authors, such pre-processing is essential for reducing high-throughput cell segmentation errors (Singh et al., 2014). Even after pre-processing, cells exhibit variability in shape and intracellular fluorescence (Fig 5A), and this is a challenge for cell detection and separation of touching/overlapping cell bodies. The widely used multiscale Laplacian of Gaussian (LoG) map (Al-Kofahi et al., 2010) misses the dim cell indicated by the red arrow, and is unable to separate the pair of cells indicated by the yellow arrow that exhibit non-round shapes and non-uniform intensities (Fig. 5C). Gradient-weighted watershed algorithms (e.g. Lin et al., 2007) have difficulty separating cells with weak edges. In order to overcome these limitations, we propose a normalized multi-threshold distance map (NMTDM) (Fig. 5C) that is designed to detect cell bodies, and it works by averaging distance maps corresponding to multiple thresholds, as follows. First, the normalized pixel intensity distributions p (i) of our pre-processed images are modeled by a mixture of 3 Gaussian distributions pi  X K k1 w k gi j l k ; r k , with parameters l k ; r k  and weights w k , k  1; 2; 3 that capture the dim background, intermediate foreground, and hyper-fluorescent foreground pixels, respectively. We use the k-means algorithm with deterministic seeding for estimating the mixture weights since it is fast, requires few initialization parameters, converges reliably, and produces comparable results to expensive expectation maximization algorithms, making it ideal for our high-throughput analysis. Clusters 2 and 3 together capture the image foreground. This foreground is divided into a set of connected components denoted R h ; h  1;. .. ; H. Next, let L min and L max denote the minimum and maximum pixel intensity values for this foreground. We define a series of M threshold levels (typ. 20) denoted l between L min and L max separated by d  L max  L min =M, so l  L min ; L min  d; L min  2d;. .. ; L max. Each of these thresholds is used to generate a corresponding binary mask denoted B l x; y and a corresponding Euclidean distance map D l x; y. We then normalize the Euclidean distance maps for each connected component by the corresponding maximum value within each connected component R h , to ensure that the distance maps at different levels contribute equally to the final response. With this, the NMTDM for each connected component R h can be written as the following pixel-level average of normalized distances across the thresholding levels l:
