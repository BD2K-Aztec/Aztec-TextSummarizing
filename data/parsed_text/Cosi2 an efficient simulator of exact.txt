Motivation: Efficient simulation of population genetic samples under a given demographic model is a prerequisite for many analyses. Coalescent theory provides an efficient framework for such simulations , but simulating longer regions and higher recombination rates remains challenging. Simulators based on a Markovian approximation to the coalescent scale well, but do not support simulation of selection. Gene conversion is not supported by any published coalescent simulators that support selection. Results: We describe cosi2, an efficient simulator that supports both exact and approximate coalescent simulation with positive selection. cosi2 improves on the speed of existing exact simulators, and permits further speedup in approximate mode while retaining support for selection. cosi2 supports a wide range of demographic scenarios, including recombination hot spots, gene conversion, population size changes, population structure and migration. cosi2 implements coalescent machinery efficiently by tracking only a small subset of the Ancestral Recombination Graph, sampling only relevant recombination events, and using augmented skip lists to represent tracked genetic segments. To preserve support for selection in approximate mode, the Markov approximation is implemented not by moving along the chromosome but by performing a standard backwards in time coalescent simulation while restricting coalescence to node pairs with overlapping or near-overlapping genetic material. We describe the algorithms used by cosi2 and present comparisons with existing selection simulators. Availability and implementation: A free C+ + implementation of cosi2 is available at
INTRODUCTIONA wide variety of population genetic analyses depend on efficient simulation of samples under a demographic model. The most efficient simulation method works backwards in time from the sample, first simulating the sample's genealogy according to coalescent theory and then placing mutations on that genealogy. Because of crossing over and gene conversion, the overall genealogy for a simulated region is not a tree but a directed acyclic graph whose size grows quickly with region length and with recombination rate. To address this simulation bottleneck, a Markovian approximation was proposed and implemented (). However, the Markovian approximation does not readily allow for the modeling of positive selection. Simulators that do support positive selection (e.g.) suffer from the performance limitations of the traditional coalescent, and do not support all commonly needed features (variable genetic maps, gene conversion, structured populations) within a single framework. Here, we describe the simulator cosi2, which implements the standard coalescent simulation algorithm but which does so using several optimizations that greatly reduce memory and CPU requirements. The use of the original coalescent allows cosi2 to support simulation of positive selection using the standard structured coalescent approach. For additional efficiency, the Markovian approximation can be enabled while retaining support for simulating selection. Cosi2 supports population structure, population size changes, bottlenecks and migrations. Recombination rate can be varied along the simulated region, and the program includes a utility to generate genetic maps with recombination hotspots. Cosi2 also supports a simple model of gene conversion.
ALGORITHM DESCRIPTIONHere, we describe the different optimizations which, taken together, greatly improve the scaling behavior of coalescent simulations (). We also describe the implementation of positive selection modeling in cosi2. Additional details of the algorithms are given in the Supplemental Information.
NotationAn ancestral recombination graph (ARG) is a directed graph, where each node represents a chromosome contributing some genetic material to the present-day sample. Let G be an ARG and n be its node. ch(n) is the set of n's children. G 0 fn 2 G j chn=;g. PL denotes the set of physical locations along the chromosome, represented as the unit interval 0; 1. inhn i ; n j  denotes the subset of PL (possibly empty) inherited by n j from n i. Ln; s fn 0 2 G 0 j inhn; n 0  \ s 6  ;g. locsn fx : PL j Ln; fxg 6  ;g. n b minlocsn, n e maxlocsn. coaln i ; n j ; n c  means n c resulted from *To whom correspondence should be addressed.  The Author 2014. Published by Oxford University Press. All rights reserved. For Permissions, please e-mail: journals.permissions@oup.com coalescence of n i and n j ; recombn r ; x; n i ; n j  means recombining n r at x produced nodes n i and n j .
Tracking only the veneer of the ARGCoalescent simulators typically work in two phases. First, they simulate the genealogy of the sample, known as the ARG. Second, they simulate mutations on that geneology. Cosi2 combines these into one phase, avoiding construction of the full ARG. During simulation, only a thin frontier of the ARG is kept, along with bookkeeping information sufficient for placing mutations. Standard coalescent simulations begin by initializing the ARG with the present-day population sample G 0. A sequence of coalescences and recombinations is then sampled, updating G: for a coalescence of nodes n i and n j producing n c , G G [ fn c g; for a recombination of node n r into nodes n i and n j , G G [ fn i ; n j g. Then, mutations are placed on the ARG. For mutation placed above node n at chromosomal location x 2 locsn; Ln; fxg is found by tracing down the ARG: Ln; fxg=G 0 \ tracen; x where tracen; x=fng [ [ftracec; x j c 2 chn ^ x 2 locscg. In cosi2, ARG nodes are discarded as soon as a parent is generated. For coalescence, G G [ fn c g n fn i ; n j g; for recombination, G G [ fn i ; n j g n n r. Not keeping the full ARG removes a computational bottleneck, but discards information needed to compute Ln; fxg when placing mutations. To compensate, we store for each node n the full function L n x=Ln; fxg, represented efficiently using skip lists (see below). L n is updated incrementally during simulation:i ; x. Despite not being kept in memory, the full ARG can be logged to a file using an option described in the documentation.
Efficiently representing segment listsThe piecewise constant function L n is represented efficiently at each node as a skip list () of segments on which it is constant and non-empty. The skip pointers of the skip list are augmented with the total physical and genetic length of the skipped segments. Standard skip-list techniques then permit logarithmic-time updates of L n during recombination, coalescence and gene conversion. Keeping just the veneer of the ARG works synergystically with skip lists: as nodes participating in recombination or coalescence are discarded immediately after the operation, large portions of their skip lists can be reused in constructing the skip-list representation of the result.
Efficient sampling of crossovers and gene conversionsThe vast majority of crossover and gene conversion events do not change the ARG but do take time to track. These are either crossovers falling entirely to one side of a node's segment list or gene conversions falling entirely outside any segment. Cosi2 directly samples only crossovers and gene conversions that actually change the ARG, by keeping the crossover and gene conversion rates of the individual nodes in a Fenwick tree data structure supporting quick access to the total rate and efficient sampling of event location weighted by the genetic map. The skip-list representation of segment lists allows incremental updating of the node's individual event rates.
Modeling of selectionSelection is implemented using the structured coalescent approach (). At start of simulation, sampled chromosomes are partitioned into two classes based on their allelic state at the selection site. Coalescence happens only within the same allelic class, with coalescence rate based on the frequency trajectory of the causal allele. The frequency trajectory of the selected allele can be deterministic (based on causal allele age and present-day frequency), or can be provided externally; the latter mode permits the use of stochastic trajectories generated for any selection model.
Implementing the Markovian approximationWe implement an approximation to the coalescent, in which coalescences are restricted to occur between nodes whose genetic information overlaps or nearly overlaps. This approximation was proved equivalent to the Markovian simulation of coalescent along the chromosome (). By modifying only the coalescence step within an existing coalescent simulator that supports selection, we add the ability to approximate the coalescent while preserving support for simulating selection. The approximation speeds up computation by reducing the number of coalescence and recombination events generated during simulation. For two nodes p, q where p e ( q b , repeated cycles of coalp; q; r followed by recombr; x; p; q where p e x q b are avoided. Such cycles do not change the output when no coalescences involving r happen between coalp; q; r and recombr; x; p; q. In general, ignoring such cycles yields an approximation, the quality of which is checked empirically. Sampling restricted coalescences requires knowing, at each simulation step, the number of coalesceable node pairs. We maintain this information incrementally using a dynamic data structure based on augmented interval trees. We define a hull of a node n as Hn=n b ; n e +u where u is a parameter controlling the amount of approximation (smaller u means greater approximation). We declare two nodes coalesceable if theirhulls overlap; u therefore specifies the maximum separation between coalescing nodes, as a fraction of the total length of the simulated region. We can dynamically maintain the count of coalesceable node pairs. Initially, the count equals jG0j
.Adding a hull n b ; n e  adds jGj  jfn 0 j n 0e 5n b gj  jfn 0 j n 0b 4n e gj to the count of hull intersections (). Hull removal is analogous. Because all coalescent operations (crossover, gene conversion, coalescence and migration) can be implemented as a sequence of hull additions and removals, we can maintain the count of coalesceable node pairs with only logarithmic overhead. Selecting a coalesceable pair uniformly at random requires maintenance of additional information; description of the implementationalso requiring only logarithmic time and space overheadis given in Supplemental Information.
at :: on August 30, 2016 http://bioinformatics.oxfordjournals.org/ Downloaded from
I.Shlyakhter et al. at :: on August 30, 2016 http://bioinformatics.oxfordjournals.org/ Downloaded from
SUMMARY cosi2 provides a combination of performance and supported demographic scenarios unavailable with existing selection-supporting simulators. We hope it becomes a useful tool for population geneticists studying positive selection. Funding: PCS is funded by an NIH Innovator Award 1DP2OD006514-01 and by a Broad Institute SPARC award. Conflict of interest: none declared.
Cosi2 at :: on August 30, 2016 http://bioinformatics.oxfordjournals.org/ Downloaded from
