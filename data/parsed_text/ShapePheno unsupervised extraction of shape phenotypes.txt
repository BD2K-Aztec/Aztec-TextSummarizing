Motivation: Accurate large-scale phenotyping has recently gained considerable importance in biology. For example, in genome-wide association studies technological advances have rendered genotyping cheap, leaving phenotype acquisition as the major bottleneck. Automatic image analysis is one major strategy to phenotype individuals in large numbers. Current approaches for visual phenotyping focus predominantly on summarizing statistics and geometric measures, such as height and width of an individual, or color histograms and patterns. However, more subtle, but biologically informative phenotypes, such as the local deformation of the shape of an individual with respect to the population mean cannot be automatically extracted and quantified by current techniques. Results: We propose a probabilistic machine learning model that allows for the extraction of deformation phenotypes from biological images, making them available as quantitative traits for downstream analysis. Our approach jointly models a collection of images using a learned common template that is mapped onto each image through a deformable smooth transformation. In a case study, we analyze the shape deformations of 388 guppy fish (Poecilia reticulata). We find that the flexible shape phenotypes our model extracts are complementary to basic geometric measures. Moreover, these quantitative traits assort the observations into distinct groups and can be mapped to polymorphic genetic loci of the sample set.
INTRODUCTIONWith the advent of high-throughput genotyping techniques an unprecedented breadth of genotypic datasets can be generated, opening doors to large-scale association studies, promising sufficient power to understand the genetic underpinning of more subtle phenotypes that characterize the sample. As phenotyping often * To whom correspondence should be addressed. requires manual labor and expert knowledge, a major bottleneck now lies with the identification and quantification of informative traits. Currently, the quantification of phenotypic traits is predominantly done in a semi-manual fashion, rendering the task of analyzing large datasets expensive, time-consuming and error-prone. In order to address these shortcomings, the automated analysis of biological images has become a staple in modern biology. High-throughput imaging techniques for various types of microscopy and other imaging modalities have become common in the experimental environment. Automated image analysis for bioimaging attempts to deal with the flood of data and subsumes a large variety of tasks and methods; for a comprehensive review, see Peng (2008) and. Common tasks include the counting of cells in microscopy images and differential analysis of distinct cell types (). Key challenges in bioimage informatics stem from the breadth and individuality of natural variation within these images and dealing with the inherent noise in biological imaging tasks. In order to deal with these factors, machine learning techniques have raised considerable attention and are used to tackle various complicated tasks in realistic settings (). For example, in the analysis of appearance phenotypes machine vision has been used to quantify the extent of existence of predefined visual features or detect interesting appearance features that characterize the data (). Visual appearance features usually pertain to specific local properties of the depicted objects. However, more general visual phenotypes often are also biologically informative, such as the description of the shape of an object and the quantification of global (including size and height) as well as local (i.e. locally deformed parts of an image) shape variations. An example where such a method is useful is the characterization of the shapes of guppy fish, which so far can only be analyzed by labor-intensive manual geometric phenotype measurements on hundreds of fish, as performed in (). Our goal is to automatically determine and quantify differences among observed shapes in biological images in order to interpret them as shape phenotypes and facilitate downstream analysis, for instance association tests of traits with putative causal factors in the genome. In this work, we propose an unsupervised machine learning method to quantify shape variations of a given object class depictedin a set of images, one per individual or sample. We postulate the existence of an unobserved reference shape, called a template. We proceed with joint learning of this shared template and the imagespecific shape deviation from this reference, allowing every image to be aligned to it. The resulting template iteratively converges to an idealized mean image from which the observed images are generated through deformation fields that explain the variation in shape of each image (). The converged model can also be run backwards, yielding a reconstruction of every image from the template and the mapping fields (R in). The general task of aligning two or more images is also known as registration, where a correspondence between pixels of one image and pixels of another image is established. For exampleperform a simpler form of registration, where images are aligned to a known template. In contrast to previous studies, our method does not require explicit knowledge of the template a priori; neither is supervision like setting of landmarks or outline selection/binarization on each image required. Instead, ShapePheno discovers and objectively quantifies deformation phenotypes on unannotated images in a fully unsupervised fashion while retaining interpretable features and results. Thus, our approach facilitates obtaining accurate non-trivial measurements on large datasets where human labor is costly and error-prone. In Section 3, we present a case study of our method on guppy fish, Poecilia reticulata. The individuals in this dataset are subject to variation in appearance and shape. Interestingly, both appearance and shape variability have previously been shown to exhibit considerable genetic components (). In Section 3.3, we describe the basic approach of quantifying shape phenotypes using our model. We demonstrate that these quantitative traits are orthogonal to traditional geometric measures (Section 3.4) and show practical utility of these traits in the context of two fundamental types of downstream analyses. First, in Section 3.5, we show how learned shape features allow for grouping the observed images into plausible similarly shaped or deformed subgroups based on characteristic deformation patterns. Second, in Section 3.6, we show that quantitative shape phenotypes can be associated to variable genetic loci in the guppy genome. This analysis serves both as a step towards obtaining further knowledge as to the underlying biological processes that lead to variation of these phenotypes as well as a natural validation step, suggesting that the automatically determined phenotypes are biologically relevant.
METHODSExtraction and quantification of shape features is carried out in two steps. In Section 2.1, we discuss how a graphical model based on Markov random fields (MRF) can be used to simultaneously learn the unknown template and recover smooth mapping fields, performing a flexible variant of deformable registration. We decompose the mapping fields into a sum of a technical translation component and shape-related deformation fields, both specific to each image. The overall setup of our probabilistic model largely follows the jigsaw model (). Under this model, a set of N observed images I i , i = 1,...,N is explained by a common latent template image T. The training images are explained as function of the template through learned mapping vectors L i between pixels in the template and observed pixels in each image i. The coordinate mapping accounts for an overall shift of the image with respect to the template, as well as local deformations, compressing or stretching specific parts of each image to match the common reference (Section 2.2). Subsequently, once the template and the deformation fields are learned, we extract quantitative traits from the information captured in the deformation fields. For this purpose, we employ linear dimensionality reduction (Section 2.3), yielding a compact set of features that explain the major axes of variation in the deformation fields for each image. For comparison, we also show how our model can be used to quantify length vectors within images, which can be directly related to established manual measurements of shape traits. Both types of features can be used for downstream analyses.i ={1,...,N}, where L i is a matrix with entries l i (x,y)  Z 2 for each image i.The size of template image T is set to (t (x) t (y)). The model parameters  0 ,a,b and  define a prior on the template T. The parameters determining the smoothness prior are given as: the prior on the translation component of the mapping field is parametrized by an energy constant  t ; the deformable component of model is defined by as based cost at saturation,  0 , the maximal allowed deformation distance  as well as , parametrizing the order of the metric. U is describing the pixel block coupling.
Markov random fields for deformable registrationEach image pixel I i (x,y) is related to the common template T, linked by a transformation M i that maps image coordinates (x,y) to the corresponding coordinates within T:The mapping is parametrized using a field of relative shifts, where contiguous (smooth) mappings of neighboring pixels corresponds to constant entries in L i. For a given mapping field, L i , the generative model () of each image is thenwhere M i is parameterized by L i and  denotes the reconstruction error of each pixel. Both, the template map T and the mapping fields L i are unknown a priori and hence need to be learned from the image data alone. For a common template T with set dimensions t (x) ,t (y) , a set of N observed images I i and corresponding mapping fields L i , the joint probability under our model isThe likelihood of the observation model corresponding to Equation (2) is a Gaussian mixture model independent for each image pixel (x,y):Here,  and  correspond to the means and the precisions at each position of the template image T and  is the mixture coefficient of the uniform background model to explain outliers that are not compatible with the template image. To ensure that the template is well-behaved, we choose a normal-gamma prior on the values of the template,Smoothness of the mapping fields L i is encouraged through the choice of a Markov random field prior that couples neighboring mapping offsets in each imageHere, E (x,y) denotes the set of pixels in the direct neighborhood of (x,y) and the pairwise energy term E V penalizes non-contiguous offsets of neighboring pixels. In ShapePheno, the mapping fields L i are decomposed into a translation and deformation component with individual smoothness priors. The specific modeling choices will be discussed in Section 2.2. Inference in the joint model implied by Equations (36) is feasible by means of iterative learning using expectation maximization. In this approach, we alternate between maximizing the joint probability () with respect to mapping fields L i and the unknown template T, keeping the other variables fixed. The first task, determining the most probable templat T essentially boils down to parameter inference in a normal-gamma model, where closed form updates for mean and precisions of the template (, ) are available (). Alternatively, for a fixed template T, the most probable mappingsLmappings mappingsL) can be determined efficiently using graph cuts for each image (seeandfor details).
Design choices for MRF energy functionsSince the alignment of template and observed images requires a combination of translation and deformation, we choose L to be the sum of a translation and deformation field component L = L t +L d. In this stacked two-layer Markov random field, P(L t ) accounts for the global shift of images to the template and P(L d ) specifies the prior probability of local deformations (see also). The joint prior probability of the mapping-field components can be expressed aswhere () denotes the Dirac delta function. Accounting for both prior contributions, the effective energy term in. Here, the cost parameter  t is set to large value, such that all mappings L i are forced to take on identical values, solely accounting for a constant overall image shift.
Deformable model:For the deformable prior P(L d ), we employ a non-rigid smoothness prior that encourages smooth deformation fields. In contrast to the rigid Pott's model, the energy costs is distant-dependent, favoring short-range deformations. More specifically, the energy function E VD scales linearly with a particular choice of distance norm of order :Here,  denotes the maximum permitted range of deformation, and  is a power (or order) where  {1,2n} for n  N >0 and scaling parameter. Intuitively, one can imagine this function to apply elastic bands connecting pieces (in our case pixels) to their four neighbours with the E VD part of the mapping costs being the equivalent of the elastic potential of the bands between all pieces.shows the energy function for two choices of .
Robustifying deformable registration:We use various constraints on the registration to further improve the robustness of our method against noise and non-standardized images and reliably produce good results. We apply our deformation fields on pixel blocks, meaning that we constrain groups of pixels of block-size to obtain the same mapping via the prior U shown in. This leads to piecewise smooth deformation fields. Additionally, we constrain the parameter  of the deformation field itself. This makes large jumps prohibitively expensive and drives the model to use smoothly varying local deformation patches. A positive side effect of this constraint is a significant boost in computational efficiency and robustness against outlier-mistakes since the solution space is reduced. We also robustify alignments against appearance outliers with a mixture of densities used as the observation model in Equation (4), which allows for a background class.
Feature representation for deformation mapsThe deformation fields L d at pixel resolution, described in Section 2.2.2, capture the relevant information to explain local shape deformations of the samples in each image. Comparing deformation fields with non-equal objects at non-equal positions is hard, since we face the problem of correspondence. However, in our framework this problem can be elegantly circumvented using the common template all images are aligned to. To render individual deformation fields comparable between images, we first project these maps from observation space into the common reference coordinate system on the template. For this purpose, we apply the same mapping operator we used for image pixels now to the mappings themselvesresulting in deformation field representations in the object-centered template space. Thus, we obtain an easily interpretable shift-corrected field D i of deformation for each image-mapping L i d .
Low-rank representations of deformation fields:In order to extract meaningful features from the high-dimensional deformation fields, we reduce their dimensionality by representing individual deformation fields via a set of coefficients over a small number of bases obtained via standard principal component analysis (PCA) (). Prior to running PCA, we can apply a binary mask to the template to select only relevant template regions for consideration as variance components. The resulting individual bases can be visualized and constitute local deformation factors.Here, these areas correspond to compression and stretching of fish tails and the main body (
Geometric measurements as shape traits:We also use our method to measure distances in the images by exploiting the mapping fields to the common template. We measure geometric traits by selecting points of interest on the template and measuring their distance per image by projecting the annotated template-points into the reconstructed image through the mapping fields. Thus, a single annotation of the shared template yields an exhaustive annotation of all images explained by the model. These annotations can be used to measure geometric distances in the images, for example. Importantly, these geometric measurements are local measurements on an image in contrast to the holistic descriptor of shape we introduce in Section 2.3.1.
RESULTSWe applied ShapePheno to a dataset that shows the lateral aspect of male guppy fish, P. reticulata. The goal was to obtain local deformation patterns that are informative about typical distortions of the shape among the individuals, which also display considerable variation of appearance traits and size. We demonstrate further use of our method in two tasks: clustering of populations according to deformation patterns and association studies to link genotypes to deformation phenotypes.
DatasetThe
ShapePhenoThis cross (157 Quare x Cuman) has been subject of a genotyping project to establishing a comprehensive genetic map and to initiate conventional QTL (quantitative trait locus) mapping (). The raw images were rescaled such that the ratio of pixels to physical length is constant across the dataset. Due to rescaling, the image size was variable, ranging between 75226 and 83250 pixel size. To account for images taken at slightly varying distance, we chose to embed all images according to original size of the fish into empty images of the chosen format (83 250). For this particular experiment, there were few outliers and thus setting the outlier ratio  = 0 yielded good results. For each of the 388 individuals, the dataset included matching genotype information, covering a total of 1063 genome-wide single nucleotide polymorphisms (SNPs). After filtering, removing rare SNPs with a minimum rare allele frequency <5%, we obtained 814 polymorphisms that were considered for analysis.
Experimental settingsWe chose the following parameters for the deformation model:  0 = 40,  = 10 and  = 1, which resulted in robust registration in a series of test runs. We applied the deformation field to 22 pixel blocks in order to locally tie together image pixels to correct for appearance differences and to prevent excessive local deformation. The normal-gamma prior parameters (Equation (5)) were set such that the prior reflects the first and second empirical moments of the distribution of the raw image pixels (see also). We ran a Python-based parallelized implementation of ShapePheno on an 8-core Intel Xeon machine where the full dataset could be run to convergence within 3 days. After convergence, we manually segmented the template fish from the background template to facilitate all downstream analyses (clustering and association mapping on foreground information only).
Shape phenotype determinationThe converged ShapePheno model yielded a sharp template that resembles an average fish and mapping fields L i for every image in the dataset (). The model perceives the shapes of the fish in individual images as locally stretched or smoothly distorted versions of the template and smoothly bypasses appearance differences that would counteract shape alignment. This suggests that the deformation fields L i d capture shape information corrupted by noise stemming from the difference in sizes of images and the background color similarity to the fish corpora. Next, we used linear dimension reduction (Section 2.3.1) to determine the corresponding deformation factors of the converged model;depicts the first three PCA-bases. These three main deformation features appear to divide the fish into the anterior and posterior part. Inflated anterior parts at the belly region as well as distorted posterior trunks are the main sources of shape variation. We also observed that local structure in the bases matches appearance features of the template that get distorted frequently. These findings reflect the set-up of the experiment inin agreement with our expectations, as the parents were originally chosen to exhibit these shape differences and the offspring shows strong variation at these features. Supplementaryprovides examples of inference results for extreme outliers within the data, here a singleton shapemutant in our training set. Since the method is unsupervised, itrequires shape mutants to be well-represented in the data in order to model their shape accurately.
Quantification of geometric measurement accuracyAfter the qualitative evaluation of the reconstructed shape template, we next characterized the accuracy of the shape representation captured by the model in a quantitative manner. For this purpose, we used the converged model to automatically measure geometric distances in images (Section 2.3.2). We comparatively evaluated eight geometric trait measurements (described in Figs 4 and 6), whose choice was motivated by primary analyses of the Guppy dataset (). Manual quantification was done on 50 individuals from our dataset chosen at random, measuring all 8 geometric distances in each raw image by 3 independent experts, as well as using the fully automated approach provided by the ShapePheno model. We assessed the correlation between manual and automated measurements, comparing the ShapePheno prediction to the mean of the manual quantification runs (). Encouragingly, all automated geometric measurements were in good agreement with the corresponding manual annotation. The correlation score for pairs of corresponding automated and manual measurements ranged between 0.65 (A2 versus M2) and 0.84 (A6 versus M6) with a mean correlation score of 0.76. To better understand the magnitude of the variation between automated and manual measurements, we also considered the pairwise correlation between two of the three manual runs (), yielding comparable results. Pairwise correlations here ranged from 0.81 (M7) up to 0.96 (M3) with a mean correlation score of 0.87. This suggests that ShapePheno captures true variability in images and yields high levels of accuracy when used to quantify geometric measurements in place of a human expert. Detailed scatter plots, showing the correlations between manually and automatically determined traits are shown in. From either of the correlation analyses, it was also notable that geometric measurements correlated well with each other, reflecting the biological relatedness of growth-phenotypes that underlie the geometric measurements under consideration. In contrast to this observation, the correlation to the new PCA-deformation phenotypes described in Section 3.3 was weak, which shows that they capture orthogonal aspects of shape variation and hence are complementary to geometric measurements.
Clustering of populations based on deformation traitsWe clustered populations of guppy fish according to their characteristic local deformation patterns, without any prior. Quantitative evaluation and comparison of the geometric traits as determined by ShapePheno (A1A8), manually measured counterparts from a human expert (L1L8) and novel PCA-deformation phenotypes (P X1 P Y 2 ). (a) Correlation between automatic geometric measurements, manual measurements and PCA-deformation phenotypes. (b) Correlation between two manual quantification runs by an expert user (M1M8 versus L1L8). The results show that the reproducibility of manual expert labels is similar to automated measurements by ShapePheno, suggesting the model is able to achieve human-like results. Weak correlation between PCAdeformation phenotypes and geometric phenotypes shows that these new quantitative traits complement established measurements.where each point corresponds to an instance of the 50 samples chosen for quantification. Error bars show 1SD, estimated separately for each quantification approach. For manual quantification, error bars correspond to the empirical variation between three independent annotation runs. For automated quantification, uncertainty estimates stem from the variation of the 15 nearest neighbor assignments on the template to the selected point and measuring their SD. The green diagonals show the expected ideal correlation. knowledge of their genetic constitution. Morphometric prototypes for the guppy have previously been determined from hand-annotated images and correlated to sex and environmental factors (). We clustered deformation fields according to a linear kernel between low-rank projections of D i (as described in Section 2.3.1) using affinity propagation (), a non-parametric clustering technique that uses deformation kernel values as inputs and yields a flexible number of clusters |C|. Reconstructing the mean low-rank vector field of each cluster given by its embedding in deformation space yields cluster-specific morphological deformation bases.provides a comparative overview of three characteristic clusters, indicating that independent factors can influence the shape of the anterior and posterior trunk of the examined guppy fish. Deformation bases correspond to low-rank projections of the cluster means, where only the characteristic local deformations per cluster are considered as shared elements of cluster members. The shape seen in an example image representing the median deformation field per cluster corresponds to our expectation given the profiles. Different clusters portray significant variability between their profiles, such as the regional focus and the extent of expected local deformation.
Association study of shape factors to genotypeFinally, we performed a genome-wide association study using the previously learned phenotypes and their measurements. The phenotypic measurements y are the per-image coefficients w i of PCA-deformation bases (Sections 2.3.1 and 3.3). We used a linear model that assesses how well a particular phenotypic value is modeled when genetic factors are taken into account, compared to when they are ignored. The relevant quantity is the log-odds (LOD) score,where s j is a SNP measurement and y j the phenotypic expression value for the j-th individual. The terms ,  bck are parameters for the genetic and background models, respectively. We thus obtain LOD score plots over a large genomic region to obtain an association plot. We used Storey's method (), a variant of Benjamini Hochberg, to assess genome-wide significance. Although the available data has sparse genetic marker coverage, we still obtained statistically meaningful peaks as can be seen in. Previous genetic QTL mapping in overlapping data has suggested markers of the proximal region of linkage group 12 (LG12) as relevant for size and body shape traits in male guppies, and in addition phenotypic sex has impact on these traits (). Among the significant hits in our mapping, Markers 398 (lod 7.7 on LG12) and 442 (lod 10.3, LG12) are found in the proximal region of LG12 while marker 229 (lod 11.9, LG12) is the most distal and closest to the putative male sex-determining locus. Depending on the trait analyzed, significant QTL were suggested within a region spanning  6 cM ( 7 Mb ()) in cross 157. Marker 442 was supported as a QTL for area of the posterior trunk for cross 158 (). Additional loci were detected with good statistical support, in agreement with the observation that co-factors on various linkage groups contribute to complex traits.
DISCUSSIONWe have proposed a generative probabilistic model that extracts deformation phenotypes by registering images to a latent, learned template in an unsupervised fashion. Our method presents a novel, clean framework for researchers to quantify and describe subtle local deformation patterns and use them for downstream analyses, like clustering or genetic association tests. We applied our method to a bioimaging task, where we discovered significant deformation patterns in images of guppy fish. We also showed that ShapePheno can be used for automated quantification of geometric measurements and showed good correspondence to manually labeled data. More important than accurate geometric traits, ShapePheno yielded deformation fields that characterize the variability in shape and could be used to identify low-rank PCA factors. Genome-wide association plot, showing the association strengths with the first two PCA-deformation phenotypes corresponding to the X and Y direction. The significance threshold of 10% false discovery rate (FDR) is shown as thin line in the diagram. SNPs are plotted in order of linkage groups, while significant hits on LG12 as described in Section 3.6 are highlighted. LG13 contains markers with function in sex determination yielding additional informative peaks for shape determination. of shape variability. While simple distance measurements intercorrelate strongly, the deformation phenotypes we propose describe orthogonal shape factors and are thus novel holistic descriptors of shape. We showed practical utility of these PCA-deformation phenotypes in the context of clustering, grouping the data into clusters exhibiting characteristic deformation. We also performed a GWAs with the same traits, which yielded biologically sound results in agreement with previous results on geometric approximations of shape (seeand unpublished observations of C.D.). We are convinced that comprehensive genomic analyses on larger datasets can be performed by using this method with a rigorous treatment of image acquisition, higher image resolution and higher marker density. Unsupervised extraction and quantification of subtle morphological phenotypes, as done here, is the logical next step in automated image analysis. The relevance of these new types of methods is expected to rise quickly as dataset sizes increase, providing the necessary statistical power to identify and quantify complex phenotypic variation.
T.Karaletsos et al.Storey,J.D. and Tibshirani,R.
The Author 2012. Published by Oxford University Press. All rights reserved. For Permissions, please email: journals.permissions@oup.com
at :: on August 30, 2016 http://bioinformatics.oxfordjournals.org/ Downloaded from
