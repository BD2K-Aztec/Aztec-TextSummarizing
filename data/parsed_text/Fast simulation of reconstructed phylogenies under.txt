Motivation: Diversification rates and patterns may be inferred from reconstructed phylogenies. Both the time-dependent and the diversity dependent birth–death process can produce the same observed patterns of diversity over time. To develop and test new models describing the macro-evolutionary process of diversification, generic and fast algorithms to simulate under these models are necessary. Simulations are not only important for testing and developing models but play an influential role in the assessment of model fit. Results: In the present article, I consider as the model a global time-dependent birth–death process where each species has the same rates but rates may vary over time. For this model, I derive the likelihood of the speciation times from a reconstructed phylogenetic tree and show that each speciation event is independent and identically distributed. This fact can be used to simulate efficiently reconstructed phylogenetic trees when conditioning on the number of species, the time of the process or both. I show the usability of the simulation by approximating the posterior predictive distribution of a birth–death process with decreasing diversification rates applied on a published bird phylogeny (family Cettiidae). Availability: The methods described in this manuscript are implemented in the R package TESS, available from the repository CRAN
INTRODUCTIONThe birthdeath process is arguably the most commonly used process to model species diversity ().introduced the birthdeath process to estimate diversification rates from reconstructed phylogenetic trees. It was then used to estimate speciation and extinction rates that are constant over time and equal for all species (). In recent years, the constant equal-rate birth death process has been extended to time-dependent speciation and extinction rates (); trait-dependent speciation and extinction rates (); and diversity-dependent speciation rates (). The models used for parameter inference have become increasingly complex and different modelssuch as the time-dependent speciation and the diversity-dependent speciation modelscan produce almost indistinguishably close fits to observed phylogenetic trees. Thus, studies investigating the different patterns generated by the different models need to be compared. An evident approach is to use simulations under one model and inference under any of the available models. Furthermore, simulations play an important role in investigations of which parameters can be estimated (). However, simulating trees has gained less attention and remains a challenge in several situations (). One might be interested in simulating trees under three different conditions when the process starts with a single species at time t 0  0: Simulating a tree for a given time t. Simulating a tree for a given number of species n.Simulating a tree for a given number of species n that have evolved over time t. Additionally, the conditions can be modified if the process starts with the most recent common ancestor (MRCA), and thus, there are two species at time t 0  0 (). I consider the timedependent speciation and extinction rates birthdeath process as the model of choice for simulations in this article. This process contains the constant-rate birthdeath process as a special case. Simulations under the first condition, a given time t of the process, are straightforward from a theoretical point of view. One only needs to simulate the exponentially distributed waiting times until the next event, either a speciation event or an extinction event, and pick a random species. Nevertheless, implementing this forward simulation might be challenging and inefficient in situation when the rates are not constant and both rates are high. Additionally, there is no available software for simulating reconstructed trees for a given time t when the rates vary continuously. An overview of available software packages for simulating trees under a time-dependent birthdeath process is given in Stadler (2011). Simulating phylogenies under models with a non-zero extinction rate is challenging when one is interested in simulating a tree with a fixed number n of extant species (). The general sampling approach (GSA) introduced byin the program TreeSim, is the currently only available approach to simulate trees under the first and second condition. However, TreeSim only implements changes of speciation and extinction rates at specific predefined times. Furthermore, when one chooses a model with high species turnover (the extinction rate being close to the speciation rate), then the GSA takes a long time to terminate because many speciation and extinction events are simulated and the process converges only slowly to the terminating species number. In this article, I will derive the joint probability density of the reconstructed phylogeny using a new approach that shows that each speciation time in the reconstructed tree is independent and identically distributed (iid). I will then develop an algorithm that uses the cumulative distribution function for fast simulation of the reconstructed tree under anycontinuous or discretetimedependent speciation and extinction rate function. I apply this new simulation technique to sample from the posterior predictive distribution of an empirical dataset, the bird family Cettidae.
METHODSThe strategy of the simulation algorithm, developed in the following section, is to derive the probability density of a single speciation event independent of all other speciation events in the reconstructed tree. Once the probability density is known, it is (at least numerically) possible to compute the inverse cumulative distribution function and thus samples from the desired distribution. The simulation procedure only needs to draw n  1 speciation events for a tree of size n and does not need to draw all speciation events that are pruned because they do not have extant descendants. I will start by defining the birthdeath process. The process starts with a single species at time t 0. Every species has the same speciation and extinction rate at any time t, denoted by lt and t, respectively. The time until a speciation event of a given species is exponentially distribution with rate lt. At a speciation event, a species gives birth to exactly one new species. The time until an extinction event of a given species is exponentially distributed with rate t. Furthermore, let N(t) denote the number of species at time t. Following standard notation, I will use t 0 as the time of the origin or start of the process and T as the present time when the process was stopped. The observation of a tree generated by the birthdeath process containing extant as well as extinct species is called a complete tree (). Removing all extinct branches gives the reconstructed tree () (). From the reconstructed tree with n extant species, I obtain the set of speciation times ftg  ft 0 ,. .. , t n1 g. In this article, I consider the reconstructed sampled tree as the data. Let me begin with stating some known probability densities of the birthdeath process, the probability of survival PNT40 j Nt  1, the probability of exactly one descendant PNT  1 j Nt  1 and the probability of n descendants PNT  n j Nt  1 (). Although I will follow closely, I modified the process to start at time t and stop at time T instead of starting at time 0 and stopping at T  t and thus is a generalization of the original equations in. Finally, I derive the probability density of a single speciation event, following the idea of, by using the above-mentioned probability densities. First, I define the rate function r as rt, s  Z s t
z  lzdz: 1The probability of a single species alive at time t surviving until time T [PNT40 j Nt  1] is given (, Equation 24) byThe probability of n species at time T when starting with a single species at time t is (PNT  n j Nt  1  1  PNT 4 0 j Nt  1 exprt, T n1  PNT 4 0 j Nt  1 2 exprt, T 3 which leads to the probability of obtaining a single lineage at time T PNT  1 j Nt  1  PNT 4 0 j Nt  1 2 exprt, T: 4 Equation (3) can be derived from a geometric distribution with parameter PNT40 j Nt  1 exprt, T multiplied by the probability of survival of the process PNT40 j Nt  1. Thus, the probability of n species at time T given that we had 1 species at time tand the species survives, denoted by S1, t, T, is PNT  n j Nt  1, S1, t, T  1  PNT40 j Nt  1 exprt, T n1  PNT40 j Nt  1 exprt, T:
5Now, following the reasoning of Thompson (1975, p. 5458), I give the joint probability distribution of all speciation times ftg of the reconstructed tree given that we sample (or stop) the process at time TThe intuitive interpretation of the probability density is that the process starts with one species that survives until the present time(6), we can compute the probability of the conditioned process on n lineages at the present time T results P BD ftg j Nt 0   1, NT  n, TNote, the factor i in front of lt i  is simply a combinatorial constant representing the n  1! possible orderings of the speciation events (). Hence, the probability density of each single speciation event is iid by the definition of independence P BD t j j ftgnft j g, Nt 0   1, NT  n, T  P BD t j j Nt 0   1, NT  n, T, and have the probability density
Simulating reconstructed trees fora fixed time t and number of species n I will start developing the algorithm for simulating reconstructed trees when conditioning on boththe time of the process t and the number of sampled extant species nalthough this might not be the common or natural condition for simulating reconstructed trees. It is, however, used by the two other simulation conditions. Random speciation events are drawn by solving the inverse cumulative distribution function of the speciation times. From Equation (7) we have that the joint probability of all speciation times in the reconstructed tree and established that all speciation times are iid with the probability density given in Equation (8). Thus, to obtain n  1 speciation times (or n  2 in the case when starting at the MRCA), one needs to draw n  1 random draws from the above distribution. Such random draws can be obtained by first drawing a random number u form the Uniform (0,1) distribution. Then, the speciation time t* for which the cumulative distribution function of Equation (8) equals u, gives the randomly drawn speciation time:shows an example of how to draw random speciation times in the sampled reconstructed tree. The algorithm how to construct a random from the set of speciation time is given below.
Simulating reconstructed trees for a fixed time tI start by simulating the number of species after the time t. Equation (3) gives the probability of n species at time t. Therefore, one only needs to make a random draw u $ unif0, 1 and find the maximal n for which the cumulative distribution function of Equation (3) is smaller or equal to u:Once the number of species is obtained by a random draw, the speciation times can be simulated using the above algorithm conditioning on both, the number of species and the time of the process.
Simulating reconstructed treesfor a fixed number of species n A tree with a fixed number of extant species can be simulated by first simulating the time of the process T given that the number of species was NT  n. Let us assume that one draws a random time T with some probability P(T) and maximum value max, then simulates a tree under the birthdeath process. A new time T and a new tree are drawn until the tree contains n species at time T. Thus, using Bayes Theorem, the probability of the time of the process (or the time of the origin/MRCA) isIf a uniform distribution as the prior distribution on the time of the process is assumed, then the probability P(T) in the numerator cancels out with the probability P(t) in the denominator. However, in the general form, when one wants to specify some informative prior distribution of the time of the process, then the integral needs to be computed numerically. Only a random draw from the distribution given in Equation (11) needs to be obtained and the same algorithm as for conditioning on the number of species and the time of the process can be used.. An example birthdeath process with rates of l  1:0 if t51:0 or t42:0 and l  0:1 otherwise;  0:95 if t51:0 or t42:0 and  0:0 otherwise. Additionally, there is a mass-extinction event at time t  0:8 with a survival probability of P  0:2 per species. The algorithm for drawing new speciation times t* draws a random u\simunif0, 1, and searches the t* for which CDFt    u
Starting at the MRCAIn the previous sections, I only considered the situations when the process starts with Nt 0   1. Now I will give the necessary modifications if one wants to condition on the MRCA. Let the process start with two species and both survive until the present S2, t 0 , t, then Equation (5) needs to be modified to condition on two species to start with n  1PNT40 j Nt  1 2 exprt, T 2  1  PNT40 j Nt  1 exprt, T n2
12The rationale behind the derivation is that one could consider two independent processes, both starting with one species at time t 0  0, and the sum of the species of both processes equals n. The algorithms for simulating reconstructed phylogenies remain unchanged, and only Equation (3) needs to be replaced by Equation (12).
Reconstruction of a tree from speciation timesIn the previous sections, I only elaborated the methods how to draw the set of speciation times. The reconstructed phylogeny can be created from the set of speciation times by first creating a set of n species. Then, repeatedly join two random species together. The time of the i-th speciation event is the i-th largest speciation time of the previously created set of speciation times. This procedure is closely related to the UPGMA method (). The resulting tree is from the correct distribution because the speciation times are iid and the birthdeath process implies a uniform distribution on labeled histories ().
Modeling mass-extinction events and random taxon samplingThe rate functions have been provided as general functions of time. Following, mass-extinction events are modeled bywhere t m is the time and m the survival probability of the m-th massextinction event. Then, the probability of a single species alive at time t surviving until time T [PNT40 j Nt  1] from Equation (2) changes toNote that here 1  m represents the extinction probability at the m-th mass-extinction event. Furthermore, random taxon sampling is the same as a mass-extinction event at the present time ().
Implementation and numerical integrationThe methods described to simulate trees are implemented in the R (R Core) package TESS (Tree Evolution Simulation Software). TESS can handle any type of rate functions and is designed for fast simulation of reconstructed trees. Furthermore, TESS computes the likelihood function [] conditioned on the time of the process, survival of the process or the time and number of taxa at present.The likelihood function can be used for Bayesian and Maximum Likelihood inference, posterior prediction and model testing (see the Supplementary Material). There are no closed form solutions known for the equations presented above. Only for the special cases when the rates are constant, one can compute the probability densities analytically. Nevertheless, R provides several methods for numerical integration. TESS uses the package deSolve () to perform the numerical integration. If only a single draw or few draws from a distribution are needed, then TESS performs a simple Monte Carlo sampling instead.
RESULTSIn this section, I compare the performance of TESS to TreeSim and show a potential application: posterior prediction of reconstructed phylogenies.
PerformanceOne of the major shortcomings of the GSA as implemented in TreeSim is the long computation time, especially in situation when lt % t. Additionally, TreeSim cannot handle continuous increasing or decreasing rate functions but only constant rates in predefined intervals. Thus, I designed a challenging but hopefully interesting function of the rates. The speciation rate lt  1:0 for t 2 0:0, 0:8, then is increased for a time of rapid radiation as lt  2:0 for t 2 0:8, 1:0 and switches back to the original rate when t41:0. The extinction rate changes at the same time points. First, the rate is comparably high t  0:95 for t 2 0:0, 0:8 and then slows down to t  0:5 for t 2 0:8, 1:0 before switching back to the original value as well. Additionally a mass-extinction event occurs at time t  0:8 and each species survives with probability P  0:2. The process resembles the situation when the diversity increases only slowly but a high species turnover happens until a mass-extinction event removes most species but also opens new niches, which results into a time of rapid radiation. Furthermore, each extant species was sampled with probability P  0:5. I ran both R packages on a MacBook Pro with a 2.3 GHz Intel Core i7 using only one core at a time to produce as fair as possible results. Simulations with the given rates where performed for n 2 f10, 20,. .. , 200g species sampled at the present time. For each n, 100 trees were simulated and the median running time was reported (). Note that the distribution of running times is skewed for TreeSim. Therefore, the median is a more stable estimator than the mean but the median is also much lower. TESS outperforms TreeSim up to four orders of magnitude. Furthermore, TESS computation time is mostly independent of the number of species, and the main challenge is to compute the integral of the probability of survival. Additionally, TESS can simulate a batch of trees faster once the integral of the survival probability is precomputed, which is shown in the simulations of 10 000 trees (TESS 10K).
Posterior predictionFor each simulated tree, I computed the posterior predictive distribution can be used to assess the fit of the model to the observed data (). Posterior predictive tests have the advantage to take the uncertainty in the model parameters into account, if applied an a Bayesian analysis (). If only the point estimate is used, e.g. the maximum likelihood estimate, then it is possible to compute the distribution of number of species at any time t using Equation (3) or the probability of n species in the reconstructed tree at time t given in. Instead, when the uncertainty of the estimated parameters is of interest, an analytical solution is infeasible in most situations because commonly there does not exist a closed form solution for the posterior distribution, as for the model considered in this article. Here I will present an example how simulating reconstructed trees can be used to approximate the posterior predictive distribution and evaluate the fit of the model. If the observed statistic fall outside the 95% confidence interval, then we can reject the model. I used the species tree phylogeny from (, Additional file 7) containing the bird family Cettiidae.showed that most bird phylogenesis show patterns of a diversification slowdown. The rate functions with a slowdown in diversification can be modeled by the functions lt  l 0  l 1 expt and t . I choose an exponential prior distribution for each parameter with rate 0.1, which is comparably flat but still puts most prior probability on small parameter values and hence on more simple models, i.e. the parameter combination  0 represents the pure birth model. The likelihood is obtained from Equation (6), starting at the MRCA and conditioned on the survival of both species. The posterior distribution was approximated using a Markov chain Monte Carlo algorithm (). The parameter values were changed using a scaling proposal and each parameter was updated once per iteration. The MCMC was run for 55 000 iterations and the first 5000 iterations were considered as the burnin period. Convergence was assessed using the Geweke test of convergence to same distribution in two parts of the run (). Every 10th sample from the posterior distribution was used to simulated one tree conditioned on the time of the process (), number of taxa at the present time and the-statistic (). The histograms of the predicted number of taxa and-statistic values indicate that the observed values fall well within the 95% confidence intervals. The observed lineage-through-time (LTT) plot and the posterior predictive LTT plots both show significant decrease in the rate of diversification. More generally, the observed LLT plot falls well within the ranges of posterior predicted LTT curves. This indicates that the model fits the data. However, the large variance in the prediction shows the uncertainty and possibly a different model could fit the data more closely. The MCMC algorithm as well as a basic posterior predictive test is available in TESS. The MCMC algorithm is kept as
0.00
Gamma StatisticPosterior Predictive Density x. The birthdeath process with the rates of l  1:0 if t50:8 or t41:0 and l  2:0 otherwise;  0:95 if t50:8 or t41:0 and  0:5 otherwise. Additionally, there is a mass-extinction event at time t  0:8 with a survival probability of P  0:2 per species. Trees with n 2 f10, 20,. .. , 200g species were simulated and the computation time was measured. The plot shows the median running time of 100 repetitions of TreeSim for one simulated tree and TESS for 1 and 10 000 trees, respectively general as possible so that any possible model might be used. See the additional file PosteriorPredictionCettiidae.R that was used for this study.
DISCUSSIONIn the present article, I only considered simulations of reconstructed phylogenies. Most estimated phylogenies are reconstructed phylogenies because no information about extinct species is available, such as ancient molecular sequences, and only the extant species are included. Nevertheless, phylogenetic trees including some extinct species might provide more information in estimating the time-dependent diversification rates. In these cases, either the GSA or simulating the missing speciation and extinction events following the idea of Bokma (2008) are useful. Another drawback of the GSA is that eventse.g. massextinction eventscannot be specified to happen at a given time before the present when one conditions on the number of species being sampled. In this manuscript, I did not consider these circumstances, although the simulation procedure can be modified to accommodate events at specific times before the present without major difficulties. In this case, the distribution of the time of the origin (or the MRCA) needs to be considered backward in time instead of forward. Finally, once the time of the process is obtained, the simulation of the single speciation events remains unchanged. The simulation algorithm presented here in this article relies on the factorization of the probability density function. Previously, only for the constant-rate birthdeath process has such a factorization been known (). I derived the factorization for the time-dependent birthdeath process. Unfortunately, other types of birthdeath process, e.g. the diversity-dependent birthdeath process () or the protracted speciation process (), do not have a know factorization. Nevertheless, the time-dependent birthdeath process might be used to approximate other birthdeath processes, such as the diversity-dependent birthdeath process (). It is possible to simulate tree using an MCMC algorithm, once the likelihood equations are known. However, if no direct simulation technique from the desired distribution is known, then the MCMC algorithm must start from some arbitrary starting values. Furthermore, samples are random draws from the specified distribution only after the chain has reached its stationary distribution. When the chain has reached its stationarity distribution and how long it takes to do so is a challenge in itself (). Thus, direct sampling, as I propose here, is safer, faster and can even be used for starting values of MCMC runs. Several of the more complicated birthdeath processes, e.g. containing different rates for different species () or heritable extinction rates (), do not have a known likelihood function. Instead, approximate Bayesian computation (ABC) can be applied to estimate the parameters of interest () although ABC has been criticized and should be used cautiously (). The birthdeath simulations implemented in TESS rely on the likelihood function, and therefore, neither ABC is necessary nor are these simulations needed for parameter estimation. Nonetheless, the simulation techniques can be used to test the summary statistics used in ABC. Currently, only the number of species at the present time, the time of the origin and the-statistic have been used as summary statistics for ABC under a birthdeath model (). Using TESS, it might be possible to test the performance of these summary statistics and develop new ones.
APPENDIX AI give here a short version of the proof of the joint probability density of all speciation times of a reconstructed tree. First, let me restate the probability of obtaining exactly one species at time T with T4t. At any given time s, t5s5T the number of species could be between one and infinity; however, all but one species must go extinct until time T ():Tg, ft 4 , Tgg. There are two types of branches, those that end at a speciation event and those that end at the sampling time T. The probability density of a branch that ends at the present time is simply the probability of starting with one species and observing exactly one speciesThe probability of any other branch starting at time t i and ending at a speciation event at time t j is given by the probability that there were k species at time t j , one of these speciated with probability klt j , this species survived but all other k  1 species went extinct before the present time:If we multiply the equation by PNT  1 j Nt j   1=PNT  1 j Nt j   1, we can see that we get exactly Equation (A
.1)Pft i , t j g  1=PNT  1 j Nt j   1 X 1 k1 k  lt j   PNt j   k j Nt i   1  PNT  0 j Nt j   1 k1  PNT  1 j Nt j   1  lt i   PNT  1 j Nt i   1=PNT  1 j Nt j   1 A:4 Finally, by multiplying the probability densities of all branches together, we obtain the probability density of the reconstructed tree
at :: on August 30, 2016 http://bioinformatics.oxfordjournals.org/ Downloaded from
S.H hna at :: on August 30, 2016 http://bioinformatics.oxfordjournals.org/ Downloaded from
Fast simulation of reconstructed phylogenies at :: on August 30, 2016 http://bioinformatics.oxfordjournals.org/ Downloaded from
CONCLUSION Simulating reconstructed phylogenies is important for developing and testing macro-evolutionary processes but has been a challenge for non-constant birthdeath models (Hartmann et al., 2010). In the present manuscript, I present an algorithm that can be used to simulate reconstructed phylogenies when conditioning on the number of species being sampled or the time of the process or both. The presented algorithms can accommodate any time-dependent rate functioncontinuous and discreteand can model mass-extinction events as well as periods of rapid radiation. Compared with the currently only available software for these types of simulations, TreeSim, my implementation is four orders of magnitude faster for 200 taxa and does not need significantly more computational time to simulate larger trees. Thus, simulations under even more complex models and many taxa at present are now feasible. I derived the probability density of the sampled reconstructed phylogenetic tree. The derivation follows the ideas of Thompson (1975) and Nee et al. (1994b). The newly derived probability density is provided in a general and new form. It shows that the speciation times are iid, which has previously only been shown for constant rates (Yang and Rannala, 1997). This enables for instance the Diversified Sampling under time-dependent speciation and extinction rates (HohnaHohna et al., 2011). R is widely used for inferring diversification patterns (Harmon et al., 2008; O'Meara, 2012). It provides a good framework to implement new methods that can be shared and used freely. The methods of this article are implemented in the R package TESS. TESS constructs trees in the phylo format of APE (Paradis et al., 2008). Thus, the trees simulated in TESS can be directly analyzed in APE and other tools using the phylo format. The implementation is kept general so that any time-dependent rate function can be used. Additionally, an implementation of the likelihood computation is provided that can be used either in a maximum likelihood or in a Bayesian inference, as shown in the posterior prediction example.
