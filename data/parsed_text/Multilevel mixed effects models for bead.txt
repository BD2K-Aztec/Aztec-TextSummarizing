Motivation: Bead arrays are becoming a popular platform for high-throughput expression arrays. However, the number of the beads targeting a transcript and the variation of their intensities differ from sample to sample in these arrays. This property results in different accuracy of expression intensities of a transcript across arrays. Results: We provide evidence, with publicly available spike-in data, that the false discovery rate of differential expression is reduced by modeling bead-level variability with a multi-level mixed effects model. We compare the performance of our proposed model to existing analysis methods for bead arrays: the unweighted t-test and other weighted methods. Additionally, we provide theoretical insights into when the multi-level mixed effects model outperforms other methods. Finally, we provide a software program for differential expression analysis using the multi-level mixed effects model that analyzes tens of thousands of genes efficiently. Availability: The software program is freely available on web at
INTRODUCTIONBead arrays are becoming a popular platform to generate highthroughput expression data (). One of the advantages of the technology is that all beads targeting a transcript have exactly the same sequence and length (): this property rids the concerns for averaging intensities from probes with different affinities and a common target transcript. However, in bead arrays, the number of beads targeting a transcript differs from sample to sample, usually between 5 and 80 beads. Moreover, variation of the bead-level intensities targeting a common transcript differs across samples. Given these differences in the number of beads and the variation of their intensities, the average expression intensity for a given transcript will have varying precision across samples. Although measures of precision are typically generated along with the computed average gene expression intensities, it is commonplace to simply compare the intensity levels across experimental groups using Analysis of Variance (ANOVA; more than two groups) or ttest (two groups), ignoring the bead-level variability. This approach is problematic. For example, the standard error of the average is inversely proportional to square root of the number of beads, and * To whom correspondence should be addressed. intensities for a transcript averaged over 5 beads will be four times more variable than that over 80 beads. Recently, there are increasing efforts to incorporate bead-level technical variability as weights in linear methods (). For example,used variance of bead-level intensities as the inverse weight in comparing two sample groups., proposed a test statistic based on unweighted average of bead-level intensities but used bead-level variability to compute standard errors. Any reasonable use of bead variability will likely improve the accuracy of differential expression analysis. However, to our knowledge, formal consideration of under which model the weighting scheme is optimal, or comparisons between different weighting schemes, have not been reported. Noticeably, in all these weighting methods, weights are completely determined by bead-level technical variation and are independent of the magnitude of array-level biological variation. Our work adds to the body of research by modeling bead-level variation by a multi-level mixed effects model (MLM). Under this model, the weights for the bead averages are determined by the relative magnitudes of both beadlevel technical variation and array-level biological variation. In addition, using publicly available spike-in data, we compare the false discovery rate (FDR), sensitivity, specificity, empirical Type I error and empirical power of our proposed model to six other methods.
METHODOLOGY
Modeling bead-level intensity with MLMFor simplicity, we consider an experimental design to detect differential expression in K independent sample groups. We propose to model bead-level intensity using the following multi-level mixed effects model.Here x kij is the bead-level expression intensity of j-th bead in i-th sample in k-th group. The fixed effect  k is the population average intensity of k-th sample group and represents the parameter of interest in our comparison.
R.S.Kim and J.Linrandom effect one-way ANOVA when  2 k are assumed to be constant across sample groups. The parameters can be estimated by maximum likelihood (ML) or restricted ML (REML;). See Appendix for an iterative Fisher's scoring algorithm for ML and REML estimation of all parameters: the biological variance ( 2 k ), the technical variance ( 2 ki ) and the average group intensities ( k ). The resulting ML (and REML) estimator of  k is the weighted average of average bead-level intensities ( x ki ) using the variance of  x ki , i.e.k , as the inverse weights. That is,The standard error of the estimator isSince the bead-level sample mean  x ki and variance s 2 ki are sufficient statistics (Appendix A), one can fit MLM using only the typical 'bead summary data' (the average, the s.d. and the number of beads for each array). These can be produced by Illumina's BeadScan software. Once the parameters are estimated, a Wald-type test can be used to compare K groups using the following test statistics:See Appendix A for derivation of the test statistics. Although asymptotically, the test for fixed effects in MLM can be performed using  2 distribution, it has been reported that, even with a moderately large sample size, it tends to be anticonservative () and it is instead desired to use F-test. Still an active research area, there are a few established approaches in choosing what denominator degrees of freedom to use for F statistics when sample size is small (). Under a balanced design with common random effects variance, these approaches result in the denominator degrees of freedom of n 1 +n 2 K or a value close to it. Note that, in two-group comparison studies, the test statistics is the square of the following:By accounting for the number of beads and the variation of their intensities using the proposed multi-level model, we see in the following sections an immediate improvement in the accuracy of detection of differential expressions. The variance structure of the technology is more complicated than having multiple beads on an array and the current model can be extended to address different levels of biological and technical variability. For example, it can incorporate longitudinal or correlated design, or multiple batch design, or it can be extended to address correlation between bead intensities that are located closely on the chip. This is the first work using multi-level modeling framework in addressing the variance structure. More in-depth discussions on multi-level modeling can be found in Pinheiro and Bates (2000).
An efficient program for multi-level modeling of bead-level intensityMLM has been rarely used to model bead-level intensities mainly because there are restrictions on the size of data that can feasibly be analyzed. We provide a software program for differential expression analysis using multi-level model comparing K independent groups, in R statistical environment. One can choose biological variation  2 k to be constant, or to vary, in K groups. Because the software reads the bead-summary data as input, the computational burden is reduced dramatically. To efficiently compute and simultaneously fit multi-level models for thousands of genes, it was important for us to develop the algorithm that avoids inversion of Fisher's information matrix at each gene level. In the Appendix A, we provide technical details of Fisher's scoring algorithm for ML and REML estimation. For example, performing two-group comparisons of 34 699 genes, 12 samples in each group, the parameter estimation and hypothesis testing were completed within 5 min on a Dell Precision T3400 computer (Intel Quad 2.83 GHz processor with 3.25 GB of RAM). The software can read in 'bead summary data' generated by Illumina's proprietary software, if researcher decides to analyze bead array data in raw scale. However, it is often desirable to analyze data in log scale (Section 5).
Theoretical comparison with other approaches
Unweighted analysisA typical differential expression analysis (t-test when K = 2, ANOVA when K > 2) without consideration of bead-level variability is optimal under the following model:One may either assume variances  2 k to be identical across K groups or modify Student's t-test or ANOVA to allow different variances. In both cases, the model is inappropriate because it assumes bead averages to have same accuracy across arrays in each sample group when in reality they must depend on the the numbers of beads and the variation of their intensities. Under this nave model, the mean intensity of each group  k can be estimated by the unweighted average of  x ki 's across the samples. It is straightforward to compute the relative efficiency, which is the asymptotic ratio of variances of the unweighted average and MLM estimate:.shows the relative efficiency after fixing the bead-level technical variation  to be constant across samples and the arraylevel biological variation  to be 0, 10, 25, 50 or 75% of . We generated bead numbers across 100 000 samples from a normal distribution with mean 40. We repeated the process of computing the relative efficiency by gradually increasing the variation of the bead numbers. When biological variation is substantially less than technical variation, the estimate under MLM is more accurate than the unweighted estimate, especially as the variation in the number of beads increases. As we increased the biological variation to be close to the technical variation, the difference between two methodsPage: 635 633640Relative efficiency of unweighted average compared with the estimate from MLM. If it is close to 1, standard errors of unweighted average and MLM estimate are similar. The less it is, the less standard error MLM has compared with the unweighted average. The technical variation is fixed constant across hundred thousand samples at  and the biological variation  are set to be 0, 10, 25, 50 or 75 of . The bead numbers were first generated from normal distribution with mean 40, and then rounded and replaced with five if the number is less than five. We repeated the process of computing the relative efficiency by gradually increasing the variation of the bead numbers. (B) Relative efficiency of the WLS a estimate under our proposed model MLM. decreased. We confirmed this theoretical property to be true in the spike-in data in the later sections.
Multi-level mixed effects models for bead arrays
Weighted analysis using only bead-level variationThere are recent efforts to incorporate bead-level technical variation in linear analysis using the weighted least square estimation (WLS). First, consider using bead-level variance divided by the number of beads as inverse weights in a linear model. This weighting scheme is optimal under the following model:Although an iterative algorithm is needed to estimate the parameters, it is a common practice to assume  2 ki = s 2 ki and use the weighted least squares estimator of  k. That is,Both estimates based on MLM and WLS a can be viewed as weighted average of average bead intensities. The weights are different, however, as they are inverse of shows the relative efficiency of the WLS a estimate under our proposed model MLM. When biological variation is substantially greater than technical variation, the MLM estimate outperforms WLS a estimate, especially as the variation in bead numbers increases. This is opposite to what we observed with Student's t-test, which performs as well as MLM with large biological variation. We confirmed this theoretical property to be also true in the spike-in data in the later sections. The weights used in recent reports are in fact different from WLS a .used variance of bead-level intensities (s 2 ki ) as inverse weights and demonstrated that it improves power to detect differential expression. That is, their test is based onSince WLS estimation is most efficient when the weights are inverse of the variances of measurements ( x ki ), this weighting scheme is optimal under the following model:However, we find that the assumption that variance of  x ki does not depend on bead numbers is unrealistic. As a result, WLS b does not take the numbers of beads into account, and will perform poorly when variation in the number of beads is large.
MATERIALS AND METHODS
Microarray dataWe examined the difference between the analysis methods of differential expression by performing two group comparison of a publicly available spike-in dataset (). In their study, Dunning et al. hybridized 48 arrays on Illumina Mouse-6 chips with a complex mouse background. In addition to the standard 48 000 bead types, the chips were modified to include 33 bead types (spikes) targeting bacterial and viral genes absent from the Mouse genome. The spikes were added at 12 concentration levels, each on four arrays: 1000, 300, 100, 30, 10, 3, 1, 0.3, 0.1, 0.03, 0.01 and 0 pM. The spikes on a given array were all added at the same concentration.
PreprocessingBead-level data for the spike-in experiment has gone through image sharpening and background subtraction and was summarized in the log 2 scale (). We further normalized all 48 arrays using the robust spline normalization (). We included in our analysis the 33 spikes and all 34 666 non-spike bead-types targeting genes annotated with Genbank IDs.
Differential expression analysisWe performed seven different differential expression analyses comparing two sample groups:MLM assuming common biological variance and (vii) Student's t-test after the variance stabilization transformation (VST;). First six tests were applied to log 2 scale data. For the last test, VST was performed on unlogged raw data: VST becomes similar to log 2 transformation for high intensities. We ranked genes from the most differentially expressed to the least differentially expressed based on the corresponding P-values from each test. For WLS a , we performed the weighted linear regression analysis with an intercept and a group indicator variable and used bead-level variance divided by number of beads as the inverse weights. Then, we used the standard P-value for testing non-zero coefficient of the indicator variable to rank the transcripts. For WLS b , we used the bead-level variance as the inverse weights. For both MLM methods, we used the software we developed. For the analyses in this article, the degrees of freedom for MLM-based tests were set to be n 1 +n 2 2 because we have balanced design and we assumed common biological variance ( 2 ).
Measuring the performance of differential expression analysis
R.S.Kim and J.Linamong up to top 100 detected transcripts. For a given gene list, the number of false discovery is defined as the number of non-spikes in the list and false discovery rate is defined as the number of false discovery divided by the size of the list. For a given gene list, sensitivity is defined as the number of spikes in the list divided by the total number of spikes, 33, and specificity is defined as the number of non-spikes not included in the list divided by the total number of non-spikes, 34 666. In differential expression analysis of microarrays, specificity is often >0.99 in even poor analyses because the number of differentially expressed transcripts is typically much smaller than total number of transcripts in the array. For this reason, we only considered up to top 100 transcripts, and receiver operating characteristic (ROC) curves are only defined above the specificity at 0.998. In addition, for each of seven methods, we computed empirical Type 1 error and power as nominal Type I error changes. For a given nominal Type I error, the corresponding empirical Type I error is defined as the number of non-spikes with P-values less than the nominal value divided by the number of all non-spikes. The corresponding empirical power is defined as the number of spikes with P-values less than the nominal value divided by 33, the number of spikes.
RESULTSIn the dataset, the number of beads ranged from 3 to 86. For all 33 spikes (bead types), the largest bead-level standard error among 48 arrays was at least 324 times larger than the smallest standard error. These observations confirmed that the accuracy of mean intensity differs greatly across samples, justifying the need to incorporate bead-level technical variability in the analysis.
When biological variation is less than technical variationFor each gene, we performed seven tests to detect differentially expressed transcripts between four arrays with 0.01 pM spikes and four arrays with no spikes (i.e. 0 pM): (i) Student's t-test, (ii) Welch's t-test, (iii) WLS a , (iv) WLS b , (v) MLM, (vi) MLM assuming common biological variance and (vii) Student's t-test after the VST. We counted the number of spikes and non-spikes among up to top 100 detected transcripts to compute sensitivity, specificity and false discovery rates. We then repeated the whole process with other 10 non-zero concentration levels. Although we do not view our model as a scaling method, we included the last method in our comparison because VST is often regarded as the current best practice; if VST can be expanded to bead-level data, then the transformation can be used in conjunction with our method. When the difference in true concentration is too small (e.g. 0.01 versus 0 pM), all methods failed to detect differential expression. On the other hand, when the difference is too large (e.g. 1 versus 0 pM), all methods successfully detected differential expression. When comparison is made between moderately different concentration levels (0.3 versus 0 pM;and), MLM resulted in the least false discoveries. For example, the numbers of false discoveries in the top 20 transcripts are 5 (t-test), 6 (WLS a ) and 1 (MLM). In the top 33 transcripts, they are 16 (t-test), 16 (WLS a ) and 9 (MLM).shows the results for all seven tests.shows that the ROC curve for MLM is consistently higher than that of t-test and WLS. The sensitivity among top 33 transcripts by MLM (73%) is statistically significantly higher than that of t-test (52%) and WLS (52%): MLM detected seven spikes that were not detected by t-test (or WLS) and missed none that was detected by t-test (or WLS; P-value <0.016; Exact McNemar's Test). Supplementaryshows the number of false discoveries and ROC curves when comparing each of 11 non-zero concentration levels to the four samples with no spikes. In addition, we compared empirical Type I error and power of the seven methods as nominal Type I error changes.shows the empirical Type I error in the range of nominal values that results in FDR < 0.9. For practically meaningful results (FDR < 0.3), MLM was conservative but all other methods were anticonservative. Nonetheless, the power (. By averaging over replicates, / for spikes at 0.3 and 0 pM are estimated at 0.06 and 0.07, respectively. For non-spikes, they are 0.08 and 0.09. Therefore, technical variation is much larger than biological variation and it is clear that one needs to avoid using unweighted methods, which uses only the biological variation in estimating sampling variation for their test statistics. The assumption of common biological variation seems to be appropriate for both spikes and non-spikes. Supplementaryshows the variance components, weights under different models and standard errors of the genes in three groups: (i) spike-ins detected by both MLM and t-test, (ii) spike-ins detected by MLM but not by t-test and (iii) non-spikes detected by t-test but not by MLM. Notice that, even with small biological variation, WLS methods perform as poorly as unweighted method, whileseems to suggest that WLS can perform as well as MLM. When  is small, the WLS and MLM estimates of  k essentially become the same because the weights become similar. Nevertheless, the standard error, or the denominator of the test statistics, differs in two tests due the difference in model assumptions. Specifically, the statistic based on WLS is further scaled by the residual standard errorcerror errorc:
Multi-level mixed effects models for bead arraysThis difference in standard error is causing the relatively poor performance of WLS tests although the estimates for the mean intensities are similar in WLS and MLM.While the results so far show that MLM outperforms other methods, the true variation among spike-ins in each group is close to zero, so the array-level biological variation is much smaller than the bead-level technical variation. This may not represent the settings in many transcriptional experiments. In fact, for in vivo data, it is quite common to compare heterogeneous populations with multiple unknown subgroups or outliers in each group (). To compare methods across a wide range of possible study settings, we performed the similar comparison using an altered spike-in dataset in the following section.
When biological variation among differentially expressed genes is greater than technical variationAs shown in, when biological variation is greater than the technical variation, it is possible for unweighted t-test to perform similarly to MLM. On the other hand, the relative performance of WLS will likely be poor because it does not use biological variation in the weights. To test this hypothesis, we increased the heterogeneity and sample sizes within each sample group: three groups of arrays with relatively high concentration (100, 10 and 1 pM) were pooled and another three groups of arrays with low concentration (0.3, 0.03 and 0 pM) were pooled. Overall, there were 12 samples with high-concentration level (mean = 37.0 pM; SD = 46.7 pM) and 12 samples with lowconcentration level (mean = 0.11 pM; SD = 0.14 pM). That is, the means and SD of spikes are both 1000/3 times larger in highconcentration group. For each gene, we again performed the seven tests to detect differentially expressed transcripts.shows the results for all seven tests. The ROC curve () shows that the sensitivities of MLM and t-test are similar and they are consistently higher than that of WLS. The sensitivity among top 33 transcripts by MLM (82%) is significantly higher than that of WLS (58%; P-value <0.008; exact McNemar's test; MLM detected eight spikes that were not detected by t-test and missed none that was detected by t-test). In this comparison, biological variation between samples is much bigger than the beadlevel technical variations, and Student's t-test performs as well as MLM as we expected. However, the performance of tests based on WLS is poor because the weighting depends only on technical variation.shows the empirical Type I error in the range of nominal values that results in FDR < 0.9. For practically meaningful resultsPage: 639 633640
R.S.Kim and J.Lin
Multi-level mixed effects models for bead arraysFinally, on a practical note, we recommend researchers to keep bead-level data from Illumina BeadScan software. The same recommendation was made in multiple other reports (). Without bead-level data, for example, one cannot analyze expression intensities in log scale and consider bead-level variation at the same time. We repeated the analysis in this article using data in raw scale, and the performance of all seven tests were markedly poorer than that based on log 2 scale, especially when biological variance were large among spike-ins. For example, top 874 genes detected by t-test did not include any spike-ins. To analyze data in log scale, researcher needs to use existing software, e.g., beadarray (), to convert bead-level data to bead summary data on log scale before applying the software provided in this article.
APPENDIX A A FISHER'S SCORING ALGORITHM FOR ML AND REML
A.1 ML estimationHere, we provide the technical details of Fisher's scoring algorithm we used in our program to maximise the likelihood of MLM to detect differential expression of K independent groups. The model has the following log-likelihood:Notice that  x ki and s 2 ki , the bead average and variance for each sample, are the sufficient statistics. Given the two variances, it is straightforward to show thatThe first derivatives of the likelihood areare correlated, using the quadratic theorem of normal variable, one can show (m ki 1)s 2 ki / 2 ki still has  2 distribution with the degrees of freedom m ki 1 and that s 2 ki is an unbiased estimator of  2 ki. By taking the expectation of second derivatives of the likelihood, and substitutingki , we have all elements of the information matrix:All other elements of the information matrix are zero. Taking the inverse of the information matrix, we have the following Fisher's scoring algorithm:(1) Set initial values atPage: 640 633640
R.S.Kim and J.Lin(3)(5) Repeat Steps (2)(4) until convergence. If we assume constant  across K conditions, Steps (3) and (4) change to the following:
A.2 REML estimationFor our linear model, the REML estimator of  2 is obtained by maximizing the following restricted likelihood ():Conveniently, one can modify Step (3) of the ML algorithm by adding the following term to the right-hand side of the equation ():If we assume constant  across K conditions, the term changes to
A.3 Wald-type testOnce the parameters are estimated, one can perform a Wald-type test to compare K groups. LetLet Let T to be (   1 ,...,   k ), to be a diagonal matrix with i-th diagonal element being v k where v 1and H to be a (k 1)k matrix with i-th and (i+1)-th elements of i-th row set as 1 and 1, and all other elements set as zero. With some algebraic work, one can derive the following Wald-type test statistic:
The Author 2010. Published by Oxford University Press. All rights reserved. For Permissions, please email: journals.permissions@oup.com
at :: on August 30, 2016 http://bioinformatics.oxfordjournals.org/ Downloaded from
(FDR < 0.3), all seven tests were mildly anticonservative. The power (Fig. 4D) of MLM was higher than other tests. Figure 3C and D show the relative size of estimated variance components in the multi-level model of 33 spikes for samples with mean spike concentration at 0.11 and 37.0 pM. The result for nonspikes is in Supplementary Figure 2. By averaging replicates, for spikes, / for 37.0 and 0.11 pM are estimated at 9.74 and 0.64, respectively. For non-spikes, they are 0.09 and 0.11. The assumption of common biological variation seems to be appropriate for nonspikes but not for spikes. Since biological variation in spikes is much larger than technical variation, it is clear that one needs to avoid using WLS methods, which does not account for biological variation in weights. We also notice that the log 2 transformation stabilized the variance, as the bead-level variation does not increase as intensity level increases. Supplementary Figure 4 shows the variance components, weights under different models and standard errors of the genes in three groups: (i) spike-ins detected by both MLM and WLS a , (ii) spikeins detected by MLM but not by WLS a and (iii) non-spikes detected by WLS a but not by MLM. It is not surprising that Student's test outperforms Welch's test (Table 2) although the true biological variances of the spikes in two conditions are very different. Non-spikes, from the same biological material across all samples, have common variance in two conditions. With sample size balanced, Student's test-statistics and Welch's test-statistics are identical and the difference in P-values comes only from the difference in degrees of freedom, which in turn come from the difference in variances. Since there are 12 samples in each group, Student's test uses 22 degrees of freedom for both spikes and non-spikes. The degrees of freedom for Welch's test are near the maximum value, 22, for all non-spikes due to homogeneity, and near the minimum possible value, 11, for all spikes due to heterogeneity. Therefore, the two tests control the Type I error equally but Welch's test has much less power. 5 DISCUSSION In this article, we presented a way to account for both biological and technical variation in weighting by fitting a multi-level mixed effects model of bead-level intensities. We compared existing analysis methods for bead arrays, showing the conditions under which each method would be optimal. Theoretical results suggest that, when array-level biological variation is substantially less than bead-level technical variation, the MLM provides more accurate estimate than the unweighted method especially if the variation in number of beads is large across samples. When biological variation is close to or greater than technical variation, the difference between two methods becomes small. On the contrary, when biological variation is substantially greater than technical variation, the WLS provides inaccurate results compared with the unweighted method or the MLM. Given these theoretical considerations, our proposed method is based on the reasonable and realistic assumption that variance of the bead-level average is additive across the two levels of variation, technical and biological. We confirmed these theoretical properties to be true in the spike-in data. We provided evidence that accuracy of differential expression analysis is improved by accounting for the bead-level variation with the multi-level model especially when biological variation is small. We also showed that when biological variation is large, weighted methods that ignore biological variation might even have lower accuracy than unweighted methods. The multi-level model, which accounts for both biological and technical variation in weighting, reduced the false discovery rate and increased the sensitivity in both settings. We provide a software program to the research community for differential expression analysis using the multi-level model that analyzes tens of thousands of genes efficiently. The key to efficient programming was avoiding numerical inversion of tens of thousands of Fisher's information matrices. We acknowledge the limitation of the spike-in data to answer questions about biological variability. Only spikes had real biological variability across samples, and non-spikes were biological replicates in all arrays. Type I error and specificity, which are estimated only by non-spikes, will be different from the reported values in real biological data. However, when biological variation exists in non-differentially expressed genes, we expect MLM to outperform methods that do not include biological variation in weights. All differential expression analyses were performed for one gene at a time. There have been efforts, however, to combine these with empirical Bayesian method to move sample variance toward a pooled estimate across genes. These have shown to result in stable inference when the number of array is small (Smyth, 2004). For example, the empirical Bayesian method has often accompanied unweighted methods (Hageman et al., 2010; Iorns et al., 2010) and weighted methods (Fernando et al., 2009). It will be interesting to investigate the effect of variance modification in the multi-level mixed effects model.
