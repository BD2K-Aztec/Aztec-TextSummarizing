Motivation: Capillary electrophoresis (CE) of nucleic acids is a workhorse technology underlying high-throughput genome analysis and large-scale chemical mapping for nucleic acid structural inference. Despite the wide availability of CE-based instruments, there remain challenges in leveraging their full power for quantitative analysis of RNA and DNA structure, thermodynamics and kinetics. In particular, the slow rate and poor automation of available analysis tools have bottlenecked a new generation of studies involving hundreds of CE profiles per experiment. Results: We propose a computational method called high-throughput robust analysis for capillary electrophoresis (HiTRACE) to automate the key tasks in large-scale nucleic acid CE analysis, including the profile alignment that has heretofore been a rate-limiting step in the highest throughput experiments. We illustrate the application of HiTRACE on 13 datasets representing 4 different RNAs, 3 chemical modification strategies and up to 480 single mutant variants; the largest datasets each include 87 360 bands. By applying a series of robust dynamic programming algorithms, HiTRACE outperforms prior tools in terms of alignment and fitting quality, as assessed by measures including the correlation between quantified band intensities between replicate datasets. Furthermore, while the smallest of these datasets required 7–10 h of manual intervention using prior approaches, HiTRACE quantitation of even the largest datasets herein was achieved in 3–12 min. The HiTRACE method, therefore, resolves a critical barrier to the efficient and accurate analysis of nucleic acid structure in experiments involving tens of thousands of electrophoretic bands. Availability: HiTRACE is freely available for download at
INTRODUCTIONCapillary electrophoresis (CE) is a widely used approach for biochemical analysis. The rapid electrophoretic separation of * To whom correspondence should be addressed. fluorescently labeled nucleic acid fragments inside electrolytefilled capillaries significantly accelerated genome sequencing (). A more recent, powerful application of CE enables the high-throughput structure analysis of self-assembling nucleic acid-containing systems () as complex as viruses () and ribosomes () at single-nucleotide resolution. The CE profiles obtained in this recent generation of 'structuremapping' experiments present tens of thousands of individual electrophoretic bands; quantifying these data gives detailed portraits of nucleic acid structure, folding thermodynamics and kinetics but requires significant informatics efforts (). 'Basecalling' software packages can assign sequences to these bands in special four-color experiments (see, e.g.) but are not applicable to structure mapping experiments, which require more robust sequence annotation and quantitative fits of each profile to a sum of peak shapes. Such quantitative analysis is aided by the design of experiments so that the desired information appears as differences between corresponding bands across profiles [see, e.g. (; then, sequence annotation of one profile results in annotation of corresponding bands across the entire data. For these datasets, tools for alignment of features or 'rectification' () across different profiles resulted in improvements in quantification speed and accuracy, but these tools remain poorly automated. As the experimental steps of large-scale CE measurements continue to accelerate, the bioinformatic task of profile alignment has become a rate-limiting step in carrying out these information-rich structural studies. Current approaches to aligning and fitting capillary profiles include capillary automated footprinting analysis (CAFA;) and ShapeFinder (); we have found these methods difficult to apply to large-scale titration or mutateand-map datasets (). For instance, CAFA is focused more on peak fitting and has limited alignment capabilities. The ShapeFinder alignment function can align spectrally separated products within a single capillary but not profiles across multiple capillaries with initially poor alignment. Use of these tools requires tedious manual intervention and risks bias or unnecessary errors from such manipulation. Analysis tools for alignment and peak fitting have also been proposed in other domains), mass spectrometry () and slab gel electrophoresis (), but, empirically, these approaches give unsatisfactory performance for CE data. To address the limitations of existing methods, we have developed high-throughput robust analysis for capillary electrophoresis (HiTRACE) to automate the alignment and quantification of nucleic acid structure mapping profiles obtained from hundreds of capillaries. As depicted in, the proposed method consists of four major steps: preprocessing (step A), correlationoptimized linear alignment (step B), dynamic programming-based non-linear adjustments (step C), sequence annotation (step D) and peak fitting (step E). After describing the core algorithms that underlie the robust automation of each step, we present quantitative comparisons illustrating the substantial boosts in both accuracy and speed of HiTRACE over previous approaches. With the proposed methodology, the previously rate-limiting step of quantifying highthroughput CE data is now faster than experimental data acquisition times, enabling the investigation of nucleic acid structure at an unprecedented rate.
METHODS
Experimental setupAn experimental protocol that is optimal for HiTRACE alignment and quantification has been developed; complete descriptions of reaction components, purification procedures and sequencing ladder generation have been given previously (). Briefly, RNA samples were chemically modified under the desired solution conditions and then reverse transcribed with primers (labeled at the 5 ends with the rhodamine green fluorophore) complementary to the 3 end of the RNA. Because the reverse transcription stops at modified nucleotides, the length distribution of the resulting DNA products encodes the chemical reactivities of the RNA. Length separation of the DNA was carried out on Applied Biosystems ABI 3100 and ABI 3730 sequencers; these instruments permit the single-nucleotide separation of products as long as 500 nt for 16 and 96 samples, respectively. To facilitate HiTRACE alignment, all samples were coloaded with a reference ladder that fluoresces in a different color and provides fiducial markers that are identical between samples. The ladder, prepared in a large batch for many experiments, was derived by reverse transcribing an arbitrary RNA (typically the 202-nt P4-P6 RNA) with a Texas red-labeled primer.
Assumptions and definitionsCE profiles each contain hundreds of 'bands' (when the data are viewed in gray scale) or 'peaks' (when the intensity is plotted as a function of electrophoresis time) whose intensities or areas report on individual residues of a nucleic acid sequence. In CE experiments that use hundreds of capillaries, profiles are typically obtained in multiple batches of experiments, e.g. with 16 capillaries in an ABI 3100 sequencer, as illustrated in. The first profile of each batch is designated the reference to which other profiles of the batch should be aligned. Each profile i represents fluorescence intensity measured at uniformly spaced time points (here, 0.1 s) denoted by n = 1,2,...,N with associated intensity values y i (n). As shown in, the horizontal and vertical axes correspond to the profile index and the measurement position in time points, respectively. Fluorescence intensity levels are represented in gray scale, with nucleic acid species of different lengths appearing as separated, dark bands. The desired final output of the proposed methodology is a set of aligned profiles with their quantified band areas.
Preprocessing (step A)In a typical profile, the starting and ending regions contain no signal. To accelerate subsequent steps, the user has the option of defining a window that brackets the electrophoretic signals in all the profiles. As another preprocessing step, we subtract an offset, constant within each profile, so as to bring the signal to zero at the boundaries of the window; this step corrects for overall drift in signal baselines that are observed in sequencer detectors. We have also implemented an option to derive and subtract a smooth (but not necessarily linear) baseline from each profile by using a procedure similar to. This operation removes smoothly varying backgrounds in fluorescence signal sporadically seen in experimental CE profiles and, empirically, brings independent replicates into closer agreement.
Alignment by linear transformation (step B.1)The first alignment step involves a linear scaling and shifting of the time axis based on maximizing the correlation coefficient between each fluorescence profile y i (n) and the reference profile y 1 (n) within each batch:where D i and S i represent the sets of possible values of the shift i and scale factor  i , respectively, and D i S i denotes their Cartesian product. Based on the values found above, we first time scale each profile y i (n) by  * i using linear interpolation and then shift it by * i. The correlation coefficient was chosen as the optimization target because it is independent of signal offset and scaling and has been widely used in other alignment tasks (). We carry out the search over shifts ( i ) efficiently through a Fast Fourier Transform (FFT;). By default, we carry out the alignment based on the reference ladder pattern that is coloaded with each sample (see above).
Alignment between batches (step B.2)Due to variabilities between batches, performing only the intrabatch alignment above produces stratified alignment results, where a number of up-and-down 'stairs' appear. To resolve this problem, we perform an additional interbatch alignment.This step constructs a representative profile of each batch by calculating the average of the first, middle and last profiles selected from each batch. We align these representative profiles to the first representative profile by the procedure above. Assume that, for the representative profile from batch b, we have determined * b and  * b values. We then realign all the profiles in batch b using these * b and  * b values (see). More details of step B.2 can be found in the Supplementary Material.
Non-linear alignment (step C)Page: 1800 17981805
S.Yoon et al.
A
HiTRACEThe concept underlying the non-linear alignment is depicted in the Supplementary Material, and resembles the warping method presented infor chromatographic data. We break the time axis of a non-reference profile into m-pixel windows and then shift each window boundary within a predefined range over the reference profile so as to maximize the correlation between profiles summed over all windows. We assume that the window ordering is preserved during alignment. The number of possible arrangements in this setup is large but can be enumerated efficiently by a dynamic programming (DP) approach () that recursively solves the problem for the first window, then the first two windows, etc. As in steps B.1 and B.2, we accelerate the calculation by computing correlation coefficients through FFT. Example results are shown in. The Supplementary Material includes a graphical description of determining the shift amount for each window edge for aligning two example profiles.
Sequence annotation (step D)Each band in a fluorescence profile corresponds to a position in the nucleic acid sequence. Currently, we carry out sequence annotation interactively and manually, as this encourages visual inspection of the data and makes use of expert knowledge to ensure accurate annotation. This step is accelerated compared to prior approaches () through visual feedback. Sequence assignments are made based on Sanger sequencing ladders included in the experiments; as the user makes assignments, 'guidemarks' appear at expected band positions (one residue longer than the corresponding position of modification, due to dideoxynucleotide incorporation). These guidemark positions can be visually confirmed or adjusted to overlay on experimental bands (see circles in). In addition, these guidemarks can be set to appear on A and C positions for dimethyl sulfate alkylation experiments (), as well as mutated positions in mutate-and-map experiments (), which typically give visually distinct perturbations in chemical modification. These features provide cross-checks on the sequencing ladder that confirm accuracy. Due to the alignment of traces achieved in previous steps, sequence annotations need to only be provided once and are applicable to all traces. Automated annotation procedures are also being developed and will be incorporated in future versions of HiTRACE.
Band deconvolution and quantification (step E)In this last step of HiTRACE, we approximate each profile y(n) for n = 1,2,...,N by a sum f (n) of K Gaussian curves with the formsuch that the deviation defined byis minimized. A k ,  k and  k are the parameters that determine the amplitude, the center location and the width, respectively, of a peak modeled by a Gaussian. We find the optimal values of these parameters by a standard LevenbergMarquardt optimization technique for least-square minimization (), and report the area of each peak as the final output.
Implementation and data preparationWe implemented the proposed HiTRACE methodology in the MATLAB programming environment (The MathWorks, http://www.mathworks.com) and are making it freely available for download at http://hitrace.stanford.edu.For comparison with HiTRACE, we also prepared the implementations of the five different profile analysis algorithms: CAFA (), ShapeFinder (), msalign (), SpecAlign () and COW (). We could not apply some methods to all situations due to their intrinsic limitations. For instance, the alignment feature of CAFA and ShapeFinder requires significant manual intervention to handle hundreds of profiles; we did not include ShapeFinder in the alignment result comparison. Similarly, msalign, SpecAlign and COW can align profiles but do not carry out peak fitting. We thus excluded them in fitting result comparisons.
Criteria for evaluating alignment resultsWe applied two widely used mathematical criteriathe mean squared error (MSE;) of aligned peak positions with respect to the reference peaks and the KullbackLeibler (KL) divergence () between reference and non-reference profiles. In MSE computation, we consider the position p of each peak in the reference profile as the true value being estimated, and use the positionpposition positionp of the aligned peak on a non-reference profile as the estimator of p. The MSE for the j-th reference peak p j is thenwhere L is the number of profiles in the dataset used, and p 1j andpand andp ij represent the positions of the j-th reference peak and the peak on profile i that is aligned to p j , respectively. For the peak detection step involved in the MSE computation, we used the peak algorithm described by, which is specifically designed for finding peaks in CE profiles and shows satisfactory performance for our purpose. To evaluate the alignment results from an information-theoretic perspective, without explicitly considering specific peaks or band positions, we utilized the KL divergence. We calculated the KL divergence between the reference profile y 1 (n) and a non-reference profile y i (n) aswhere N is the number of pixels in each profile. We repeat this calculation for every reference and non-reference pair in a dataset. Before computing KL divergence, intensity values were limited to two SDs above the mean to prevent KL divergence values from being dominated by strong bands at the beginning and end of each profile.
RESULTS
High-throughput RNA structure mapping datasetsTo test HiTRACE, we collected 13 nucleic acid structure mapping experiments read out by capillary electrophoresis (). These datasets were diverse: probed molecules included artificial model systems (the MedLoop RNA and the X20/H20 RNA/DNA system) as well as natural structured RNAs (a conserved domain from the signal recognition particle and the P4-P6 domain of the Tetrahymena group I ribozyme), with lengths between 60 and 202 nt. Three common chemical modification strategies were represented in the data: dimethyl sulfate alkylation (), carbodiimide modification () and 2-OH acylation [the SHAPE strategy (. In addition, the datasets were challenging in their size. Three experiments each gave 182 bands over 480 electropherograms, for a total of 87 360 bands per dataset. Finally, to test the precision of quantification relative to other sources of error, five experiments were conducted twice byPage: 1802 17981805two independent researchers. Additional datasets were collected to confirm HiTRACE's ability to quantify data for RNAs over 400 nt in length (the L-21 ScaI Tetrahymena group I ribozyme) and to compare overlapping SHAPE data derived from reverse transcription starting at different primers on the same RNA (the P4-P6 domain). Overall, these datasets provide a diverse and challenging benchmark of nucleic acid CE experiments at the large scale permitted by current high-throughput experimental protocols.
S.Yoon et al.
Robust alignment of CE profilesAs the most basic test, we first compared the alignment results of HiTRACE with previously available methodologies by visual inspection (). Prior to alignment, CE experiments gave initially poor alignments of DMS chemical mapping profiles for the 60 band MedLoop RNA and the 182 band P4-P6 RNA ('Raw' inand B). Application of automated HiTRACE alignment aligns the strong bands across all profiles ('HiTRACE' inand B; see alsoC). In the alignment results produced by methods other than HiTRACE, profiles within each group tend to be reasonably aligned, whereas profile groups are not well-aligned. We did not observe this 'stratification' problem in the HiTRACE result, mainly due to the interbatch alignment step (B.2) used by HiTRACE. Additionally, comparing HiTRACE results with SpecAlign and CAFA results reveals the effectiveness of the HiTRACE non-linear alignment step, which adapts alignment to weakly varying electrophoretic rates along the profile. In the alignment results produced by SpecAlign and CAFA, some parts of the profiles appear reasonably aligned, but the top (SpecAlign) or bottom (CAFA) portions are not well aligned. For msalign and COW, this problem is much more noticeable. For more quantitative evaluation of profile alignments, we compared the different methodologies in terms of two mathematical criteria, mean squared error in peak position (MSE) and KL divergence between profiles.) (replicate 2) before alignment and after alignment by HiTRACE, msalign (), SpecAlign (), COW () and CAFA ().
Leveraging accurate alignments into accurate quantificationTo assess the accuracy of the entire quantification procedure, including alignment, sequence annotation and band deconvolution, we compared final quantified results between HiTRACE and previously available software for RNA structure mapping CE data, using two MedLoop DMS mutate-and-map datasets () (see also Supplementary Material for a comparison with the X20/H20 DMS data). Each set contained at least 120 profiles with 60 bands, for a total of 7200 data points per set. (Further comparisons between software packages were precluded by the difficulty of carrying out the analysis with prior software: ShapeFinder gave poor alignment even after several hours of manual intervention, and CAFA analysis required 10 h of manual adjustment for this data set and would have required days for larger data sets.) The MedLoop sets gave excellent Pearson's correlation coefficients between band intensities quantified with HiTRACE to those quantified with CAFA (r of 0.979 and 0.965;and B), confirming the lack of any major systematic errors introduced by the HiTRACE method. We hypothesized that the small, residual variance between the methods might stem from user-introduced variation during alignment (CAFA) or sequence assignment of bands (in CAFA and HiTRACE). To test this hypothesis, we carried out replicate quantification of the same datasets; the second independent analysis gave values with correlation coefficient (r) to the first analysis of 0.987 and 0.989 (HiTRACE;and D) and 0.989 and 0.974 (CAFA;and F). We conclude that any differences between HiTRACE and CAFA can be explained by imprecision (variance of 1.11.3% in HiTRACE and 1.12.6% in CAFA) introduced by users; this error is much smaller than variances arising from experimental error, as is discussed in the next section.
Consistency in band quantification between experimental replicatesA stringent measure of the accuracy of an experiment and its analysis is the correlation of quantified intensities between independent replicates. The goodness of this correlation is determined by experimental factors, including small variations in sample purity, pipetting errors, temperature differences and variable times of each experimental step, and is also sensitive to any uncertainties arising from the data analysis procedure. We compared correlation coefficients between separate independent replicates of the MedLoop DMS mutate-and-map experiments (), quantified by both HiTRACE and CAFA (and B). In both cases, the cross-replicate correlations (0.890.90) are significantly lower than the intrareplicate comparisons (0.970.99) above, verifying that variances in experimental procedures exceed any variances in the data quantification. The throughput of HiTRACE quantification enabled us to carry out this cross-replicate comparison for the additional replicate sets (see Supplementary Material) and to explore whether alternative data processing schemes might improve the precision of the HiTRACE quantification. We tested a computationally expensiveband deconvolution procedure [previously used in SAFA ()] that optimized centers of fitted Gaussians for each individual profile. We observed indistinguishable cross-replicate correlation coefficients () with this procedure as compared to the the default HiTRACE method (no refinement of band centers). This comparison further validated the high quality of the profile-to-profile alignment in earlier HiTRACE steps, and motivated our choice to make as the HiTRACE default the 10to 100-fold faster band-deconvolution procedure without band center refinement. We observed similarly invariant or slightly worse correlation coefficients in experiments without the baseline subtraction procedure; with additional alignment steps of 'binarized' profiles; and with other methods to automatically refine band positions in each profile (see Supplementary Material).
Reduced time demand of quantificationAlthough HiTRACE relies on multiple steps for accurate analysis, the time demand of quantification by HiTRACE was considerably smaller (a few minutes) than the time required by prior informatic approaches as well as the time involved in preparing and obtaining the CE experiments (a few hours).shows the average running time of HiTRACE for different datasets, along with the breakdown of the running time. The largest dataset (P4-P6 CMCT; 480 profiles and 87 360 bands) took approximately 12 min to Page: 1804 17981805), and (C) for HiTRACE on five replicate data sets without (black bars) and with (white bars) optimization of Gaussian positions during band deconvolution. quantify, and the smaller sets (88136 profiles, 40008000 bands) required 3 min or less. Overall, HiTRACE averaged 1.58 s per profile from beginning (raw data load-in) to end (quantified band intensities). For the same datasets, the overall computational time of the tools for alignment only (i.e. msalign, SpecAlign and COW) were between 10 min to 2 h (without peak fitting) depending on the data size. As discussed above, CAFA and ShapeFinder, the previous full suites available for nucleic acid CE quantification, required even more time (hours for the smaller datasets, extrapolated to days or weeks for the larger sets). As shown in, the HiTRACE time breakdown is similar for all datasets, except for the P4-P6 RNA datasets, in which later stages are lengthened by increasing the number of bands in each profile (200 residues in the P4-P6 RNA, compared to under 100 residues for the other RNAs). We further used HiTRACE on datasets with longer RNAs (up to 400 nt) and involving reverse transcription with primers complementary to the middle of a long RNA; the HiTRACE procedure was readily applied to these datasets (see Supplementary Material), and, encouragingly, the time demand remained linear with the number of bands.
S.Yoon et al.
DISCUSSIONHiTRACE employs a series of automated techniques to control the high level of variability in parameters of CE systems and to resolve a key alignment bottleneck of modern nucleic acid structure mapping experiments. Several algorithmic advances are responsible for HiTRACE's accuracy and speed, including dynamic programming strategies that have not been been previously considered in the field. Quantitative comparisons on large experimental datasets
The Author 2011. Published by Oxford University Press. All rights reserved. For Permissions, please email: journals.permissions@oup.com at :: on August 30, 2016 http://bioinformatics.oxfordjournals.org/ Downloaded from
With current CE equipment, we found that it was not feasible to get complete alignment for profiles with single-band resolution through just linear scaling of the time axis. There are two reasons for this problem. First, the electrophoretic mobilities of the same products in different capillaries, or for the same capillary used at different times, can vary due to temperature differences and geometry differences. As a result, long profiles, containing hundreds of bands measured over tens of minutes, can be aligned well over the initial part of the data (e.g. the first 2 min) or the final part of the data (e.g. the last 2 min), but both parts cannot be simultaneously aligned with a single linear transformation. Second, we often run capillary electrophoresis experiments for structure mapping of molecules with slightly different sequences, e.g. libraries of single-mutation constructs (Kladwang and Das, 2010; Kladwang et al., 2011). This leads to small perturbations in the band mobilities at the site of the mutation and requires a locally nonlinear transformation to permit alignment. To correct for both these issues, we perform another round of refining the alignment.
at :: on August 30, 2016 http://bioinformatics.oxfordjournals.org/ Downloaded from
Fig. 5. The average running time of HiTRACE on different datasets. The time was measured on a personal computer system equipped with a 2.66 GHz Core i5 processor (4 cores; multithreading enabled) with 4 GB RAM. demonstrate the utility of a linear time-axis transformation used in globally aligning profiles as well as the importance of a non-linear alignment procedure for resolving further unavoidable variations in elution rates along a capillary. In addition, an interactive band annotation interface increases user convenience and provides accurate starting positions for the subsequent quantification step. These improvements have brought down the overall analysis time of datasets with tens of thousands of electrophoretic bands from days to minutes. The largest time savings of the method are on experiments in which the same RNA sequence is probed under a variety of solution conditions, chemical modifiers, kinetic timepoints or mutations [see, e.g. (Das et al., 2010; Kladwang and Das, 2010; Kladwang et al., 2011; Mitra et al., 2008; Weeks, 2010; Wilkinson et al., 2008)]. Now, the slow step in these and other experiments is interactive band annotation, which takes minutes (Fig. 5). As more automated band assignment methods are developed (R.D., unpublished data; P.Pang, M.Elazar, J.S.Glenn, personal communication), we plan to incorporate them into this interface. Although we designed HiTRACE primarily for RNA chemical structure mapping, the principles and premises that underlie HiTRACE are general and can easily be modified for use in other types of experimental assays. To enhance the adoption of this tool, we have created a stand-alone version of HiTRACE with a graphical user interface. We are also making the source code freely available to encourage further innovation and incorporation of these algorithms into other laboratories' CE software suites. Beyond the datasets discussed herein, HiTRACE is continuously being used for other studies, totalling over 20 000 profiles (greater than 2 million bands) at the time of submission (W.K., R.D., unpublished data; see also http://rmdb.stanford.edu). Given its accuracy, robustness and efficiency, we expect that HiTRACE will become a valuable tool for nucleic acid experimentalists entering a high-throughput era of structural analysis.
