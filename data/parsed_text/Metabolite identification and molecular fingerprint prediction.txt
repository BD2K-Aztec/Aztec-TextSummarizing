Motivation: Metabolite identification from tandem mass spectra is an important problem in metabolomics, underpinning subsequent metabolic modelling and network analysis. Yet, currently this task requires matching the observed spectrum against a database of reference spectra originating from similar equipment and closely matching operating parameters, a condition that is rarely satisfied in public repositories. Furthermore, the computational support for identification of molecules not present in reference databases is lacking. Recent efforts in assembling large public mass spectral databases such as MassBank have opened the door for the development of a new genre of metabolite identification methods. Results: We introduce a novel framework for prediction of molecular characteristics and identification of metabolites from tandem mass spectra using machine learning with the support vector machine. Our approach is to first predict a large set of molecular properties of the unknown metabolite from salient tandem mass spectral signals, and in the second step to use the predicted properties for matching against large molecule databases, such as PubChem. We demonstrate that several molecular properties can be predicted to high accuracy and that they are useful in de novo metabolite identification, where the reference database does not contain any spectra of the same molecule.
INTRODUCTIONIn metabolomics, mass spectrometry (MS) provides the key measurement technology for quantifying and qualifying chemical signals to provide biological knowledge of cellular processes (). An MS measurement of a biological sample results in a set of peaks representing the mass-to-charge ratios and intensities of the different compounds of the sample. Identification of these molecules through mass spectra is a prerequisite for further biological interpretation and is the most time-consuming and laborious step in metabolomics experiments (). The identification process is still mostly not automatized, thus requiring extensive manual analysis and expert knowledge (). Some structural information on a given compound can be obtained by tandem mass spectrometry (MS/MS) through ionization or collision-induced dissociation fragmentation experiments. Tandem mass spectrum contains peaks representing various fragmentation products of the unknown compound, including the difficulty to predict rearrangement reaction products. A compound fragments in specific patterns according to its structure, the collision energy and the experimental configuration (). Elucidation of tandem spectra is at the core of molecular identification (). The standard method of performing compound identification is to measure the tandem mass spectrum of the unknown compound and to query the spectrum against annotated reference libraries of standardized spectra (NIST, MassBank, Wiley Registry) (), followed by extensive domain expert analysis. In practice, the reference database requires a closely matching type of equipment and operational parameters for reliable matching (). Machine learning approaches for metabolite identification from MS/MS data have not been widely studied. Early related work includes STIRS () that uses a nearest neighbor approach to model the statistical relationships between spectral features and molecular substructures, the neural network work of, and the decision tree approach by. However, the impact of these methods has remained dormant perhaps due to predating the era of systems biology and limited available data. In contrast, current state-of-the-art methods are based on combinatorial algorithms and database searches. The MetFrag software identifies metabolites by matching candidate metabolites with closest combinatorially simulated spectrum to the observed one (). Analysis of isotopic patterns can give additional clues on the metabolite's elemental composition (). We introduce a novel two-step pattern-recognition approach (see) to the metabolite identification problem. Instead of directly learning a mapping between the spectrum and the metabolite, we first predict a set of characterizing fingerprints of the metabolite from its tandem mass spectrum using a kernel-based approach. We learn our fingerprint prediction model from a large set of tandem mass spectra obtained from public mass spectral database MassBank (step, we match the predicted fingerprints against a large molecular database to obtain a list of candidate metabolites. The metabolite identification model generalizes to metabolites not present in reference spectral databases. Due to the machine learning approach, data from any type of mass spectrometer are supported. In Section 2, we review the basics of mass spectrometry and the current state-of-the-art of metabolite identification through reference databases. We introduce three classes of mass spectral features and a probability product kernel over the spectral features in Section 3. We also discuss the use of multiple measurements from the same metabolite. We propose a statistical approach to retrieve candidate metabolites using the predicted properties in Section 4. In Section 5, we experiment with the proposed FingerID method in fingerprint prediction and metabolite identification. We conclude this article with discussion in Section 6.
METABOLITE IDENTIFICATION THROUGH TANDEM MASS SPECTROMETRYA tandem mass spectrum is generated by selecting an unknown ion band and its mass-to-charge ratio to undergo fragmentation (see). Under mild fragmentation conditions, the peak corresponding to the molecule ion is still visible in the tandem spectrum at the same mass-to-charge. During fragmentation, an ion is often cleaved into two fragments, one of which retains the charge (Small molecules appear often as singly charged ions. We assume single-charged ions throughout the paper for clarity.) and is visible in the tandem mass spectrum. The complementary fragment is a neutral loss invisible in the spectrum. The first step in compound identification is to constraint the mass and elemental composition of the compound through peak masses. Computational methods utilize the compound's peak and its isotope peak masses to compute set of possible elemental compositions (). However, mass measurement accuracy defines the set of compatible compositions through the scope of error in the mass measurements. High-or ultra-high-resolution analyzers, such as Time-of-flight and fourier transform analyzers, can achieve low mass errors in the range of 15 ppm (). We distinguish four increasingly challenging cases for annotating an unknown spectrum measured at specific device through querying mass spectral databases:(1) The database contains a spectrum of the molecule, measured with the same device and experimental parameters(2) The database contains a spectrum of the molecule, measured on the same device but with different experimental parameters (e.g. collision energy)(3) The database contains a spectrum of the molecule, measured on a different device(4) The database does not contain the spectrum. Annotation requires de novo metabolite identificationIn the first Case (a), we expect a simple retrieval of the most similar spectrum from the reference database to give reliable identifications, with no need for more complicated prediction schemes. Cases (b) and (c) are expected to be less suited to simple retrieval and leave room for improvement through machine learning approaches. Finally, Case (d) is not possible to tackle with retrieval from a reference database and can be seen as the prime motivation for machine learning method development. The standard query methods rely on a distance function to compute the best hits of the unknown spectra against a library. The most common approach is to count the number or proportion of shared peaks. Several methods include peak intensities with experimentally defined weights () or probabilistic measures (). In our experiments we use retrieval from the MassBank database as the reference database method, giving match scores for query spectra. (MassBank also has an advanced metabolite identification service, which however is not available in batch mode.) The score is the Pearson correlation between weighted peak vectors between query w (q) and target w (t) spectra with elements w i  int i  mass i ; where  0.5 and  2 (). Alignment of the peaks is ensured by allowing some mismatch, default value at 0.3.
KERNELS FOR MASS SPECTRAIn this section, we build three classes of features extracted from mass spectra that are relevant to the fingerprint prediction task. The features are used in two families of mass spectral kernels for SVM classification: an integral mass accuracy kernel and a high mass accuracy kernel, where the peaks generate a gaussian mixture model densities. Furthermore, we introduce methods to utilize multiple collision energy spectra through kernel fusion.We consider mass spectra of molecule as a collection  fx 1 ;. .. ; x k g 2 X of k two-dimensional peak tuples x i 2 R 2 (see). (The number of peaks k varies from spectrum to spectrum in the dataset.) A peak x  (mass,int) T represents the mass-to-charge value and the intensity of the peak measurement. We normalize all intensities to range. Often we have a series of spectra of a molecule measured with increasing collision energies as ( 10eV,. . ., 50eV ). A mass spectral kernel K : X  X ! R is a positive semi-definite similarity function between sets. The kernel K induces a mapping : X ! H of input to a Hilbert space, such that K(, 0 )  h(),( 0 )i where ; 0 2 X. The power of kernels comes from the fact that a simple similarity value can implicitly construct a rich feature representation of non-vectorial objects. We learn a function f : X ! f1; 1g m mapping the tandem mass spectrum of an unknown metabolite into the mdimensional fingerprint target vector y  (y i ) i  1 m 2f-1,1} m using a dataset of n spectra f 1 ,.. ., n }. We opt to use n binary SVM's each learning the subtask f i : X ! f1; 1g. The learning function is f i   signw T i   sign P j j K j ; , where w i 2 H. The main types of fingerprints are topological, physico-chemical and electrical properties of the molecule (). In Section 4, we utilize the fingerprints y to filter candidates from molecular databases.where iAE0.5 (mass) is an indicator function giving 1 if i  0.55mass5i  0.5, and 0 otherwise. The 'peaks' features gather all intensity of peaks that are rounded to its nearest integral mass. The dimensionality d of the feature space is equivalent to the largest feature index with non-zero value, i.e. the mass of the largest peak in the dataset. The peak ions are complemented by undetected neutral loss peaks which indicate the masses of cleaved fragments from the precursor (mother) ion. The 'neutral loss' features nloss
Integral mass kernelwhere we add the intensities of all peaks whose mass difference to the precursor prec() rounds to i. The neutral losses are invariant of the mother ion mass and allow cleavage detection of e.g. phosphate group PO 4  which has a standard atomic weight of 94.97. In tandem mass spectrometry, the fragment ions themselves can undergo further fragmentation. We can generalize the notion of neutral losses to include secondary fragmentation reactions between non-mother ion peaks by multiplying the intensities of any two pairs of peaks with a fixed integral mass difference. The peak 'difference' feature representation diff ()  ( diff ()The full integral kernel K full  K peaks  K nloss  K diff corresponds to a concatenation of the feature sets full  ( peaks ; nloss ; diff ). Polynomial combinations of the features are easily computed by applying a polynomial kernel. We experiment with linear and quadratic kernels in Section 5. The integral kernel is directly positive semi-definite (Shawe).
High-resolution mass kernelThe explicit feature representation of the discrete kernel allows direct inspection of the feature weights. However, it rounds all peaks to a nearest integer value. The unique peaks with same rounded mass are erroneously binned together. We can expand the feature space by narrowing the bin widths; however, this introduces an alignment problem in the dot product. Instead, we generalize the feature mapping with a kernel between distributions by applying the probability product kernel of Kondor and Jebara (). We fit probabilistic models p() and p 0 ( 0 ) over spectra and 0 and define the kernel between spectra as a kernel between the corresponding probability distributions, K(, 0 ) K(p,p 0 ). We use a probability product kernelwhich has an interpretation as an expectation of one distribution under the other Zcalled the expected likelihood kernel as in. For countable and finite quantities, the probability product corresponds to a dot product hp,p 0 i in ' 2 with a feature representation : ! p() that collects the probabilities into a vector. Note that in general K(,)6 1 as the probability product is not a proper distribution. We normalize all kernels to. We opt to model the probabilities p  1 k P k i1 p i x as gaussian mixture models estimated using maximum likelihood density estimation separately for the three feature classes. Each feature (e.g. peaks) x i  (mass i ,int i ) corresponds to a non-isotropic two-variate normal distribution p i x i  $ N x i ; AE over the mass and intensity of peak i. We assume zero covariance between mass and intensity by setting AE . The probability product kernel can be computed in closed form aswherethe kernel measure the tuple products of features analogous to the integral case. The kernel is a valid positive semi-definite function ().
Multiple collision energiesDatabases such as MassBank contain a series of spectra measured using various collision energies (CE). Complementary structural information can be attained from spectra of different collision energies. A higher collision energy places more energy into the fragmentation process, usually producing more small secondary and tertiary fragments. Gradually ramping up the collision energy might reveal the gradients of the peaks, which are related to the energy landscape of the fragments. In practice, spectra are measured with fixed collision energies, often from 10 to 50 eV. A simple strategy to facilitate learning from various collision energies is to denote all spectra as independent data points and use majority voting over all collision energies.
Sum kernelsSpectra at different collision energies provide complementary information on the molecule. Thus, we can model the process by having CE-specific variables. Let e be the feature space of measurements at CE-e. Then, the full feature space is a concatenation of CE, specific spaces;  ( e 1 ;.. .; e n ), where e i is the ith collision energy. The kernel is computed as the sum of CE-specific kernels, K  K e 1    K e n. In this model, we take all similarity information into account with equal weights. The method supports natural data where molecules have partial spectra series with some measurements missing.
Merged spectraIt is common practice to merge the differing collision energy spectra together by summing the intensities into a single spectrum. This corresponds to summing the feature values across spectra, i.e. the feature space is  P ei ei. This can be computed with kernel matrices by) is kernel value of e (i) and e 0 (j). This formulation corresponds to a sum kernel model with additional similarities between features across different CE added.
METABOLITE IDENTIFICATION THROUGH FINGERPRINTSThe predicted fingerprints can be directly used to characterize the class and properties of the measured metabolite. However, our primary interest is to support metabolite identification, which calls for converting a set of predicted molecular fingerprints into a score function that can be used to retrieve candidate molecules from large molecular databases such as PubChem (). As different fingerprints can be predicted with varying accuracy from the mass spectra, the reliability of the fingerprints in identification of the molecule varies correspondingly. We develop a probabilistic model to tackle this uncertainty, in such a manner that the more reliably predicted fingerprints receive more weight when matching to a large set of candidate molecules.denote the vector of prediction accuracies (reliability of fingerprint prediction) of the m fingerprints y  (y i ) i1 m , obtained, e.g. from a cross-validation experiment. Taking the individual fingerprints as independent, we obtain a probability for a fingerprint vector y to be the true fingerprint vector given a predicted vector y 0 from the Poisson-binomial distributionNow, given a fingerprint vector y 0 predicted from a mass spectrum, and a set M of candidate molecules M with the true fingerprint vectors y(M) pre-computed, we can use Equation (1) to score the candidate molecules by scoreM  PyM j p; y 0 :A ranking is established by checking the number of molecules M 0 in the dataset M that have as high score or higher than the given molecule M: rankM  jfM 0 2 M j scoreM 0  ! scoreMgj:Thus, all molecules with the same score receive the same rank. We, note that scoring and ranking a set of candidate molecules is efficient. The time complexity of evaluating the probabilities of database's fingerprints given a prediction is ONm operations, where N is the size of the database and m the number of fingerprints. In our experiments, the success of metabolite identification query is simply determined by rank (M*) of the true molecule M* among the candidates. In our experiments, we use in addition to MassBank, the Kegg database (), which represents over 14 000 common organic molecules, and the PubChem database, which is the largest open repository of known molecular universe with over 30 million unique structures. Utilizing special purpose databases such as Kegg act as prior knowledge that our target molecules are most likely metabolites.
EXPERIMENTSWe experiment with our method, called FingerID, in predicting fingerprints and identifying metabolites with three datasets: QqQ, Ltq and Lipids. The 'QqQ' dataset is of nominal mass accuracy and contains positive-mode Quadrupole measurements of 514 metabolites. The metabolites are also measured with five different collision energies from 10 to 50 eV, however 11.5 % of the measurements are missing. The 'Ltq' dataset is an ultra-high accuracy positive-mode Orbitrap dataset of 293 miscellaneous metabolites. Finally, 'Lipids' is an ultra-high-accuracy negative-mode Orbitrap dataset of 403 internally homogeneous phophatidylethanolamines. All data are obtained from the MassBank database (). The average mass offsets and standard deviations are computed using MassBank annotations and are listed in. We initially examined a set of 528 unique structural fingerprints from OpenBabel (FP3, FP4 and MACCS). However, many of the fingerprints appear in either all or none of the molecules in the dataset and are excluded from the set of potentially useful fingerprints (). For each dataset, we retain only non-uniform fingerprints.
Experimental settingsWe used the libSVM implementation with 5-fold cross-validation over the fingerprints in each dataset. We choose the optimal C parameter from f10 0 ,10 1 ,10 2 ,10 3 ,10 4 }; however, in general it had a small effect. Each fingerprint was predicted independently as a binary classification task. The baseline classifier (default) always blindly votes for the most common fingerprint assignment according to the dataset. Note that due to the cross-validation the method is assessed with a test set that contains only spectra not seen in learning the model. This is analogous to the Case (d), where the metabolites are novel and not previously annotated. We experimented with various values for the width parameter mass of the gaussian kernel (shown). The value of two times the empirical standard deviation yielded consistently high results. We set the int such that the similarity in density between maximal (1.0) and minimal (0.0) intensity peak is half of the mode, resulting in int  0.849.
Fingerprint prediction performanceThe aggregate mean results of the fingerprint prediction experiments are summarized in. The F 1  2PR/(P  R), where R is the recall and P is the precision, measures the balance of the model in predicting both positive and negative and improvement over the default classifier. The high-resolution kernel on all features comes out as the best on average. However, 'peaks' and 'neutral loss' kernel is almost as good. Quadratic kernel helps prediction on average only in the case of integral kernel on 'peaks' or 'peaksneutral loss' features (open markers). The dataset-specific results are summarized in Tables 2 and 3 denoting the average prediction accuracy and F 1 , respectively, over the kernel and dataset. In general, the high-resolution mass kernels (lower part of the table) achieve better results than the discrete kernels (upper part). The quadratic high-resolution kernel over all three feature types achieves best results in 5 cases out of 9. The difference in three feature classes is consistent in all datasets. In the 'Ltq' dataset, the 'peaks' features give 86.7%, 'neutral losses' 88.8% and 'peak differences' 83.9% accuracies. Combining 'peaks' and 'neutral losses' improves the result to 91.1% while combining 'peak differences' does not improve the results. In general, the 'peak difference' features are useful only in the 'QqQ' dataset with a single CE dataset. In the 'QqQ' dataset, metabolites are measured with five collision energies. The 40 eV CE is alone the most informative data source; however, utilizing all spectra of different collision energies increases the results notably. In the high-resolution kernel, best results are achieved by merging the spectra (91.1%), while in the discrete case summing the kernels directly gives best results (90.7%). Individual fingerprint prediction performance is depicted in. The figure shows the predictive accuracy for the 150 least accurately predicted fingerprints using the worst single CE as the sorting criterion. The merged spectrum always surpasses the predicting made by individual CE's. The 'Lipids' dataset achieves extremely high-prediction accuracies of over 97% with almost all kernels. This is in contrast to the 'QqQ' dataset, where utilizing any individual CE measurement gives only small improvements over the baseline predictor. This is partly explained by the integral measurement accuracy of the 'QqQ' dataset, while the other two datasets come from ultra-high-resolution analyzers.Only a subset of fingerprints are exhibited in each dataset's molecules.
40
Direct spectral matchingWe characterize the reference database retrieval performance in our three datasets (). In the reference retrieval, we assume the correct molecule is contained in the reference database (Cases ac). On average (the upper portion of the), the 'QqQ' and 'Lipids' datasets achieve almost 100% retrieval rates. We define the retrieval rate as the proportion of metabolites that are identified correctly within the first 10 candidates. This is due to the existence of multiple measurements of the same metabolite in MassBank: in 'QqQ' almost all metabolites have measurements at five collision energies (Case b), and in 'Lipids' almost all metabolites have a duplicate measurement (case a). By limiting ourselves to spectra measured at the same device but different CE, the retrieval rate becomes 94% in 'QqQ'. In 'Ltq' utilizing the duplicate measurements does not increase the retrieval rates. However, when spectral matches are restricted to measurements made with different devices, the retrieval drops from 63.2 to 28.2%. This is an expected drop, as the mass spectrometer defines the fragmentation process and thus has a major impact on the spectral signals.
Metabolite identification through fingerprintsHerein, we examine the performance of our method in de novo identification (Case d), where the test set contains only spectra of molecules not seen in the training set. This is expected to be a challenging task as the machine learning method needs to generalize from the spectral signals. Notably, the direct spectral matching method cannot work in this case.andindicate the de novo metabolite identification performance utilizing the predicted fingerprints in the three datasets. We first search for candidate metabolites matching the measured neutral mass using a mass range of AE 0.5 ('Avg. hits w/ AE 0.5 mass' in) from either Kegg or PubChem, followed by fingerprint prediction and metabolite identification. When querying molecular identification from Kegg, the average ranks of the correct metabolites are 5.0 and 3.2 for 'QqQ' and 'Ltq', respectively. The retriaval rates are 85 and 91.8%, respectively. None of the molecules in the 'Lipids' dataset was found from Kegg. Against PubChem several tens of thousands of candidates match the mass range on average. The top 10 rank retrieval rates for PubChem are 29.3, 50.8 and 54.4%, for the three datasets, even though the average ranks are relatively high. The P 50 value is the normalized median rank, i.e. it indicates the maximum rank, normalized by the database size, which 50% of the query molecules attain. For instance, in 'Ltq' dataset against PubChem, the P 50 is 3.2  10 4 , which indicates that the better half of the predictions are able to exclude 99.96% of the neutral mass matching molecules in PubChem.indicates the cumulative portions of the datasets at a given maximum rank. The P 50 values correspond to the x-axisAbbreviations: p is peaks, nl is neutral loss and df is difference kernel. values at y-axis value of 0.5. Due to the large size of PubChem, the ranks are in general several orders of magnitude larger. However, most of the molecules are still within the absolute rank of 1000. We experimented with thresholding the set of fingerprints used based on the bias and accuracy of the fingerprints. By leaving out some portion of the least accurately predicted and most biased fingerprints the actual molecule ranks decreased (data not shown).In the next experiment, we test the performance of the FingerID method against the approach of retrieving the closest matching spectrum from MassBank, under the assumption that the spectrum of the metabolite is MassBank but measured with a different collision energy, representing Case (b). We trained our fingerprint prediction model in a stratified cross-validation setting where spectra of specific collision energy (1050 eV) were chosen to the test fold and the other collision energies were used in training the model (). As the baseline, direct spectral matching from Massbank finds a match with correct metabolite in 94% of the cases. The performance of the FingerID method depends on both the molecular database used for retrieval (Kegg or PubChem) and the CE used for training and testing. The performance of FingerID coupled with Kegg is better than direct spectral matching when retrieving the 'middle' collision energy spectra (2040 eV) but is weaker in predicting the two extremes, especially 10 eV spectra. When identifying against PubChem, the retriaval rate differences become larger from a minimum of 13.1% at 10 eV to a maximum of 70% at 30 eV.
Comparison to MetFragMetFrag is a state-of-the-art metabolite identification method, which assigns a score to candidate metabolite based on the similarity of a simulated spectrum to the observed one (). The simulated spectrum is produced by combinatorially removing bonds from the parent ion and recording the resulting. The fingerprint specific accuracies of the 'QqQ' dataset with the high resolution quadratic full kernel. The bars indicate the accuracy of the fingerprints when using least informative and most informative collision energy spectra, and the merged spectra. Only the 150 least accurate fingerprints are shown. The default classifier is indicated by the bottom of the bars fragments as possible explanations for the observed peaks. This parallels the idea that a good candidate should be able to produce all peaks by mostly bond cleavages. We randomly selected a subset of 20 spectra from both QqQ and Lipids datasets, respectively. The QqQ represents nominal mass spectra with an absolute mass error set to 0.5, while Lipids is a high-resolution dataset with absolute mass error of 0.05. The appropriate mass errors were used in MetFrag. We queried both datasets against both Kegg and PubChem in MetFrag. Analysing the total of 40 spectra took approximately 1 day of manual work, as MetFrag does not support batch processing. We measure the rank of the correct metabolite with both MetFrag and our method. The results are highlighted in. FingerID obtains favourable results to MetFrag in most cases, with significantly more retrieval results with top 10 rank, and higher overall recall rate. MetFrag found the correct metabolite for approximately half of the spectra from Kegg and for only a couple of spectra from PubChem. This is due to the default limit of 100 candidate structures, which allows for an analysis of spectral datasets in appropriate time frames.
DISCUSSIONWe presented a novel approach for de novo metabolite identification through intermediate fingerprint prediction based on tandem mass spectra. Our results indicate that it is possible to learn the statistical dependencies between tandem mass spectral signals and molecular properties, which can be used to score and rank metabolites, with good identification performance. Moreover, a sufficiently large set of fingerprint predictions can give useful clues to the actual metabolite identity to the human expert, even if exact automatic identification remains elusive. The machine learning approach widens the utility of mass spectral databases such as MassBank. Due to the nature of theThe upper part of the table shows performance of reference queries in general, while the lower part indicates the performance when utilizing spectra only from the four different cases (Section 2). By definition, the (d) case gives no identifications.method, any type of tandem mass spectral data is applicable. This also allows us to handle, for example, the rearrangement reactions, which result in exceptional and difficult-to-predict fragment products (). Utilizing multiple measurements increases the prediction accuracies through kernel-based data fusion. Our method can be easily complemented by inferring additional information about the metabolites, such as sum formulas from isotopic patterns () or by performing fragmentation analysis () in addition to fingerprint prediction. Further research is obviously necessary to bring the machine learning-based approach towards a practical tool for metabolomics. In de novo metabolite identification, the identification performance depends, on one hand, on the uniqueness of the fingerprints to particular sets of metabolites, and on the other hand, the ability to predict these fingerprints from tandem mass spectra. It is an interesting future research direction to develop computational methods to identify sets of fingerprints that strike a good balance between these two qualities. An interesting machine learning approach for representing the molecular properties would be to use structured prediction () to model the statistical dependencies between the fingerprints and the input spectrum.
at :: on August 30, 2016 http://bioinformatics.oxfordjournals.org/ Downloaded from
M. Heinonen et al. at :: on August 30, 2016 http://bioinformatics.oxfordjournals.org/ Downloaded from
Metabolite identification through machine learning at :: on August 30, 2016 http://bioinformatics.oxfordjournals.org/ Downloaded from
