Motivation: Alignment of multiple liquid chromatography/mass spectrometry (LC/MS) experiments is a necessity today, which arises from the need for biological and technical repeats. Due to limits in sampling frequency and poor reproducibility of retention times, current LC systems suffer from missing observations and non-linear distortions of the retention times across runs. Existing approaches for peak correspondence estimation focus almost exclusively on solving the pairwise alignment problem, yielding straightforward but suboptimal results for multiple alignment problems. Results: We propose SIMA, a novel automated procedure for alignment of peak lists from multiple LC/MS runs. SIMA combines hierarchical pairwise correspondence estimation with simultaneous alignment and global retention time correction. It employs a tailored multidimensional kernel function and a procedure based on maximum likelihood estimation to find the retention time distortion function that best fits the observed data. SIMA does not require a dedicated reference spectrum, is robust with regard to outliers, needs only two intuitive parameters and naturally incorporates incomplete correspondence information. In a comparison with seven alternative methods on four different datasets, we show that SIMA yields competitive and superior performance on real-world data. Availability: A C++ implementation of the SIMA algorithm is available from
INTRODUCTIONRecent developments in liquid chromatography/mass spectrometry (LC/MS) have afforded insight into the dynamics of biological systems at unprecedented levels of detail. High-resolution MSbased protein identification and quantitative MS are now established methodologies in fields as diverse as proteomics (), glycomics (), lipidomics () and metabolomics (). * To whom correspondence should be addressed.  The authors wish it to be known that, in their opinion, the first two authors should be regarded as jointRobust alignment of LC/MS experiments: current LC/MS experiments often investigate complex biological systems over a set of different environmental conditions and/or time-courses. The associated data are routinely split into multiple fractions and acquired in technical and biological replicates, yielding tens to hundreds of LC/MS runs. Each of these runs delivers a snapshot of the system of interest and to enable their joint analysis, the common components in different measurements need to be related to each other. In practical LC/MS applications, two major factors complicate the determination of component correspondences across multiple runs: (i) the limited reproducibility attained on LC systems, which gives rise to non-linear distortions of the retention time domain; and (ii) the limited sampling frequency inherent to data-driven MS/MS acquisition as a notorious cause for missing observations. To obtain quantitative estimates or to increase peptide identification rates over a series of experiments, LC/MS data analysis frameworks () rely on accurate mass and retention time alignment to propagate correspondence information between runs, experiments and samples. Accounting for LC distortions is a necessary prerequisite for such cross-experiment inference (). Although numerous pairwise alignment methods have been proposed, the question of simultaneous alignment of multiple datasets is still a particularly challenging task: as the number of potential correspondences grows exponentially, false initial multiple correspondence estimates are more likely, and estimation procedures for the associated warping functions need to be robust to potential outliers. Even more, in the light of practical application, multiple alignment methods should naturally cope with incomplete correspondences where peaks are only observed in a subset of runs and no obvious missing value imputation strategy is available. Types of LC/MS alignment algorithms: published alignment algorithms work on different representationseither peaks extracted from raw measurements or the raw measurements themselves (). This contribution focuses on the alignment of sparse sets of samples, i.e. peaks, which lie in a 3D feature space (ion mass-to-charge ratio, ion elution time and ion charge) as proposed in Cox and Mann (2008);. Existing approaches can be divided into three categories:(1) Alignment based on a static reference, where all observed measurements are aligned to a single reference peak list (). Because these approaches single out one measured reference run, they perform well if therePage: 988 987993
B.Voss et al.is at least one run of exceptional quality. Peaks that are not present in the reference cannot be used for alignment. This can be a substantial drawback, especially in low signal-tonoise ratio (SNR) situations or if suboptimal reproducibility is an issue.(2) Complete pairwise correspondence-based alignment, where the pairwise distances between all observed measurements in all runs yield pairwise alignments (). Based on these correspondence pairs, global correspondence groups are computed by iteratively linking similar peaks. Although this approach overcomes the single reference problem, it is computationally expensive since it requires the calculation of all similarity measurements between all extracted peaks and performs a retention time correction in each iteration.(3) Hierarchical progressive alignment, where a similarity measure based on peak distances determines the merging sequence between different peak lists (). The algorithm starts with an arbitrary (e.g. the most complete) list and subsequently merges the most similar lists until all correspondences are computed. Like in pairwise alignment, the retention times are corrected in each step that is suboptimal (). Few methods exist that work without a similarity measure (). In all categories, existing multiple alignment methods are straightforward extensions of pairwise alignments (). While some of them use heuristics to deal with peaks that are not present in all available peak lists, i.e. missing correspondences, others completely discard incomplete correspondence information. However, the probability that a peak is visible in all peak lists decreases with increasing numbers of runs that have to be aligned. Simultaneous correction of all peak lists is superior but rarely considered (). Simultaneous multiple LC/MS alignment: we propose SIMA, a novel approach that performs a single global retention time correction based on the multiple correspondence information obtained from all peak lists and naturally deals with missing correspondences. SIMA: (i) uses a pairwise greedy hierarchical strategy to determine all (potentially incomplete) correspondences across D peak lists (without performing a retention time correction in each step; Section 2.1); and then (ii) uses a kernel density estimation type non-parametric approach to simultaneously work on all correspondence groups and derive a D-dimensional retention time ridge. Its highest path is found by maximum likelihood estimation and approximates the global retention time distortion function that describes retention time shifts across all runs (Section 2.2). Finally, (iii) it uses this function to correct the individual peak lists for retention time shifts and optionally performs a second hierarchical correspondence estimation (Section 2.3). Step (ii) relies on a customized kernel that is inspired by signal maps () and that has specifically been tailored to make direct use of complete and incomplete correspondence information. The remainder of this contribution is organized as follows: Section 2 introduces the proposed workflow (see) and its mathematical framework. Section 3 describes the experimental setup and error statistics that is used to judge SIMA performance and Section 4 reports and discusses the outcomes. We end with conclusions in Section 5.
METHODS
Correspondence estimationThe correspondence estimation is based on: (i) a measure for estimating the distance of peaks from two different peak lists, (ii) an algorithm for establishing peak correspondence pairs based on this measure, (iii) a distance measure for quantifying the dissimilarity of two peak lists based on their peak correspondences and (iv) a hierarchical iteration scheme that successively combines the sparse individual peak lists into a more complete master peak list, while storing all established peak correspondences. Notation: let P = {P d },d = 1,...,D, be the set of the D LC/MS peak lists to be aligned. The d-th peak list P d comprises |P d | peaks,,i is described by its mass over charge position (m/z), retention time (rt) and charge state z. To simplify notation, we discard the index indicating the membership of a peak to a peak list throughout the remainder of the derivations. Scalars are printed in standard font and vectors in bold. Distance measure for peak correspondence estimation: the definition of an adequate peak distance measure is fundamental for identifying peak correspondences between different LC/MS runs. We quantify the distance between two peaks p i and p j by the diagonal thresholded squared Mahalanobis distance  given bywhere we define () =  for 0    1, () = for >1, and the weight matrix W as W = diag 1 (T 2 (m/z) ,T 2 (rt) ,T 2 z ). T (m/z) and T (rt) are userdefined threshold parameters for the upper bounds on (m/z) and (rt) shift tolerance. In practice, their choice depends on the measurement precision and is determined by the experimental instrument setup. Choosing very small values for T z disallows correspondences between peaks with different charge states (default). If reliable charge state information is not available, deviations in charge state may be allowed by using larger values for T z. Furthermore, W may easily be adapted to also take other features like intensity differences into account (cf. Supplementary Material A). In the 2D [(m/z),(rt)] domain, Equation (1) yields elliptical equidistance lines within the feasible area in which peaks may correspond to each other (cf. Supplementary Material B).
Page: 989 987993
Simultaneous Multiple Alignment of LC/MS DataEstablishing correspondence groups: given (,), the problem of finding correspondences between peaks from two peak lists P d and P e can efficiently be solved by an algorithm that is best known for solving the 'stable marriage' problem (). Initially designed for graph-matching problems, this method computes an optimal matching between elements from two disjunct sets, such that peak pairs with small distances are preferred. The resulting set F de contains all peak correspondences of P d and P e , that is each peak pair (i,j)  F de contains exactly one peak from both P d and P e. Note that the two peaks forming a pair may differ in (m/z), (rt), and z. Some peaks might not find a partner. Distance measure for peak list dissimilarity: given F de , the dissimilarityHierarchical correspondence estimation: rather than relying on one predetermined reference peak list for the alignment, we follow the idea ofand apply a greedy pairwise hierarchical iterative approach: This strategy eliminates the bias toward a single LC/MS run, which occurs when using a reference peak list in the correspondence estimation. Nonetheless, SIMA can also use a single reference peak list to compute multiple peak correspondences. This may be beneficial if one of the peak lists is a priori known to be correct. We successively combine the peak lists until all individual peak lists have been absorbed in one master peak list. In parallel, we construct correspondence groups, i.e. sets of peaks from the individual peak lists that match (see Supplementary Material C for details). Let P(t) be the set of peak lists that still have to be combined in iteration t. We initialize P(0) = P, that is with all original peak lists. During the course of the iterations, P(t) may contain both members of the set of original peak lists and/or representatives for previously combined lists. In each iteration, the two most similar peak lists according to Equation (2) are combined. Assume that in iteration step t these are P d  P(t) and P e  P(t). First, an empty peak list P de is created, and all peaks that are unique to either P d or P e are added to it. Then, all peak correspondences (i,j)  F de between P d and P e are considered, and one representative peak is added for each correspondence pair. Its (rt) and (m/z) values are set to the mean over the respective values of all peaks that in previous iterations have contributed to the two merging peaks. Finally, P d and P e are removed from P(t) and replaced by the combined peak list P de yielding P(t +1). The correspondence groups are updated accordingly. After D1 steps, all peak lists have been combined, i.e. |P(D1)|=1. We note that the greedy nature of the correspondence estimation allows for an efficient implementation. However, once merged, peaks cannot be split at later iterations, which may suggest that the respective peaks should rather be kept separate. This typically does not pose a practical problem, since by setting the thresholds in W the experimentalist can control the merging behavior of peaks. Let N be the number of resulting correspondence groups. After iteration D1, the retention times associated with the peaks in the N groups are stored in a retention time correspondence map C  R ND. More precisely, element c n,d of C holds the retention time of the peak in P d that is a member in correspondence group n. If no such peak exists, the respective entry is flagged to indicate a missing correspondence. Each row vector c n  R D ,n = 1,...,N, in C can be interpreted as a correspondence point in the D-dimensional retention time space (see Figs 4 and 6).
Maximum likelihood path estimationRetention time distortion function: define a master time scale (MTS) in the retention time space by equidistant sampling of the line of unit slope (that is the angle bisection line for D = 2). Further, define the retention time distortion function (RTDF) as the function that describes the retention time shifts for all peak lists. Its trajectory in retention time space thus explains the observed correspondence points c n ,n = 1,...,N. For a set of perfectly reproducible LC/MS measurements, all c n lie on the line of unit slope such that the RTDF is equivalent to the latter. In practice, however, retention time measurements are subject to correlated noise and non-linearly deviate from the ideal case. Given an estimate for the RTDF, the distortion of a peak can be identified by back-projecting its retention time onto the MTS (cf.). The behavior of the estimate should be in agreement with the fundamental physical properties of LC/MS. We argue that a suitable estimation procedure should: (i) yield a RTDF that features a certain degree of smoothness since we do not expect abrupt changes in the elution process, (ii) ensure that the RTDF is monotonous such that the elution order is preserved across runs (), (iii) be robust with respect to measurement errors and naturally deal with outliers that may originate from incorrect matches in the initial correspondence estimation and (iv) be independent of the input order of peak lists. We cast the problem of estimating the RTDF into a maximum likelihood (MFL) estimation framework, i.e. we find the RTDF as the function that best explains the correspondence points and at the same time fulfills the above constraints. To this end, we define a customized kernel that incorporates all prior assumptions. Its convolution with the (partially incomplete) observed peak correspondences yields a retention time ridge. The path along the highest points of this 'height profile', i.e. the maximum likelihood path, is the RTDF that describes the non-linear retention time distortions across the set of peak lists. Constructing a retention time ridge using a sigmoid kernel: whereas smoothness is guaranteed by employing a smooth kernel, the monotonicity of the ridge in retention times is more difficult to achieve. Figuratively speaking, the kernel (cf.) should induce two preferred areas (lower left, upper right) and two 'forbidden regions': when convolving it with all correspondence points in C, the response at a point x  R 2 merely depends on the contribution of correspondence points whose retention times are not both lower or both higher than the ones of x. This encourages the monotonicity of the ridge. Whereas, theoretically speaking, sets of correspondence points can be constructed that lead to paths that violate the monotonicity constraint, all point sets that can be considered a reasonable outcome of a set of LC/MS measurements yield a monotonous result. To make our approach more robust against measurement errors, an adaptive kernel parameter is used that controls the slope and hence the smoothness of the kernel and decreases the influence of outliers. Finally, our method is independent of the input order of the peak lists, since we use an equal kernel profile along all dimensions. By construction, all discussed properties carry over to the higher dimensions. More formally, let the kernel K : x  R D  (0,1) be an outer product of sigmoid functions k(x,) = 1/(1+e x ) whereHere, x d  R denotes the d-th component of x, and   R + is a parameter that controls the influence of the estimated correspondences in the retention time space (see). A higher value for  yields a steeper slope of the sigmoid function k(,) and thus increases the local influence of the kernel (see below). For an arbitrary point x  R D , we obtain the cumulative kernel response H with regard to all correspondence points c n with the convolutionwhere (c n ) is a weighting factor and = N n=1 (c n ). To deal with missing correspondences, we replace k(,) with the adapted versio k(,), given byk by byk(x d c n,d ,) = k(x d c n,d ,) if c n,d = 0 and 1 otherwise. In both cases, an analytical solution for the derivative H (x) exists (cf. Supplementary Material DF). The intuition behind the adaption is as follows: in case of missing Page: 990 987993with the sigmoid kernel (cf.). Also see movie 3 (Supplementary Material). correspondences, the correspondence points degenerate to correspondence hyperplanes (cf.). Although incomplete, these correspondences still constrain the RTDF in the orthogonal subspace within the retention time domain. We hence adapt the kernel to be uniform along the missing dimensions. This way, dimensions for which no correspondence information is available are simply ignored, whereas all other information is used whenever available. Here, we use equal weights for all correspondence points, that is (c n ) = 1 n = 1,...,N. However, different weighting schemes are possible (cf. Supplementary Material G). An exemplary retention time ridge is shown inand 4. ML-estimation of the retention time distortion function: using the sigmoidal kernel from above, the RTDF can be estimated by finding the points on the highest path through the retention time ridge that correspond to the time points of the MTS. We start with sampling a set of L equidistant points y l  R D ,l = 1,...,L from the line of unit slope that constitute the MTS, and perform L gradient ascents toward the retention time ridge, starting from each of the y l. Each gradient ascent is performed on a subspace of R D (cf.). These subspaces H l are hyperplanes perpendicular to the line of unit slope and contain the y l , that is, they are described by the normal vectorand support vectors y l. The gradient ascents yield L points x l  R D whose piecewise linear interpolation approximates the RTDF. Mathematically, this procedure is similar to a maximum likelihood (ML) estimation where K(x)  (0,1) acts as a prior and we determine the
B.Voss et al.Formulas for the normalized gradient directions along which we search for the maxima and for the update of the current estimate of x l in iteration t arederived in Supplementary Material D. We propose to use an adaptive step size for the gradient ascents based on the PowellWolfe conditions () for increased robustness (Supplementary Material F). Note that when performing the gradient ascents, our method never computes the retention time ridge in its entirety but only evaluates H(x) at a few points. Adaptive kernel bandwidth: naturally, the density of the correspondence points varies throughout retention time space. In such scenarios, the performance of non-parametric kernel methods can be improved by introducing an adaptive kernel bandwidth (). Thus, we locally adapt the kernel parameter  as follows: in low-density areas,  is set to low values to achieve a higher robustness and avoid artifacts in the RTDF caused by single observations. In areas of high density, the smoothness of the RTDF is reduced by using larger values for  (cf. Supplementary Material H). This trades off bias and variance and reduces the overall error compared with a non-adaptive scheme.
Retention time correctionAfter performing the L gradient ascents and subsequent linear interpolation, we obtain the piecewise linear RTDF which we use for correcting the retention times of the peaks observed in the D peak lists. Assume we want to correct the retention time for peakthe intersection of the RTDF with the hyperplane given by support vector a with a d = (rt) i and 0 elsewhere and normal vector a/||a||. We then identify that point on the line of unit slope that is closest to this intersection point (m 2 ). The distance of those two points in the d-th dimension constitutes the amount by which the retention time of p i needs to be corrected. The procedure is repeated for all peaks and all peak lists (see). Second correspondence estimation: correction of the retention times after the first iteration may give more correspondences. Hence, a second correspondence estimation (cf. Section 2.1) may yield a slightly more complete correspondence map C. However, practical impact is limited due to the overall robust nature of SIMA.
Page: 991 987993
Simultaneous Multiple Alignment of LC/MS Data
EXPERIMENTSReal-world data:compared a total of six alignment algorithms on four publicly available proteomics (P1, P2) and metabolomics (M1, M2) datasets, including msInspect (), MZmine (), OpenMS (), SpecArray (), XAlign () and XCMS (). In addition, Pluskal et al. recently proposed MZmine 2 with RANSAC aligner (). We obtained the proteomics datasets used byfrom the Open Proteomics Database (OPD) (). Dataset P1 originates from an Escherichia coli sample and contains two LC/MS runs of six fractions. Dataset P2 represents three LC/MS runs of five fractions of different cell states of Mycobacterium smegmatis. The datasets were analyzed by LC/MS/MS on an ESI ion trap mass spectrometer (ThermoFinnigan Dexa XP Plus), exported in centroid mode and preprocessed using TOPP tools () resulting in a peak list of (m/z) and (rt) positions, which served as input for all alignment procedures. Each run of a fraction contains between 400 and 5800 peaks.optimized parameters for all approaches on the first fraction of each dataset and generated a partial ground truth by linking MS/MS search results from SEQUEST to the LC/MS spectra. A detailed description of all steps and the parameterization of the algorithms is given in Supplementary Material I and (). For the metabolomics samples,analyzed Arabidopsis thaliana leaf tissue using an API QSTAR Pulsar i (Applied Biosystems/MDS Sciex) for the M1 dataset and a MicrOTOF-Q (Bruker Daltonics) for the M2 dataset resulting in 44 and 24 LC/MS spectra, respectively. Peaks were identified using XCMS () resulting in 4000 to 17 600 data points per LC/MS spectrum. They generated ground truth by identifying highly confident peak groups, which were reproducible over at least four runs and did not only have the same retention time, but also showed high correlation in their chromatographic peak shapes. Parameters were optimized on the complete datasets for all algorithms since no separate fractions were available. Even though SIMA can operate without a predetermined alignment order, it was run in the same starwise manner (i.e. using one predefined reference against which all remaining runs were aligned) that was used for the other algorithms and the ground truth generation in order to enable a fair comparison (Otherwise, SIMA might benefit from not using a potentially incomplete reference). Again we refer toand the Supplementary Materials for a detailed description and the parameterization of the algorithms. Performance measures: to measure the performance of an approach, we compute its precision (PR) and recall (RE). Precision is the fraction of correctly aligned peaks among all peaks aligned by one approach, PR = # correctly aligned peaks # aligned peaks , whereas recall corresponds to the fraction of correctly aligned peaks by one approach among all correct peaks according to the ground truth, RE = # correctly aligned peaks # correct peaks . To simplify comparison, we use the F-measure F = 2PRRE PR+RE , which summarizes precision and recall value by computing their harmonic mean ().
RESULTS AND DISCUSSIONSIMA yields competitive or superior results: in, the results of the comparison are detailed. With regard to recall, SIMA and MZ-mine 2 (RANSAC) tie at the best performance with an average recall of 0.90. While MZ-mine 2 (RANSAC) and OpenMS feature better recall values for the P1 and P2 datasets, SIMA shows better recall performance on the M1 and M2 data. With regard to precision, i.e. the likelihood of results being correct, SIMA shows the best performance in all datasets with an average precision value of 0.81. This is also reflected in the F-measure, which combines recall and precision. Here, SIMA shows the best overall performance with an average value of 0.85. SIMA always is among the best two methods with respect to the F-measure (P1, P2) or even performs best (M1, M2). A complete list of the results on all fractions of all datasets is given in Supplementary Material J. It is important to note that the comparison favors the algorithms that require a reference peak list: the ground truth generated byis based on the same reference run as used for the alignment. For independently generated ground truth, results for any reference spectrum-based approach are bound to deteriorate since not all peaks present in the ground truth necessarily need to be in the reference peak list. The performance measurements of hierarchical approaches such as SIMA are not affected by this kind of ground truth generation. SIMA is especially powerful when aligning numerous spectra:The strength of the SIMA approach is particularly visible on the metabolomics (M1 and M2) datasets. Here, it outperforms the other methods with regard to precision as well as recall. The metabolomics datasets contain more LC/MS spectra (44 and 24, respectively) than the proteomics datasets (2 and 3, respectively) and, thus, also show significantly more missing correspondences. Further, visual inspection confirms that these datasets are less perturbed by noise and show a more characteristic structure, which benefits more from the non-linear fitting of SIMA than the proteomics set, for which linear methods already show good results. Exploiting incomplete correspondence information is feasible: visual examples of SIMA alignment results are given inas well as in Supplementary Material K and movies 1 and 2.and movie 1 show an (m/z) 500800 subrange of the first three peak lists in the M1 dataset, in which 8 correspondence groups are complete, and incomplete information is available for an additional 14 groups (omitting single entry correspondence groups for visual clarity). The exploitation of partial correspondence groups yields Page: 992 987993Recall (RE), precision (PR) and the F-measure (F) are reported as an average over various runs on two proteomics (P1, P2) and two metabolomics (M1, M2) datasets as well as an overall average of all datasets (All). Bold print highlights the overall best values for each dataset. MZ-mine 2 (RANSAC) and SIMA show the best overall recall, while SIMA features the highest values for precision and the F-measure.peaks were additionally available in two of the three peak lists only. Since these peaks contain information for two dimensions, but are non-informative for the third, they are displayed by straight lines parallel to the coordinate axis of the missing information. The computed retention time distortion function (red) still benefits from these straight lines as they help pinpointing its optimal path through this area of few observations. valuable constraints for guiding the RTDF curve through retention time space and provides robustness in cases where single complete retention time observations show extreme values. The latter is especially prevalent with the obvious outliers present in the mass range (m/z) 8001100, as illustrated in Supplementary Material K and movie 2. SIMA uses all information available from the data by including missing correspondences and can thus base estimates on larger effective numbers of observations compared with other approaches (also cf. Supplementary Material K and L).
B.Voss et al.
Hierarchical correspondence estimation renders distinguished reference spectra obsolete: SIMA eliminatesthe problem of selecting a distinguished reference spectrum or peak list, respectively. In practical applications, obvious reference candidates are neither easily obtained nor guaranteed to exist. Consequently, SIMA-based alignment is not subject to a reference bias and independent of the peak list processing order. SIMA is robust with regard to parameter settings: considering that for the proteomics datasets the first fraction was used for parameter optimization, it is interesting to observe that SIMA is not performing as well as, e.g. OpenMS on these fractions. Still, SIMA shows superior performance on the remaining fractions, for which the parameters identified on the first sections were used (cf. Supplementary Material J). This indicates that SIMA is not overly dependent on parameter settings since it not only does benefit from the overfitting on the first fractions where parameters were adjusted to give optimal results, but also shows high-quality results on datasets where parameter optimization was not performed. This can at least partially be explained by the fact that (given reliable charge state information) SIMA only requires two parameters in the matrix W for correspondence estimation, which in our experiments have proven robust to changes. Choosing a larger region for the correspondence estimation results in additional random data points for the kernel regression. However, as long as those additional points are unstructured, they do not bias the estimate for the RTDF, since our approach is robust to outliers. Choosing a smaller region results in fewer data points and additional missing correspondences, which can be handled as long as not all data points of a region are removed.
CONCLUSIONWe introduced SIMA, a novel approach for the simultaneous alignment of multiple LC/MS peak lists. SIMA is specifically tailored to the problems arising from large-scale experiments where
The Author 2011. Published by Oxford University Press. All rights reserved. For Permissions, please email: journals.permissions@oup.com
at :: on August 30, 2016 http://bioinformatics.oxfordjournals.org/ Downloaded from
