Motivation: Correlation between life history or ecological traits and genomic features such as nucleotide or amino acid composition can be used for reconstructing the evolutionary history of the traits of interest along phylogenies. Thus far, however, such ancestral reconstructions have been done using simple linear regression approaches that do not account for phylogenetic inertia. These reconstructions could instead be seen as a genuine comparative regression problem, such as formalized by classical generalized least-square comparative methods , in which the trait of interest and the molecular predictor are represented as correlated Brownian characters coevolving along the phylogeny. Results: Here, a Bayesian sampler is introduced, representing an alternative and more efficient algorithmic solution to this comparative regression problem, compared with currently existing generalized least-square approaches. Technically, ancestral trait reconstruction based on a molecular predictor is shown to be formally equivalent to a phylogenetic Kalman filter problem, for which backward and forward recursions are developed and implemented in the context of a Markov chain Monte Carlo sampler. The comparative regression method results in more accurate reconstructions and a more faithful representation of uncertainty, compared with simple linear regression. Application to the reconstruction of the evolution of optimal growth temperature in Archaea, using GC composition in ribosomal RNA stems and amino acid composition of a sample of protein-coding genes, confirms previous findings, in particular, pointing to a hyperthermophilic ancestor for the kingdom. Availability and implementation: The program is freely available at www.phylobayes.org.
INTRODUCTIONThere is a growing interest in reconstructing the evolutionary history of quantitative traits along phylogenies using information coming from genetic sequences. In those cases where the evolution of genes or genomes is influenced by ecological or life history traits, the ancestral sequences, which can be reconstructed over the tree using phylogenetic methods, will contain useful information about ancestral values of the trait. One of the first applications of this idea was to the reconstruction of ancestral optimal growth temperatures based on ribosomal RNA (rRNA) nucleotide composition (), or amino acid composition of the proteome (), although in principle, the same idea could be applied to other cellular, ecological or morphological traits that would correlate with genetic sequences. In its original formulation, the sequence-trait correlation approach proceeds in several steps. First, the correlation between the trait and the molecular predictor (in the aforementioned example, the trait being temperature and the predictor rRNA or protein composition) is characterized in extant species. Typically, a regression analysis is conducted, yielding an estimate of the slope and the intercept of the linear regression of the trait against the predictor. Second, ancestral sequences, and thus ancestral values of the molecular predictor, are inferred using molecular phylogenetic methods. Finally, the values of the predictor inferred in the ancestors along the phylogeny are translated into estimates of ancestral traits, based on the regression. This approach is simple and straightforward to implement. One potential problem, however, is that it does not take into account phylogenetic inertia. In the present context, the phylogenetic structure underlying both the trait and the molecular predictor has at least two important consequences. First, the correlation measured in extant taxa between the trait and the molecular predictor should be corrected for the non-independence between data points (). Second, ancestral reconstructions could possibly benefit from the fact that inertia effectively induces an intertemporal smoothing of the reconstruction across neighboring nodes along the phylogeny. An alternative to the stepwise regression method would be to use a fully integrated comparative and phylogenetic approach, modeling the joint correlated evolution of the trait and the sequences and conditioning the resulting hierarchical model simultaneously on genetic sequences and quantitative data (). This would account not only for phylogenetic inertia but also for all sources of uncertainty associated with the unknown parameters of the model. However, in some cases, proceeding in a stepwise manner, dividing the problem into smaller and computationally more manageable tasks, can be more practical. Also, some interesting situations, in particular involving trait-dependent stabilizing selection on sequence composition, are not so easily modeled directly at the level of the substitution process, as they induce interdependence among sites of the alignment. A middle-ground solution, explored here, still relies on a preliminary estimation of ancestral sequence compositions along the tree using a phylogenetic program. Thus, ancestral composition is here treated as known and inferred separately from the model to be presented later in the text. On the other hand, the estimation of the correlation between composition and trait and the ancestral reconstruction of the trait are merged into one single step, explicitly formalized as a comparative regression problem. Similar models have been developed in the context of generalized least-square methods () and used for reconstructing, among other things, ancestral genome sizes of extinct lineages (). Once reconsidered in the context of the comparative method, the question is typically formulated in terms of a multivariate process jointly encompassing the trait of interest and the molecular predictor. Mathematically, a process Z(t) is defined, running along the branches of the phylogeny and combining the trait of interest X(t) and the molecular predictor Y(t). In the case of rRNA stems, X(t) would be the temperature, Y(t) some function of the GC content of RNA stems, so that Z(t) would be a bivariate process. In more general settings, both X(t) and Y(t) could themselves be multivariate. Under the Brownian assumption, the joint posterior distribution over the values of the trait X and the predictor Y over the phylogeny is multivariate normal and can be compactly represented using the Kronecker product formalism (e.g. as in). Conditioning this distribution on observed values for the trait and/or the predictor at the relevant nodes of the phylogeny can be done by maximum likelihood, using multivariate normal theory and matrix calculus () or in a Bayesian Markov chain Monte Carlo (MCMC) context, using standard MetropolisHastings algorithms (). Equivalently, standard multivariate normal theory allows for a reformulation of this model, such that the joint variation of the trait X and the predictor Y over the time interval t represented by a branch of the phylogenetic tree is written as follows:where t and t are normally distributed residual errors and B is a linear operator. This reformulation suggests a hierarchical structure in which a (partially) hidden state, the trait X, evolves along the phylogeny according to its own Brownian generator, effectively undergoing discrete-time transitions from one node of the tree (at time t) to the next (at time t  t) according to a multivariate normal kernel (the distribution of t ). Before each such transition, the process emits, along the branch just visited, an observable quantity, the predictor Yt  Yt  t  Yt, whose distribution linearly depends on the hidden states at both ends of the branch (through Xt  Xt  t  Xt). Based on the observed history of the predictor Y along the phylogeny and the observed values of X at the tips, the aim is to reconstruct the hidden evolutionary history of X. This reformulation suggests an analogy with hidden Markov models or, more specifically, as all distributions are normal, with what is known in particle filtering and tracking as the Kalman filter (). There are several differences between the classical Kalman filter and its phylogenetic counterpart introduced here. In particular, in the classical Kalman filter, the emitted state only depends on the current state, whereas in the phylogenetic model, the emitted state Yt depends on both the current and the previous hidden states. Also, the classical Kalman filter unfolds along a linear time frame, whereas the phylogenetic model is branched in time. However, these differences are minor and do not compromise the most important property of the Kalman filter, namely, its convenient analytical tractability, leading to simple and computationally efficient recursions for integrating and resampling hidden states along the phylogeny using dynamic programming methods and elementary matrix algebra. Importantly, such reconstructions will automatically integrate both the across-time smoothing effect between neighboring nodes for the trait X(t) and the additional information provided by the local behavior of the predictor Yt about the local evolution of the trait X(t). The Kalman approach introduced here and the generalized least-square approaches mentioned earlier in the text () are similar. The main difference is algorithmic, the Kalman filter having a globally lower algorithmic complexity than the algebraic and the MetropolisHastings approaches, as will be detailed later in the text. In this article, the phylogenetic Kalman filter is introduced and formalized. Backward and forward recursions are established and are used in the context of a Bayesian MCMC sampler, as a Gibbs sampling method for updating the X component of the model. This Gibbs sampling approach is then combined with another previously described conjugate Gibbs sampling algorithm for updating the correlation matrix (). The combination of the two algorithms results in an efficient alternating Gibbs strategy for sampling from the joint posterior distribution over the unknown parameters. Finally, the phylogenetic Kalman filter is applied to the reconstruction of ancestral growth temperatures in Archaea.
METHODS
ModelThe phylogenetic tree is here considered as known, with the topology and the branch lengths fixed throughout. The model assumes that a multivariate Brownian process Z(t) runs along the lineages of the phylogeny, splitting into two independent processes after each cladogenetic event. This process, of dimension M  L  K, has two subcomponents, X(t), of dimension L, representing the quantitative trait to be reconstructed along the phylogeny, and Y(t), of dimension K, representing the molecular predictor. For instance, X(t) can be thought of as being the optimal growth temperature (L  1) and Y(t) the GC content of the rRNA stems (K  1) or the suitably transformed amino acid composition of the proteome (K  19 degrees of freedom). As a Brownian process, Z(t) is parameterized by an M  M precision matrix. The precision matrix, which is the inverse of the covariance matrix, is used here for mathematical convenience, as it leads to easier computation in the context of the Kalman filtering recursion. The variation of Z over a finite amount of time t is normally distributed, with covariance proportional to t:The value of the process at the root, Z(0), is an independent parameter of the model. The predictor variable Y(t) is assumed to be known with certainty at each node of the tree (in practice, it is reconstructed using a phylogenetic method, see later in the text). As for the quantitative trait of interest X(t), it is known only at the tips (corresponding to extant taxa). A Wishart prior is used for , of parameter 0 and m  K  L degrees of freedom. The hyperparameter 0 is a diagonal matrix, which is partitioned according to the X and the Y components of the process:where I L and I K are the identity matrices of dimension L and K, respectively, and x and y are two hyperparameters, themselves endowed with an improper log-uniform prior. An improper uniform prior is used for X(0).
Markov chain Monte CarloMCMC sampling proceeds by alternating between updates of and updates of X. Updates of are done by Gibbs sampling, using the fact that the Wishart prior on is conjugate to the multivariate normal distribution (see). Updates of X are done either by MetropolisHastings (as in) or by Gibbs sampling, using a Kalman filter algorithm which is now described.
The Kalman filterThe subdivision of the process Z as a L-dimensional component X and a K-dimensional component Y leads to a natural block representation of :  xx xy yx yy ;Given an internal node n, its parent node is denoted as u (up), and its two daughter nodes are referred to as nodes l (left) and r (right). The root node is referred to as node 0. For a given node n, X n denotes the random variable representing the instant value of the trait at node n. If n is not the root node, and u is its parent, Y n denotes the variation in the value of the predictor between node u and node n, Z n the corresponding variation in the entire process Z and n stands for the inverse of the length of the branch leading from node u to node n. For any node n, D n refers to all of the data that are downstream to node n. The conditional likelihood at node n is defined as the probability density of the data downstream to node n (i.e. the values of x at the tips and the values of y at all nodes downstream to and including node n), conditional on the value taken by X n :or, for short:The conditional likelihood is not a probability density as a function of x n. On the other hand, as the process is Brownian, the conditional likelihood is a (possibly degenerate) multivariate Gaussian function, entirely characterized, up to a multiplicative constant, by its mean n and its precision matrix K n :The multiplicative constant is not needed here, where the interest is in sampling from the posterior distribution, not in computing the marginal likelihood. The Kalman filtering algorithm proceeds in two steps: a backward and a forward recursion. The backward recursion proceeds from the tips to the root. Its aim is to compute the conditional likelihoods at all nodes. This is done recursively, by expressing, for each node n, the conditional likelihood L n x n  as a function of the conditional likelihoods of the left and right descendants, L l x l  and L r x r . Because these conditional likelihoods are Gaussian, this is equivalent to expressing the mean n and the precision K n in terms of l , r , K l and K r. Next, the forward recursion proceeds from the root to the tips. Its aim is to recursively sample the values of X at all ancestral nodes from the joint posterior distribution. This is done by first sampling the value X 0 at the root. Then, once X n has been sampled at node n, X l and X r are sampled from their conditional posterior distribution pX l  x l jX n  x n , D l  and pX r  x r jX n  x n , D r , until the recursion has proceeded down to the tips of the tree. Therefore, the calculation is analogous to what is done for mapping ancestral states along phylogenies (). The backward recursion more specifically corresponds to the so-called pruning algorithm for computing the likelihood under a finite state Markov substitution process (), with the only difference that discrete sums are replaced by continuous integrals. The algebra is detailed in the Supplementary Material. The essential steps are now summarized. First proceeding with the backward recursion and using the Markov property, the conditional likelihood at node n can be expressed as a product of the probabilities of D l and D r , which are independent given X n :Considering only the left component (similar results holding for the right node by symmetry), pD l jX n  x n  is an integral over all possible values of X l :abbreviated as follows:The finite-time probability of transition along the branch going from node n to node l, pX l  x l jX n  x n , is Gaussian. To characterize its moments, one can observe that the variation undergone by Z(t) along the branch leading from node n to node l follows a normal distribution:By standard multivariate normal theory, this implies that:This gives the probability density of going from x n to x l along the branch going from node n to node l:Second, multiplying pD l jX l  x l  and pX l  x l jX n  x n  yields the joint probability pD l , X l  x l jX n  x n , which, after some algebra, can be rearranged as follows:The backward recursion is initiated at the tips by setting l  x l  m l and M l  l xx , if x l is observed. Otherwise, if information about x l is missing, l and M l can be set to 0 (the conditional likelihood, being flat, can be seen as the limit of a multivariate normal of vanishing precision and undefined mean). The forward recursion starts from the root (node 0). By Bayes theorem:that is, the posterior is proportional to the conditional likelihood, as the prior on x 0 is uniform. Therefore, X 0 can be sampled from its normal conditional posterior: X 0 jD $ N 0 , K 1 0 : Once the value X n of the trait has been sampled for a given internal node n, then if node l is also internal, X l can be sampled from its conditional posterior which, according to the above derivation], is given by:The same formula can be applied by symmetry to node r, and the forward recursion can thus proceed down to the tips of the tree. The overall algorithm has a complexity linear in the number of taxa N. In addition, as each step of the recursion involves products of matrices of dimension L or K and inversion of matrices of dimension L, the complexity scales as K 2 L 3 N. As mentioned in the introduction, the problem can also be formalized by calculating the mean vector and the covariance matrix of the joint posterior distribution of the values of the trait X over the phylogeny, which is multivariate normal (). However, sampling from this joint posterior distribution, or even maximizing the likelihood, entails matrix calculation such as inversion or Cholesky decomposition on the covariance matrix, which is here of dimension NL  K  NL  K. Therefore, the complexity of this direct approach scales as N 3 L  K 3 , making the Kalman filtering approach a more attractive alternative, at least in a Bayesian context. In addition to X and , the model has two hyperparameters, x and y. These two parameters are resampled from the conditional posterior distribution by standard MetropolisHastings. Therefore, the overall schedule consists of one call to the Kalman filter algorithm, followed by one call to the conjugate Gibbs resampling method on , followed by a series of five updates of x and y. The chains are run for at least 100 000 cycles, saving one every 10 points. Two independent chains are run under each condition. Convergence is first checked visually and then quantitatively assessed using the tracecomp program in the PhyloBayes package (). The tracecomp program estimates the effective sample size and the overlap between the two independent chains. In practice, all effective sample sizes were found to be41000.
Calculating ancestral compositionsThe two datasets analyzed in this study, previously introduced in Groussin and Gouy (2011), were kindly provided by the authors. Bayesian phylogenetic inference was conducted using a site-and timeheterogeneous model implemented in PhyloBayes (), corresponding to the branchwise version of the model presented in Blanquart and Lartillot (2008). Specifically, across sites, the model is a Dirichlet process mixture of F81 processes (), with the equilibrium frequencies of this mixture of process jointly modulated across branches by introducing branch-specific modulating profiles, independently drawn from a hyperparameterized Dirichlet distribution (). Chains were run for 11 000 points, saving one every 10 points and excluding a burn-in of 1000 points. All runs were duplicated. For a subset or 1000 regularly spaced points obtained from the MCMC sample produced by PhyloBayes, ancestral sequences were reconstructed by stochastic mapping (), and the corresponding ancestral compositions at each node were computed. Ancestral compositions were averaged over the 1000 points sampled by MCMC and were used as an input for the phylogenetic covariance analysis. Alternatively, as a way of taking into account uncertainty about ancestral reconstructions, ancestral compositions were computed and saved separately for each of a subset of 100 points from the MCMC sample. Each set of ancestral compositions thereby produced was used as a separate dataset in the downstream phylogenetic covariance analysis, and the resulting MCMC samples were pooled, thus representing a sample from a mixture of 100 posterior distributions. The analyses under PhyloBayes were conducted on the complete alignment of the 45 archaeal and eubacterial sequences. In a second step, only the compositions corresponding to the subtree spanned by the 33 archeal species were considered for the phylogenetic covariance analysis. Thus, eubacteria are only used here for polarizing the reconstruction of ancestral compositions, whereas the covariance analysis is restricted to Archaea. Before being used in the phylogenetic covariance analysis, the ancestral compositions were log-transformed as follows. In the case of rRNA, the logit transform of the GC content was used as the molecular predictor y. Thus, if q is the GC content of the ancestral sequence reconstructed at a given node, then the corresponding value of the molecular predictor is defined to be as follows:This change of variable maps the unit interval onto the real line. In the case of proteins, ancestral compositions were first log-transformed and offset so as to sum to 0. Thus, if   a  a1::20 , P a a  1 is the amino acid composition at a given point of time, the following variable is defined as follows:The resulting 20-dimensional vector can be assumed to evolve according to a Brownian motion constrained to live within the 19-dimensional hyperplane defined by H  f, P a a  0g. To deal with this additional linear restriction, an orthonormal basis of the 20-dimensional space is introduced, V  v ab  1 a, b 20 , such that its first vector v 1 is the unit vector orthogonal to H:The 19 remaining vectors of the basis are determined randomly using the GramSchmidt process method. The incomplete basis P  v k  k2::20 is then a basis of the H subspace. Expressing the ancestral log compositions in this basis requires to operate a linear change of variable on , resulting in a 19-dimensional predictor:The model induced by Equation(14) is independent of the choice of the basis P. It is also invariant by permutation of the 20 amino acids. This is because the prior over the generator of the Brownian motion (the Wishart of parameter 0 ) is invariant by rotation in the Y subspace. Although the log transformation proposed here is convenient, other transformations could also be considered based on more mechanistic derivations. Alternatively, this aspect of the model could be addressed using non-parametric approaches for estimating the transformation.
RESULTS
MCMC mixingThe Gibbs sampler based on the Kalman filter, hereafter called the KalmanGibbs sampler, was tested against a more classical MetropolisHastings sampling method. As expected, both samplers give indistinguishable confidence intervals (). However, the Gibbs algorithm appears to be faster and more efficient than classical MetropolisHastings under all conditions. The improvement over the MetropolisHastings sampler is moderate for low-dimensional problems (L  1). On the other hand, the advantage of using the KalmanGibbs sampler over the MetropolisHastings alternative is overwhelming for higher dimensional traits (L  10), for which a dense sample from the posterior distribution is obtained within a few hours using the KalmanGibbs sampler, whereas several days would be needed with the MetropolisHastings algorithm to obtain an equivalent effective sample size.
Accuracy and confidenceThe simplest alternative to the comparative method is to perform a simple linear regression between the predictor and the trait in extant species. The estimated slope and intercept can then be used to predict the value of the trait based on the value of the predictor in the ancestors. This linear regression method has been used in previously published reconstructions (). To compare its performance with that of the KalmanGibbs sampler, simulation experiments were conducted, using the archaeal dataset used below (33 taxa) as a template, a 2D model (with one predictor and one quantitative trait) and under four configurations of the precision matrix , with the correlation coefficient between the predictor and the trait ranging from 0.35 to 0.95. Compared with the linear regression method, the Kalman Gibbs sampler results in more accurate ancestral reconstructions (). The root mean squared errors (RMSE) under the KalmanGibbs sampler are approximately twice as small as those incurred under the linear regression method (). In both cases, RMSE are globally smaller when the correlation between the trait and the predictor is strong, indicating that reconstructions are then expected to be globally robust to the methodological details.KGPS), adding $2 C to the width of intervals that typically encompass 20 C. Therefore, the uncertainty associated with the ancestral reconstruction is primarily caused by the errors associated with the regression, i.e. incompletely known correlation between temperature and composition, as well as the residual errors. The confidence intervals reported in the original analysis of these data (,, LRMLBP), as well as in a previous similar work (), were obtained by bootstrapping the multiple sequence alignment. For each bootstrap replicate, ancestral compositions were reestimated, followed by a reestimation of the
A B
DISCUSSION AND CONCLUSIONIn this article, a computationally efficient method is introduced for comparative regression analysis and reconstruction of quantitative traits along phylogenies using ancestral information provided by other traits or molecular sequences. The method fully accounts for the comparative structure of the problem and integrates the two dimensions over which correlations arise: first, between molecular predictors and the predicted trait, and second, among ancestors, owing to their shared phylogenetic ancestry. These two orthogonal dependencies make the problem equivalent to a hidden Markov model, and the method is thus. Reconstructed evolution of the optimal growth temperature (as estimated by the posterior mean) along the phylogeny of Archaea using the KalmanGibbs algorithm applied to the rRNA dataset similar to a Kalman filtering approach embedded in a Bayesian MCMC sampler. The underlying statistical framework is similar to the one assumed by classical generalized least-square approaches to this problem (
The Author 2013. Published by Oxford University Press. All rights reserved. For Permissions, please e-mail: journals.permissions@oup.com at :: on August 30, 2016 http://bioinformatics.oxfordjournals.org/ Downloaded from
at :: on August 30, 2016 http://bioinformatics.oxfordjournals.org/ Downloaded from
N.Lartillot at :: on August 30, 2016 http://bioinformatics.oxfordjournals.org/ Downloaded from
A phylogenetic Kalman filter at :: on August 30, 2016 http://bioinformatics.oxfordjournals.org/ Downloaded from
N.Lartillot at :: on August 30, 2016 http://bioinformatics.oxfordjournals.org/ Downloaded from In this simulation experiment, the predictor is assumed to be known without error for all ancestors along the phylogeny, which leaves two remaining sources of uncertainty about the estimated ancestral traits. First, there is only a finite number of data points and therefore the regression between the predictor and the trait is imperfectly estimated. Second, the correlation coefficient is 51, and therefore, even if the parameters of the regression were perfectly known, there would nevertheless be some residual uncertainty about the value of the predicted traits. Both sources of uncertainty are integrated in the credible intervals produced by the KalmanGibbs sampler, as well as by the prediction intervals constructed by standard linear regression methods, such as implemented in R (R Development Core Team, 2001). Although, in general, Bayesian credible intervals do not have exact frequentist coverage for finite sample size, in the present case, the average frequentist coverage of the credible intervals returned by the KalmanGibbs sampler is close to 95% (Table 2). On the other hand, the disparity observed across individual ancestors is larger than expected with an average of 6 of 32 ancestors displaying a coverage of 92% or less (P510 5 ), and a minimum observed coverage across all experiments of 87%. The prediction intervals of the linear regression approach appear to be conservative, with an average coverage499%. However, this globally conservative behavior hides a large disparity across ancestors, with individual ancestors displaying a coverage of 92% or less430% of the time (i.e. for 510 of the 32 ancestors, Table 2), and a minimum observed coverage of 75%, thus pointing to underestimation of the uncertainty associated with specific nodes along the phylogeny. Importantly, the prediction intervals returned by the linear regression method are approximately three times as large as the credible intervals proposed by the KalmanGibbs sampler (Table 2). Excessively large prediction intervals result in low power when it comes to testing alternative biological hypotheses (such as deciding between a mesophilic or a thermophilic ancestor for Archaea, as in the example shown later in the text). Interestingly, the width of the Bayesian credible intervals depends on the exact position of the ancestral node of interest along the phylogeny, with nodes that are closer to the tips having narrower credible intervals than nodes closer to the root (Fig. 1B). This reflects the fact that the model-based comparative approach implemented by the KalmanGibbs sampler performs a contextdependent integration of all available sources of information. In the present case, for recent ancestors, information about the value of the trait in nearby extant species is combined with the information contained in the local value of the molecular predictor, thus leading to more precise estimates of the trait. In contrast, information coming from nearby nodes is ignored by the linear regression method, which therefore tends to yield uniformly wide confidence intervals over all ancestors, irrespective of their age. Altogether, compared with a simple linear regression method, the explicit comparative approach adopted here results in more accurate reconstructions, combined with a more flexible and more efficient estimation of the associated uncertainty. 3.3 Application to the reconstruction of ancestral temperatures in Archaea The KalmanGibbs sampler was applied to the reconstruction of ancestral optimal growth temperatures in Archaea, using a previously published dataset (Groussin and Gouy, 2011). The data consist of two alignments, of rRNA stems and of amino acid recoded protein sequences, for the same set of 33 Archaea and an outgroup of 12 eubacteria. Using these data, ancestral compositions at each node of the phylogeny were first estimated using site-and time-heterogeneous models of sequence evolution and then used, after adequate transformation, as predictors for reconstructing ancestral growth temperatures (see Section 2). The reconstruction based on the rRNA dataset (point estimates in Fig. 2, credibility intervals for several key ancestors in Table 3, line KG-PM) yields a hyperthermophilic ancestor for Archaea, with an optimal growth temperature of about 100 C (CI from 90110). From there, the growth temperature remains approximately stable, although slightly decreasing, in Crenarchaea and Koarchaea (the latter represented by Candidatus), while decreasing down to moderate temperatures in Thaumarchaea and most Euryarchaea, except in the three hyperthermophilic species Nanoarchaeum, Thermococcus and Pyrococcus. The optimal growth temperature of the ancestor of Archaea is higher than that of all extant species. In contrast, a reconstruction using a simple univariate Brownian motion (Supplementary Fig. S1, Table 3, line BM), thus not integrating information from the reconstructed evolution of rRNA sequences, results in a nonhyperthermophilic ancestor, with a growth temperature between 60 and 96 C, thus intermediate between the mesophilic and the hyperthermophilic extant species. This experiment demonstrates that molecular information can make an important difference for estimating ancestral traits. The ancestral reconstruction displayed in Figure 1 is globally similar to the one previously published (confidence intervals reported in Table 3, line LRMLBP). Slightly higher temperatures are obtained here, although with 450% of overlap between the confidence intervals of the two studies. The correlation between GC content in rRNA stems and temperature is strong (R  0:89), which may explain the robustness of the results. The results just presented are based on point estimates of ancestral compositions, such as obtained from a separate Bayesian phylogenetic sampler (see Section 2). Therefore, the resulting credible intervals ignore the uncertainty about ancestral compositions. As a way of including this latter source of uncertainty, a set of 100 ancestral compositions were drawn from the posterior distribution under the non-homogeneous phylogenetic model, and the KalmanGibbs sampler was separately applied to each of these 100 datasets. The resulting MCMC samples were pooled and credible intervals were computed based on this pooled sample. These credible intervals now combine all sources of error, caused by the imperfect estimation of ancestral compositions, the incompletely known correlation between GC content and temperature and the residual error associated with the regression. This two-step approach is not ideal, suffering from a conceptual incoherence in that ancestral compositions are first inferred under the prior of the non-homogeneous substitution model and then assumed to evolve according to a Brownian prior. Nevertheless, it should work reasonably well in practice, as long as the prior distributions are sufficiently diffused compared with the posterior distribution. In the present case, the ancestral compositions appear to contribute a small proportion of the total uncertainty (Table 3,
ancestral temperatures. A conceptual problem with this bootstrap method is that it results in theoretically vanishing confidence intervals for large alignment, and this, even if the number of taxa remains constant. Yet, although arbitrarily large alignment may result in asymptotically consistent estimates of ancestral compositions, if the number of taxa is constant and the correlation is not perfect, uncertainty about ancestral traits should normally remain finite, even asymptotically. The uncertainty missed by the bootstrap method is that about the correlation between the trait and the predictor (both the residual error and the error on the parameters of the regression). This suggests that, instead of pooling the point estimates obtained over the bootstrap replicates, one could instead combine the prediction intervals separately calculated using standard linear regression methods on each replicate. However, this would result in fairly large confidence intervals. The prediction intervals based on the posterior mean ancestral reconstructions (Table 3, LRML), thus not taking into account uncertainty about ancestral compositions, already encompass nearly 40 C. Combining these intervals with the bootstrap contribution would amount to a total uncertainty spanning an interval of $5060 C. In contrast, the Bayesian method yields intervals spanning $30 C. The ancestral reconstruction of temperatures obtained with the protein sequence data (Supplementary Fig. S2 and Table 310, KGPM) is similar to the one obtained using rRNA stem sequences (Fig. 1 and Table 3). In particular, the archaebacterial ancestor is again inferred to be hyperthermophilic, although with a larger uncertainty (between 86 and 121 C). The uncertainty about ancestral compositions also appears to be larger in the case of proteins, contributing for an additional 5 C of uncertainty about the ancestral temperature (Table 3, KGPS). The overall congruence between the two molecular predictors (Fig. 1 and Supplementary Fig. S2), despite the different underlying data and selective forces, is reassuring. There is a difference here with the previously published analysis, which tended to infer a lower ancestral growth temperature for the ancestor of Archaea with protein data, compared with what was obtained using the rRNA dataset (Groussin and Gouy, 2011, Table 3, LRML). Reanalyzing the ancestral compositions inferred in this previous study with the KalmanGibbs sampler also results in an lower inferred ancestral growth temperature (Table 3, KGML), thus suggesting that the observed difference is due to the differing methods used here and in the previous study for inferring ancestral compositions, and not to the differing approaches for translating ancestral compositions into optimal growth temperatures.
). The main difference is algorithmic, the Kalman filtering approach having a good overall scaling, in particular with respect to the number of taxa, for which it is linear. The derivation conducted here is in terms of an observed predictor Y conditional on a hidden trait X. Alternatively, and equivalently in the present case, the problem could have been more directly formulated as a regression of X onto a non-random y. Doing so would have the advantage of not making any assumption about the process followed by Y and would avoid the inconsistencies created by reconstructing y separately from the model. On the other hand, it would have a less natural interpretation in terms of the underlying processes. In the present case, the trait (temperature) influences the molecular variable (composition), and therefore a hidden trait model appears to be more adequate. A hidden trait approach will also more easily generalize to more complex mechanistic models that would for instance include some elasticity, and therefore some delay, in the response of the molecular predictor to changes in the value of the trait. Several ancestral reconstructions based on molecular predictors published thus far have been performed using simple linear regression methods that do not fully integrate the comparative dimension of the question. In practice, the simulations and the empirical analyses reported here suggest that, although such simple regression approaches are less principled and less accurate than explicitly comparative methods, they nevertheless lead to reasonable point estimation of ancestral traits, at least when the correlation between the trait and the predictor is strong. In particular, the present analysis mostly confirms previous reports about the evolution of growth temperature in Archaea (Groussin and Gouy, 2011). A more fundamental weakness of non-comparative approaches to ancestral reconstructions, however, is that they do not appear to offer a reasonable measure of statistical confidence. Assessing confidence is often the most problematic question in a comparative context, owing to the complex array of dependencies created by phylogenetic inertia. In such situations, simple approaches based on classical linear regression will generally fail to capture the context-dependent modulations of estimation error (as illustrated in Fig. 1B). Alternative methods based on sampling theory, such as the non-parametric bootstrap (Efron, 1979), although attractive at first sight owing to their simplicity and their robustness, do not address all sources of uncertainty. In particular, resampling approaches applied across sites will not capture the residual error about ancestral traits even granting perfect knowledge of ancestral proteome compositions, or the error resulting from the finite number of taxa. In the comparative approach, in contrast, the uncertainty represented in the posterior credible intervals does take into account both the finite number of independent contrasts and the residual error of the correlation between the trait and the predictor. As for the uncertainty about the ancestral compositions, it is here accounted for only indirectly, via a two-step MCMC approach. On the other hand, such a flexible integration of multiple levels of information comes at a cost: the method, at least in its present state, is dependent on the Brownian assumption. The Brownian hypothesis has repeatedly shown to be violated (Lartillot and Delsuc, 2012; Oakley and Cunningham, 2000). In the present case, the systematic trend in decreasing growth temperature observed along the archaeal phylogeny (Fig. 1) is clearly a symptom of a violation of the undirected Brownian assumption. Apart from systematic trends, punctuated evolution is another potential violation deserving further consideration. The method introduced here could easily be adapted so as to include directional trends in the Brownian process, in a way that would preserve the analytical properties underlying the Kalman filtering algorithm. More general processes, potentially including jumps or large deviations (Landis et al., 2013) could also be considered, although the analytical facilities offered by the multivariate normal distribution would then most probably be compromised. More intensive but more general numerical integration methods would then have to be recruited as an alternative to the Kalman filter.
