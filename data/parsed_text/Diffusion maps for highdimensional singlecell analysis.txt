Motivation: Single-cell technologies have recently gained popularity in cellular differentiation studies regarding their ability to resolve potential heterogeneities in cell populations. Analyzing such high-dimensional single-cell data has its own statistical and computational challenges. Popular multi-variate approaches are based on data normalization, followed by dimension reduction and clustering to identify subgroups. However, in the case of cellular differentiation, we would not expect clear clusters to be present but instead expect the cells to follow continuous branching lineages. Results: Here, we propose the use of diffusion maps to deal with the problem of defining differentiation trajectories. We adapt this method to single-cell data by adequate choice of kernel width and inclusion of uncertainties or missing measurement values, which enables the establishment of a pseudotemporal ordering of single cells in a high-dimensional gene expression space. We expect this output to reflect cell differentiation trajectories, where the data originates from intrinsic diffusion-like dynamics. Starting from a pluripotent stage, cells move smoothly within the tran-scriptional landscape towards more differentiated states with some stochasticity along their path. We demonstrate the robustness of our method with respect to extrinsic noise (e.g. measurement noise) and sampling density heterogeneities on simulated toy data as well as two single-cell quantitative polymerase chain reaction datasets (i.e. mouse haematopoietic stem cells and mouse embryonic stem cells) and an RNA-Seq data of human pre-implantation embryos. We show that diffusion maps perform considerably better than Principal Component Analysis and are advantageous over other techniques for non-linear dimension reduction such as t-distributed Stochastic Neighbour Embedding for preserving the global structures and pseudotemporal ordering of cells. Availability and implementation: The Matlab implementation of diffusion maps for single-cell data is available at https://www.helmholtz-muenchen.de/
IntroductionThe advantages of single-cell measurements to various biological research fields have become obvious in recent years. One example is the stem cell studies for which population measurements fail to reveal the properties of the heterogeneous population of cells at various stages of development. Purifying for a certain cell type or synchronizing cells is experimentally challenging. Moreover, stem cell populations that have been functionally characterized often showheterogeneity in their cellular and molecular properties (). To overcome these barriers, on the one hand researchers conduct continuous single-cell observation using time-lapse microscopy (), accompanied by single-cell tracking and analysis tools. However, this approach is still limited as the expression of very few genes (typically one to three) could be observed. On the other hand, with the advent of new technologies, such as single-cell qPCR () or RNA-Seq () and flow or mass cytometry (), it is now possible to measure hundreds to thousands of genes from thousands of single cells at different specific experimental time points (time-course experiments). However, several single cells measured at the same experimental time point may be at different developmental stages. Therefore, there is a need for computational methods which resolve the hidden temporal order that reflects the ordering of developmental stages of differentiating cells. While differentiation has to be regarded as a non-linear continuous process (), standard methods used for the analysis of high-dimensional gene expression data are either based on linear methods such as principal component analysis (PCA) and independent components analysis (ICA) [e.g. used as part of the monocle algorithm (or they use clustering techniques that groups cells according to specific properties. Hierarchical clustering methods as used in SPADE () and t-SNE (Van der) as used in viSNE () are examples of clustering methods. However, as these methods are designed to detect discrete subpopulations, they usually do not preserve the continuous trajectories of differentiation data. A more recently proposed algorithm Wanderlust () incorporates the nonlinearity and continuity concepts but provides a pseudotemporal ordering of cells only if the data comprise a single branch. Furthermore, in gene expression measurement techniques, there is usually a detection limit at which lower expression levels and nonexpressed genes are all reported at the same value.suggested the use of a censoring noise model for PCA, whereas for the other methods it is unclear how these uncertain or missing values are to be treated. A variety of other manifold learning methods including (Hessian) locally linear embedding (HLLE) () and Isomap () exist in the machine-learning community and are discussed in detail in the discussion and conclusion section. Here, we propose diffusion maps () as a tool for analyzing single-cell differentiation data. Diffusion maps use a distance metric (usually referred to as diffusion distance) conceptually relevant to how differentiation data is generated biologically, as cells follow noisy diffusion-like dynamics in the course of taking several differentiation lineage paths. Diffusion maps preserve the nonlinear structure of data as a continuum and are robust to noise. Furthermore, with density normalization, diffusion maps are resistant to sampling density heterogeneities and can capture rare as well as abundant populations. As a non-linear dimension-reduction tool, diffusion maps can be applied on single-cell omics data to perform dimension-reduction and ordering of cells along the differentiation path in a single step, thus providing insight to the dynamics of differentiation (or any other concept with continuous dynamics). In this article, we @BULLET propose an adaptation of diffusion maps for the analysis of single-cell data which is less affected by sampling density heterogeneities and addresses the issues relating to missing values and uncertainties of measurement, @BULLET propose a criterion for selecting the scale parameter in a diffusion map, @BULLET evaluate the performance of the diffusion map and its robustness to noise and density heterogeneities using a toy model that mimics the dynamics of differentiation, @BULLET apply the adapted diffusion map algorithm to two typical qPCR and one RNA-Seq datasets and show that it captures the differentiation dynamics more accurately than other algorithms.
Methods
Diffusion mapsLet n be the number of cells and let G be the number of genes measured for each cell. Denote the set of all measured cells by X. We allow each cell x to diffuse around its measured position x 2 R G through an isotropic Gaussian wave function,The normalization of Y x x 0  is such that  1 1 Y 2 x x 0 dx 0  1. The Gaussian width r 2 determines the length scale over which each cell can randomly diffuse. The transition probability from cell x to cell y is then defined by the interference of the two wave functions Y x and Y y. One can easily show that this interference product is another Gaussian (all prefactors cancel out):Hence, we can construct the n  n Markovian transition probability matrix P for all pairs of cells in X as follows:At the position of each cell, Zx is the partition function which provides an estimate of the number of neighbours of x in a certain volume defined by r. Hence, it can be interpreted as the density of cells at that proximity. Consequently, we redefine the density normalized transition probability matrix ~ P as:Because we are only interested in the transition probabilities between cells and not the on-cell potentials imposed by local densities, we set the diagonal of ~ P to zero and exclude y  x from the sum in the partition function ~ Z. For a large enough r, the matrix ~ P defines an ergodic Markovian diffusion process on the data and has n ordered eigenvalues k 0  1 > k 1 !:::!k n1 with corresponding right eigenvectors w 0 :::w n1. The t-th power of ~ P will present the transition probabilities between cells in a diffusion (random walk) process of length t. Noting that ~ P t has the same eigenvectors as ~ P, one can show that this transition probability can be represented as follows:Each row of ~ P t can be viewed as a vector, which we represent as p t x;  and consider as the feature representation (Shawe) for each cell x. By computing the weighted L 2 distance in the feature space, the diffusion distance D 2 t between two cells x and y is defined as follows:This diffusion distance can be expressed in terms of the eigenvectors of ~ P such that:The corresponding eigenvector to the largest eigenvalue k 0 is a constant vector w 0  1. Therefore, it only contributes a zero term to D 2 t and is excluded from the spectral decomposition of D 2 t in Equation (9). That means the Euclidean distance of the cells in the firstleigenvector space represents an approximation of their diffusion distance D 2 t. Moreover, the eigenvalues of ~ P determine the diffusion coefficients in the direction of the corresponding eigenvector. As real data usually lie on a lower dimensional manifold than the entire dimensions of space G, these diffusion coefficients drop to a noise level other than a few first (l) prominent directions. Therefore, if there is a significant gap between the l-th and l  1-th eigenvalue, the sum up to the l-th term usually determines a good approximation for diffusion distances. Thus, for data visualization we select these eigenvectors and instead of the mathematical notation w, we call them diffusion components (DCs).presents a summary of diffusion map embedding. Each cell is represented by a Gaussian wave function in the Gdimensional gene space. On an adequate Gaussian width, the wave functions of neighbouring cells interfere with each other and form the diffusion paths along the (non-linear) data manifold in the highdimensional space. Hence, we construct the Markovian transition probability matrix, the elements of which are the transition probabilities between all pairs of cells. The eigenfunctions of the Markovian transition probability matrix (DC1 and DC2) are then used for low-dimensional representation and visualization of data.
Accounting for missing and uncertain valuesThe data generated from qPCR, RNA-Seq or cytometry experiments are very often prone to imperfections such as missing values or detection limit thresholds. It is important to properly treat such uncertainties of data (). Our probabilistic interpretation of diffusion maps allows a straightforward mechanism of handling missing and uncertain data measurements. First, we have to decompose the kernel into G components. Then, instead of a Gaussian, we can use any other wave function that best represents our prior knowledge on the probability distribution of the missing or uncertain values, which then should be square-normalized to ensure equal contribution of the G components. For example, for missing values and non-detects (measurements below the limit of detection), one might choose a uniform distribution over the whole range of possible values. In the following, we describe how to account for the uncertainty of non-detect measurements in qPCR data. The statistical subtleties of non-detect values in qPCR experiments have been systematically studied byfor univariate models. In addition, for a multivariate PCA analysis,proposed that different kernels be allowed in each dimension. For the diffusion map implementation, we assume any value between the detection limit (M 0 ) and a completely non-expressed (off) state of genes valued as M 1 , is equally possible for the non-detect measurements. Considering the kernel width formulated in the diffusion map wave functions, we assume an indicator wave function between M 0  r and M 1  r normalized by M 1  M 0  2r 1=2. Thus, we have to calculate three different kinds of interference of wave functions: The interference of two cells with definite measured values for gene g is the standard Gaussian kernel (see Section 2.1):the interference of two cells both with non-detect values for gene g is 1 (due to the square-normalization constraint):) which correspond to the largest diffusion coefficients of the data manifold. The embedding shows the continuous flow of cells across four cell types; however, it does not suggest the putative time direction the interference of a missing (non-detect) value to a definite measured value x g is:For data with missing or uncertain values, we need to check the pairwise interference of the wave functions for each gene. The computation time is thus proportional to the number of genes G for a fixed number of cells n. Therefore, it might be preferable (especially in the case of large G) to choose the wave function of the missing (or uncertain) value also in the form of a Gaussian such that the multiplication of the G components of interference can be expressed as the sum of the exponents and the exponentiation step can be performed only once at the end of the algorithm for computation of the transition matrix. An implementation of this fast version of the censoring algorithm is also provided in the codes package. Supplementaryprovides an illustration of our approach for accounting for missing and uncertain values.
Determination of Gaussian kernel widthThe parameter r in Equation (1) determines the scale at which we visualize the data. If r is extremely small, most elements of the transition probability matrix ~ P will tend to be zero and we do not get an overall view of a connected graph structure. In fact, when r is too small, the number of degenerate eigenvectors with eigenvalue equal to one, indicates the number of disconnected segments that ~ P defines on the data. For too large r however, the transition probability sensitivity on the distance between the cells blurs. There is a certain range of r variations for which ~ P defines an ergodic diffusion process on the data as a connected graph and still the diffusion distances between the cells are informative. The un-normalized density at each cell (Zx in) is proportional to the number of cells in a fixed volume in its neighbourhood and depends on r. At scales of r close to zero, cells do not have any neighbours and their average density is 1 (because of the 1s on the diagonal of P). By increasing r, the average density gradually increases as more cells find other cells in their neighbourhood. There is a density saturation point where r reaches the system size and all cells form part of one neighbourhood. At this point, for every cell x 2 X, the density Zx will be equal to the entire system size n. Assuming that the density gradient is not extremely sharp along the data manifold, the number of neighbours of cell x in the neighbourhood r will be proportional to the volume of a hypersphere of radius r, hence: Zx / r dx;rwhere dx; r is the dimensionality of data manifold at the position of cell x and at the scale r. By differentiating both sides with respect to log r, we find that the average dimensionality of the manifold can be estimated by the slope of the loglog plot of the number of neighbours versus the length scale:where we compute the average of log Zx with consideration of density heterogeneities such that:It is worth noting that this average density underestimates the real dimensionality of the structure due to the contribution of the cells lying on the surface of the manifold. However, this does not affect our heuristic since the variation of hdi is our main interest rather than hdi itself. Each time hdi reaches its maximum and starts to decrease, one can deduce that an intrinsically lower dimensional structure is emerging from the noise-enriched distributed cells in the original high-dimensional space. Therefore several characteristic length scales of the data manifold (i.e. width of its linear parts, radius of its curves, etc.) give rise to several local maxima in hdi. Such characteristic scales indeed make our choice for the Gaussian width r since they indicate the scale at which the Euclidean distances used in the Gaussian kernel are sensible in an assumed Euclidean tangent space to the manifold. Although Euclidean distances are also valid for smaller rs than the characteristic length scale, they are not recommended because smaller kernel width would mean less connectivity in the cells graph which in turn results in an increased sensitivity to noise. Supplementary Figures S2 and S3 illustrate the resulting diffusion map on optimal kernel width and several other kernel widths values for a U-shaped toy data. Also the performance of diffusion map at the optimal kernel width when there is no distinguishable pattern in the data (e.g. normally distributed data in all dimensions or sparse data) is illustrated in the Supplementary.
Toy model for differentiationAs toggle switches are known to play a role in differentiation branching processes (), we designed a regulatory network of three pairs of toggle genes to evaluate the performance of our method on a toy dataset that mimics a differentiation tree (). Assuming a genetic regulatory module as presented in, we simulated the stochastic differentiation process by the Gillespie algorithm () with the reactions as shown inand C (). More details about the chemical reactions and the reaction rates used in the Gillespie algorithm model can be found in the supplement (Supplementary Figs S5A and B). Genes G 1 and G 2 are antagonistic to each other through an inhibiting Hill function. Therefore, starting from an initial undifferentiated state where G 1 and G 2 are both in a very low expression level, single samples may end up in either of the states where G 1 or G 2 is exclusively expressed. At this stage, the next pair of toggle genes in the differentiation hierarchy is activated (through an activating binding Hill function), which are again antagonistic to each other. This model generates four different types of fully differentiated cells in the six-dimensional space of genes. To establish a steady state in the cell population, once a cell hits the end of each branch, we remove it from the population and initiate a new cell at the original undifferentiated state. This approach maintains the population size of cells. After an extended simulation run, the steady state of the population is established and resembles the haemostatic state of (e.g. hematopoietic) stem cells in natural organisms. We sampled cells from this toy model in two different sets, a balanced toy dataset, wherein 600 samples serve as a snapshot of the steady state of the system with no additional extrinsic noise, and an imbalanced toy dataset, wherein 1800 sample are derived from a non-steady-state density distribution with heavier sampling density on the G  1 G  3 branch. We also added an extrinsic Gaussian noise with a variance of 25% maximum expression to each gene. The gene expression plot for a simulated single cell as it proceeds from the initial pluripotent state to a fully differentiated state is presented in the supplement (Supplementary Figs S5C and D).
Experimental data2.5.1 qPCR data of mouse haematopoietic stem cells. We calculated a diffusion map embedding for the haematopoietic and progenitor stem cells dataset from. In this experiment, 597 cells from five different haematopoietic cell types, namely, haematopoietic stem cell (HSC), lymphoid-primed multipotent progenitor (LMPP), megakaryocyte-erythroid progenitor (PreMegE), common lymphoid progenitor (CLP) and granulocyte monocyte progenitor (GMP) were gated by Fluorescence-activated cell sorting (FACS) sorting. Single-cell qPCR expression level measurement was then performed for 24 genes. Housekeeping genes were only used for cell-cycle normalization, where for each cell, all expression values were divided by the average expression of its housekeeping genes. Furthermore we excluded the five housekeeping genes, as well as c-Kit, which is a stem-cell receptor factor expressed on the surface of all analyzed cells, from the diffusion map analysis. 2.5.2 qPCR data of mouse stem cells from zygote to blastocyst To understand the earliest cell fate decision in a developing mouse embryo,conducted a qPCR experiment for 48 genes in seven different developmental time points. The gene expression levels were normalized to the endogenous controls Actb and Gapdh. The authors also identified four cell types, namely, inner cell mass (ICM), trophectoderm (TE), primitive endoderm (PE) and epiblast (EPI) using characteristic markers. The total number of single cells used in the diffusion map analysis was 429.
RNA-Seq of human preimplantation embryosFor the dataset published by, RNA-Seq analysis was performed on 90 individual cells from 20 oocytes and embryos. The sequenced embryos were picked at seven crucial stages of preimplantation: metaphase II oocyte, zygote, 2-cell, 4-cell, 8-cell, morula and late blastocyst at the hatching stage.
ResultsIn this section, we evaluate the performance of the diffusion map on each of the datasets described in the Methods section and compare it to the performance of two other dimension-reduction methods PCA and t-SNE. Data embeddings with several other methods including ICA, SPADE, kernel-PCA (), isomap and Hessian Locally linear embedding (HLLE) are provided in the Supplementary Figures S16S20.shows the average dimensionality hdi for balanced toy data (red) and imbalanced toy data (black) as a function of log r. The balanced set exhibits two maxima. The first one arises at the length scale of the thickness of the differentiation branches which include only a few cells. At this r several subpopulations form at the more densely populated stages of the steady state. The second maximum appears at a larger length scale when several subpopulations become visible to each other and the continuous branches form. We picked the r at the second maximum for visualization (data visualization at the first maximum is provided in the Supplementary). For the imbalanced set, however, due to the high noise level, the first maximum vanished and we only detected one maximum which we then used for the visualization.
Diffusion
Performanceof the diffusion map on the toy data as compared to the other methods Definition of diffusion distance () based on probability of transition between cells through several paths renders diffusion maps very robust to noise.presents a comparison between the performance of the diffusion map and the other two methods PCA and t-SNE on the balanced toy dataset. The eigenvalues of the diffusion map () suggest that there are four leading dimensions that explain the data structure and the higher dimensions present noise rather than the intrinsic structure of the data manifold. The complete set of two-by-two projections up to the fourth eigenvector can be found in the supplementary. PCA of this dataset generated results that were similar to the diffusion map, where all four branches of the data could be distinguished. However, standard t-SNE did not preserve the data structure continuity. Visualization using t-SNE with non-standard perplexity values are also provided in the Supplementary. To determine how additional extrinsic noise and density heterogeneities affect each method, we also applied the three methods on imbalanced toy(A) Toy model of a differentiation regulatory network consisting of three pairs of antagonistic genes simulated by the Gillespie algorithm. The arrows show activation or inhibition interactions between genes. The toy model employs two classes of gene regulation: (B) G i is connected to an inhibitor, its production rate a i is proportional to a Hill function of the concentration of the inhibitor Protein i 0 (C) G i is connected to an inhibitor G i 0 and an activator G i 00 , its production rate a i is proportional to product of an inhibiting and an activating Hill function. The degradation rate c is constant for all proteinsDiffusion maps for high-dimensional single-cell analysisdata (). The eigenvalues plot of the diffusion map in this figure suggests the same order of significance for the third and fourth eigenvectors as k 4 almost equals k 3 and that the higher order eigenfunctions mostly present noise. We chose two projections (DC, DC2, and DC3) and (DC1, DC2, and DC4) for illustration in. The complete set of two-by-two projection can be found in the Supplementary. From, one can infer the same size for all four branches of differentiation despite different sampling densities. This figure also suggests that the diffusion map clearly shows four branches of the imbalanced toy data, whereas PCA and t-SNE produce noisier visualization and represent the two rarer branches as smaller. For additional t-SNE visualizations with non-standard perplexity values for the imbalanced toy data see Supplementary.
Refinement of the transition matrix by density normalization, zero diagonal and accounting for missing valuesIn order to adapt the standard diffusion map algorithm to the properties of single-cell gene expression parameters, we refined the transition matrix in different ways. First, we set the diagonal of the transition matrix to zero () since the (non-zero version) diagonal carries information about local sampling densities. Unlike many other applications where the information about local densities has some value, the sampling density in the context of single-cell data is somewhat arbitrary (e.g. only specific cell types are monitored, different proliferation rates in several stages of differentiation alters the sampling density, outlier cells show lower density, etc.). For a demonstration of how zero diagonal improves the quality of the diffusion map see Supplementary. Second, we refined the Markovian transition matrix by density normalization () since the number of diffusion paths between two cells depends on the density of cells connecting them and more densely sampled regions of the data would seem to have smaller diffusion distance to each other on a diffusion map without density normalization. Supplementarydemonstrates how density normalization improves the quality of the diffusion map. The third refinement that we used in our implementation of diffusion maps is accounting for missing and non-detect values (Section 2.2). Generally speaking as the proportion of missing and non-detect values increases, there is a decrease in the quality of the diffusion map. However the magnitude of this effect depends highly on the architecture of the gene regulatory network and the role of the corresponding gene in the network. For example, for a toggle switch, low expression of a gene would always imply high expression of the other gene. Therefore, increasing the detection threshold (i.e. increasing number of non-detects) does not have a major influence on the analysis, as the information is still present in the other gene with high expression. We evaluate the performance of diffusion map in several proportions of missing values for the balanced toy data in Supplementary.
Diffusion map allows identification of differentiation trajectories on experimental data3.2.1 Performance on haematopoietic stem cells qPCR data as compared to the other methods The diffusion map embedding for the haematopoietic stem cells () indicates a major branching of HSCs to PreMegE and LMPP cell types and a further branching of LMPPs to CLP and GMP cells. The branching structures are less clear in the PCA plot (). Moreover, PCA produces artificial planes of data in the embedding because of the non-detect measurements in the qPCR data. The t-SNE plot () almost separated the cell types (except for LMPPs) into different clusters. However, the notion of temporal progress is less clear compared to the diffusion map embedding. In addition, since uncertainties in the values of non-detects were not considered, a widening within the clusters is observed. Detailed visualization using the three methods and the Gaussian width determination for diffusion map embedding are provided in the Supplementary. The ordered eigenvalues plot for the diffusion map and PCA are shown in Figures 6D and E. The ordered eigenvalues plot of the diffusion map suggests that there is no clear separation between the eigenvectors of the diffusion map that captures the intrinsic low-dimensional data manifold and those characterizing noise for this dataset. However, what makes the diffusion map embedding of this dataset more plausible is the concordance between the branching structure as suggested by the diffusion map and the recently established hierarchy of haematopoietic cell types () illustrated in3.2.2 Performance of the diffusion map on mouse embryonic stem cells qPCR data as compared to the other methods For the mouse embryonic stem cells, diffusion map visualization using the first three eigenvectors indicated a branching at the early16-cell stage to the ICM and TE cell types, and further branching of the ICM at the late 32-cell stage into the EPI and PE (). The branching structure is unclear in the PCA and t-SNE plots (Figs 7B and C). The ordered eigenvalues plot for the diffusion map and PCA are shown in Figures 7D and 7E. The branching structure indicated by the diffusion map is in agreement with the results of previous studies on this dataset (), which suggests a branching into the two cell types, ICM and TE, after the 8-cell stage and further branching of the ICM into EPI and PE cells (). More information on Gaussian width determination and two-dimensional projections of data on each pair of the first to fourth eigenvectors of the diffusion map are provided in the Supplementary.
Performance onhuman pre-implantation embryos RNA-Seq data compared with other methods The performance of the diffusion map on this RNA-Seq dataset is comparable (although slightly sharper with respect to pseudotime ordering) to the other two methods, PCA and t-SNE (). The number of single cells measured in RNA-Seq is currently limited due to high sequencing costs. A low number of sampled cells could not meaningfully indicate a complex structure. Hence, PCA and t-SNE performance is almost as good as that of the diffusion map. However, with the expected development of new and cheaper RNA sequencing technologies, we propose a diffusion map that could be used as a powerful dimension-reduction tool the computation time of which is only linear with respect to the number of genes.Among these methods, isomap and (H)LLE have not been applied for the analysis of single-cell differentiation data and pseudotime ordering so far, mainly because they do not meet the specific requirements for the analysis of such data including capability to handle high levels of technical noise, sampling density heterogeneities, detection limits and missing values. Supplementary Figures S19 and S20 in the supplement demonstrate the poor performance of these methods for finding the differentiation manifold in presence of noise and density heterogeneity for our toy dataset as well as the three experimental single-cell datasets. For any dataset, it is important to consider the advantages and disadvantages of each method with respect to the data properties and the purpose of the analysis, in order to make a suitable choice for applying to that dataset. In our diffusion maps implementation, by performing density normalization and setting the diagonal of the transition probability matrix to zero, we propose a mapping technique wherein the closeness of cells in the diffusion metric is unaffected by density heterogeneities in data sampling (see Supplementary Figs S9 and S10). This feature can be crucial for the detection of rare populations, which is one of the main challenges in the analysis of differentiation data. By breaking the diffusion kernel () to its multiplicand wave functions, we also propose a method in accommodating the uncertainties of measurement and missing values into the wave function. Consequently, we have successfully addressed uncertainties in the value of non-detects in qPCR data. Tuning the scale parameter r is also important for generating insights into the structure of the data, for which we proposed a criterion on the basis of the characteristic length scales of the data manifold. Because of computational limitations, for our criterion we compute the average intrinsic dimensionality and hence the average characteristic length scale. However, when density heterogeneities are extremely large, or the data manifold has many sharp changes and several scales, a single r may not provide a globally optimal scale for data embedding. Therefore, implementation of an efficient and cost-effective method for several locally valid rs determinations, instead of a single global value is of interest. It is worth noting that the mathematical ergodicity in diffusion maps reached by adequate kernel width selection does not necessarily imply biological ergodicity. If there appears a trace of transitory cells between two clusters, we conclude the two clusters are also biologically connected to each other in an ergodic sense. However this trace might be not present if the transition is too fast or switch-like abrupt, so that no transitory cells have been caught in the finite set of sampled cells of snapshot data. Thus it has to be proven with dedicated biological experiments (e.g. as used byand) whether the data is biologically ergodic or not. A possible strategy for enhancing the capacity of capturing details of the structure of rare populations using diffusion maps is to limit the transition possibility of each cell only to its closest neighbours. In this scenario, we could render the diffusion map more local by building the transition matrix ~ P in Equation (6) for k nearest neighbours only. This method, however, might end up with several disconnected sub-graphs of cells when the sampling density along the intrinsic data manifold is extremely heterogeneous. Furthermore, ~ P (without the row normalization) will not be symmetric any more and we cannot ensure real eigenvalues for the transition probability matrix. However, as long as the graph is(weak) global
Diffusion maps for high-dimensional single-cell analysisconnected and eigenvalues are real, we can benefit from a more locally detailed map. One caveat in the current version of diffusion map is the n 2  G computation time which can be prohibitive for large cell numbers (> 10 4 ) as generated from cytometry experiments. Choosing the k nearest neighbours version of diffusion map can therefore be a solution to this problem. Diffusion distances are based on a robust connectivity measure between cells which is calculated over all possible paths of a certain length between the cells. Thus, a diffusion mapping obtained by accounting for a smaller fraction of all possible paths (namely those going through each cells' nearest neighbours) can still provide a good approximation of the diffusion distance between the cells and yet avoid computing all n 2 elements of the transition probability matrix. With such modifications, diffusion maps prevail as a promising method for the analysis of large cell numbers omics data. Another issue is the number of embedding dimensions. The number of significant dimensions of the diffusion map is determined where a remarkable gap occurs in its sorted eigenvalues plot. This is not intrinsically bound to the conventional visualizable dimensions two or three. In contrast, for some other methods such as t-SNE, one can pre-determine the number of visualization dimensions for the embedding optimization to two or three dimensions. We conclude that diffusion maps are appropriate and powerful for the dimension-reduction of single-cell qPCR and RNA-Seq cell differentiation data as they are able to handle high noise levels, sampling density heterogeneities, and missing and uncertain values. As a result diffusion maps can organize single cells along the non-linear and complex branches of differentiation, maintain the global structure of the differentiation dynamics and detect rare populations as well.
at University of California, Los Angeles on August 30, 2016 http://bioinformatics.oxfordjournals.org/ Downloaded from
Discussion and conclusion In this manuscript, we have demonstrated the capabilities of diffusion maps for the analysis of continuous dynamic processes, in particular, differentiation data in a toy dataset and a few experimental datasets. Using a biologically relevant distance metric (i.e. diffusion distance), the adapted diffusion map method outperforms other dimension-reduction methods in pseudotemporal ordering of cells along the differentiation paths and could capture the expected differentiation structure in all cases. Table 1 provides a general comparison of several dimension-reduction methods, detailing capabilities and limitations in application to single-cell omics data. Fig. 5. Visualization of the imbalanced toy data on (A) the first three eigenvectors of the diffusion map, (B) the first, second and fourth eigenvectors of the diffusion map, (C) the first three components of the PCA (D) the first, second and fourth components of PCA and (E) t-SNE. The colours (heat map of blue to red) indicate the maximum expression among all genes. Eigenvalues sorted in a decreasing order for (F) diffusion map and (G) PCA Fig. 6. Visualization of haematopoietic stem cells data on the first three eigenvectors of (A) diffusion map, (B) PCA and (C) t-SNE. Eigenvalues sorted in a decreasing order for (D) diffusion map and (E) PCA. (F) The hierarchy of haematopoietic cell types
