Liquid chromatography coupled to mass spectrometry (LC/MS) has become widely used in Metabolomics. Several artefacts have been identified during the acquisition step in large LC/MS metabolomics experiments, including ion suppression, carryover or changes in the sensitivity and intensity. Several sources have been pointed out as responsible for these effects. In this context, the drift effects of the peak intensity is one of the most frequent and may even constitute the main source of variance in the data, resulting in misleading statistical results when the samples are analysed. In this article, we propose the introduction of a methodology based on a common variance analysis before the data normalization to address this issue. This methodology was tested and compared with four other methods by calculating the Dunn and Silhouette indices of the quality control classes. The results showed that our proposed methodology performed better than any of the other four methods. As far as we know, this is the first time that this kind of approach has been applied in the metabolomics context. Availability and implementation: The source code of the methods is available as the R package intCor at http://b2slab.upc.edu/software-and-downloads/intensity-drift-correction/.
INTRODUCTIONMetabolomics aims to asses the metabolic changes in a global way to infer biological functions and provide the detailed biochemical responses of cellular systems (). Liquid chromatography/mass spectrometry (LC/MS) devices are among the most used experimental set-ups in metabolomics. LC/MS analyses of biological samples such as urine or plasma give high-throughput data having a three index scheme: retention time, mass/charge ratio and intensity values (). In metabolomic data, as in other types of high-dimensional data such as gas sensor arrays or microarray data, the intensity values of the variables might be biased or might suffer from variations owing to external factors. Among these factors is a contribution from the drift of the experimental devices, owing to various causes such as column ageing in the case of LC/MS, temperature variations or contamination effects (). The presence of peak intensity drift in the data is an important issue, as its effects can be important enough to mask the real statistical behaviour of the data and may indeed be the largest source of variance in the data (). In most LC/MS protocols, quality control (QC) samples are regularly injected to ensure good analytical device performance (). In LC/MS metabolomics studies, the quality controls have been carried out using pools of biological samples, spikes with standards or Milli-Q water samples (). These quality control samples consist either of a pooling of all the samples in the study or of a spike-in of some known metabolites (several classes having different types of QC samples might be injected). In the data preprocessing stage, one may distinguish two different steps: data normalization and data equalization. We understand the data normalization step as the mathematical process that makes the variables in the dataset comparable, whereas the data equalization step makes the samples from the dataset comparable. In the literature, many normalization and equalization methods, based on several different approaches and scopes, may be found. Regarding equalization methods, a methodology using certain internal known metabolites as quality standards to normalize the whole dataset has been reported (). Another approach is to use the injected samples for internal control (i.e. QCs) to fit a smoothed model for the intensity levels of certain features, and then to correct all the biological samples accordingly (). The R package sva includes the ComBat function, which compensates the batch effects on microarray data using an empirical Bayes approach (). This method has been applied to normalize gene expression and methylation data (). Equalization methods based on a sample-wise correction for LC/ MS metabolomic data have also been tested and compared by. Their results suggest that a variance stabilization transformation of the data, followed by a median fold change normalization, gives the best performance as compared *To whom correspondence should be addressed. with three other methods. Their method performs a normalization and an equalization step to give a robust output when having urine samples with different concentration values. Among the equalization methods, the one proposed by Artursson et al., based on component correction (CC), was developed in the sensor-array field (). This method is based on the assumption that, in multivariate data, the drift direction is the first principal component (PC) of a PCA decomposition for a class consisting of measurements of the same samples. Such samples are known as technical replicates (i.e. there is no biological or chemical variation in addition to the variability of the technical replication of the measure). Once the drift direction is computed, the drift is removed from the data by subtracting the data projection on the drift direction from the original data. However, if some between-class variability is aligned with the drift direction, it will also be subtracted, and some non-drift variability will be removed. A natural extension of the CC method is the one proposed by Ziyatdinov et al., which is based on a common principal component analysis (CPCA) decomposition (). This method proposes modelling the drift contribution in the data as the direction capturing maximum variance that simultaneously diagonalizes the covariance matrices of a set of classes. All the variability of the samples in that particular direction is considered to be driftinduced variability, and the projection of the data on that direction is subtracted from the data as in the CC method. In this article, to find the drift model, we state the hypothesis that the intensity drift of the chromatograms is the common variance direction of all the QC classes that captures the maximum variance. In this context, we propose a preprocessing method based on a two-step approach by first equalizing the data through a CPCA, and then normalizing the data using a median fold change step.
MATERIALS AND METHODS
Description of the dataThe samples were analysed by liquid chromatography coupled with a hybrid quadrupole time-of-flight (LC-q-TOF, Hybrid quadrupole TOF QSTAR Elite, AB/MDS Sciex) in positive mode using the protocol proposed by. LC was performed in High-Performance Liquid Chromatography (HPLC) Agilent (Agilent 1200 Series Rapid Resolution HPLC system) using an RP 18 Luna column (50  2.0 mm, 5 m), with a sample injection volume of 15 l. A linear gradient elution was performed consisting ofMilli-Q water 0.1% HCOOH (v/v) andacetonitrile 0.1% HCOOH (v/v).The gradient elution (v/v) ofwas as follows: (time, min; B, %):). Q-TOF spray parameters were set as previously described (), and full data acquisition was performed scanning from 70 to 700 m/z. The TOF was calibrated with reserpine (1 pmol/l). LCMS data were acquired in random order to avoid possible bias and the batches equilibrated. Throughout all the analysis, data process quality control (QC) samples were analysed to monitor the stability and functionality of the system. The sample collecting span was of 18 days, and there was a replacement of the chromatographic column in the process on day 14. There were 994 study samples and 182 QC samples. Three classes of QC samples were used for each batch: Water: Milli-Q water samples (n = 96 samples). Spikes: Standard mixture solution (n = 48 samples) consisting of 12 metabolites at the final concentration of 5 ppm for all of them except for indole-3-acetic-2,2-d2 acid whose final concentration was of 10 ppm.
MethodsThe five methods compared in this article (CPCA, CC, median fold change, ComBat and our CPCA + median fold change) have different input parameters. The methods based on a CPCA decomposition or the CC method involve a class (or classes)-selection step to use them for the drift modelling. These methods also need as input the number of components of the drift decomposition, which are supposed to be captured. The ComBat method needs the batch relation for each class, whereas the median fold change method does not need any specific input parameter in addition to the data to be normalized.
Component correction The hypothesis underlying this methodis that the drift direction is found in the first PC of a reference class. The methodology used to normalize these data is described in (). As the feature pattern of the QC samples was more complex than that of the other two QC classes, the reference class was selected to generate the PCA model. Because of this higher complexity, this class is better able to capture the drift in the data than would a class with a simpler feature pattern. Mathematically, the CC method can be expressed 2900The methodology proposed by Artursson et al. removes one PC, but the method can be generalized to remove as many PCs as can be found in the data. If Ncomps is the number of components to be removed, then S (p r  Ncomps) is the scores matrix, L (m  Ncomps) is the loadings matrix and E (p r  m) is the error matrix. As only one PC is required to perform the normalization, no further increase in the dimensions of the matrices S and L is necessary. The drift direction is the first PC, which in this case corresponds to the matrix L. The next step is to project the dataset Y onto this direction to obtain the drift component in the data. This projection is mathematically expressed as the Equation (2).where the superscript cc refers to CC and the subscript d to drift. Once the drift component Y cc d (p r  m) of the data is computed, the last step in removing the drift is to subtract it from the data.shows this last step, and the resulting matrix Z cc (p r  m) is the corrected matrix using the CC method.). The first step of this method, shown in equation (4), is to compute the median for each variable, thus obtaining a vector ^ y i 1  m. This vector is used to rescale the original dataset Y into a new one, ^ Yp  m IG(IG) [seeTo obtain the normalized dataset Z M p  m, the dataset Y is divided by the sample median of the matrix ^ Y (defined as ^ w j p  1) as shown in Equation (5).where the superscript M refers to median fold change method.
ComBatThe ComBat method is a function of the R package sva. This function aims to correct the batch effects, which are known to be a source of bias, in gene expression experiments; its extension to LC/ MS metabolomic datasets is both natural and straightforward. First, it is assumed that batch effects have multiplicative and additive contributions to the data, and that these effects can be variable dependent (gene or peak, respectively). We state a model following this hypothesis [seewhere Y ijb is the intensity value for sample i, variable j and batch b. j is the intensity value for variable j, X is the design matrix, j contains the regression coefficients of the model, jb is a matrix containing the additive batch effects for variable j and batch b, jb is a matrix containing the multiplicative batch effects for variable j and batch b and ijb is the residual matrix of the model. Using either a parametric or a non-parametric empirical prior estimation, the distributions for jb and 2 jb are estimated. The conditional posterior probabilities (  jb and 2 jb ) can then be found, and the data are corrected for batch effects as shown in Equation (7). In the following, all the variables having a hat (^) on them refer to their values estimated from the data.where the superscript CB refers to the ComBat function, Z ijb is the standardized data and ^ j is the estimated standard deviation.
CPCA CPCA is a generalization of the PCA decomposition fordifferent classes first introduced by). Say we have k classes and S k p k  p k  are the set of their covariance matrices, then CPCA aims at finding a space such as the one defined by the V (in general, p k  p k  matrix shown in Equation (8). In the space spanned by V, the covariance matrices for all the classes involved S k are diagonal.where  k p k  p k  is the diagonalized covariance matrix for class k. Each one of the dimensions of this space is called a common principal component (CPC). The hypothesis underlying the CPCA method for drift correction is that the drift direction is contained in the CPC capturing the largest variance. The CPC will be computed by using the Y QC dataset [i.e. there are three expressions like Equation (8), using the different covariance matrices for the QC classes: S r , S water , S spikes ]. In a similar way as in a PCA decomposition, given the desired number of CPCs and following a stepwise algorithm, it is possible to compute the number of CPCs one by one (). Setting the desired number of CPCs as Ncomps, the dimensionality of the V matrix is (p k  Ncomps). We have tested the values Ncomps = 1, 2, 3 separately for this method. Once the CPCs are found, the dataset is projected onto this space as shown in
CPCA + median fold changeThe method we propose consists of a two-step approach. First, the data are equalized by removing the drift using CPCA and, in the second step, the data are normalized by applying the median fold change method. As the CPCA method was applied three times with different number of extracted CPCs (Ncomps in previous subsection), the proposed method will be computed for the same number of components (Ncomps = 1, 2, 3).
ValidationFrom the class definition in Section 2.1, it follows that a PCA score plot of all the classes should have the classes clearly separated in different clusters. We propose a quality measure for peak intensity drift correction methods based on the standard clustering internal measures Dunn and Silhouette for the QC classes in the principal plane (the plane explaining maximum variability of the data) score plot of all the classes (including the study class). The clustering technique used was k-means. The R package clValid was used to compute the quality indices (). In general, the greater the Dunn and Silhouette indices, the better the clustering, meaning that the QC classes are more easily separable in the principal plane and that the intra-class variance is lower.
RESULTS AND DISCUSSIONThe top left plot indepicts a PCA score plot for the raw data using all the classes. Thethat one of the main sources of variance is the interclass variability. The drift effect on the variance becomes clear when the same PCA score plots are coloured according to the injection time or the batch of the sample. This effect is shown in. From this Figure, we conclude that there is a clear drift component (having different sources) that is causing an important drift of the QC classes and which, in all likelihood, affects the samples in the study class as well.contains the Dunn and Silhouette values for all the methods used, whereasdepicts the PCA Scoreplots for the same methods. The CPCA + median fold change method shows the highest clustering values (highest Dunn index when two components are removed and highest Silhouette index when one component is removed) and it has a slight advantage over the CPCA and the median fold change methods. From the mathematical formulation of the Dunn index, it is important to note that its measures might give low values when there are a small number of samples some distance from the cluster centre, even if all the other samples and classes are tightly clustered (). This might be the case here, as applying the CC method removing two PCs had a higher Dunn index than the CPCA + median fold change removing one CPC, when the PCA score plots showed a lower drift clustering for the latter (compare Supplementaryversus the bottom right plot of). The Silhouette index () for the different CPCA methods applied suggests that the drift seems to be contained in just the first CPC, as the quality measures go down as more CPCs are removed from the data.depicts the originof the variance removed by each of the three CPCs and the mean chromatogram of the QC samples. Whereas the first CPC shows a smooth variation along the retention time, the second and third CPCs show abrupt changes in their values, especially close to major chromatographic peaks. In some of these peaks, the values of the second and third CPCs have a zigzag behaviour, suddenly going from negative to positive values or vice versa. This behaviour suggests that the variance captured by these two CPCs corresponds to not having the chromatograms perfectly aligned, meaning that the peaks in the chromatograms are not fully coincident across the samples. This fact further reinforces the hypothesis that the drift is contained in just the first CPC. Assuming this hypothesis, it can be noted fromthat the drift of the data is not higher close to the chromatographic peaks, apparently quite the opposite, meaning that the drift affects the baselines of the chromatograms more than their peaks. The CC method corrects some of the drift in the data although a large drift component is still to be found in the data (). The larger Dunn index value for the CC method as compared with the raw data value is evidence for the drift correction (). However, this improvement is not validated by the Silhouette index, which remains practically unchanged as compared with the raw Silhouette value regardless of the number of components removed. The ComBat method does not seem to be the most suitable method for correcting LC/MS metabolomic data despite being used widely and successfully in the field of gene expression and methylation data. Although it corrects some batch effects in the study samples, the batch effects are still important in the QC classes after the correction (see circles AG for some spikes and water samples compared with the H circle containing some study samples in Supplementary). Furthermore, the resultant PCA score plot (lower left plot of) for the ComBat correction suggests that some between-variance component was removed in the correction process, as the different classes are closer than for the raw data. The median fold change method considerably improves both the Dunn and the Silhouette indices. A visual inspection of the resulting PCA score plot for the median fold change method confirms this improvement (). Nevertheless, the PCA score plot also shows that the spikes and water classes have similar shapes and these long shapes turn out to be caused by residual uncorrected drift effects (Supplementary). This fact suggests that, as the median fold change method normalizes the data without specifically trying to remove the drift, there mayin the data. The three plots in the lower left show the effect of the time elapsed since the first sample was injected, whereas the plots in the top right refer to the batch of the sample. The numbers in the diagonal plots correspond to the variance captured by each PC. The order in the legend of the batches corresponds to the real injection order of the samples still be a source of variance in the data caused by the drift of the experimental device. On the other hand, because the methods based in the CPCA approach (CPCA and CPCA + median fold change methods) are developed to model the drift direction, their resultant datasets show less residual drift in their corresponding principal plane score plot (Supplementary Figs. S4 and S5 for the CPCA and the CPCA + median fold change methods, respectively). The methods have been characterised for different dataset sizes (10, 25, 33 and 50% of the dataset) through a random subsampling stage (taking 100 iterations per subsample). For each subset, we applied the proposed methodology to test the compensation effect given dataset size and to find an estimate on the variability of this effect. We computed the Silhouette index for each drift-correction method as described in Supplementary Section S1.contains the values of the slopes, the standard errors and the P-values of the ANOVA tests for all the methods. Results show that the median fold change and the CC methods suffer from performance for large datasets. On the other hand, the ComBat method improves its correction as data availability increases. This last result is probably because of a better estimation of the batch components when having larger sample sizes. The Supplementary Table S1 also shows that the performance of the CPCA and CPCA + Medians methods is insensitive to the considered dataset size. This suggests that the mathematical approach taken, where the drift component is extracted from a multi-class QC variance analysis is more resilient to the sample size variations. Overall, in the context of LC/MS drift correction, the proposed two-step methodology shows better clustering properties of the QC samples for large metabolomic studies than the median fold change method. The method also shows a robust behaviour under small sample size conditions. Furthermore, unlike the median fold change method, the two-step method is able to capture intensity drifts that covariate with the retention time.
CONCLUSIONSApplying the combined method CPCA and the median fold change, results in a dataset that contains less drift effects than the dataset corrected solely by the median fold change, and the
at :: on August 30, 2016 http://bioinformatics.oxfordjournals.org/ Downloaded from
Reference: Urine sample belonging to the one volunteer (n = 38 samples). 2.2 Preprocessing All the methods were applied to the chromatograms without any prior feature detection. The R package XCMS was used to read the chromatograms of the mzXML files containing the sample data (Smith et al., 2006). The chromatograms were aligned using an in-house-developed R package (UB/UPC). The chromatographic data of all the files read were merged, creating an n  m chromatogram matrix X. This step required the binning of the retention time in m bins that were given by the XCMS package. Therefore, the chromatogram matrix had samples as rows and retention time as columns (in our case, n = 1176 samples and m = 441 retention time points). Thus, the i-th row of this matrix corresponds to the chromatogram of the i-th sample. From here on, the variable j refers to the retention time bins in the chromatogram matrix. A class-wise outlier detection and removal procedure was applied to the QC classes. This procedure was based on computing the score distance (SD) and an orthogonal distance (OD) in a PCA model using the pcaPP R package (Filzmoser et al., 2013; Hubert et al., 2005). QC samples having SD and OD distances greater than the suggested critical values were considered to be outliers and were discarded from the dataset (Filzmoser and Fritz, 2007). The critical values used in the package were (i) a quantile of the chi-squared distribution for the SD and (ii) a WilsonHilferty approximation for the scaled chi-squared distribution for the OD (Filzmoser and Fritz, 2007; Hubert et al., 2005). Using this approach, nine outlier samples were detected (four samples in class reference, three in class water and two in class spikes). As it is known that raw LC/MS metabolomic data suffer from multiplicative noise, we took the logarithm of the data to compensate for such error sources and to convert them into additive noise sources (Veselkov et al., 2011). Once the o outliers were removed, we could then define the quantity p=n  o to be the new sample range. The resulting matrix Yp  m was used as an input parameter for all the normalization methods tested. This matrix contains the data for both the QC classes and the study class, and it can be divided into matrices corresponding to each class (i.e. Y QC p QC  m for the corresponding dataset for all QC classes, Y r p r  m for the corresponding dataset for the reference class, etc.).
Intensity drift removal in LC/MS metabolomics at :: on August 30, 2016 http://bioinformatics.oxfordjournals.org/ Downloaded from
