Motivation: A detailed analysis of multidimensional NMR spectra of macromolecules requires the identification of individual resonances (peaks). This task can be tedious and time-consuming and often requires support by experienced users. Automated peak picking algorithms were introduced more than 25 years ago, but there are still major deficiencies/flaws that often prevent complete and error free peak picking of biological macromolecule spectra. The major challenges of automated peak picking algorithms is both the distinction of artifacts from real peaks particularly from those with irregular shapes and also picking peaks in spectral regions with overlapping resonances which are very hard to resolve by existing computer algorithms. In both of these cases a visual inspection approach could be more effective than a 'blind' algorithm. Results: We present a novel approach using computer vision (CV) methodology which could be better adapted to the problem of peak recognition. After suitable 'training' we successfully applied the CV algorithm to spectra of medium-sized soluble proteins up to molecular weights of 26 kDa and to a 130 kDa complex of a tetrameric membrane protein in detergent micelles. Our CV approach outperforms commonly used programs. With suitable training datasets the application of the presented method can be extended to automated peak picking in multidimensional spectra of nucleic acids or carbohydrates and adapted to solid-state NMR spectra.
IntroductionNuclear magnetic resonance (NMR) spectroscopy has become a standard technique in biological research. NMR applied on solutions of biological macromolecules provides data on their structural as well as dynamic properties and supplies detailed information on molecular interactions. The analysis of the NMR spectra often still includes substantial manual work even though a broad range of automated procedures have been developed (). Automation of spectral analysis is particularly important in NMR-based drug discovery where hundreds of two-dimensional spectra are measured during screening of libraries of chemical compounds (). Moreover, the increasing amount of structural genomics and proteomics using NMR necessitate fast automated procedures to alleviate the time-consuminguser-dependent classical analysis of spectra (). A rapid and robust user-independent pipeline in NMR data analysis would relieve many NMR spectroscopists from routine tasks. The first step in a fully computerized analysis of NMR spectra is automated peak picking-a task that has attracted substantial interest and there are numerous algorithms available (). And yet manual peak picking usually still provides superior results. Existing programs for automated peak picking can suffer from limited ability to discriminate between signals, artifacts and noise requiring external intervention by experienced spectroscopists for an exhaustive recognition of all resonances. In manual peak picking a researcher visually selects peaks with the expected shapes that, from experience, represent real signals. Thus, he relies on his prior knowledge about the appearance of real peaks as local extrema in the spectrum. An analogous approach is used by people to recognize solid objects in planar images, where small patches are analyzed for the decision whether or not they contain an object. Computer vision is a rapidly developing branch of computer science that attempts to automate this process known as the object detection problem. Computer vision techniques have been successfully applied in many areas as e.g. in face detection (), for pedestrian detection (), or car detection (). Object detection is usually a two-phase process, where binary classification is followed by feature extraction from a local image patch. Different image features () and binary classifiers () are available. To our knowledge such an image processing approach has not been applied to automate peak picking in which it could provide a reliable algorithm for the identification of peaks in multidimensional NMR spectra. In this work, we developed a peak picking algorithm based on computer vision which uses a technique called Histogram of Oriented Gradients (HOG) () as a feature extraction procedure and Support Vector Machine (SVM) () as a binary classifier for reasons discussed later in the text. As input, the CV-Peak Picker accepts any kind of spectra with different data formats (Sparky, Topspinor VNMR [) and returns peak lists for a given spectrum in Sparky format (http://www.cgl.ucsf.edu/home/sparky). The general scheme of the CV-Peak Picker function is illustrated in.
Methods
General strategyThe following features are used in CV-Peak Picker:classification: all recognized and dispersed shapes are compared with a training set consisting of manually identified shape set that contains real peaks and peak artifacts; the comparison is performed with Support Vector Machines (SVMs).
Extrema selectionThe NMR spectrum is an array of pixels having individual intensities; e.g. a 3D spectrum consists of intensity values I x,y,z with the Cartesian coordinates x, y, z along the three frequency axes. After exclusion of a user-defined spectral band around the water resonance the spectrum is scanned with a 3  3  3 pixel cube. First local extrema are identified by the criterion that the central pixel has the single largest or smallest value of all adjacent pixels. Then, the spectrum is cut into 2D layers perpendicular to one axis, and henceforth it is analyzed layer-by-layer.
Volume calculationFor all extrema in a particular 2D layer the peak volume is defined as the sum of the intensities of data points (pixels) in small areas around the extremum starting with 3  3 pixels with the extremum in the center. The number of pixels is iteratively optimized based on the peak volume as proposed by. The extrema are sorted according to their absolute volumes starting with the largest value. CV-Peak Picker analyzes N peaks per layer (default N  500, any N can be chosen). N was set based on 13 C/ 15 N-resolved 3D NOESY spectra which provide a high dynamic range in volumes and contain much more resonances than through-bond correlation experiments including TOCSY. N must be larger than the expected number of real peaks; larger N values increase the scanning time.
Bounding boxPeaks with absolute volumes above the cut-off value are tightly confined by the bounding box () which varies in size between the largest and smallest peak. Dimensions of the largest and smallest bounding boxes are predefined by the user visually within a 2D layer of the spectrum. The area of all bounding boxes is rescaled to the default size of 32  32 pixels (see Supporting Information for details). The features will be extracted within the bounding box of the individual peaks. The manual choice of the maximal and the minimal bounding box affects the result in that the size of the bounding box determines the accuracy and sensitivity of the resulting peak list. A larger box increases the chances to pick all real peaks, but also allows the algorithm to pick more artifacts.
SymmetrizationOverlapping peaks may strongly influence feature values and thus cause significant irregularities in shape mapping. We empirically found better accuracy in peak picking, when HOG features are extracted before and after symmetrization of a peak and thus, both are included into the peak descriptor (Supplementary). For local symmetrization the following equation is applied:). For better stability local gradients are averaged over non-overlapping cells with 4  4 pixels by trilinear interpolation (large black squares). Next, for each cell a histogram of gradient orientation is calculated: 9 histogram bins evenly distributed over 360 are filled by adding partial gradient magnitudes calculated using trilinear interpolation, i.e. each gradient magnitude is distributed among two closest orientation bins in four adjacent cells according to Dalal and Triggs (). Then cells are organized into blocks consisting of 2  2 cells (blue square) and bin values normalized. (C) The resulting bin values obtained in (B) are added into final feature vectors. These feature vectors (peak descriptors) are compared with the support vectors in the feature space. This comparison is performed using the Gaussian kernel and allows classification of the peak into the region of true peaks or peak artifacts in feature space. The flow of the algorithm is presented by solid black arrows, and elements of the flow chart are indicated with dashed black arrows. Two main layers of the algorithm, HOG feature extraction and peak classification, are restrained by the single brackets. In the program we actually use a total ofwhere x,y denote the coordinates of the bounding box center (which can consist of non-integer values); bc; de denote floor and ceiling operators, respectively; the peak extremum is located in the pixel (bxc,byc); the numbers (u,v) vary from b0:5M  1c to 0:5M, where M denotes the width of bounding box after rescaling. The symmetrized spectrum is subtracted from the original spectrum and an additional round of extrema selection is performed. This provides a systematic detection of overlapped peaks.
Shape mappingThe crucial aspect in choosing the right features is their discriminative property, i.e. their values should differ significantly between real peaks and artifacts. One pronounced difference is the shape of the peaks. Real peaks usually exhibit a Lorentzian or Gaussian type line shape unlike artifacts, which have varying shapes with less symmetry. For a peak descriptor we selected 'Histogram of Oriented Gradients' (HOG) due to its flexibility in describing various irregular shapes. HOG was successfully applied in computer vision for object detection in photographs (). For the bounding box the vector field consisting of intensity gradients is created (). The horizontal gradient g H l for a pixel l is calculated from three consecutive pixels k, l, m with intensities I k , I l and I m , respectively, byThe vertical gradients g V l are calculated correspondingly. Subsequently, vertical and horizontal gradients are combined so that the magnitude of the resulting diagonal gradient g l , for each pixel l equals:and its orientation is:For further evaluation, the gradient vector field within a bounding box is divided into 16 non-overlapping cells with 8  8 pixels each (). Based on the cells the histogram of gradient orientation (HOG) is calculated. For the HOG the unit circle is divided into 9 equal parts forming the histogram bins. The bins are filled according to the gradient orientations h l and the corresponding partial magnitudes of the gradients are calculated by trilinear interpolation (). This interpolation makes the feature descriptor less susceptible to small perturbations in the shape. To increase the robustness of the feature descriptor even further, the contribution of the noise must be minimized. To this end the cells are grouped into blocks consisting of 2  2 cells. Final features are a result of normalization of the histogram values in every single block as described by Dalal and Triggs (2005).
Feature pyramidThe size of the bounding box depends on the peak size in a contour plot which also represents its volume. The program uses K bounding boxes with different sizes (for details see Supporting Information). From the spectral information within individual bounding boxes we extract features that we combine with a procedure called feature pyramid (). Formally, the feature pyramid U i is defined bywhere / i;k is a vector of extracted features for the peak x i ; y i  using the k-th area, where k  1;. .. ; K, for which we calculate exactly the same features, i.e. HOG with and without symmetrization. To confirm the reproducibility of the feature extraction procedure, the peak previously confined by the bounding box, is rescaled to default 32  32 pixels (for details see Supporting Information).
Peak classificationFrom every feature pyramid U i a sequence of real valued responses fr i;1 ;. .. ; r i;K g can be extracted, in which larger r i;k values represent stronger evidence that the peak is in the positive class (real peak), the value of p i is set to the strongest response p i  1 if max k r i;k ! r 0 0 if max k r i;k < r 0 ; (where r 0 is a constant threshold tuned by classifying a preliminary referenced set of peaks (see Supplementary). The classifier is trained on a set of true peaks, where the correct size of the bounding box was set manually. Consequently, it is highly probable that a real peak with an improper bounding box size will be classified as an artifact, because it is divergent from the real peaks in the training set. However, at least one of the different bounding boxes used between the manually defined minimum and maximum, will be classified as highly positive. To calculate the r i;k a classifier known as Support Vector Machine (SVM) is used (). SVMs are currently one of the basic techniques in window-based object detection where binary classification is used [along with AdaBoost and Random Forests (. A major advantage is that they are fast and easily trained to obtain a robust classifier. An SVM classifier has the following formwhere a j denotes model parameters, K; is defined in Equation (8), and / j are the reference descriptors, also called support vectors. Model parameters and support vectors are obtained during the SVM learning process based on a set of examples n / 1 ; p 1 ;. .. ; / N ; p N o , the area of which is called here the training set (). Our training set consists of 7566 manually selected example peaks which cover various shapes including both real peaks (3887) and artifacts (3679). The set containing 13 spectra was created from HNCO, HNCA, HSQC, CBCA(CO)NH, HNCACB experiments measured with proteins that contained between 114 and 209 residues. The peak descriptor (feature vector) is compared with support vectors () using the Gaussian kernel K/; / 0   expck/  / 0 k 2 :With increasing similarity of the feature vectors the kernel approaches its maximum value of 1. Thereby, the support vectors that are similar to the feature vector, have higher impact on the response. Thus, it is important to have a representative training set so that the support vectors cover diverse regions in the feature space.The precision parameter c is tuned according to the standard procedures (see Supporting Information). After the peak classification process the positively classified peaks from all layers are entered into a three-dimensional peak list. This list is imported into the program Sparky, the peak extrema are refined by quadratic interpolation and the list is stored in Sparky format.
ResultsWe evaluated the CV-Peak Picker algorithm by comparing the results with those of established programs PICKY (), WaVPeak () using a set of benchmark spectra and additional spectra (). Spectra of only 3 proteins from the original benchmark set were made available to us by the authors of PICKY and WaVPeak. We also tested our CV based algorithm on a set of different spectra obtained for proteins with molecular weights from 13 to 130 kDa () to test the high potential of the CV software. All spectra were picked independently of any other spectrum or input, i.e. the number of artifacts will be reduced when combining peak lists from different spectra which is necessary for sequence specific assignments or structure calculations. For most spectra all real peaks were correctly picked with a remarkably small number of artifacts. In the evaluation of our results we used generally accepted statistical measures: precision, recall and F-measure. Precision, P, and recall, R, are defined as P  (TP/(TP  FP))*100 and R  (TP/(TP  FN))*100, where TP stands for true positives ('real peaks' which were classified as 'true peaks'), FN stands for false negatives ('real peaks' which were classified as 'artifacts') and FP stands for false positives ('false peaks' classified as 'real peaks'). Combination of these two measures is represented as F-measure, F  2RP/(R  P), and allows for direct comparisons of performance between different methods (). Values of the F-measure fall into the range from 0 to 100, where 100 represents highest performance of the method.The correlation coefficient was calculated with the standard function 'Correlation Coefficient' in Microsoft Excel.compares the peak picking performance of CV-Peak Picker, PICKY and WaVPeak on the set of benchmarked spectra as introduced by () and on more challenging spectra selected by us. A comparison of the F-measures between CVPeak Picker, PICKY and WaVPeak shows that CV-Peak Picker performs substantially better on each of the benchmark spectra. In the same table correlation coefficient between F-measure and signal-tonoise ratio is presented. In, we summarize peak picking results for spectra which are more challenging than the benchmark spectra. In two cases for the highly overlapped spectra of the 130 kDa helical membrane protein KcsA alpha and of intrinsically disordered Nlgn-3, CV-Peak Picker reaches F-measures of about 75. For the remaining proteins high F-measure scores of approximately 95 are achieved. Exemplary planes of these five spectra are shown in Supplementary. The reference peak lists for the spectra in, were obtained from original peak lists (provided by the authors or found in assignment papers) which we manually corrected as they contained only assigned peaks and not all real peaks. The performance of CV-Peak Picker is exemplified in Supplementarywith six consecutive cross sections of the HN(CO)CA spectrum of KcsA.lists the 3 parameters (1 obligatory and 2 optional) which must be set before running the CV-Peak Picker. In the Supporting Information, we graphically represent the dependence of the performance (F-measure) of CV-Peak Picker on the selection of the size of bounding box (Supplementary) and on the threshold value r 0 (Supplementary). These figures show that the values for the bounding box and r 0 can be chosen in a wide range without substantially changing the resulting peak list. Further, in Supplementary Table S2, we provide average scanning times per 2D layer of various 3D heteronuclear correlation spectra measured with different proteins.
Automated peak picking
DiscussionThe application of computer vision techniques for a peak picking algorithm applied to NMR spectra described here, results in fully automated peak recognition in a wide range of triple-resonance spectra obtained with five different globular proteins with molecular weights between 13 and 26 kDa and a uniformly deuterated tetrameric (4  17.5 kDa) alpha helical membrane protein in detergent micelles (130 kDa in complex). Moreover it outperforms other currently used peak pickers as evaluated by benchmark spectra. Features and system requirements of the most popular peak picking programs are presented in Supplementary Table S1. A standard measure used for comparison of the performance of peak picking algorithms, the F-measure, is a combination of two components: recall and precision. The precision measure contains information on the excessively picked artifacts, while recall contains information on missed real peaks. In practice, for structural studies recall has significantly higher importance than precision as loss of information (missed real peaks) often cannot be compensated and thus it may lead to incomplete assignments. Conversely, excessively picked artifacts are rather easily rejected in an assignment process. Inthe performance of CV-Peak Picker and WaVPeak as well as PICKY are compared. CV-Peak Picker always has superior precision scores and overall F-measures. However, in ten cases CV-Peak Picker reaches slightly worse recall scores than PICKY and/or WaVPeak. Although these differences are relatively small, weObligatory: Estimation of the proper size of the scanning window is crucial for the scanning procedure. The peak picker performs well if the side length of the window selected by the user varies up to 6 50% from the optimal one. CV-Peak Picker offers an interactive tool which allows a user to draw a scanning window on the contour plot of the spectrum.Threshold r 0 Optional: The parameter can be used for fine tuning after all peaks are evaluated using SVM. Often change of the default value is not necessary.The parameter can be adjusted using an interactive graphical user interface, which updates visualization of the scanning results in real time according to the value of r 0. Number of scanned peaks per layer Optional: The parameter is introduced exclusively for performance optimization. A user can request to scan all peaks in the spectrum (even small artifacts) by assigning an arbitrarily large value to this parameter. Nevertheless, scanning the biggest 500 peaks on each layer of a tripleresonance spectrum is usually sufficient.The parameter can be specified in the CV-Peak Picker configuration file. speculate that a substantial increase of the number of peaks in the CV-Peak Picker's training set, might help reaching higher recall scores. On the other hand, WaVPeak requires a preset number of the expected real peaks in the spectrum, which results in a classification of questionable peaks as real.also presents a correlation between the F-measure and the signal-to-noise ratio (SNR). CVPeak Picker reaches the similar F-measure at low SNR which is a substantial advantage for its versatility and usefulness in real spectra with suboptimal SNR. The applications of CV-Peak Picker in this work demonstrate that the analysis of NMR spectra of proteins with difficult, highly overlapped spectra including IDPs or molten globules () can be fully automated. User attention can be focused on validation of the results. We believe that highest accuracy can be achieved by coupling our software with powerful assignment programs as e.g. FLYA (L pez-Mndez and G ntert, 2006). The methodology presented in this paper has high potential for investigations and analysis of NMR spectra of nucleic acids and carbohydrates, and could be adapted for peak picking of solid state NMR spectra.
at University of California, Los Angeles on August 30, 2016 http://bioinformatics.oxfordjournals.org/ Downloaded from
P.Klukowski et al. at University of California, Los Angeles on August 30, 2016 http://bioinformatics.oxfordjournals.org/ Downloaded from
